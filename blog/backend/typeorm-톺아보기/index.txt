3:I[808,[],""]
5:I[6217,[],""]
6:I[5217,["3185","static/chunks/app/layout-3ad8bb7cb2292578.js"],"ServiceWorkerCleanup"]
7:I[6484,["3185","static/chunks/app/layout-3ad8bb7cb2292578.js"],"ThemeProvider"]
4:["slug","backend/typeorm-%ED%86%BA%EC%95%84%EB%B3%B4%EA%B8%B0","c"]
0:["static-build-id",[[["",{"children":["blog",{"children":[["slug","backend/typeorm-%ED%86%BA%EC%95%84%EB%B3%B4%EA%B8%B0","c"],{"children":["__PAGE__?{\"slug\":[\"backend\",\"typeorm-톺아보기\"]}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","backend/typeorm-%ED%86%BA%EC%95%84%EB%B3%B4%EA%B8%B0","c"],{"children":["__PAGE__",{},[["$L1","$L2",null],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/bc8bb31cb71603b2.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"ko","children":[["$","head",null,{"children":[["$","link",null,{"rel":"preconnect","href":"https://fonts.googleapis.com"}],["$","link",null,{"rel":"preconnect","href":"https://fonts.gstatic.com","crossOrigin":"anonymous"}],["$","link",null,{"href":"https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap","rel":"stylesheet"}],["$","link",null,{"href":"https://fonts.googleapis.com/css2?family=Catamaran:wght@800&display=swap","rel":"stylesheet"}],["$","link",null,{"rel":"icon","type":"image/png","href":"/favicon2.png"}],["$","link",null,{"rel":"shortcut icon","href":"/favicon2.png"}],["$","link",null,{"rel":"apple-touch-icon","href":"/favicon2.png"}],["$","script",null,{"id":"ads","async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"}],["$","script",null,{"dangerouslySetInnerHTML":{"__html":"(adsbygoogle=window.adsbygoogle||[]).requestNonPersonalizedAds=1;"}}]]}],["$","body",null,{"children":[["$","noscript",null,{"children":"You need to enable JavaScript to run this app."}],["$","$L6",null,{}],["$","$L7",null,{"children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[]}]}]]}]]}]],null],null],["$L8",null]]]]
9:I[5553,["9243","static/chunks/9243-972bdccd4ceb11ae.js","5800","static/chunks/5800-4312aed1aa8a4305.js","549","static/chunks/549-2babc012700e23ed.js","4853","static/chunks/4853-73ca7990eb89674b.js","6797","static/chunks/app/blog/%5B...slug%5D/page-9b274a2e0073d544.js"],"BlogPostPageClient"]
a:T8785,
- Node와 RDB의 ORM 서비스는 sequelize, typeorm, prisma 등 많은 라이브러리들이 있습니다.
- 가장 먼저 사용한 ORM 서비스는 sequelize 였지만 typeorm이 typescript 지원이나 시장의 흐름에 따라 조금 더 많이 사용된다고 생각되어 공부하게 되었습니다.

  - prisma도 고려해 보았으나 아직은 시기상조인 것 같았습니다.

## typeorm에 대해 알아보기 전에 ORM이 무엇인지 알아보겠습니다.

- ORM(Object-relational mapping)은 객체지향 프로그래밍(Object-Oriented-Programming)과 관계형 데이터베이스(Relational-Database)사이의 호환되지 않는 `데이터를 변환하는 시스템`입니다.
  - 객체와 테이블 시스템(RDBMS)을 변형 및 연결해주는 작업입니다.
- ORM을 이용한 개발은 객체와 데이터베이스의 변형에 유연하게 대처할 수 있습니다.
- ORM을 객체 지향 프로그래밍 관점에서 생각해보면, 관계형 데이터베이스에 제약을 최대한 받지 않으면서, 객체를 클래스로 표현하는 것과 같이 관계형 데이터베이스를 객체처럼 쉽게 표현합니다.
  - 객체지향 프로그래밍은 Class를 사용하고 관계형 데이터베이스는 Table을 사용합니다.

## 바로 본론으로 들어가서 typeorm을 프로젝트에서 어떻게 도입할지 알아보겠습니다.

- 의존성 설치 및 init

```zsh
npm install typeorm reflect-metadata @types/node mysql
typeorm init --name [프로젝트이름] --database [데이터베이스]
```

- global place 의 app.ts에 import 추가합니다.
  - reflect-metadata 패키지를 사용하면 유형에 대한 런타임 반영을 수행 할 수 있습니다. TypeORM은 대부분 데코레이터 (@Entity 또는 @Column)와 함께 작동하므로이 패키지는 이러한 데코레이터를 구문 분석하고 SQL 쿼리를 작성하는 데 사용합니다.

```ts
import 'reflect-metadata';
```

### 노드 모듈(typeorm-model-generator) 이용해 모델 자동 생성하는 방법도 있습니다.

- 각 옵션을 수동으로 입력

```zsh
typeorm-model-generator
```

- 커맨드 한 번에 생성

```zsh
typeorm-model-generator -h localhost -u $userName -x $password -e mysql -o ./entities --ssl
```

## typeorm 작성 패턴에 대해 알아보겠습니다.

- Active Record 패턴과 Data Mapper 패턴이 있습니다.

## Active Record 패턴에 대해 먼저 알아보겠습니다.

- Active Record 패턴은 `모델 그 자체에 쿼리 메소드를 정의`하고, `모델의 메소드를 사용`하여 객체를 저장, 제거, 불러오는 방식입니다.
- BaseEntity라는 클래스를 사용하여 새로운 클래스에 상속하게 한 후 사용할 수 있습니다. 이를 통해 BaseEntity가 갖고 있는 메소드와 static으로 만들어 내는 커스텀 메소드를 이용할 수 있습니다.
- 규모가 작은 애플리케이션에서 적합하고 간단히 사용할 수 있습니다.

```ts
import { BaseEntity, Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

@Entity()
export class User extends BaseEntity {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column()
  isActive: boolean;

  static findByName(firstName: string, lastName: string) {
    return this.createQueryBuilder('user')
      .where('user.firstName = :firstName', { firstName })
      .andWhere('user.lastName = :lastName', { lastName })
      .getMany();
  }
}
```

```ts
// example how to save AR entity
const user = new User();
user.firstName = 'Timber';
user.lastName = 'Saw';
user.isActive = true;
await user.save();

// example how to remove AR entity
await user.remove();

// example how to load AR entities
const users = await User.find({ skip: 2, take: 5 });
const newUsers = await User.find({ isActive: true });
const timber = await User.findOne({ firstName: 'Timber', lastName: 'Saw' });
const timber = await User.findByName('Timber', 'Saw');
```

## Data Mapper 패턴에 대해서도 알아보겠습니다.

- Data Mapper 패턴은 `분리된 클래스에 쿼리 메소드를 정의`하는 방식이며, `Repository를 이용`하여 객체를 저장, 제거, 불러옵니다.
- Active Record 패턴과의 차이점은 모델에 접근하는 방식이 아닌 `Repository에서 데이터에 접근`한다는 것입니다.
- 규모가 큰 애플리케이션에 적합하고 유지보수하는데 효과적이다.

```ts
import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column()
  isActive: boolean;
}
```

```ts
import { EntityRepository, Repository } from 'typeorm';
import { User } from '../entity/User';

@EntityRepository()
export class UserRepository extends Repository<User> {
  findByName(firstName: string, lastName: string) {
    return this.createQueryBuilder('user')
      .where('user.firstName = :firstName', { firstName })
      .andWhere('user.lastName = :lastName', { lastName })
      .getMany();
  }
}
```

```ts
const userRepository = connection.getRepository(User);

// example how to save DM entity
const user = new User();
user.firstName = 'Timber';
user.lastName = 'Saw';
user.isActive = true;
await userRepository.save(user);

// example how to remove DM entity
await userRepository.remove(user);

// example how to load DM entities
const users = await userRepository.find({ skip: 2, take: 5 });
const newUsers = await userRepository.find({ isActive: true });
const timber = await userRepository.findOne({
  firstName: 'Timber',
  lastName: 'Saw',
});
```

## entity들을 만들었다면 데이터베이스에 대한 연결 생성하는 법을 알아 보겠습니다.

```ts
import 'reflect-metadata';
import { createConnection } from 'typeorm';
import { Photo } from './entity/Photo';

createConnection({
  type: 'mysql',
  host: 'localhost',
  port: 3306,
  username: 'root',
  password: 'admin',
  database: 'test',
  entities: [
    Photo,
    // __dirname + '/entity/*.js'
  ],
  synchronize: true,
  logging: false,
})
  .then((connection) => {
    // here you can start to work with your entities
  })
  .catch((error) => console.log(error));
```

## Entity를 만드는 방법에 대해 조금 더 상세히 알아보겠습니다.

### Entity 데코레이터

- 데이터베이스 테이블을 정의하기 전에 실행해야하는 데코레이터입니다.
- 테이블명을 따로 지정하지 않아도 클래스명으로 매핑하지만, 옵션으로 테이블명을 지정할 수 있습니다.

```ts
@Entity('users')
export class User {}
```

- name: `테이블 이름`입니다. 지정하지 않으면 테이블 이름은 엔티티 `클래스명`으로 생성됩니다.
- database: 선택된 DB서버의 데이터베이스 이름입니다.
- schema: 스키마 이름입니다.
  - MySQL에서는 schema와 database가 따로 분리되어있지 않습니다. OracleDB에서는 schema를 따로 분리해서 database에 할당된 사용자로 사용합니다.
- engine: 테이블 생성 중에 설정할 수 있는 DB엔진 이름입니다.
- synchronize: false로 설정할 시 스키마 싱크를 건너뜁니다.
- orderBy: QueryBuilder과 find를 실행할 때 엔티티의 기본순서를 지정합니다.

```ts
@Entity({
  name: 'users',
  engine: 'MyISAM',
  database: 'example_dev',
  schema: 'schema_with_best_tables',
  synchronize: false,
  orderBy: {
    name: 'ASC',
    id: 'DESC',
  },
})
export class User {}
```

### 중복되는 Entity를 상속를 사용하여 해결할 수 있습니다.

- Concrete table inheritance와 Single table inheritance가 있습니다.

#### Concrete table inheritance

- 중복된 칼럼을 베이스가 되는 `추상 클래스`를 선언한 다음 확장할 수 있습니다.
- 참고로 active record 패턴을 사용할 예정이라면, `BaseEntity`라는 이름은 피하는게 좋습니다.
  - typeorm에서 제공하는 클래스인 BaseEntity는 기본 쿼리 메서드 hasId, save, remove 등의 메서드를 담은 클래스입니다.

```ts
// 추상 클래스
export abstract class Content {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  description: string;
}

// 1
@Entity()
export class Photo extends Content {
  @Column()
  size: string;
}

// 2
@Entity()
export class Question extends Content {
  @Column()
  answersCount: number;
}

// 3
@Entity()
export class Post extends Content {
  @Column()
  viewCount: number;
}
```

#### Single table inheritance

- @TableInheritance(), @ChildEntity()를 사용하는 방법입니다.
- 이 방법은 데이터베이스에 Content 테이블이 생성됩니다. `Content 위에 @Entity()를 선언`해줘야 아래와 같은 패턴을 사용할 수 있습니다.

```ts
@Entity()
@TableInheritance({ column: { type: 'varchar', name: 'type' } })
export class Content {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  description: string;
}

@ChildEntity()
export class Photo extends Content {
  @Column()
  size: string;
}

@ChildEntity()
export class Question extends Content {
  @Column()
  answersCount: number;
}

@ChildEntity()
export class Post extends Content {
  @Column()
  viewCount: number;
}
```

### Embedded entities

- 이름이 비슷하고 타입이 같은 칼럼들을 묶는 패턴입니다.
- User.name은 User.nameFirst, User.nameLast로 분기합니다. Name은 데코레이터 @Entity()가 붙어있지 않기때문에 위의 패턴처럼 `실제 테이블이 생겨나지는 않습니다`.

```ts
export class Name {
  @Column()
  first: string;

  @Column()
  last: string;
}

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: string;

  @Column((type) => Name)
  name: Name;

  @Column()
  isActive: boolean;
}
```

### ViewEntity

#### SQL view란 ?

- view는 하나의 `가상 테이블`입니다.
- 실제 데이터가 저장되는 것은 아니지만, view를 통해 데이터를 가상 테이블로 관리가 가능합니다.
- 1개의 view로 여러 테이블의 데이터를 조회할 수 있습니다.
- 복잡한 쿼리를 통해 얻을 수 있는 결과를 간단한 쿼리로 얻을 수 있게 도와줍니다.
- 특정 기준에 따른 사용자 별로 다른 데이터를 액세스할 수 있도록 도와줄 수도 있습니다.
- 조회 대상을 줄이고 싶을 때 사용할 수 있습니다.

#### ViewEntity 데코레이터 인자

- 데코레이터에 들어가는 인자가 아래와 같이 @Entity()와는 약간 다릅니다.
  - name: 테이블 이름입니다. 지정하지 않으면 테이블 이름은 엔티티 클래스명으로 생성됩니다.
  - database: 선택된 DB서버의 데이터베이스 이름입니다.
  - schema: 스키머 이름입니다.
  - expression: view를 정의합니다. 꼭 있어야하는 파라미터로 SQL쿼리문이나 queryBuilder 체이닝 메서드가 들어갈 수 있습니다.
- expression은 SQL 쿼리문이나 QueryBuilder에 체이닝할 수 있는 메서드가 들어갈 수 있습니다. 특이점으로는 필드명 위에 들어가는 데코레이터를 id까지 전부 @ViewColumn()을 사용해야 한다는 점이 있습니다. 만약 사용을 고려한다면, JOIN을 쳐서 테이블끼리 연결을 시키냐, 아니면 view를 통해 나중에 자주 사용할 가상 테이블을 미리 만들어두냐의 차이로 생각할 수 있습니다.

```ts
@ViewEntity({
  expression: `
        SELECT "post"."id" AS "id", "post"."name" AS "name", "category"."name" AS "categoryName"
        FROM "post" "post"
        LEFT JOIN "category" "category" ON "post"."categoryId" = "category"."id"
    `,
})
export class PostCategory {
  @ViewColumn()
  id: number;

  @ViewColumn()
  name: string;

  @ViewColumn()
  categoryName: string;
}
```

- 구조가 복잡하고, 여러군데서 호출하는 데이터의 경우 미리 ViewEntity로 view 테이블을 만들어두면 유용합니다.

### Column

- entity의 속성을 테이블 칼럼으로 표시합니다.

```ts
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ tpye: 'varchar', length: 200, unique: true })
  firstName: string;

  @Column({ nullable: true })
  lastName: string;

  @Column({ default: false })
  isActive: boolean;
}
```

- @Column()에 들어갈 수 있는 옵션들 중 중요하다고 판단한 것들은 아래와 같습니다.

  - type(ColumnType) : `javascript의 원시타입`들을 세분화해서 사용할 수 있습니다. 타입을 정의하는 방법은 다음과 같습니다.
  - length(string | number) : javascript의 원시타입들을 세분화해서 사용하기 위해 type 옵션과 같이 사용할 수 있습니다.
  - onUpdate(string) : cascading을 하기 위한 옵션으로 ON UPDATE 트리거입니다.
  - nullable(boolean) : 칼럼을 NULL이나 NOT NULL로 만드는 옵션입니다. 기본값은 false입니다.
  - default(string) : 칼럼에 DEFAULT 값을 설정합니다.
  - unique(boolean) : 유니크 칼럼이라고 표시할 수 있습니다. 유니크 constraint를 만듭니다. 기본값은 false 입니다.
  - enum(string[] | AnyEnum) : 칼럼의 값으로 enum을 사용할 수 있습니다. enum은 db단에서 처리할 수도, orm단에서 처리할 수도 있습니다.
  - enumName(string) : 다른 테이블에서 같은 enum을 사용하는 경우 필요합니다.
  - transformer({ from(value: DatabaseType): EntityType, to(value: EntityType): DatabaseType }) : 아래와 같은 코드를 만들어내서 json을 문자열로 만들고 파싱하는 역할을 합니다. 또는 boolean을 integer로 바꿔주는 일도 할 수 있습니다.

  ```ts
  import { ValueTransformer } from 'typeorm';

  class SomeTransformer implements ValueTransformer {
    to(value: Map<string, number>): string {
      return JSON.stringify([...value]);
    }
    from(value: string): Map<string, number> {
      return new Map(JSON.parse(value));
    }
  }
  ```

### IdColumn

- PrimaryColumn과 PrimaryGeneratedColum이 있습니다.

#### PrimaryColumn

- @Column()의 옵션인 primary를 대체할 수 있습니다. `PK`를 만드는 역할을 합니다.

#### PrimaryGeneratedColumn

- `자동생성`되는 ID값을 표현하는 방식을 아래와 같이 2가지 옵션을 사용할 수 있도록 도와줍니다.
  - increment: AUTO_INCREMENT를 사용해서 1씩 증가하는 ID를 부여합니다. 기본 옵션입니다.
  - uuid: 유니크한 uuid를 사용할 수 있습니다.

```ts
// using increment
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;
}

// using uuid
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;
}
```

##### Generated

- PK로 쓰는 ID 외에 추가로 uuid를 기록하기 위해서 사용할 수 있습니다.

```ts
@Entity()
export class User {
  @Column()
  @Generated('uuid')
  uuid: string;
}
```

### DateColumn

- CreateDateColumn과 UpdateDateColumn, DeleteDateColumn이 있습니다.

#### CreateDateColumn

- 해당 열이 추가된 시각을 자동으로 기록합니다.
- 옵션을 적지 않을시 datetime 타입으로 기록됩니다.

```ts
@Entity()
export class User {
  @CreateDateColumn()
  createdAt: Date;
}
```

#### UpdateDateColumn

- 해당 열이 수정된 시각을 자동으로 기록합니다.
- 옵션을 적지 않을시 datetime 타입으로 기록됩니다.

```ts
@Entity()
export class User {
  @UpdateDateColumn()
  updatedAt: Date;
}
```

#### DeleteDateColumn

- 해당 열이 삭제된 시각을 자동으로 기록합니다.
- 옵션을 적지 않을시 datetime 타입으로 기록됩니다.
- deletedAt에 시각이 기록되지 않은 열들만 쿼리하기 위해 TypeORM의 soft delete 기능을 활용할 수 있습니다.

```ts
@Entity()
export class User {
  @DeleteDateColumn()
  deletedAt: Date;
}
```

##### soft delete이란 ?

- 데이터 열을 실제로 삭제하지 않고, 삭제여부를 나타내는 칼럼인 deletedAt을 사용하는 방식입니다.
- 일반적인 삭제 대신 삭제된 열을 갱신하는 UPDATE문을 사용하는 방식입니다.
- 시각이 기록되지 않은 열들만 필터해서 쿼리하도록 도와주는 역할을 합니다.
- 다른 테이블과 JOIN시 항상 삭제된 열을 검사해서 성능이 떨어집니다.
- 복구하거나 예전 기록을 확인하고자 할 때 간편합니다.

### Relation. 이제 하나의 테이블이 아닌 테이블간의 관계에 대해 알아보겠습니다.

- 테이블간의 관계는 1:1, 1:N, M:N 관계가 있습니다.

#### OneToOne

- @JoinColumn()을 사용한 필드는 FK(외래키)로 타겟 테이블에 등록됩니다. `@JoinColumn()은 반드시 한쪽 테이블에서만 사용해야 합니다`.
- 관계는 단방향과 양방향 모두 작성이 가능합니다.
  - uni-directional은 @OneToOne()을 한쪽에만 써주는 것
  - bi-directional은 양쪽에 모두 써주는 것

```ts
@Entity()
export class Profile {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  gender: string;

  @Column()
  photo: string;

  @OneToOne(() => User, (user) => user.profile)
  user: User;
}

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @OneToOne((type) => Profile, (profile) => profile.user)
  @JoinColumn()
  profile: Profile;
}

// using find* method
const userRepo = connection.getRepository(User);
const users = await userRepo.find({ relations: ['profile'] });

// using query builder
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .leftJoinAndSelect('user.profile', 'profile')
  .getMany();
```

#### ManyToOne/OneToMany

- @OneToMany()/@ManyToOne()에서는 `@JoinColumn()을 생략`할 수 있습니다.
- `@OneToMany()는 @ManyToOne()이 없으면 안됩니다`.
  - 하지만 반대로 @ManyToOne()은 @OneToMany()이 없어도 정의할 수 있습니다.
- @ManyToOne()을 설정한 테이블에는 `relation id가 외래키`를 가지고 있게 됩니다.

```ts
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @OneToMany((type) => Photo, (photo) => photo.user)
  photos: Photo[];
}

@Entity()
export class Photo {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  url: string;

  @ManyToOne((type) => User, (user) => user.photos)
  user: User;
}

// using find* method
const userRepository = connection.getRepository(User);
const users = await userRepository.find({ relations: ['photos'] });
// or from inverse side
const photoRepository = connection.getRepository(Photo);
const photos = await photoRepository.find({ relations: ['user'] });

// using query builder
const users = await connection
  .getRepository(User)
  .createQueryBuilder('user')
  .leftJoinAndSelect('user.photos', 'photo')
  .getMany();
// or from inverse side
const photos = await connection
  .getRepository(Photo)
  .createQueryBuilder('photo')
  .leftJoinAndSelect('photo.user', 'user')
  .getMany();
```

#### ManyToMany

- @ManyToMany() 관계에서는 `@JoinTable()이 반드시 필요합니다`. 한쪽 테이블에만 @JoinTable()을 넣어주면 됩니다.
- 단, @ManyToMany()에서 옵션 cascade가 true인 경우 soft delete를 할 수 있습니다. 필요에 따라 사용할 수 있습니다.

```ts
@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;
}

@Entity()
export class Question {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  text: string;

  @ManyToMany(() => Category)
  @JoinTable()
  categories: Category[];
}

// using find* method
const questionRepository = connection.getRepository(Question);
const questions = await questionRepository.find({ relations: ['categories'] });

// using query builder
const questions = await connection
  .getRepository(Question)
  .createQueryBuilder('question')
  .leftJoinAndSelect('question.categories', 'category')
  .getMany();
```

### Tree entity

- TypeORM은 트리 구조를 저장하기 위해 인접 목록 및 클로저 테이블 패턴을 지원합니다.

#### 먼저 셀프조인에 예시에 대해 알아보겠습니다.

- 1개의 테이블에서 부모-자식 관계를 나타낼 수 있는 패턴
- 상품 카테고리(소,중,대분류)
- 사원(사원,관리자,상위관리자)
- 지역(읍/면/동,구/군,시/도)

#### TypeORM은 셀프조인을 아래와 같은 4가지 패턴으로 지원합니다.

#### Adjacency list

- 자기참조를 @ManyToOne(), @OneToMany() 데코레이터로 표현할 수 있습니다.
- 이 방식은 간단한 것이 가장 큰 장점이지만, JOIN하는데 제약이 있어 큰 트리를 로드하는데 문제가 있습니다.

```ts
@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column()
  description: string;

  @ManyToOne((type) => Category, (category) => category.children)
  parent: Category;

  @OneToMany((type) => Category, (category) => category.parent)
  children: Category[];
}
```

#### Nested set

- @Tree(), @TreeChildren(), @TreeParent()를 사용한 또 다른 패턴입니다.
- 읽기 작업에는 효과적이지만 쓰기 작업에는 효과적이지 않습니다.
- 여러 개의 루트를 가질 수 없다는 점도 문제입니다.
- @Tree()의 인자로 `nested-set`이 들어갑니다.

```ts
@Entity()
@Tree('nested-set')
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @TreeChildren()
  children: Category[];

  @TreeParent()
  parent: Category;
}
```

#### Materialized path

- 구체화된 경로 혹은 경로 열거라고 부릅니다.
- 간단하고 효율적입니다.
- nested set과 사용방법은 같습니다.
- @Tree()의 인자로 `materialized-path`이 들어갑니다.

```ts
import {
  Entity,
  Tree,
  Column,
  PrimaryGeneratedColumn,
  TreeChildren,
  TreeParent,
  TreeLevelColumn,
} from 'typeorm';

@Entity()
@Tree('materialized-path')
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @TreeChildren()
  children: Category[];

  @TreeParent()
  parent: Category;
}
```

### Closure table

- 부모와 자식 사이의 관계를 분리된 테이블에 특별한 방법으로 저장합니다.
- 읽기와 쓰기 모두 효율적으로 할 수 있습니다.
- nested set과 사용방법은 같습니다.
- @Tree()의 인자로 closure-table이 들어갑니다.

```ts
import {
  Entity,
  Tree,
  Column,
  PrimaryGeneratedColumn,
  TreeChildren,
  TreeParent,
  TreeLevelColumn,
} from 'typeorm';

@Entity()
@Tree('closure-table')
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @TreeChildren()
  children: Category[];

  @TreeParent()
  parent: Category;
}
```

- 선택적 매개 변수 옵션을 @Tree ( "closure-table", options)로 설정하여 클로저 테이블 이름 또는 클로저 테이블 열 이름을 지정할 수 있습니다.
- ancestorColumnName 및 descandantColumnName은 기본 열의 메타 데이터를 수신하고 열의 이름을 반환하는 콜백 함수입니다.

```ts
@Tree("closure-table", {
    closureTableName: "category_closure",
    ancestorColumnName: (column) => "ancestor_" + column.propertyName,
    descendantColumnName: (column) => "descendant_" + column.propertyName,
})
```

### JoinColumn/JoinTable에 대해 조금 더 알아보겠습니다.

- 아래는 아래 2개의 데코레이터에 공통으로 사용할 수 있는 옵션입니다.
  - eager 옵션이 있어서 N+1 문제를 제어할 수 있음
  - cascade, onDelete 옵션이 있어 관계가 연결된 객체를 추가/수정/삭제되도록 할 수 있습니다. 버그를 유발할 수 있으니 주의해서 사용해야 합니다.

#### N+1 문제란?

- 하위 엔티티들을 첫 쿼리 실행시 한번에 가져오지 않고, Lazy Loading으로 필요한 곳에서 사용되어 쿼리가 실행될때 발생하는 문제가 N+1 쿼리 문제입니다.

#### JoinColumn

- @JoinColumn()을 사용하면 테이블에 자동으로 칼럼명과 참조 칼럼명을 합친 이름의 칼럼을 만들어냅니다.
- 외래키를 가진 칼럼명과 참조칼럼명을 설정할 수 있는 옵션을 가지고 있습니다.
- 설정하지 않으면 테이블명을 가지고 자동으로 매핑합니다.
- 주의할 점으로는 @ManyToOne()에서는 꼭 적지 않아도 칼럼을 자동으로 만들어주지만, `@OneToOne()에서는 반드시 적어줘야 합니다`.

```ts
@Entity()
export class Post {
  @ManyToOne((type) => Category)
  @JoinColumn({
    name: 'category_id',
    referencedColumnName: 'name',
  })
  category: Category;
}

@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;
}
```

### JoinTable

- `M:N 관계`에서 사용하며 연결 테이블을 설정할 수 있습니다.
- @JoinTable()의 옵션을 사용해 연결 테이블의 칼럼명과 참조 칼럼명을 설정할 수 있습니다.

```ts
@Entity()
export class Question {
  @ManyToMany((type) => Category)
  @JoinTable({
    name: 'question_categories',
    joinColumn: {
      name: 'question',
      referencedColumnName: 'id',
    },
    inverseJoinColumn: {
      name: 'category',
      referencedColumnName: 'id',
    },
  })
  categories: Category[];
}

@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;
}
```

### RelationId

- 1:N/M:N 관계에서 entity에 명시적으로 관계가 있는 테이블의 칼럼 id를 적고싶은 경우, @RelationId()를 사용하면 됩니다.
- @RelationId()가 꼭 필요하지는 않지만 entity를 보면서 칼럼을 한 눈에 볼 수 있다는 장점이 있습니다.
- @RelationId()로 테이블을 조회하면 새로운 칼럼명도 결과에 같이 들고올 수 있습니다.
- 하지만 relationId 칼럼에 삽입하여 사용할 수 없습니다.
  - inset or update 시 payload에 relationId가 아닌 relation으로 사용해야 합니다.
  - 관련 이슈 : https://github.com/typeorm/typeorm/issues/3867
  - @RelationId를 사용하는 대신 @Column으로 relationId를 장식 할 수 있습니다. JoinColumn의 이름이 숫자열 이름과 같을 때 TypeORM이 둘 다 일치하고 userId를 설정하거나 사용자를 설정하면 TypeORM이 처리합니다.

```ts
// using many to one
@Entity()
export class Post {
  @ManyToOne((type) => Category)
  category: Category;

  @RelationId((post: Post) => post.category)
  categoryId: number;
}

// using many to many
@Entity()
export class Post {
  @ManyToMany((type) => Category)
  categories: Category[];

  @RelationId((post: Post) => post.categories)
  categoryIds: number[];
}
```

### Subscriber

- 데이터베이스에 특화된 리스너로 CRUD 이벤트 발생을 리슨합니다.
- 다음과 같은 데코레이터들을 가지고 있습니다.
  - @AfterLoad, @AfterInsert, @BeforeInsert, @AfterUpdate, @BeforeUpdate, @AfterRemove, @BeforeRemove
- logging 옵션이 있긴 하지만 쿼리만을 보여주기 때문에 한 줄씩 분석하기 위해 로그를 남기는 경우에는 지양하는 것이 좋습니다.

```ts
import {
  Connection,
  EntitySubscriberInterface,
  EventSubscriber,
  InsertEvent,
} from 'typeorm/index';
import { User } from './User';

@EventSubscriber()
export class UserSubscriber implements EntitySubscriberInterface<User> {
  constructor(connection: Connection) {
    connection.subscribers.push(this);
  }
  listenTo() {
    return User;
  }
  beforeInsert(event: InsertEvent<User>): Promise<any> | void {
    console.log('User 테이블에 입력 전 : ', event.entity);
  }
  afterInsert(event: InsertEvent<User>): Promise<any> | void {
    console.log('User 테이블에 입력 후 : ', event.entity);
  }
}
```

### Index

- 테이블 `쿼리 속도`를 올려주는 자료구조입니다.
- 테이블 내 1개 혹은 그 이상의 칼럼을 이용해 생성할 수 있습니다.
- 인덱스는 보통 키-필드만 갖고있고, 테이블의 다른 세부항목을 갖지 않기때문에 보통 테이블을 저장하는 공간보다 더 `적은 공간`을 차지합니다.
- 특정 칼럼 값을 가지고 있는 열이나 값을 `빠르게 찾기` 위해 사용합니다.
  - 인덱싱하지 않은 경우는 첫번째 열부터 전체 테이블을 걸쳐 연관된 열을 검색하기때문에 테이블이 클수록 쿼리비용이 커집니다.
  - 인덱싱을 한 경우는 모든 데이터를 조회하지 않고 데이터 파일의 중간에서 검색위치를 빠르게 잡을 수 있습니다.
- `WHERE`절과 일치하는 열을 빨리 찾기 위해서 사용합니다.
- `JOIN`을 실행할 때 다른 테이블에서 열을 추출하기 위해서 사용합니다.
- 데이터 양이 많고 변경보다 `검색이 빈번한 경우` 인덱싱을 하면 좋습니다.

> 쉽게 말해 책에서 transaction이란 주제가 어딨는지 목차 없이 찾으려면 눈물날지도 모릅니다. 책의 주요내용을 가나다순으로 정리한 목록이 있으면 찾기 쉬울텐데 인덱스가 바로 그 역할을 합니다.
> 특정 칼럼에 인덱스를 걸 수 있습니다. 옵션으로 고유키를 부여할 수도 있습니다. 단일 칼럼에 인덱스를 걸고 싶으면 칼럼마다 추가할 수도 있지만, 테이블 전체에 인덱스를 걸고싶은 경우 @Entity()아래 @Index()를 추가할 수도 있습니다.

```ts
// using with single column
@Entity()
export class User {
  @Index()
  @Column()
  firstName: string;

  @Index({ unique: true })
  @Column()
  lastName: string;
}

// using with entity
@Entity()
@Index(['firstName', 'lastName'], { unique: true })
export class User {
  @Column()
  firstName: string;

  @Column()
  lastName: string;
}
```

### Unique

- 특정 칼럼에 고유키 제약조건을 생성할 수 있습니다.
- @Unique()는 테이블 자체에만 적용하는 것이 가능합니다.

```ts
@Entity()
@Unique(['firstName', 'lastName'])
export class User {
  @Column()
  firstName: string;

  @Column()
  lastName: string;
}
```

### Check

- 테이블에서 데이터 추가 쿼리가 날아오면 값을 체크하는 역할을 합니다.

```ts
@Entity()
@Check('"age" > 18')
export class User {
  @Column()
  firstName: string;

  @Column()
  firstName: string;

  @Column()
  age: number;
}
```

### Transaction

- 데이터베이스 내에서 하나의 `그룹으로 처리해야하는 명령문`을 모아서 처리하는 작업의 단위를 말합니다.
  - 여러 단계의 처리를 `하나의 처리처럼` 다루는 기능입니다.
  - 여러 개의 명령어의 집합이 정상적으로 처리되면 정상종료됩니다.
  - 하나의 명령어라도 `잘못되면 전체 취소`됩니다.
- 트랜잭션을 쓰는 이유는 `데이터의 일관성`을 유지하면서 `안정적으로 데이터를 복구`하기 위함입니다.
- 격리성 수준 설정을 통해 트랜잭션이 열려있는 동안 외부에서 해당 데이터에 접근하지 못하도록 락을 걸 수 있습니다.

#### 격리성 수준

- READ UNCOMMITTED
- READ COMMITTED
- REPEATABLE READ
- SERIALIZABLE

#### global connection을 열어서 트랜젝션을 사용하는 경우는 아래와 같이 사용합니다.

```ts
await getManager().transaction(
  'SERIALIZABLE',
  (transactionalEntityManager) => {},
);
```

#### 하지만 global connection은 사이드이펙트가 많은 방법이기때문에 데코레이터나 queryRunner를 사용한 방법을 추천합니다.

- 아래는 데코레이터 @Transaction(), @TransactionManager(), @TransactionRepository()를 사용한 패턴입니다.

```ts
// using transaction manager
@Transaction({ isolation: 'SERIALIZABLE' })
save(@TransactionManager() manager: EntityManager, user: User) {
    return manager.save(user)
}

// using transaction repository
@Transaction({ isolation: 'SERIALIZABLE' })
save(user: User, @TransactionRepository(User) userRepository: Repository<User>) {
    return userRepository.save(user)
}
```

#### 아래는 queryRunner를 사용한 방법입니다. 다만 이 방법에서는 격리성 수준 설정이 불가능합니다.

- startTransaction은 트랜잭션을 시작하는 메서드
- commitTransaction는 모든 변경사항을 커밋하는 메서드
- rollbackTransaction는 모든 변경사항을 되돌리는 메서드

```ts
await queryRunner.startTransaction();

try {
  await queryRunner.manager.save(user);
  await queryRunner.manager.save(photos);

  await queryRunner.commitTransaction();
} catch (err) {
  await queryRunner.rollbackTransaction();
} finally {
  await queryRunner.release();
}
```

### Eager and Lazy Relations

#### eager

- relationship을 설정하지 않아도 eager를 설정하면 자동으로 relationship을 불러옵니다.
  - find\* (즉, find, findAll, findOne...)에서 자동으로 relationship을 불러옵니다.

```ts
@ManyToMany(type => Category, category => category.questions, {
  eager: true
})
```

#### lazy

- Promise로 반환하면, 자동으로 lazy relationship이 됩니다.
  - lazy를 불러올 때는 Promise.resolve를 하던가, await로 불러오면 됩니다.

```ts
@ManyToMany(type => Question, question => question.categories)
questions: Promise<Question[]>;
```

```ts
const question = await connection.getRepository(Question).findOne(1);
const categories = await question.categories;
```

- 참고 : 다른 언어 (자바, PHP 등)에서 왔고 모든 곳에서 게으른 관계를 사용하는 데 익숙하다면 조심하세요. 이러한 언어는 비동기식이 아니며 지연로드는 다른 방식으로 이루어집니다. 그렇기 때문에 거기에서 promise를 사용하지 않습니다. 자바 스크립트와 Node.JS에서 지연로드 된 관계를 원하면 promise를 사용해야합니다. 이것은 비표준 기술이며 TypeORM에서 실험적인 것으로 간주됩니다.

## typeorm의 bigint

- typeorm bigint는 number로 바꿔주지 않습니다. string입니다.
  - [Note about bigint type: bigint column type, used in SQL databases, doesn’t fit into the regular number type and maps property to a string instead.](https://typeorm.io/entities#column-types)

---

## 참고

- [TypeORM 시작하기](https://velog.io/@josworks27/typeORM-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0)
- [TypeORM 데코레이터 씹어먹기](https://yangeok.github.io/orm/2020/12/14/typeorm-decorators.html)
- [개발자 마르코](https://gkqlgkql.tistory.com/85)
b:T27d0c,<ul>
<li>
<p>Node와 RDB의 ORM 서비스는 sequelize, typeorm, prisma 등 많은 라이브러리들이 있습니다.</p>
</li>
<li>
<p>가장 먼저 사용한 ORM 서비스는 sequelize 였지만 typeorm이 typescript 지원이나 시장의 흐름에 따라 조금 더 많이 사용된다고 생각되어 공부하게 되었습니다.</p>
<ul>
<li>prisma도 고려해 보았으나 아직은 시기상조인 것 같았습니다.</li>
</ul>
</li>
</ul>
<h2 id="typeorm에-대해-알아보기-전에-orm이-무엇인지-알아보겠습니다">typeorm에 대해 알아보기 전에 ORM이 무엇인지 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#typeorm에-대해-알아보기-전에-orm이-무엇인지-알아보겠습니다"><span class="anchor"></span></a></h2>
<ul>
<li>ORM(Object-relational mapping)은 객체지향 프로그래밍(Object-Oriented-Programming)과 관계형 데이터베이스(Relational-Database)사이의 호환되지 않는 <code class="inline-code">데이터를 변환하는 시스템</code>입니다.
<ul>
<li>객체와 테이블 시스템(RDBMS)을 변형 및 연결해주는 작업입니다.</li>
</ul>
</li>
<li>ORM을 이용한 개발은 객체와 데이터베이스의 변형에 유연하게 대처할 수 있습니다.</li>
<li>ORM을 객체 지향 프로그래밍 관점에서 생각해보면, 관계형 데이터베이스에 제약을 최대한 받지 않으면서, 객체를 클래스로 표현하는 것과 같이 관계형 데이터베이스를 객체처럼 쉽게 표현합니다.
<ul>
<li>객체지향 프로그래밍은 Class를 사용하고 관계형 데이터베이스는 Table을 사용합니다.</li>
</ul>
</li>
</ul>
<h2 id="바로-본론으로-들어가서-typeorm을-프로젝트에서-어떻게-도입할지-알아보겠습니다">바로 본론으로 들어가서 typeorm을 프로젝트에서 어떻게 도입할지 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#바로-본론으로-들어가서-typeorm을-프로젝트에서-어떻게-도입할지-알아보겠습니다"><span class="anchor"></span></a></h2>
<ul>
<li>의존성 설치 및 init</li>
</ul>
<pre class="language-bash optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-bash code-highlight"><span class="code-line"><span class="token function">npm</span> <span class="token function">install</span> typeorm reflect-metadata @types/node mysql
</span><span class="code-line">typeorm init <span class="token parameter variable">--name</span> <span class="token punctuation">[</span>프로젝트이름<span class="token punctuation">]</span> <span class="token parameter variable">--database</span> <span class="token punctuation">[</span>데이터베이스<span class="token punctuation">]</span>
</span></code></pre>
<ul>
<li>global place 의 app.ts에 import 추가합니다.
<ul>
<li>reflect-metadata 패키지를 사용하면 유형에 대한 런타임 반영을 수행 할 수 있습니다. TypeORM은 대부분 데코레이터 (@Entity 또는 @Column)와 함께 작동하므로이 패키지는 이러한 데코레이터를 구문 분석하고 SQL 쿼리를 작성하는 데 사용합니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token string">'reflect-metadata'</span><span class="token punctuation">;</span>
</span></code></pre>
<h3 id="노드-모듈typeorm-model-generator-이용해-모델-자동-생성하는-방법도-있습니다">노드 모듈(typeorm-model-generator) 이용해 모델 자동 생성하는 방법도 있습니다.<a aria-hidden="true" tabindex="-1" href="#노드-모듈typeorm-model-generator-이용해-모델-자동-생성하는-방법도-있습니다"><span class="anchor"></span></a></h3>
<ul>
<li>각 옵션을 수동으로 입력</li>
</ul>
<pre class="language-bash optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-bash code-highlight"><span class="code-line">typeorm-model-generator
</span></code></pre>
<ul>
<li>커맨드 한 번에 생성</li>
</ul>
<pre class="language-bash optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-bash code-highlight"><span class="code-line">typeorm-model-generator <span class="token parameter variable">-h</span> localhost <span class="token parameter variable">-u</span> <span class="token variable">$userName</span> <span class="token parameter variable">-x</span> <span class="token variable">$password</span> <span class="token parameter variable">-e</span> mysql <span class="token parameter variable">-o</span> ./entities <span class="token parameter variable">--ssl</span>
</span></code></pre>
<h2 id="typeorm-작성-패턴에-대해-알아보겠습니다">typeorm 작성 패턴에 대해 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#typeorm-작성-패턴에-대해-알아보겠습니다"><span class="anchor"></span></a></h2>
<ul>
<li>Active Record 패턴과 Data Mapper 패턴이 있습니다.</li>
</ul>
<h2 id="active-record-패턴에-대해-먼저-알아보겠습니다">Active Record 패턴에 대해 먼저 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#active-record-패턴에-대해-먼저-알아보겠습니다"><span class="anchor"></span></a></h2>
<ul>
<li>Active Record 패턴은 <code class="inline-code">모델 그 자체에 쿼리 메소드를 정의</code>하고, <code class="inline-code">모델의 메소드를 사용</code>하여 객체를 저장, 제거, 불러오는 방식입니다.</li>
<li>BaseEntity라는 클래스를 사용하여 새로운 클래스에 상속하게 한 후 사용할 수 있습니다. 이를 통해 BaseEntity가 갖고 있는 메소드와 static으로 만들어 내는 커스텀 메소드를 이용할 수 있습니다.</li>
<li>규모가 작은 애플리케이션에서 적합하고 간단히 사용할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> BaseEntity<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">static</span> <span class="token function">findByName</span><span class="token punctuation">(</span>firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.firstName = :firstName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'user.lastName = :lastName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// example how to save AR entity</span>
</span><span class="code-line"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// example how to remove AR entity</span>
</span><span class="code-line"><span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// example how to load AR entities</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> skip<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> take<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> newUsers <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isActive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> timber <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> firstName<span class="token operator">:</span> <span class="token string">'Timber'</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">'Saw'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> timber <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span><span class="token string">'Timber'</span><span class="token punctuation">,</span> <span class="token string">'Saw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2 id="data-mapper-패턴에-대해서도-알아보겠습니다">Data Mapper 패턴에 대해서도 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#data-mapper-패턴에-대해서도-알아보겠습니다"><span class="anchor"></span></a></h2>
<ul>
<li>Data Mapper 패턴은 <code class="inline-code">분리된 클래스에 쿼리 메소드를 정의</code>하는 방식이며, <code class="inline-code">Repository를 이용</code>하여 객체를 저장, 제거, 불러옵니다.</li>
<li>Active Record 패턴과의 차이점은 모델에 접근하는 방식이 아닌 <code class="inline-code">Repository에서 데이터에 접근</code>한다는 것입니다.</li>
<li>규모가 큰 애플리케이션에 적합하고 유지보수하는데 효과적이다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn<span class="token punctuation">,</span> Column <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> EntityRepository<span class="token punctuation">,</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../entity/User'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">EntityRepository</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">Repository<span class="token operator">&#x3C;</span>User<span class="token operator">></span></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token function">findByName</span><span class="token punctuation">(</span>firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'user.firstName = :firstName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> firstName <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'user.lastName = :lastName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> lastName <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">const</span> userRepository <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// example how to save DM entity</span>
</span><span class="code-line"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">'Timber'</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">'Saw'</span><span class="token punctuation">;</span>
</span><span class="code-line">user<span class="token punctuation">.</span>isActive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// example how to remove DM entity</span>
</span><span class="code-line"><span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// example how to load DM entities</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> skip<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> take<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> newUsers <span class="token operator">=</span> <span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isActive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> timber <span class="token operator">=</span> <span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token string">'Timber'</span><span class="token punctuation">,</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token string">'Saw'</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2 id="entity들을-만들었다면-데이터베이스에-대한-연결-생성하는-법을-알아-보겠습니다">entity들을 만들었다면 데이터베이스에 대한 연결 생성하는 법을 알아 보겠습니다.<a aria-hidden="true" tabindex="-1" href="#entity들을-만들었다면-데이터베이스에-대한-연결-생성하는-법을-알아-보겠습니다"><span class="anchor"></span></a></h2>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token string">'reflect-metadata'</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createConnection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Photo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./entity/Photo'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
</span><span class="code-line">  host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
</span><span class="code-line">  port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
</span><span class="code-line">  username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
</span><span class="code-line">  password<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
</span><span class="code-line">  database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
</span><span class="code-line">  entities<span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line">    Photo<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token comment">// __dirname + '/entity/*.js'</span>
</span><span class="code-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line">  synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</span><span class="code-line">  logging<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// here you can start to work with your entities</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2 id="entity를-만드는-방법에-대해-조금-더-상세히-알아보겠습니다">Entity를 만드는 방법에 대해 조금 더 상세히 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#entity를-만드는-방법에-대해-조금-더-상세히-알아보겠습니다"><span class="anchor"></span></a></h2>
<h3 id="entity-데코레이터">Entity 데코레이터<a aria-hidden="true" tabindex="-1" href="#entity-데코레이터"><span class="anchor"></span></a></h3>
<ul>
<li>데이터베이스 테이블을 정의하기 전에 실행해야하는 데코레이터입니다.</li>
<li>테이블명을 따로 지정하지 않아도 클래스명으로 매핑하지만, 옵션으로 테이블명을 지정할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>name: <code class="inline-code">테이블 이름</code>입니다. 지정하지 않으면 테이블 이름은 엔티티 <code class="inline-code">클래스명</code>으로 생성됩니다.</li>
<li>database: 선택된 DB서버의 데이터베이스 이름입니다.</li>
<li>schema: 스키마 이름입니다.
<ul>
<li>MySQL에서는 schema와 database가 따로 분리되어있지 않습니다. OracleDB에서는 schema를 따로 분리해서 database에 할당된 사용자로 사용합니다.</li>
</ul>
</li>
<li>engine: 테이블 생성 중에 설정할 수 있는 DB엔진 이름입니다.</li>
<li>synchronize: false로 설정할 시 스키마 싱크를 건너뜁니다.</li>
<li>orderBy: QueryBuilder과 find를 실행할 때 엔티티의 기본순서를 지정합니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
</span><span class="code-line">  engine<span class="token operator">:</span> <span class="token string">'MyISAM'</span><span class="token punctuation">,</span>
</span><span class="code-line">  database<span class="token operator">:</span> <span class="token string">'example_dev'</span><span class="token punctuation">,</span>
</span><span class="code-line">  schema<span class="token operator">:</span> <span class="token string">'schema_with_best_tables'</span><span class="token punctuation">,</span>
</span><span class="code-line">  synchronize<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="code-line">  orderBy<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">    name<span class="token operator">:</span> <span class="token string">'ASC'</span><span class="token punctuation">,</span>
</span><span class="code-line">    id<span class="token operator">:</span> <span class="token string">'DESC'</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="중복되는-entity를-상속를-사용하여-해결할-수-있습니다">중복되는 Entity를 상속를 사용하여 해결할 수 있습니다.<a aria-hidden="true" tabindex="-1" href="#중복되는-entity를-상속를-사용하여-해결할-수-있습니다"><span class="anchor"></span></a></h3>
<ul>
<li>Concrete table inheritance와 Single table inheritance가 있습니다.</li>
</ul>
<h4 id="concrete-table-inheritance">Concrete table inheritance<a aria-hidden="true" tabindex="-1" href="#concrete-table-inheritance"><span class="anchor"></span></a></h4>
<ul>
<li>중복된 칼럼을 베이스가 되는 <code class="inline-code">추상 클래스</code>를 선언한 다음 확장할 수 있습니다.</li>
<li>참고로 active record 패턴을 사용할 예정이라면, <code class="inline-code">BaseEntity</code>라는 이름은 피하는게 좋습니다.
<ul>
<li>typeorm에서 제공하는 클래스인 BaseEntity는 기본 쿼리 메서드 hasId, save, remove 등의 메서드를 담은 클래스입니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// 추상 클래스</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// 1</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Photo</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  size<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// 2</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Question</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  answersCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// 3</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  viewCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="single-table-inheritance">Single table inheritance<a aria-hidden="true" tabindex="-1" href="#single-table-inheritance"><span class="anchor"></span></a></h4>
<ul>
<li>@TableInheritance(), @ChildEntity()를 사용하는 방법입니다.</li>
<li>이 방법은 데이터베이스에 Content 테이블이 생성됩니다. <code class="inline-code">Content 위에 @Entity()를 선언</code>해줘야 아래와 같은 패턴을 사용할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">TableInheritance</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> column<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'type'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ChildEntity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Photo</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  size<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ChildEntity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Question</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  answersCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ChildEntity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  viewCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="embedded-entities">Embedded entities<a aria-hidden="true" tabindex="-1" href="#embedded-entities"><span class="anchor"></span></a></h3>
<ul>
<li>이름이 비슷하고 타입이 같은 칼럼들을 묶는 패턴입니다.</li>
<li>User.name은 User.nameFirst, User.nameLast로 분기합니다. Name은 데코레이터 @Entity()가 붙어있지 않기때문에 위의 패턴처럼 <code class="inline-code">실제 테이블이 생겨나지는 않습니다</code>.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Name</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  first<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  last<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Name<span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> Name<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="viewentity">ViewEntity<a aria-hidden="true" tabindex="-1" href="#viewentity"><span class="anchor"></span></a></h3>
<h4 id="sql-view란-">SQL view란 ?<a aria-hidden="true" tabindex="-1" href="#sql-view란-"><span class="anchor"></span></a></h4>
<ul>
<li>view는 하나의 <code class="inline-code">가상 테이블</code>입니다.</li>
<li>실제 데이터가 저장되는 것은 아니지만, view를 통해 데이터를 가상 테이블로 관리가 가능합니다.</li>
<li>1개의 view로 여러 테이블의 데이터를 조회할 수 있습니다.</li>
<li>복잡한 쿼리를 통해 얻을 수 있는 결과를 간단한 쿼리로 얻을 수 있게 도와줍니다.</li>
<li>특정 기준에 따른 사용자 별로 다른 데이터를 액세스할 수 있도록 도와줄 수도 있습니다.</li>
<li>조회 대상을 줄이고 싶을 때 사용할 수 있습니다.</li>
</ul>
<h4 id="viewentity-데코레이터-인자">ViewEntity 데코레이터 인자<a aria-hidden="true" tabindex="-1" href="#viewentity-데코레이터-인자"><span class="anchor"></span></a></h4>
<ul>
<li>데코레이터에 들어가는 인자가 아래와 같이 @Entity()와는 약간 다릅니다.
<ul>
<li>name: 테이블 이름입니다. 지정하지 않으면 테이블 이름은 엔티티 클래스명으로 생성됩니다.</li>
<li>database: 선택된 DB서버의 데이터베이스 이름입니다.</li>
<li>schema: 스키머 이름입니다.</li>
<li>expression: view를 정의합니다. 꼭 있어야하는 파라미터로 SQL쿼리문이나 queryBuilder 체이닝 메서드가 들어갈 수 있습니다.</li>
</ul>
</li>
<li>expression은 SQL 쿼리문이나 QueryBuilder에 체이닝할 수 있는 메서드가 들어갈 수 있습니다. 특이점으로는 필드명 위에 들어가는 데코레이터를 id까지 전부 @ViewColumn()을 사용해야 한다는 점이 있습니다. 만약 사용을 고려한다면, JOIN을 쳐서 테이블끼리 연결을 시키냐, 아니면 view를 통해 나중에 자주 사용할 가상 테이블을 미리 만들어두냐의 차이로 생각할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ViewEntity</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  expression<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">        SELECT "post"."id" AS "id", "post"."name" AS "name", "category"."name" AS "categoryName"
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">        FROM "post" "post"
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">        LEFT JOIN "category" "category" ON "post"."categoryId" = "category"."id"
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostCategory</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ViewColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ViewColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ViewColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  categoryName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>구조가 복잡하고, 여러군데서 호출하는 데이터의 경우 미리 ViewEntity로 view 테이블을 만들어두면 유용합니다.</li>
</ul>
<h3 id="column">Column<a aria-hidden="true" tabindex="-1" href="#column"><span class="anchor"></span></a></h3>
<ul>
<li>entity의 속성을 테이블 칼럼으로 표시합니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> tpye<span class="token operator">:</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> length<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  isActive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>
<p>@Column()에 들어갈 수 있는 옵션들 중 중요하다고 판단한 것들은 아래와 같습니다.</p>
<ul>
<li>type(ColumnType) : <code class="inline-code">javascript의 원시타입</code>들을 세분화해서 사용할 수 있습니다. 타입을 정의하는 방법은 다음과 같습니다.</li>
<li>length(string | number) : javascript의 원시타입들을 세분화해서 사용하기 위해 type 옵션과 같이 사용할 수 있습니다.</li>
<li>onUpdate(string) : cascading을 하기 위한 옵션으로 ON UPDATE 트리거입니다.</li>
<li>nullable(boolean) : 칼럼을 NULL이나 NOT NULL로 만드는 옵션입니다. 기본값은 false입니다.</li>
<li>default(string) : 칼럼에 DEFAULT 값을 설정합니다.</li>
<li>unique(boolean) : 유니크 칼럼이라고 표시할 수 있습니다. 유니크 constraint를 만듭니다. 기본값은 false 입니다.</li>
<li>enum(string[] | AnyEnum) : 칼럼의 값으로 enum을 사용할 수 있습니다. enum은 db단에서 처리할 수도, orm단에서 처리할 수도 있습니다.</li>
<li>enumName(string) : 다른 테이블에서 같은 enum을 사용하는 경우 필요합니다.</li>
<li>transformer({ from(value: DatabaseType): EntityType, to(value: EntityType): DatabaseType }) : 아래와 같은 코드를 만들어내서 json을 문자열로 만들고 파싱하는 역할을 합니다. 또는 boolean을 integer로 바꿔주는 일도 할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ValueTransformer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">class</span> <span class="token class-name">SomeTransformer</span> <span class="token keyword">implements</span> <span class="token class-name">ValueTransformer</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token function">to</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Map<span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token function">from</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
</li>
</ul>
<h3 id="idcolumn">IdColumn<a aria-hidden="true" tabindex="-1" href="#idcolumn"><span class="anchor"></span></a></h3>
<ul>
<li>PrimaryColumn과 PrimaryGeneratedColum이 있습니다.</li>
</ul>
<h4 id="primarycolumn">PrimaryColumn<a aria-hidden="true" tabindex="-1" href="#primarycolumn"><span class="anchor"></span></a></h4>
<ul>
<li>@Column()의 옵션인 primary를 대체할 수 있습니다. <code class="inline-code">PK</code>를 만드는 역할을 합니다.</li>
</ul>
<h4 id="primarygeneratedcolumn">PrimaryGeneratedColumn<a aria-hidden="true" tabindex="-1" href="#primarygeneratedcolumn"><span class="anchor"></span></a></h4>
<ul>
<li><code class="inline-code">자동생성</code>되는 ID값을 표현하는 방식을 아래와 같이 2가지 옵션을 사용할 수 있도록 도와줍니다.
<ul>
<li>increment: AUTO_INCREMENT를 사용해서 1씩 증가하는 ID를 부여합니다. 기본 옵션입니다.</li>
<li>uuid: 유니크한 uuid를 사용할 수 있습니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// using increment</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using uuid</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h5 id="generated">Generated<a aria-hidden="true" tabindex="-1" href="#generated"><span class="anchor"></span></a></h5>
<ul>
<li>PK로 쓰는 ID 외에 추가로 uuid를 기록하기 위해서 사용할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Generated</span></span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
</span><span class="code-line">  uuid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="datecolumn">DateColumn<a aria-hidden="true" tabindex="-1" href="#datecolumn"><span class="anchor"></span></a></h3>
<ul>
<li>CreateDateColumn과 UpdateDateColumn, DeleteDateColumn이 있습니다.</li>
</ul>
<h4 id="createdatecolumn">CreateDateColumn<a aria-hidden="true" tabindex="-1" href="#createdatecolumn"><span class="anchor"></span></a></h4>
<ul>
<li>해당 열이 추가된 시각을 자동으로 기록합니다.</li>
<li>옵션을 적지 않을시 datetime 타입으로 기록됩니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CreateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  createdAt<span class="token operator">:</span> Date<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="updatedatecolumn">UpdateDateColumn<a aria-hidden="true" tabindex="-1" href="#updatedatecolumn"><span class="anchor"></span></a></h4>
<ul>
<li>해당 열이 수정된 시각을 자동으로 기록합니다.</li>
<li>옵션을 적지 않을시 datetime 타입으로 기록됩니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UpdateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  updatedAt<span class="token operator">:</span> Date<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="deletedatecolumn">DeleteDateColumn<a aria-hidden="true" tabindex="-1" href="#deletedatecolumn"><span class="anchor"></span></a></h4>
<ul>
<li>해당 열이 삭제된 시각을 자동으로 기록합니다.</li>
<li>옵션을 적지 않을시 datetime 타입으로 기록됩니다.</li>
<li>deletedAt에 시각이 기록되지 않은 열들만 쿼리하기 위해 TypeORM의 soft delete 기능을 활용할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">DeleteDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  deletedAt<span class="token operator">:</span> Date<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h5 id="soft-delete이란-">soft delete이란 ?<a aria-hidden="true" tabindex="-1" href="#soft-delete이란-"><span class="anchor"></span></a></h5>
<ul>
<li>데이터 열을 실제로 삭제하지 않고, 삭제여부를 나타내는 칼럼인 deletedAt을 사용하는 방식입니다.</li>
<li>일반적인 삭제 대신 삭제된 열을 갱신하는 UPDATE문을 사용하는 방식입니다.</li>
<li>시각이 기록되지 않은 열들만 필터해서 쿼리하도록 도와주는 역할을 합니다.</li>
<li>다른 테이블과 JOIN시 항상 삭제된 열을 검사해서 성능이 떨어집니다.</li>
<li>복구하거나 예전 기록을 확인하고자 할 때 간편합니다.</li>
</ul>
<h3 id="relation-이제-하나의-테이블이-아닌-테이블간의-관계에-대해-알아보겠습니다">Relation. 이제 하나의 테이블이 아닌 테이블간의 관계에 대해 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#relation-이제-하나의-테이블이-아닌-테이블간의-관계에-대해-알아보겠습니다"><span class="anchor"></span></a></h3>
<ul>
<li>테이블간의 관계는 1:1, 1:N, M:N 관계가 있습니다.</li>
</ul>
<h4 id="onetoone">OneToOne<a aria-hidden="true" tabindex="-1" href="#onetoone"><span class="anchor"></span></a></h4>
<ul>
<li>@JoinColumn()을 사용한 필드는 FK(외래키)로 타겟 테이블에 등록됩니다. <code class="inline-code">@JoinColumn()은 반드시 한쪽 테이블에서만 사용해야 합니다</code>.</li>
<li>관계는 단방향과 양방향 모두 작성이 가능합니다.
<ul>
<li>uni-directional은 @OneToOne()을 한쪽에만 써주는 것</li>
<li>bi-directional은 양쪽에 모두 써주는 것</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Profile</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  gender<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  photo<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">OneToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> User<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>profile<span class="token punctuation">)</span>
</span><span class="code-line">  user<span class="token operator">:</span> User<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">OneToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Profile<span class="token punctuation">,</span> <span class="token punctuation">(</span>profile<span class="token punctuation">)</span> <span class="token operator">=></span> profile<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">JoinColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  profile<span class="token operator">:</span> Profile<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using find* method</span>
</span><span class="code-line"><span class="token keyword">const</span> userRepo <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> userRepo<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> relations<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'profile'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using query builder</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> connection
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'user.profile'</span><span class="token punctuation">,</span> <span class="token string">'profile'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h4 id="manytooneonetomany">ManyToOne/OneToMany<a aria-hidden="true" tabindex="-1" href="#manytooneonetomany"><span class="anchor"></span></a></h4>
<ul>
<li>@OneToMany()/@ManyToOne()에서는 <code class="inline-code">@JoinColumn()을 생략</code>할 수 있습니다.</li>
<li><code class="inline-code">@OneToMany()는 @ManyToOne()이 없으면 안됩니다</code>.
<ul>
<li>하지만 반대로 @ManyToOne()은 @OneToMany()이 없어도 정의할 수 있습니다.</li>
</ul>
</li>
<li>@ManyToOne()을 설정한 테이블에는 <code class="inline-code">relation id가 외래키</code>를 가지고 있게 됩니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">OneToMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Photo<span class="token punctuation">,</span> <span class="token punctuation">(</span>photo<span class="token punctuation">)</span> <span class="token operator">=></span> photo<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
</span><span class="code-line">  photos<span class="token operator">:</span> Photo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Photo</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> User<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>photos<span class="token punctuation">)</span>
</span><span class="code-line">  user<span class="token operator">:</span> User<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using find* method</span>
</span><span class="code-line"><span class="token keyword">const</span> userRepository <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> userRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> relations<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'photos'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token comment">// or from inverse side</span>
</span><span class="code-line"><span class="token keyword">const</span> photoRepository <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Photo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> photos <span class="token operator">=</span> <span class="token keyword">await</span> photoRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> relations<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using query builder</span>
</span><span class="code-line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> connection
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'user.photos'</span><span class="token punctuation">,</span> <span class="token string">'photo'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token comment">// or from inverse side</span>
</span><span class="code-line"><span class="token keyword">const</span> photos <span class="token operator">=</span> <span class="token keyword">await</span> connection
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Photo<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'photo'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'photo.user'</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h4 id="manytomany">ManyToMany<a aria-hidden="true" tabindex="-1" href="#manytomany"><span class="anchor"></span></a></h4>
<ul>
<li>@ManyToMany() 관계에서는 <code class="inline-code">@JoinTable()이 반드시 필요합니다</code>. 한쪽 테이블에만 @JoinTable()을 넣어주면 됩니다.</li>
<li>단, @ManyToMany()에서 옵션 cascade가 true인 경우 soft delete를 할 수 있습니다. 필요에 따라 사용할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Question</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">JoinTable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  categories<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using find* method</span>
</span><span class="code-line"><span class="token keyword">const</span> questionRepository <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Question<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> questions <span class="token operator">=</span> <span class="token keyword">await</span> questionRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> relations<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using query builder</span>
</span><span class="code-line"><span class="token keyword">const</span> questions <span class="token operator">=</span> <span class="token keyword">await</span> connection
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Question<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'question'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'question.categories'</span><span class="token punctuation">,</span> <span class="token string">'category'</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h3 id="tree-entity">Tree entity<a aria-hidden="true" tabindex="-1" href="#tree-entity"><span class="anchor"></span></a></h3>
<ul>
<li>TypeORM은 트리 구조를 저장하기 위해 인접 목록 및 클로저 테이블 패턴을 지원합니다.</li>
</ul>
<h4 id="먼저-셀프조인에-예시에-대해-알아보겠습니다">먼저 셀프조인에 예시에 대해 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#먼저-셀프조인에-예시에-대해-알아보겠습니다"><span class="anchor"></span></a></h4>
<ul>
<li>1개의 테이블에서 부모-자식 관계를 나타낼 수 있는 패턴</li>
<li>상품 카테고리(소,중,대분류)</li>
<li>사원(사원,관리자,상위관리자)</li>
<li>지역(읍/면/동,구/군,시/도)</li>
</ul>
<h4 id="typeorm은-셀프조인을-아래와-같은-4가지-패턴으로-지원합니다">TypeORM은 셀프조인을 아래와 같은 4가지 패턴으로 지원합니다.<a aria-hidden="true" tabindex="-1" href="#typeorm은-셀프조인을-아래와-같은-4가지-패턴으로-지원합니다"><span class="anchor"></span></a></h4>
<h4 id="adjacency-list">Adjacency list<a aria-hidden="true" tabindex="-1" href="#adjacency-list"><span class="anchor"></span></a></h4>
<ul>
<li>자기참조를 @ManyToOne(), @OneToMany() 데코레이터로 표현할 수 있습니다.</li>
<li>이 방식은 간단한 것이 가장 큰 장점이지만, JOIN하는데 제약이 있어 큰 트리를 로드하는데 문제가 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">,</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token operator">=></span> category<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
</span><span class="code-line">  parent<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">OneToMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">,</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token operator">=></span> category<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
</span><span class="code-line">  children<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="nested-set">Nested set<a aria-hidden="true" tabindex="-1" href="#nested-set"><span class="anchor"></span></a></h4>
<ul>
<li>@Tree(), @TreeChildren(), @TreeParent()를 사용한 또 다른 패턴입니다.</li>
<li>읽기 작업에는 효과적이지만 쓰기 작업에는 효과적이지 않습니다.</li>
<li>여러 개의 루트를 가질 수 없다는 점도 문제입니다.</li>
<li>@Tree()의 인자로 <code class="inline-code">nested-set</code>이 들어갑니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Tree</span></span><span class="token punctuation">(</span><span class="token string">'nested-set'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeChildren</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  children<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeParent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  parent<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="materialized-path">Materialized path<a aria-hidden="true" tabindex="-1" href="#materialized-path"><span class="anchor"></span></a></h4>
<ul>
<li>구체화된 경로 혹은 경로 열거라고 부릅니다.</li>
<li>간단하고 효율적입니다.</li>
<li>nested set과 사용방법은 같습니다.</li>
<li>@Tree()의 인자로 <code class="inline-code">materialized-path</code>이 들어갑니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span>
</span><span class="code-line">  Entity<span class="token punctuation">,</span>
</span><span class="code-line">  Tree<span class="token punctuation">,</span>
</span><span class="code-line">  Column<span class="token punctuation">,</span>
</span><span class="code-line">  PrimaryGeneratedColumn<span class="token punctuation">,</span>
</span><span class="code-line">  TreeChildren<span class="token punctuation">,</span>
</span><span class="code-line">  TreeParent<span class="token punctuation">,</span>
</span><span class="code-line">  TreeLevelColumn<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Tree</span></span><span class="token punctuation">(</span><span class="token string">'materialized-path'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeChildren</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  children<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeParent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  parent<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="closure-table">Closure table<a aria-hidden="true" tabindex="-1" href="#closure-table"><span class="anchor"></span></a></h3>
<ul>
<li>부모와 자식 사이의 관계를 분리된 테이블에 특별한 방법으로 저장합니다.</li>
<li>읽기와 쓰기 모두 효율적으로 할 수 있습니다.</li>
<li>nested set과 사용방법은 같습니다.</li>
<li>@Tree()의 인자로 closure-table이 들어갑니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span>
</span><span class="code-line">  Entity<span class="token punctuation">,</span>
</span><span class="code-line">  Tree<span class="token punctuation">,</span>
</span><span class="code-line">  Column<span class="token punctuation">,</span>
</span><span class="code-line">  PrimaryGeneratedColumn<span class="token punctuation">,</span>
</span><span class="code-line">  TreeChildren<span class="token punctuation">,</span>
</span><span class="code-line">  TreeParent<span class="token punctuation">,</span>
</span><span class="code-line">  TreeLevelColumn<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Tree</span></span><span class="token punctuation">(</span><span class="token string">'closure-table'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeChildren</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  children<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">TreeParent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  parent<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<ul>
<li>선택적 매개 변수 옵션을 @Tree ( "closure-table", options)로 설정하여 클로저 테이블 이름 또는 클로저 테이블 열 이름을 지정할 수 있습니다.</li>
<li>ancestorColumnName 및 descandantColumnName은 기본 열의 메타 데이터를 수신하고 열의 이름을 반환하는 콜백 함수입니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Tree</span></span><span class="token punctuation">(</span><span class="token string">"closure-table"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">    closureTableName<span class="token operator">:</span> <span class="token string">"category_closure"</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token function-variable function">ancestorColumnName</span><span class="token operator">:</span> <span class="token punctuation">(</span>column<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"ancestor_"</span> <span class="token operator">+</span> column<span class="token punctuation">.</span>propertyName<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token function-variable function">descendantColumnName</span><span class="token operator">:</span> <span class="token punctuation">(</span>column<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"descendant_"</span> <span class="token operator">+</span> column<span class="token punctuation">.</span>propertyName<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<h3 id="joincolumnjointable에-대해-조금-더-알아보겠습니다">JoinColumn/JoinTable에 대해 조금 더 알아보겠습니다.<a aria-hidden="true" tabindex="-1" href="#joincolumnjointable에-대해-조금-더-알아보겠습니다"><span class="anchor"></span></a></h3>
<ul>
<li>아래는 아래 2개의 데코레이터에 공통으로 사용할 수 있는 옵션입니다.
<ul>
<li>eager 옵션이 있어서 N+1 문제를 제어할 수 있음</li>
<li>cascade, onDelete 옵션이 있어 관계가 연결된 객체를 추가/수정/삭제되도록 할 수 있습니다. 버그를 유발할 수 있으니 주의해서 사용해야 합니다.</li>
</ul>
</li>
</ul>
<h4 id="n1-문제란">N+1 문제란?<a aria-hidden="true" tabindex="-1" href="#n1-문제란"><span class="anchor"></span></a></h4>
<ul>
<li>하위 엔티티들을 첫 쿼리 실행시 한번에 가져오지 않고, Lazy Loading으로 필요한 곳에서 사용되어 쿼리가 실행될때 발생하는 문제가 N+1 쿼리 문제입니다.</li>
</ul>
<h4 id="joincolumn">JoinColumn<a aria-hidden="true" tabindex="-1" href="#joincolumn"><span class="anchor"></span></a></h4>
<ul>
<li>@JoinColumn()을 사용하면 테이블에 자동으로 칼럼명과 참조 칼럼명을 합친 이름의 칼럼을 만들어냅니다.</li>
<li>외래키를 가진 칼럼명과 참조칼럼명을 설정할 수 있는 옵션을 가지고 있습니다.</li>
<li>설정하지 않으면 테이블명을 가지고 자동으로 매핑합니다.</li>
<li>주의할 점으로는 @ManyToOne()에서는 꼭 적지 않아도 칼럼을 자동으로 만들어주지만, <code class="inline-code">@OneToOne()에서는 반드시 적어줘야 합니다</code>.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">JoinColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">    name<span class="token operator">:</span> <span class="token string">'category_id'</span><span class="token punctuation">,</span>
</span><span class="code-line">    referencedColumnName<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  category<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="jointable">JoinTable<a aria-hidden="true" tabindex="-1" href="#jointable"><span class="anchor"></span></a></h3>
<ul>
<li><code class="inline-code">M:N 관계</code>에서 사용하며 연결 테이블을 설정할 수 있습니다.</li>
<li>@JoinTable()의 옵션을 사용해 연결 테이블의 칼럼명과 참조 칼럼명을 설정할 수 있습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Question</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">JoinTable</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">    name<span class="token operator">:</span> <span class="token string">'question_categories'</span><span class="token punctuation">,</span>
</span><span class="code-line">    joinColumn<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      name<span class="token operator">:</span> <span class="token string">'question'</span><span class="token punctuation">,</span>
</span><span class="code-line">      referencedColumnName<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">    inverseJoinColumn<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line">      name<span class="token operator">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>
</span><span class="code-line">      referencedColumnName<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  categories<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="relationid">RelationId<a aria-hidden="true" tabindex="-1" href="#relationid"><span class="anchor"></span></a></h3>
<ul>
<li>1:N/M:N 관계에서 entity에 명시적으로 관계가 있는 테이블의 칼럼 id를 적고싶은 경우, @RelationId()를 사용하면 됩니다.</li>
<li>@RelationId()가 꼭 필요하지는 않지만 entity를 보면서 칼럼을 한 눈에 볼 수 있다는 장점이 있습니다.</li>
<li>@RelationId()로 테이블을 조회하면 새로운 칼럼명도 결과에 같이 들고올 수 있습니다.</li>
<li>하지만 relationId 칼럼에 삽입하여 사용할 수 없습니다.
<ul>
<li>inset or update 시 payload에 relationId가 아닌 relation으로 사용해야 합니다.</li>
<li>관련 이슈 : <a href="https://github.com/typeorm/typeorm/issues/3867">https://github.com/typeorm/typeorm/issues/3867</a></li>
<li>@RelationId를 사용하는 대신 @Column으로 relationId를 장식 할 수 있습니다. JoinColumn의 이름이 숫자열 이름과 같을 때 TypeORM이 둘 다 일치하고 userId를 설정하거나 사용자를 설정하면 TypeORM이 처리합니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// using many to one</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">)</span>
</span><span class="code-line">  category<span class="token operator">:</span> Category<span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">RelationId</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token operator">:</span> Post<span class="token punctuation">)</span> <span class="token operator">=></span> post<span class="token punctuation">.</span>category<span class="token punctuation">)</span>
</span><span class="code-line">  categoryId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using many to many</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToMany</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> Category<span class="token punctuation">)</span>
</span><span class="code-line">  categories<span class="token operator">:</span> Category<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">RelationId</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token operator">:</span> Post<span class="token punctuation">)</span> <span class="token operator">=></span> post<span class="token punctuation">.</span>categories<span class="token punctuation">)</span>
</span><span class="code-line">  categoryIds<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="subscriber">Subscriber<a aria-hidden="true" tabindex="-1" href="#subscriber"><span class="anchor"></span></a></h3>
<ul>
<li>데이터베이스에 특화된 리스너로 CRUD 이벤트 발생을 리슨합니다.</li>
<li>다음과 같은 데코레이터들을 가지고 있습니다.
<ul>
<li>@AfterLoad, @AfterInsert, @BeforeInsert, @AfterUpdate, @BeforeUpdate, @AfterRemove, @BeforeRemove</li>
</ul>
</li>
<li>logging 옵션이 있긴 하지만 쿼리만을 보여주기 때문에 한 줄씩 분석하기 위해 로그를 남기는 경우에는 지양하는 것이 좋습니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span>
</span><span class="code-line">  Connection<span class="token punctuation">,</span>
</span><span class="code-line">  EntitySubscriberInterface<span class="token punctuation">,</span>
</span><span class="code-line">  EventSubscriber<span class="token punctuation">,</span>
</span><span class="code-line">  InsertEvent<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'typeorm/index'</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./User'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">EventSubscriber</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserSubscriber</span> <span class="token keyword">implements</span> <span class="token class-name">EntitySubscriberInterface<span class="token operator">&#x3C;</span>User<span class="token operator">></span></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token function">constructor</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> Connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    connection<span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token function">listenTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> User<span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token function">beforeInsert</span><span class="token punctuation">(</span>event<span class="token operator">:</span> InsertEvent<span class="token operator">&#x3C;</span>User<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User 테이블에 입력 전 : '</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token function">afterInsert</span><span class="token punctuation">(</span>event<span class="token operator">:</span> InsertEvent<span class="token operator">&#x3C;</span>User<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User 테이블에 입력 후 : '</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="index">Index<a aria-hidden="true" tabindex="-1" href="#index"><span class="anchor"></span></a></h3>
<ul>
<li>테이블 <code class="inline-code">쿼리 속도</code>를 올려주는 자료구조입니다.</li>
<li>테이블 내 1개 혹은 그 이상의 칼럼을 이용해 생성할 수 있습니다.</li>
<li>인덱스는 보통 키-필드만 갖고있고, 테이블의 다른 세부항목을 갖지 않기때문에 보통 테이블을 저장하는 공간보다 더 <code class="inline-code">적은 공간</code>을 차지합니다.</li>
<li>특정 칼럼 값을 가지고 있는 열이나 값을 <code class="inline-code">빠르게 찾기</code> 위해 사용합니다.
<ul>
<li>인덱싱하지 않은 경우는 첫번째 열부터 전체 테이블을 걸쳐 연관된 열을 검색하기때문에 테이블이 클수록 쿼리비용이 커집니다.</li>
<li>인덱싱을 한 경우는 모든 데이터를 조회하지 않고 데이터 파일의 중간에서 검색위치를 빠르게 잡을 수 있습니다.</li>
</ul>
</li>
<li><code class="inline-code">WHERE</code>절과 일치하는 열을 빨리 찾기 위해서 사용합니다.</li>
<li><code class="inline-code">JOIN</code>을 실행할 때 다른 테이블에서 열을 추출하기 위해서 사용합니다.</li>
<li>데이터 양이 많고 변경보다 <code class="inline-code">검색이 빈번한 경우</code> 인덱싱을 하면 좋습니다.</li>
</ul>
<blockquote>
<p>쉽게 말해 책에서 transaction이란 주제가 어딨는지 목차 없이 찾으려면 눈물날지도 모릅니다. 책의 주요내용을 가나다순으로 정리한 목록이 있으면 찾기 쉬울텐데 인덱스가 바로 그 역할을 합니다.
특정 칼럼에 인덱스를 걸 수 있습니다. 옵션으로 고유키를 부여할 수도 있습니다. 단일 칼럼에 인덱스를 걸고 싶으면 칼럼마다 추가할 수도 있지만, 테이블 전체에 인덱스를 걸고싶은 경우 @Entity()아래 @Index()를 추가할 수도 있습니다.</p>
</blockquote>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// using with single column</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Index</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Index</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using with entity</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Index</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="unique">Unique<a aria-hidden="true" tabindex="-1" href="#unique"><span class="anchor"></span></a></h3>
<ul>
<li>특정 칼럼에 고유키 제약조건을 생성할 수 있습니다.</li>
<li>@Unique()는 테이블 자체에만 적용하는 것이 가능합니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Unique</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  lastName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="check">Check<a aria-hidden="true" tabindex="-1" href="#check"><span class="anchor"></span></a></h3>
<ul>
<li>테이블에서 데이터 추가 쿼리가 날아오면 값을 체크하는 역할을 합니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Check</span></span><span class="token punctuation">(</span><span class="token string">'"age" > 18'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  firstName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="transaction">Transaction<a aria-hidden="true" tabindex="-1" href="#transaction"><span class="anchor"></span></a></h3>
<ul>
<li>데이터베이스 내에서 하나의 <code class="inline-code">그룹으로 처리해야하는 명령문</code>을 모아서 처리하는 작업의 단위를 말합니다.
<ul>
<li>여러 단계의 처리를 <code class="inline-code">하나의 처리처럼</code> 다루는 기능입니다.</li>
<li>여러 개의 명령어의 집합이 정상적으로 처리되면 정상종료됩니다.</li>
<li>하나의 명령어라도 <code class="inline-code">잘못되면 전체 취소</code>됩니다.</li>
</ul>
</li>
<li>트랜잭션을 쓰는 이유는 <code class="inline-code">데이터의 일관성</code>을 유지하면서 <code class="inline-code">안정적으로 데이터를 복구</code>하기 위함입니다.</li>
<li>격리성 수준 설정을 통해 트랜잭션이 열려있는 동안 외부에서 해당 데이터에 접근하지 못하도록 락을 걸 수 있습니다.</li>
</ul>
<h4 id="격리성-수준">격리성 수준<a aria-hidden="true" tabindex="-1" href="#격리성-수준"><span class="anchor"></span></a></h4>
<ul>
<li>READ UNCOMMITTED</li>
<li>READ COMMITTED</li>
<li>REPEATABLE READ</li>
<li>SERIALIZABLE</li>
</ul>
<h4 id="global-connection을-열어서-트랜젝션을-사용하는-경우는-아래와-같이-사용합니다">global connection을 열어서 트랜젝션을 사용하는 경우는 아래와 같이 사용합니다.<a aria-hidden="true" tabindex="-1" href="#global-connection을-열어서-트랜젝션을-사용하는-경우는-아래와-같이-사용합니다"><span class="anchor"></span></a></h4>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">await</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>
</span><span class="code-line">  <span class="token string">'SERIALIZABLE'</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">(</span>transactionalEntityManager<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h4 id="하지만-global-connection은-사이드이펙트가-많은-방법이기때문에-데코레이터나-queryrunner를-사용한-방법을-추천합니다">하지만 global connection은 사이드이펙트가 많은 방법이기때문에 데코레이터나 queryRunner를 사용한 방법을 추천합니다.<a aria-hidden="true" tabindex="-1" href="#하지만-global-connection은-사이드이펙트가-많은-방법이기때문에-데코레이터나-queryrunner를-사용한-방법을-추천합니다"><span class="anchor"></span></a></h4>
<ul>
<li>아래는 데코레이터 @Transaction(), @TransactionManager(), @TransactionRepository()를 사용한 패턴입니다.</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token comment">// using transaction manager</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Transaction</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> isolation<span class="token operator">:</span> <span class="token string">'SERIALIZABLE'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token function">save</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">TransactionManager</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> manager<span class="token operator">:</span> EntityManager<span class="token punctuation">,</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// using transaction repository</span>
</span><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Transaction</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> isolation<span class="token operator">:</span> <span class="token string">'SERIALIZABLE'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">TransactionRepository</span></span><span class="token punctuation">(</span>User<span class="token punctuation">)</span> userRepository<span class="token operator">:</span> Repository<span class="token operator">&#x3C;</span>User<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h4 id="아래는-queryrunner를-사용한-방법입니다-다만-이-방법에서는-격리성-수준-설정이-불가능합니다">아래는 queryRunner를 사용한 방법입니다. 다만 이 방법에서는 격리성 수준 설정이 불가능합니다.<a aria-hidden="true" tabindex="-1" href="#아래는-queryrunner를-사용한-방법입니다-다만-이-방법에서는-격리성-수준-설정이-불가능합니다"><span class="anchor"></span></a></h4>
<ul>
<li>startTransaction은 트랜잭션을 시작하는 메서드</li>
<li>commitTransaction는 모든 변경사항을 커밋하는 메서드</li>
<li>rollbackTransaction는 모든 변경사항을 되돌리는 메서드</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">  <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>photos<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">rollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">await</span> queryRunner<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<h3 id="eager-and-lazy-relations">Eager and Lazy Relations<a aria-hidden="true" tabindex="-1" href="#eager-and-lazy-relations"><span class="anchor"></span></a></h3>
<h4 id="eager">eager<a aria-hidden="true" tabindex="-1" href="#eager"><span class="anchor"></span></a></h4>
<ul>
<li>relationship을 설정하지 않아도 eager를 설정하면 자동으로 relationship을 불러옵니다.
<ul>
<li>find* (즉, find, findAll, findOne...)에서 자동으로 relationship을 불러옵니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToMany</span></span><span class="token punctuation">(</span>type <span class="token operator">=></span> Category<span class="token punctuation">,</span> category <span class="token operator">=></span> category<span class="token punctuation">.</span>questions<span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line">  eager<span class="token operator">:</span> <span class="token boolean">true</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<h4 id="lazy">lazy<a aria-hidden="true" tabindex="-1" href="#lazy"><span class="anchor"></span></a></h4>
<ul>
<li>Promise로 반환하면, 자동으로 lazy relationship이 됩니다.
<ul>
<li>lazy를 불러올 때는 Promise.resolve를 하던가, await로 불러오면 됩니다.</li>
</ul>
</li>
</ul>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToMany</span></span><span class="token punctuation">(</span>type <span class="token operator">=></span> Question<span class="token punctuation">,</span> question <span class="token operator">=></span> question<span class="token punctuation">.</span>categories<span class="token punctuation">)</span>
</span><span class="code-line">questions<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&#x3C;</span>Question<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">;</span>
</span></code></pre>
<pre class="language-ts optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-ts code-highlight"><span class="code-line"><span class="token keyword">const</span> question <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getRepository</span><span class="token punctuation">(</span>Question<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> categories <span class="token operator">=</span> <span class="token keyword">await</span> question<span class="token punctuation">.</span>categories<span class="token punctuation">;</span>
</span></code></pre>
<ul>
<li>참고 : 다른 언어 (자바, PHP 등)에서 왔고 모든 곳에서 게으른 관계를 사용하는 데 익숙하다면 조심하세요. 이러한 언어는 비동기식이 아니며 지연로드는 다른 방식으로 이루어집니다. 그렇기 때문에 거기에서 promise를 사용하지 않습니다. 자바 스크립트와 Node.JS에서 지연로드 된 관계를 원하면 promise를 사용해야합니다. 이것은 비표준 기술이며 TypeORM에서 실험적인 것으로 간주됩니다.</li>
</ul>
<h2 id="typeorm의-bigint">typeorm의 bigint<a aria-hidden="true" tabindex="-1" href="#typeorm의-bigint"><span class="anchor"></span></a></h2>
<ul>
<li>typeorm bigint는 number로 바꿔주지 않습니다. string입니다.
<ul>
<li><a href="https://typeorm.io/entities#column-types">Note about bigint type: bigint column type, used in SQL databases, doesn’t fit into the regular number type and maps property to a string instead.</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="참고">참고<a aria-hidden="true" tabindex="-1" href="#참고"><span class="anchor"></span></a></h2>
<ul>
<li><a href="https://velog.io/@josworks27/typeORM-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0">TypeORM 시작하기</a></li>
<li><a href="https://yangeok.github.io/orm/2020/12/14/typeorm-decorators.html">TypeORM 데코레이터 씹어먹기</a></li>
<li><a href="https://gkqlgkql.tistory.com/85">개발자 마르코</a></li>
</ul>2:["$","$L9",null,{"post":{"slug":"/backend/typeorm-톺아보기","frontmatter":{"title":"typeorm 톺아보기","date":"2021-03-09T09:03:06.000Z","category":"backend","tags":["node","sql","db","rdb","typeorm","orm"],"draft":false},"content":"$a","html":"$b","excerpt":"- Node와 RDB의 ORM 서비스는 sequelize, typeorm, prisma 등 많은 라이브러리들이 있습니다. - 가장 먼저 사용한 ORM 서비스는 sequelize 였지만 typeorm이 typescript 지원이나 시장의 흐름에 따라 조금 더 많이 사용된다고 생각되어 공부하게 되었습니다.    - prisma도 고려해 보았으나 아직은 시기상"},"previousPost":{"slug":"/design-pattern/builder-pattern","frontmatter":{"title":"builder pattern","date":"2021-03-07T12:03:46.000Z","category":"design pattern","tags":["design pattern"],"draft":false}},"nextPost":{"slug":"/design-pattern/visitor-pattern","frontmatter":{"title":"visitor pattern","date":"2021-03-13T11:03:33.000Z","category":"design pattern","tags":[],"draft":false}}}]
8:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"typeorm 톺아보기"}],["$","meta","3",{"name":"description","content":"- Node와 RDB의 ORM 서비스는 sequelize, typeorm, prisma 등 많은 라이브러리들이 있습니다. - 가장 먼저 사용한 ORM 서비스는 sequelize 였지만 typeorm이 typescript 지원이나 시장의 흐름에 따라 조금 더 많이 사용된다고 생각되어 공부하게 되었습니다.    - prisma도 고려해 보았으나 아직은 시기상"}]]
1:null
