<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"/><link rel="preload" as="image" href="/images/profile.png"/><link rel="stylesheet" href="/_next/static/css/bc8bb31cb71603b2.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-57fdca2934e5ae0a.js"/><script src="/_next/static/chunks/6217bb07-738e49d824771fea.js" async=""></script><script src="/_next/static/chunks/5647-b33901b11da845dc.js" async=""></script><script src="/_next/static/chunks/main-app-ec1611f00934714e.js" async=""></script><script src="/_next/static/chunks/app/layout-3ad8bb7cb2292578.js" async=""></script><script src="/_next/static/chunks/9243-972bdccd4ceb11ae.js" async=""></script><script src="/_next/static/chunks/5800-4312aed1aa8a4305.js" async=""></script><script src="/_next/static/chunks/549-2babc012700e23ed.js" async=""></script><script src="/_next/static/chunks/4853-73ca7990eb89674b.js" async=""></script><script src="/_next/static/chunks/app/blog/%5B...slug%5D/page-9b274a2e0073d544.js" async=""></script><script id="ads" async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><title>히스토리 복원 시스템 재설계</title><meta name="description" content="&gt; Next.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.  ## 📊 프로젝트 개요  - **주요 목표**: 완벽한 히스토리 복원 지원 - **기술 스택**: N"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="icon" type="image/png" href="/favicon2.png"/><link rel="shortcut icon" href="/favicon2.png"/><link rel="apple-touch-icon" href="/favicon2.png"/><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Catamaran:wght@800&amp;display=swap" rel="stylesheet"/><script>(adsbygoogle=window.adsbygoogle||[]).requestNonPersonalizedAds=1;</script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div class="top-header"><a class="top-link" href="/">Yuni-Q</a><div class="flex items-center"><button class="outline-0 bg-white mx-[5px] p-0 appearance-none items-center rounded-[5px] border-0 cursor-pointer inline-flex h-10 justify-center opacity-75 overflow-hidden relative scale-75 transition-opacity duration-300 ease-in-out w-10 flex-shrink-0 hover:bg-black max-[800px]:hover:bg-white"><a href="https://github.com/Yuni-Q/blog" class="github" aria-label="GitHub"><svg class="github transition-all duration-300 ease-in-out pt-1 text-[#78757a] w-8 hover:text-white max-[800px]:hover:text-[#78757a]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></button><button class="outline-0 bg-white mx-[5px] p-0 appearance-none items-center rounded-[5px] border-0 cursor-pointer inline-flex h-10 justify-center opacity-75 overflow-hidden relative scale-75 transition-opacity duration-300 ease-in-out w-10 flex-shrink-0 hover:bg-black max-[800px]:hover:bg-white group"><div class="theme1 rounded-full h-6 relative w-6 transition-all duration-[450ms] ease-in-out bg-[#78757a]" style="border:none;overflow:visible;transform:scale(0.55)"><div class="absolute rounded-full h-6 w-6 transition-transform duration-[450ms] ease-in-out" style="border:none;opacity:0;right:-9px;top:-9px;transform:translate(14px, -14px);background:#78757a"></div><div class="absolute rounded-full h-2 w-2 left-1/2 top-1/2 transition-all duration-[350ms] ease-in-out" style="box-shadow:0 -23px 0 #78757a, 0 23px 0 #78757a, 23px 0 0 #78757a, -23px 0 0 #78757a, 15px 15px 0 #78757a, -15px 15px 0 #78757a, 15px -15px 0 #78757a, -15px -15px 0 #78757a;transform:scale(1);margin:-4px 0px 0px -4px"></div></div><div class="theme2 rounded-full border-0 h-6 absolute right-0 top-0 w-6 transition-all duration-[450ms] ease-in-out" style="background:none;opacity:0;transform:translate(14px, -14px)"></div></button><button class="outline-0 bg-white mx-[5px] p-0 appearance-none items-center rounded-[5px] border-0 cursor-pointer inline-flex h-10 justify-center opacity-75 overflow-hidden relative scale-75 transition-opacity duration-300 ease-in-out w-10 flex-shrink-0 hover:bg-black max-[800px]:hover:bg-white group"><svg class="snow transition-all duration-300 ease-in-out w-7 group-hover:fill-white max-[800px]:group-hover:fill-[#78757a]" style="fill:#78757a" version="1.1" id="레이어_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 23.9 22.9"><path d="M23.9,10c0-0.3-0.2-0.5-0.4-0.6l-1.1-0.3C22.1,9.1,22,9,21.9,8.8c-0.1-0.2,0-0.4,0.1-0.6l0.8-0.9       c0.2-0.2,0.2-0.5,0-0.7c-1.2-1.4-3.1-2-5-1.4c-0.4,0.1-0.9,0.4-1.4,0.7c0.1-0.6,0.2-1.1,0.2-1.6c0-1.9-1.2-3.6-2.9-4.3       c-0.2-0.1-0.5,0-0.7,0.2l-0.6,1c-0.1,0.2-0.3,0.3-0.5,0.3c-0.2,0-0.4-0.1-0.5-0.3l-0.6-1C10.7,0,10.4-0.1,10.2,0       C8.5,0.7,7.3,2.4,7.3,4.3c0,0.5,0.1,1,0.2,1.6C7,5.6,6.5,5.4,6.1,5.2c-1.8-0.6-3.8,0-5,1.4c-0.2,0.2-0.2,0.5,0,0.7l0.8,0.9       C2,8.4,2.1,8.6,2,8.8c0,0.2-0.2,0.3-0.4,0.4L0.4,9.5C0.2,9.5,0,9.8,0,10c0.1,1.8,1.4,3.5,3.2,4c0.4,0.1,1,0.2,1.5,0.3       c-0.4,0.4-0.8,0.8-1.1,1.1c-1.1,1.6-1.2,3.6-0.2,5.2c0.1,0.2,0.4,0.3,0.7,0.2l1.1-0.4c0.2-0.1,0.4-0.1,0.6,0C6,20.6,6,20.8,6,21.1       l-0.1,1.2c0,0.3,0.2,0.5,0.4,0.6c1.8,0.4,3.7-0.2,4.8-1.8c0.3-0.4,0.5-0.8,0.8-1.4c0.2,0.5,0.5,1,0.8,1.4c1.1,1.6,3.1,2.2,4.8,1.8       c0.3-0.1,0.4-0.3,0.4-0.6l-0.1-1.2c0-0.3,0.1-0.4,0.2-0.5c0.1-0.1,0.3-0.1,0.6,0l1.1,0.4c0.2,0.1,0.5,0,0.7-0.2       c1-1.6,0.9-3.6-0.2-5.2c-0.3-0.4-0.6-0.8-1.1-1.1c0.6-0.1,1.1-0.2,1.5-0.3C22.6,13.5,23.8,11.8,23.9,10z M14.1,12.8       c0.3-0.2,0.7-0.3,1.1-0.1c0.4,0.3,0.6,0.8,0.3,1.3c-0.3,0.4-0.8,0.6-1.3,0.3c-0.3-0.2-0.5-0.6-0.4-1l-1.4-0.8v1.6       c0.4,0.1,0.6,0.5,0.6,0.9c0,0.5-0.4,0.9-0.9,0.9c-0.5,0-0.9-0.4-0.9-0.9c0-0.4,0.3-0.7,0.6-0.9v-1.6l-1.4,0.8c0.1,0.4-0.1,0.8-0.4,1       c-0.4,0.3-1,0.1-1.3-0.3c-0.3-0.4-0.1-1,0.3-1.3c0.3-0.2,0.8-0.1,1.1,0.1l1.4-0.8L10,11.1c-0.3,0.2-0.7,0.3-1.1,0.1       C8.5,11,8.3,10.4,8.6,10c0.3-0.4,0.8-0.6,1.3-0.3c0.3,0.2,0.5,0.6,0.4,1l1.4,0.8V9.8c-0.4-0.1-0.6-0.5-0.6-0.9C11.1,8.4,11.5,8,12,8       c0.5,0,0.9,0.4,0.9,0.9c0,0.4-0.3,0.7-0.6,0.9v1.6l1.4-0.8c-0.1-0.4,0.1-0.8,0.4-1c0.4-0.3,1-0.1,1.3,0.3c0.3,0.4,0.1,1-0.3,1.3       c-0.3,0.2-0.8,0.1-1.1-0.1l-1.4,0.8L14.1,12.8z"></path></svg></button><a class="w-[30px] h-[30px] leading-[30px] mx-[5px] text-black flex-shrink-0 flex items-center justify-center" href="/search/">검색</a></div></div><div class="layout-content" style="margin-right:0;max-width:none"><div class="mb-6 max-w-4xl mx-auto px-4 xl:pr-[220px]"><ins class="adsbygoogle block min-w-[320px] min-h-0 mx-auto bg-gray-300" data-ad-client="ca-pub-2667251850399676" data-ad-slot="9586629994" data-ad-format="auto" data-full-width-responsive="true"></ins></div><div class="relative"><div class="max-w-4xl mx-auto px-4 xl:pr-[220px]"><h1 class="text-4xl md:text-5xl font-extrabold mb-6 leading-tight text-gray-900 dark:text-gray-100">히스토리 복원 시스템 재설계</h1><div class="flex flex-col gap-4 mb-8"><div class="flex items-center gap-2 text-gray-600 dark:text-gray-400"><span class="text-sm font-medium">yuni-q</span><span class="text-gray-400 dark:text-gray-500">·</span><span class="text-sm">2025년 12월 28일</span></div><div class="flex flex-wrap gap-2"><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">Next.js</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">React</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">히스토리복원</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">BF-Cache</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">CSR</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">SSR</span><span class="px-3 py-1.5 text-sm rounded-md bg-green-50 dark:bg-green-900/20 text-gray-700 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer">모노레포</span></div></div><div class="jsx-4115489982 post-content prose prose-lg max-w-none  prose-headings:font-semibold prose-p:leading-relaxed prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline prose-strong:font-semibold prose-code:font-mono prose-code:text-sm prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-pre:bg-gray-900 dark:prose-pre:bg-gray-800 prose-blockquote:border-l-4 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:my-6 prose-img:rounded-lg prose-img:shadow-md prose-table:w-full prose-ul:list-disc prose-ol:list-decimal prose-li:my-1"><blockquote>
<p>Next.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.</p>
</blockquote>
<h2 id="-프로젝트-개요">📊 프로젝트 개요<a aria-hidden="true" tabindex="-1" href="#-프로젝트-개요"><span class="anchor"></span></a></h2>
<ul>
<li><strong>주요 목표</strong>: 완벽한 히스토리 복원 지원</li>
<li><strong>기술 스택</strong>: Next.js 14, React 18, TypeScript</li>
</ul>
<h3 id="핵심-성과">핵심 성과<a aria-hidden="true" tabindex="-1" href="#핵심-성과"><span class="anchor"></span></a></h3>
<ul>
<li>✅ 명시적 클릭 이벤트 기반 저장 시스템 구축</li>
<li>✅ React Strict Mode로 인한 상태 관리 문제 완벽 해결</li>
<li>✅ Next.js의 history.state 덮어쓰기 문제 해결</li>
<li>✅ BF Cache 대응 및 CSR/SSR 환경 통합 처리</li>
<li>✅ Safari/Chrome 등 모든 브라우저 호환</li>
<li>✅ API 호출 최적화 (204 응답 캐싱 처리로 레이아웃 시프트 해결)</li>
</ul>
<hr>
<h2 id="-문제-상황">🔴 문제 상황<a aria-hidden="true" tabindex="-1" href="#-문제-상황"><span class="anchor"></span></a></h2>
<h3 id="1-히스토리-복원-키-불일치">1. 히스토리 복원 키 불일치<a aria-hidden="true" tabindex="-1" href="#1-히스토리-복원-키-불일치"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>네플스홈과 전시허브의 히스토리 복원 관리 키 값이 다름</li>
<li>각 모듈마다 다른 키 체계를 사용하여 일관성 부족</li>
</ul>
<p><strong>영향</strong>:</p>
<ul>
<li>모듈 간 히스토리 복원이 제대로 동작하지 않음</li>
<li>스크롤 위치 복원이 정확하지 않음</li>
</ul>
<h3 id="2-스크롤-복원-위치-오차">2. 스크롤 복원 위치 오차<a aria-hidden="true" tabindex="-1" href="#2-스크롤-복원-위치-오차"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>스크롤이 긴 경우 스크롤 복원 위치가 조금 틀어짐</li>
<li>동적 콘텐츠 로딩으로 인한 높이 변화 미반영</li>
</ul>
<p><strong>영향</strong>:</p>
<ul>
<li>사용자가 이전에 보던 위치로 정확히 돌아가지 못함</li>
<li>사용자 경험 저하</li>
</ul>
<h3 id="3-react-strict-mode로-인한-상태-관리-문제">3. React Strict Mode로 인한 상태 관리 문제<a aria-hidden="true" tabindex="-1" href="#3-react-strict-mode로-인한-상태-관리-문제"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>React Strict Mode에서 컴포넌트가 두 번 렌더링됨</li>
<li>히스토리 저장/복원 타이밍이 꼬임</li>
<li><code class="inline-code">pagehide</code> 이벤트 기반 저장이 불안정함</li>
</ul>
<p><strong>영향</strong>:</p>
<ul>
<li>히스토리 저장이 중복되거나 누락됨</li>
<li>뒤로가기 시 상태가 제대로 복원되지 않음</li>
</ul>
<h3 id="4-nextjs의-historystate-덮어쓰기-문제">4. Next.js의 history.state 덮어쓰기 문제<a aria-hidden="true" tabindex="-1" href="#4-nextjs의-historystate-덮어쓰기-문제"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>Next.js가 자신들의 데이터로 <code class="inline-code">history.state</code>를 덮어씀</li>
<li>사용자가 저장한 커스텀 state가 삭제됨</li>
</ul>
<p><strong>영향</strong>:</p>
<ul>
<li>히스토리 복원 정보가 손실됨</li>
<li>CSR 환경에서 특히 문제 발생</li>
</ul>
<h3 id="5-이미지-과다-요청-문제">5. 이미지 과다 요청 문제<a aria-hidden="true" tabindex="-1" href="#5-이미지-과다-요청-문제"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>"컬리홈 -> 새로고침 -> 베스트 이동 -> 새로고침 -> 뒤로가기" 시나리오에서 이미지를 엄청 많이 요청</li>
<li>기존의 5~10배 이미지 요청 발생</li>
</ul>
<p><strong>원인</strong>:</p>
<ul>
<li><code class="inline-code">StateRestorationUtil.clearOptionsState()</code>가 무수히 호출됨</li>
<li>히스토리 삭제 로직이 잘못된 타이밍에 실행됨</li>
</ul>
<hr>
<h2 id="-해결-방법">✅ 해결 방법<a aria-hidden="true" tabindex="-1" href="#-해결-방법"><span class="anchor"></span></a></h2>
<h3 id="1-명시적-클릭-이벤트-기반-저장-시스템">1. 명시적 클릭 이벤트 기반 저장 시스템<a aria-hidden="true" tabindex="-1" href="#1-명시적-클릭-이벤트-기반-저장-시스템"><span class="anchor"></span></a></h3>
<p><strong>변경 전</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// pagehide 이벤트 기반 저장</span>
</span><span class="code-line">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pagehide'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  StateRestorationUtil<span class="token punctuation">.</span><span class="token function">saveOptionsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>문제점</strong>:</p>
<ul>
<li><code class="inline-code">pagehide</code> 이벤트는 예측하기 어려운 타이밍에 발생</li>
<li>React Strict Mode에서 중복 실행 가능</li>
<li>새로고침 후 뒤로가기 시 문제 발생</li>
</ul>
<p><strong>변경 후</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// 명시적 클릭 이벤트 기반 저장</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">handleLinkClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span>href<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// 스크롤 위치 저장</span>
</span><span class="code-line">  <span class="token keyword">const</span> scrollY <span class="token operator">=</span> window<span class="token punctuation">.</span>scrollY
</span><span class="code-line">  StateRestorationUtil<span class="token punctuation">.</span><span class="token function">saveOptionsState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">    scrollY<span class="token punctuation">,</span>
</span><span class="code-line">    pathname<span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// Next.js Link로 이동</span>
</span><span class="code-line">  router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ 저장 타이밍이 명확해짐</li>
<li>✅ React Strict Mode 문제 해결</li>
<li>✅ 이미지 과다 요청 문제 해결</li>
</ul>
<hr>
<h3 id="2-pathname-기반-키-체계-구축">2. pathname 기반 키 체계 구축<a aria-hidden="true" tabindex="-1" href="#2-pathname-기반-키-체계-구축"><span class="anchor"></span></a></h3>
<p><strong>변경 전</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// 모듈별로 다른 키 사용</span>
</span><span class="code-line"><span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__USER_STATE__</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 네플스홈</span>
</span><span class="code-line"><span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">container-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 전시허브</span>
</span></code></pre>
<p><strong>변경 후</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// pathname 기반 통일된 키 체계</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">getHistoryKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">history-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// SCROLL_POS 복원을 위한 추가 키</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">getScrollPosKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scroll-pos</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// pathname 없는 키도 필요</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ 모듈 간 일관성 확보</li>
<li>✅ Safari에서 히스토리 꼬임 이슈 해결</li>
<li>✅ 키 충돌 방지</li>
</ul>
<hr>
<h3 id="3-nextjs-historystate-덮어쓰기-문제-해결">3. Next.js history.state 덮어쓰기 문제 해결<a aria-hidden="true" tabindex="-1" href="#3-nextjs-historystate-덮어쓰기-문제-해결"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// Next.js가 history.state를 덮어씀</span>
</span><span class="code-line">router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/page'</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">// 사용자가 저장한 커스텀 state가 사라짐</span>
</span></code></pre>
<p><strong>해결 방법</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// patchHistoryReplaceState 함수로 해결</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">patchHistoryReplaceState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> originalReplaceState <span class="token operator">=</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>replaceState
</span><span class="code-line">
</span><span class="code-line">  window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function-variable function">replaceState</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// 사용자 정의 state 보존</span>
</span><span class="code-line">    <span class="token keyword">const</span> userState <span class="token operator">=</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>state<span class="token operator">?.</span>__USER_STATE__
</span><span class="code-line">    <span class="token keyword">const</span> mergedState <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token operator">...</span>state<span class="token punctuation">,</span>
</span><span class="code-line">      __USER_STATE__<span class="token operator">:</span> userState<span class="token punctuation">,</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token function">originalReplaceState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mergedState<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// VerticalLayoutWrapper에서 초기화</span>
</span><span class="code-line"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token function">patchHistoryReplaceState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ Next.js가 state를 덮어써도 사용자 정의 state 보존</li>
<li>✅ CSR 환경에서 안정적인 히스토리 복원</li>
</ul>
<hr>
<h3 id="4-bf-cache-대응">4. BF Cache 대응<a aria-hidden="true" tabindex="-1" href="#4-bf-cache-대응"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>Safari의 Back-Forward Cache (bfcache)로 인한 복원 문제</li>
<li>Dev 모드와 Production 모드의 동작 차이</li>
</ul>
<p><strong>해결 방법</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// Safari bfcache 대응</span>
</span><span class="code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token string">'safari'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> safariVersion <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>
</span><span class="code-line">    navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Version<span class="token escape">\/</span><span class="token group punctuation">(</span><span class="token char-set class-name">\d</span><span class="token quantifier number">+</span><span class="token special-escape escape">\.</span><span class="token char-set class-name">\d</span><span class="token quantifier number">+</span><span class="token group punctuation">)</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'0'</span>
</span><span class="code-line">  <span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>safariVersion <span class="token operator">>=</span> <span class="token number">13.4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>scrollRestoration <span class="token operator">=</span> <span class="token string">'auto'</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// bfcache 복원 시 처리</span>
</span><span class="code-line">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pageshow'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token comment">// bfcache에서 복원된 경우</span>
</span><span class="code-line">    <span class="token function">restoreHistoryState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ Safari에서도 정상적인 히스토리 복원</li>
<li>✅ 모든 브라우저 호환성 확보</li>
</ul>
<hr>
<h3 id="5-스크롤-복원-위치-보정">5. 스크롤 복원 위치 보정<a aria-hidden="true" tabindex="-1" href="#5-스크롤-복원-위치-보정"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>동적 콘텐츠 로딩으로 인한 높이 변화</li>
<li>스크롤 복원 위치가 정확하지 않음</li>
</ul>
<p><strong>해결 방법</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">restoreScrollPosition</span> <span class="token operator">=</span> <span class="token punctuation">(</span>savedScrollY<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token comment">// 즉시 스크롤 복원</span>
</span><span class="code-line">  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> savedScrollY<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment">// 높이 변화 감지 및 재조정</span>
</span><span class="code-line">  <span class="token keyword">let</span> checkCount <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line">  <span class="token keyword">const</span> maxChecks <span class="token operator">=</span> <span class="token number">20</span> <span class="token comment">// 최대 1초 (20 * 50ms)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">const</span> <span class="token function-variable function">checkAndAdjust</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">const</span> currentHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight
</span><span class="code-line">    <span class="token keyword">const</span> expectedHeight <span class="token operator">=</span> savedScrollY <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHeight <span class="token operator">&#x3C;</span> expectedHeight <span class="token operator">&#x26;&#x26;</span> checkCount <span class="token operator">&#x3C;</span> maxChecks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">// 높이가 아직 충분하지 않음</span>
</span><span class="code-line">      checkCount<span class="token operator">++</span>
</span><span class="code-line">      <span class="token function">setTimeout</span><span class="token punctuation">(</span>checkAndAdjust<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">// 최종 스크롤 위치 조정</span>
</span><span class="code-line">      window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> savedScrollY<span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token function">checkAndAdjust</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ 동적 콘텐츠 로딩 후에도 정확한 스크롤 위치 복원</li>
<li>✅ 최대 1초 내 높이 변화 감지 및 보정</li>
</ul>
<hr>
<h3 id="6-히스토리-삭제-로직-개선">6. 히스토리 삭제 로직 개선<a aria-hidden="true" tabindex="-1" href="#6-히스토리-삭제-로직-개선"><span class="anchor"></span></a></h3>
<p><strong>문제</strong>:</p>
<ul>
<li>새로고침 후 뒤로가기 시 히스토리 삭제 로직이 잘못 실행됨</li>
<li><code class="inline-code">GlobalPersistManager.getPersistSavingStatus</code> 값이 초기화되지 않음</li>
</ul>
<p><strong>변경 전</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// pagehide에서 히스토리 삭제 시도</span>
</span><span class="code-line">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pagehide'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldClearHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    StateRestorationUtil<span class="token punctuation">.</span><span class="token function">clearOptionsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>변경 후</strong>:</p>
<pre class="language-typescript optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="language-typescript code-highlight"><span class="code-line"><span class="token comment">// 명시적 클릭 시에만 저장하므로 삭제 로직 불필요</span>
</span><span class="code-line"><span class="token comment">// 히스토리는 사용 후 자동으로 관리됨</span>
</span><span class="code-line"><span class="token comment">// pathname 기반 키로 충돌 방지</span>
</span></code></pre>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ 이미지 과다 요청 문제 해결 (5~10배 → 정상)</li>
<li>✅ 히스토리 삭제 플래그 제거로 복잡도 감소</li>
</ul>
<hr>
<h3 id="7-페이지-레벨-스크롤-복원-책임-이전">7. 페이지 레벨 스크롤 복원 책임 이전<a aria-hidden="true" tabindex="-1" href="#7-페이지-레벨-스크롤-복원-책임-이전"><span class="anchor"></span></a></h3>
<p><strong>변경 전</strong>:</p>
<ul>
<li>CorePack에서 페이지 레벨 스크롤 복원 처리</li>
<li>모듈 간 일관성 부족</li>
</ul>
<p><strong>변경 후</strong>:</p>
<ul>
<li>버티컬레이아웃(VerticalLayoutWrapper)에서 스크롤 복원 처리</li>
<li>CorePack은 모듈 단위로만 제공</li>
</ul>
<p><strong>효과</strong>:</p>
<ul>
<li>✅ 책임 분리로 코드 가독성 향상</li>
<li>✅ 모듈 간 일관성 확보</li>
<li>✅ 불필요한 플래그 값 제거</li>
</ul>
<hr>
<h2 id="️-아키텍처-개선">🏗️ 아키텍처 개선<a aria-hidden="true" tabindex="-1" href="#️-아키텍처-개선"><span class="anchor"></span></a></h2>
<h3 id="변경-전-구조">변경 전 구조<a aria-hidden="true" tabindex="-1" href="#변경-전-구조"><span class="anchor"></span></a></h3>
<pre class="optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="code-highlight"><span class="code-line">CorePack
</span><span class="code-line">├── 페이지 레벨 스크롤 복원 (pagehide 이벤트)
</span><span class="code-line">├── 모듈별 다른 키 체계
</span><span class="code-line">└── 히스토리 삭제 플래그 관리
</span></code></pre>
<h3 id="변경-후-구조">변경 후 구조<a aria-hidden="true" tabindex="-1" href="#변경-후-구조"><span class="anchor"></span></a></h3>
<pre class="optimized-code-block" style="max-height: 600px; overflow-y: auto;"><code class="code-highlight"><span class="code-line">VerticalLayoutWrapper (버티컬레이아웃)
</span><span class="code-line">├── 명시적 클릭 이벤트 기반 저장
</span><span class="code-line">├── pathname 기반 통일된 키 체계
</span><span class="code-line">├── Next.js history.state 덮어쓰기 패치
</span><span class="code-line">└── BF Cache 대응
</span><span class="code-line">
</span><span class="code-line">CorePack
</span><span class="code-line">└── 모듈 단위 스크롤 복원만 제공
</span></code></pre>
<hr>
<h2 id="-핵심-교훈">💡 핵심 교훈<a aria-hidden="true" tabindex="-1" href="#-핵심-교훈"><span class="anchor"></span></a></h2>
<h3 id="1-명시적-이벤트가-암묵적-이벤트보다-안정적">1. 명시적 이벤트가 암묵적 이벤트보다 안정적<a aria-hidden="true" tabindex="-1" href="#1-명시적-이벤트가-암묵적-이벤트보다-안정적"><span class="anchor"></span></a></h3>
<p><code class="inline-code">pagehide</code> 이벤트는 예측하기 어려운 타이밍에 발생하지만, 명시적 클릭 이벤트는 개발자가 완전히 제어할 수 있습니다. React Strict Mode와 같은 환경에서도 안정적으로 동작합니다.</p>
<h3 id="2-프레임워크의-기본-동작을-이해해야-함">2. 프레임워크의 기본 동작을 이해해야 함<a aria-hidden="true" tabindex="-1" href="#2-프레임워크의-기본-동작을-이해해야-함"><span class="anchor"></span></a></h3>
<p>Next.js가 <code class="inline-code">history.state</code>를 덮어쓰는 동작을 이해하지 못하면, 사용자 정의 state가 손실될 수 있습니다. 프레임워크의 내부 동작을 이해하고 적절히 패치하는 것이 중요합니다.</p>
<h3 id="3-bf-cache는-브라우저마다-다르게-동작함">3. BF Cache는 브라우저마다 다르게 동작함<a aria-hidden="true" tabindex="-1" href="#3-bf-cache는-브라우저마다-다르게-동작함"><span class="anchor"></span></a></h3>
<p>Safari와 Chrome의 BF Cache 동작이 다르며, Dev 모드와 Production 모드에서도 차이가 있습니다. 모든 환경에서 테스트하는 것이 중요합니다.</p>
<h3 id="4-키-체계의-일관성이-중요함">4. 키 체계의 일관성이 중요함<a aria-hidden="true" tabindex="-1" href="#4-키-체계의-일관성이-중요함"><span class="anchor"></span></a></h3>
<p>모듈마다 다른 키를 사용하면 히스토리 복원이 제대로 동작하지 않습니다. 통일된 키 체계를 구축하는 것이 중요합니다.</p>
<h3 id="5-점진적-마이그레이션이-필요함">5. 점진적 마이그레이션이 필요함<a aria-hidden="true" tabindex="-1" href="#5-점진적-마이그레이션이-필요함"><span class="anchor"></span></a></h3>
<p>7개 모듈에 걸친 대규모 변경은 한 번에 적용하기 어렵습니다. 단계적으로 마이그레이션하고 각 단계마다 검증하는 것이 중요합니다.</p>
<hr>
<h2 id="-최종-결과">📈 최종 결과<a aria-hidden="true" tabindex="-1" href="#-최종-결과"><span class="anchor"></span></a></h2>
<h3 id="성능-개선">성능 개선<a aria-hidden="true" tabindex="-1" href="#성능-개선"><span class="anchor"></span></a></h3>
<ul>
<li>✅ 이미지 요청 횟수: 5~10배 → 정상 수준</li>
<li>✅ API 호출 최적화: 204 응답 캐싱 처리로 레이아웃 시프트 해결</li>
<li>✅ 히스토리 복원 정확도: 100% 달성</li>
</ul>
<h3 id="코드-품질-개선">코드 품질 개선<a aria-hidden="true" tabindex="-1" href="#코드-품질-개선"><span class="anchor"></span></a></h3>
<ul>
<li>✅ 히스토리 삭제 플래그 제거로 복잡도 감소</li>
<li>✅ 책임 분리로 코드 가독성 향상</li>
<li>✅ 통일된 키 체계로 유지보수성 향상</li>
</ul>
<h3 id="사용자-경험-개선">사용자 경험 개선<a aria-hidden="true" tabindex="-1" href="#사용자-경험-개선"><span class="anchor"></span></a></h3>
<ul>
<li>✅ 스크롤 위치 정확도 향상</li>
<li>✅ 뒤로가기 시 상태 완벽 복원</li>
<li>✅ 모든 브라우저에서 일관된 동작</li>
</ul>
<hr>
<h2 id="-결론">🎯 결론<a aria-hidden="true" tabindex="-1" href="#-결론"><span class="anchor"></span></a></h2>
<p>7개 모듈에 걸친 히스토리 복원 시스템 재설계를 통해 다음과 같은 성과를 달성했습니다:</p>
<ol>
<li>✅ <strong>명시적 클릭 이벤트 기반 저장 시스템</strong>으로 React Strict Mode 문제 해결</li>
<li>✅ <strong>pathname 기반 통일된 키 체계</strong>로 모듈 간 일관성 확보</li>
<li>✅ <strong>Next.js history.state 덮어쓰기 패치</strong>로 CSR 환경 안정성 확보</li>
<li>✅ <strong>BF Cache 대응</strong>으로 모든 브라우저 호환성 확보</li>
<li>✅ <strong>스크롤 복원 위치 보정</strong>으로 사용자 경험 향상</li>
</ol>
<p>이번 작업을 통해 대규모 모노레포에서의 히스토리 복원 시스템 설계 경험을 쌓았고, React Strict Mode, Next.js 내부 동작, BF Cache 등 다양한 기술적 도전을 해결할 수 있었습니다.</p>
<hr>
<h2 id="-참고-자료">📚 참고 자료<a aria-hidden="true" tabindex="-1" href="#-참고-자료"><span class="anchor"></span></a></h2>
<ul>
<li><a href="https://nextjs.org/docs/app/building-your-application/routing">Next.js Documentation - Routing</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/History_API">MDN Web Docs - History API</a></li>
<li><a href="https://web.dev/bfcache/">MDN Web Docs - Back/Forward Cache</a></li>
<li><a href="https://react.dev/reference/react/StrictMode">React Documentation - Strict Mode</a></li>
</ul></div></div></div><div class="flex flex-col gap-5 my-10 max-w-4xl mx-auto px-4 xl:pr-[220px]"><div class="sponsor-button"><a class="flex items-center justify-center gap-3 px-6 py-3.5 bg-gradient-to-r from-amber-400 via-amber-500 to-amber-600 hover:from-amber-500 hover:via-amber-600 hover:to-amber-700 active:from-amber-600 active:via-amber-700 active:to-amber-800 text-white rounded-2xl transition-all duration-300 cursor-pointer border-0 shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] font-semibold text-base no-underline" target="_blank" rel="noopener noreferrer" href="https://www.buymeacoffee.com/yuniq"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me a coffee" class="w-7 h-7 flex-shrink-0"/><span>Buy me a coffee</span></a></div></div><div class="max-w-4xl mx-auto px-4 xl:pr-[220px]"><ins class="kakao_ad_area block" data-ad-unit="DAN-kkYIHzVbuDz3kYsq" data-ad-width="320" data-ad-height="50" style="width:320px;height:50px"></ins></div><div class="max-w-4xl mx-auto px-4 xl:pr-[220px]"><hr class="custom-hr"/></div><div class="my-8 max-w-4xl mx-auto px-4 xl:pr-[220px]"><div class="bio-container"><div class="author-description flex"><img class="bio-author-image" src="/images/profile.png" alt="yuni-q" width="72"/><div><span class="author-name-prefix text-[90%] mr-1">Written by</span><a class="author-name-content" href="/about/"><span>@<!-- -->yuni-q</span></a><div class="author-introduction mt-1 text-[80%] leading-[1.4]">yuni-q&#x27;s graffiti.</div><p class="author-socials mt-[-4px]"><a href="https://github.com/Yuni-Q" class="mr-2 text-[80%]">GitHub</a></p></div></div></div></div><div class="max-w-4xl mx-auto px-4 xl:pr-[220px]"><nav class="navigator my-8"><ul class="flex flex-col gap-4"><li><a rel="prev" class="block p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200 group" href="/book/업무시각화/"><div class="text-xs text-gray-500 dark:text-gray-400 mb-1 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">이전 글</div><div class="text-sm font-medium text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">← <!-- -->업무 시각화: 시간 도둑을 잡고 효율적인 업무 흐름 만들기</div></a></li><li><a rel="next" class="block p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200 group text-right" href="/develop/우아한웤플로/"><div class="text-xs text-gray-500 dark:text-gray-400 mb-1 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">다음 글</div><div class="text-sm font-medium text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">우아한웤플로<!-- --> →</div></a></li></ul></nav></div><div class="max-w-4xl mx-auto px-4 xl:pr-[220px]"><div class="utterences"></div></div><footer class="pt-[52px] text-center text-xs">©<a href="https://github.com/Yuni-Q" class="no-underline">yuni-q</a>, Built with<!-- --> <a href="https://nextjs.org" class="no-underline">Next.js</a></footer></div><script src="/_next/static/chunks/webpack-57fdca2934e5ae0a.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/bc8bb31cb71603b2.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[1633,[],\"\"]\n5:I[808,[],\"\"]\n7:I[6217,[],\"\"]\n8:I[5217,[\"3185\",\"static/chunks/app/layout-3ad8bb7cb2292578.js\"],\"ServiceWorkerCleanup\"]\n9:I[6484,[\"3185\",\"static/chunks/app/layout-3ad8bb7cb2292578.js\"],\"ThemeProvider\"]\nb:I[7768,[],\"\"]\n6:[\"slug\",\"develop/%ED%9E%88%EC%8A%A4%ED%86%A0%EB%A6%AC%20%EB%B3%B5%EC%9B%90%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%9E%AC%EC%84%A4%EA%B3%84\",\"c\"]\nc:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L2\",null,{\"buildId\":\"static-build-id\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"blog\",\"develop\",\"%ED%9E%88%EC%8A%A4%ED%86%A0%EB%A6%AC%20%EB%B3%B5%EC%9B%90%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%9E%AC%EC%84%A4%EA%B3%84\",\"\"],\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"develop/%ED%9E%88%EC%8A%A4%ED%86%A0%EB%A6%AC%20%EB%B3%B5%EC%9B%90%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%9E%AC%EC%84%A4%EA%B3%84\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"develop\\\",\\\"히스토리 복원 시스템 재설계\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"develop/%ED%9E%88%EC%8A%A4%ED%86%A0%EB%A6%AC%20%EB%B3%B5%EC%9B%90%20%EC%8B%9C%EC%8A%A4%ED%85%9C%20%EC%9E%AC%EC%84%A4%EA%B3%84\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\",null],null],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$6\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/bc8bb31cb71603b2.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.googleapis.com\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.gstatic.com\",\"crossOrigin\":\"anonymous\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Catamaran:wght@800\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"href\":\"/favicon2.png\"}],[\"$\",\"link\",null,{\"rel\":\"shortcut icon\",\"href\":\"/favicon2.png\"}],[\"$\",\"link\",null,{\"rel\":\"apple-touch-icon\",\"href\":\"/favicon2.png\"}],[\"$\",\"script\",null,{\"id\":\"ads\",\"async\":true,\"src\":\"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js\"}],[\"$\",\"script\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"(adsbygoogle=window.adsbygoogle||[]).requestNonPersonalizedAds=1;\"}}]]}],[\"$\",\"body\",null,{\"children\":[[\"$\",\"noscript\",null,{\"children\":\"You need to enable JavaScript to run this app.\"}],[\"$\",\"$L8\",null,{}],[\"$\",\"$L9\",null,{\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]]}]]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"d:I[5553,[\"9243\",\"static/chunks/9243-972bdccd4ceb11ae.js\",\"5800\",\"static/chunks/5800-4312aed1aa8a4305.js\",\"549\",\"static/chunks/549-2babc012700e23ed.js\",\"4853\",\"static/chunks/4853-73ca7990eb89674b.js\",\"6797\",\"static/chunks/app/blog/%5B...slug%5D/page-9b274a2e0073d544.js\"],\"BlogPostPageClient\"]\ne:T2d07,"])</script><script>self.__next_f.push([1,"\n\u003e Next.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.\n\n## 📊 프로젝트 개요\n\n- **주요 목표**: 완벽한 히스토리 복원 지원\n- **기술 스택**: Next.js 14, React 18, TypeScript\n\n### 핵심 성과\n\n- ✅ 명시적 클릭 이벤트 기반 저장 시스템 구축\n- ✅ React Strict Mode로 인한 상태 관리 문제 완벽 해결\n- ✅ Next.js의 history.state 덮어쓰기 문제 해결\n- ✅ BF Cache 대응 및 CSR/SSR 환경 통합 처리\n- ✅ Safari/Chrome 등 모든 브라우저 호환\n- ✅ API 호출 최적화 (204 응답 캐싱 처리로 레이아웃 시프트 해결)\n\n---\n\n## 🔴 문제 상황\n\n### 1. 히스토리 복원 키 불일치\n\n**문제**:\n\n- 네플스홈과 전시허브의 히스토리 복원 관리 키 값이 다름\n- 각 모듈마다 다른 키 체계를 사용하여 일관성 부족\n\n**영향**:\n\n- 모듈 간 히스토리 복원이 제대로 동작하지 않음\n- 스크롤 위치 복원이 정확하지 않음\n\n### 2. 스크롤 복원 위치 오차\n\n**문제**:\n\n- 스크롤이 긴 경우 스크롤 복원 위치가 조금 틀어짐\n- 동적 콘텐츠 로딩으로 인한 높이 변화 미반영\n\n**영향**:\n\n- 사용자가 이전에 보던 위치로 정확히 돌아가지 못함\n- 사용자 경험 저하\n\n### 3. React Strict Mode로 인한 상태 관리 문제\n\n**문제**:\n\n- React Strict Mode에서 컴포넌트가 두 번 렌더링됨\n- 히스토리 저장/복원 타이밍이 꼬임\n- `pagehide` 이벤트 기반 저장이 불안정함\n\n**영향**:\n\n- 히스토리 저장이 중복되거나 누락됨\n- 뒤로가기 시 상태가 제대로 복원되지 않음\n\n### 4. Next.js의 history.state 덮어쓰기 문제\n\n**문제**:\n\n- Next.js가 자신들의 데이터로 `history.state`를 덮어씀\n- 사용자가 저장한 커스텀 state가 삭제됨\n\n**영향**:\n\n- 히스토리 복원 정보가 손실됨\n- CSR 환경에서 특히 문제 발생\n\n### 5. 이미지 과다 요청 문제\n\n**문제**:\n\n- \"컬리홈 -\u003e 새로고침 -\u003e 베스트 이동 -\u003e 새로고침 -\u003e 뒤로가기\" 시나리오에서 이미지를 엄청 많이 요청\n- 기존의 5~10배 이미지 요청 발생\n\n**원인**:\n\n- `StateRestorationUtil.clearOptionsState()`가 무수히 호출됨\n- 히스토리 삭제 로직이 잘못된 타이밍에 실행됨\n\n---\n\n## ✅ 해결 방법\n\n### 1. 명시적 클릭 이벤트 기반 저장 시스템\n\n**변경 전**:\n\n```typescript\n// pagehide 이벤트 기반 저장\nwindow.addEventListener('pagehide', () =\u003e {\n  StateRestorationUtil.saveOptionsState()\n})\n```\n\n**문제점**:\n\n- `pagehide` 이벤트는 예측하기 어려운 타이밍에 발생\n- React Strict Mode에서 중복 실행 가능\n- 새로고침 후 뒤로가기 시 문제 발생\n\n**변경 후**:\n\n```typescript\n// 명시적 클릭 이벤트 기반 저장\nconst handleLinkClick = (href: string) =\u003e {\n  // 스크롤 위치 저장\n  const scrollY = window.scrollY\n  StateRestorationUtil.saveOptionsState({\n    scrollY,\n    pathname: window.location.pathname,\n  })\n\n  // Next.js Link로 이동\n  router.push(href)\n}\n```\n\n**효과**:\n\n- ✅ 저장 타이밍이 명확해짐\n- ✅ React Strict Mode 문제 해결\n- ✅ 이미지 과다 요청 문제 해결\n\n---\n\n### 2. pathname 기반 키 체계 구축\n\n**변경 전**:\n\n```typescript\n// 모듈별로 다른 키 사용\nconst key = `__USER_STATE__` // 네플스홈\nconst key = `container-${id}` // 전시허브\n```\n\n**변경 후**:\n\n```typescript\n// pathname 기반 통일된 키 체계\nconst getHistoryKey = (pathname: string) =\u003e {\n  return `history-${pathname}`\n}\n\n// SCROLL_POS 복원을 위한 추가 키\nconst getScrollPosKey = () =\u003e {\n  return `scroll-pos` // pathname 없는 키도 필요\n}\n```\n\n**효과**:\n\n- ✅ 모듈 간 일관성 확보\n- ✅ Safari에서 히스토리 꼬임 이슈 해결\n- ✅ 키 충돌 방지\n\n---\n\n### 3. Next.js history.state 덮어쓰기 문제 해결\n\n**문제**:\n\n```typescript\n// Next.js가 history.state를 덮어씀\nrouter.push('/page')\n// 사용자가 저장한 커스텀 state가 사라짐\n```\n\n**해결 방법**:\n\n```typescript\n// patchHistoryReplaceState 함수로 해결\nconst patchHistoryReplaceState = () =\u003e {\n  const originalReplaceState = window.history.replaceState\n\n  window.history.replaceState = function (state, title, url) {\n    // 사용자 정의 state 보존\n    const userState = window.history.state?.__USER_STATE__\n    const mergedState = {\n      ...state,\n      __USER_STATE__: userState,\n    }\n\n    return originalReplaceState.call(this, mergedState, title, url)\n  }\n}\n\n// VerticalLayoutWrapper에서 초기화\nuseEffect(() =\u003e {\n  patchHistoryReplaceState()\n}, [])\n```\n\n**효과**:\n\n- ✅ Next.js가 state를 덮어써도 사용자 정의 state 보존\n- ✅ CSR 환경에서 안정적인 히스토리 복원\n\n---\n\n### 4. BF Cache 대응\n\n**문제**:\n\n- Safari의 Back-Forward Cache (bfcache)로 인한 복원 문제\n- Dev 모드와 Production 모드의 동작 차이\n\n**해결 방법**:\n\n```typescript\n// Safari bfcache 대응\nif (typeof window !== 'undefined' \u0026\u0026 'safari' in window) {\n  const safariVersion = parseFloat(\n    navigator.userAgent.match(/Version\\/(\\d+\\.\\d+)/)?.[1] || '0'\n  )\n\n  if (safariVersion \u003e= 13.4) {\n    window.history.scrollRestoration = 'auto'\n  }\n}\n\n// bfcache 복원 시 처리\nwindow.addEventListener('pageshow', (event) =\u003e {\n  if (event.persisted) {\n    // bfcache에서 복원된 경우\n    restoreHistoryState()\n  }\n})\n```\n\n**효과**:\n\n- ✅ Safari에서도 정상적인 히스토리 복원\n- ✅ 모든 브라우저 호환성 확보\n\n---\n\n### 5. 스크롤 복원 위치 보정\n\n**문제**:\n\n- 동적 콘텐츠 로딩으로 인한 높이 변화\n- 스크롤 복원 위치가 정확하지 않음\n\n**해결 방법**:\n\n```typescript\nconst restoreScrollPosition = (savedScrollY: number) =\u003e {\n  // 즉시 스크롤 복원\n  window.scrollTo(0, savedScrollY)\n\n  // 높이 변화 감지 및 재조정\n  let checkCount = 0\n  const maxChecks = 20 // 최대 1초 (20 * 50ms)\n\n  const checkAndAdjust = () =\u003e {\n    const currentHeight = document.documentElement.scrollHeight\n    const expectedHeight = savedScrollY + window.innerHeight\n\n    if (currentHeight \u003c expectedHeight \u0026\u0026 checkCount \u003c maxChecks) {\n      // 높이가 아직 충분하지 않음\n      checkCount++\n      setTimeout(checkAndAdjust, 50)\n    } else {\n      // 최종 스크롤 위치 조정\n      window.scrollTo(0, savedScrollY)\n    }\n  }\n\n  checkAndAdjust()\n}\n```\n\n**효과**:\n\n- ✅ 동적 콘텐츠 로딩 후에도 정확한 스크롤 위치 복원\n- ✅ 최대 1초 내 높이 변화 감지 및 보정\n\n---\n\n### 6. 히스토리 삭제 로직 개선\n\n**문제**:\n\n- 새로고침 후 뒤로가기 시 히스토리 삭제 로직이 잘못 실행됨\n- `GlobalPersistManager.getPersistSavingStatus` 값이 초기화되지 않음\n\n**변경 전**:\n\n```typescript\n// pagehide에서 히스토리 삭제 시도\nwindow.addEventListener('pagehide', () =\u003e {\n  if (shouldClearHistory()) {\n    StateRestorationUtil.clearOptionsState()\n  }\n})\n```\n\n**변경 후**:\n\n```typescript\n// 명시적 클릭 시에만 저장하므로 삭제 로직 불필요\n// 히스토리는 사용 후 자동으로 관리됨\n// pathname 기반 키로 충돌 방지\n```\n\n**효과**:\n\n- ✅ 이미지 과다 요청 문제 해결 (5~10배 → 정상)\n- ✅ 히스토리 삭제 플래그 제거로 복잡도 감소\n\n---\n\n### 7. 페이지 레벨 스크롤 복원 책임 이전\n\n**변경 전**:\n\n- CorePack에서 페이지 레벨 스크롤 복원 처리\n- 모듈 간 일관성 부족\n\n**변경 후**:\n\n- 버티컬레이아웃(VerticalLayoutWrapper)에서 스크롤 복원 처리\n- CorePack은 모듈 단위로만 제공\n\n**효과**:\n\n- ✅ 책임 분리로 코드 가독성 향상\n- ✅ 모듈 간 일관성 확보\n- ✅ 불필요한 플래그 값 제거\n\n---\n\n## 🏗️ 아키텍처 개선\n\n### 변경 전 구조\n\n```\nCorePack\n├── 페이지 레벨 스크롤 복원 (pagehide 이벤트)\n├── 모듈별 다른 키 체계\n└── 히스토리 삭제 플래그 관리\n```\n\n### 변경 후 구조\n\n```\nVerticalLayoutWrapper (버티컬레이아웃)\n├── 명시적 클릭 이벤트 기반 저장\n├── pathname 기반 통일된 키 체계\n├── Next.js history.state 덮어쓰기 패치\n└── BF Cache 대응\n\nCorePack\n└── 모듈 단위 스크롤 복원만 제공\n```\n\n---\n\n## 💡 핵심 교훈\n\n### 1. 명시적 이벤트가 암묵적 이벤트보다 안정적\n\n`pagehide` 이벤트는 예측하기 어려운 타이밍에 발생하지만, 명시적 클릭 이벤트는 개발자가 완전히 제어할 수 있습니다. React Strict Mode와 같은 환경에서도 안정적으로 동작합니다.\n\n### 2. 프레임워크의 기본 동작을 이해해야 함\n\nNext.js가 `history.state`를 덮어쓰는 동작을 이해하지 못하면, 사용자 정의 state가 손실될 수 있습니다. 프레임워크의 내부 동작을 이해하고 적절히 패치하는 것이 중요합니다.\n\n### 3. BF Cache는 브라우저마다 다르게 동작함\n\nSafari와 Chrome의 BF Cache 동작이 다르며, Dev 모드와 Production 모드에서도 차이가 있습니다. 모든 환경에서 테스트하는 것이 중요합니다.\n\n### 4. 키 체계의 일관성이 중요함\n\n모듈마다 다른 키를 사용하면 히스토리 복원이 제대로 동작하지 않습니다. 통일된 키 체계를 구축하는 것이 중요합니다.\n\n### 5. 점진적 마이그레이션이 필요함\n\n7개 모듈에 걸친 대규모 변경은 한 번에 적용하기 어렵습니다. 단계적으로 마이그레이션하고 각 단계마다 검증하는 것이 중요합니다.\n\n---\n\n## 📈 최종 결과\n\n### 성능 개선\n\n- ✅ 이미지 요청 횟수: 5~10배 → 정상 수준\n- ✅ API 호출 최적화: 204 응답 캐싱 처리로 레이아웃 시프트 해결\n- ✅ 히스토리 복원 정확도: 100% 달성\n\n### 코드 품질 개선\n\n- ✅ 히스토리 삭제 플래그 제거로 복잡도 감소\n- ✅ 책임 분리로 코드 가독성 향상\n- ✅ 통일된 키 체계로 유지보수성 향상\n\n### 사용자 경험 개선\n\n- ✅ 스크롤 위치 정확도 향상\n- ✅ 뒤로가기 시 상태 완벽 복원\n- ✅ 모든 브라우저에서 일관된 동작\n\n---\n\n## 🎯 결론\n\n7개 모듈에 걸친 히스토리 복원 시스템 재설계를 통해 다음과 같은 성과를 달성했습니다:\n\n1. ✅ **명시적 클릭 이벤트 기반 저장 시스템**으로 React Strict Mode 문제 해결\n2. ✅ **pathname 기반 통일된 키 체계**로 모듈 간 일관성 확보\n3. ✅ **Next.js history.state 덮어쓰기 패치**로 CSR 환경 안정성 확보\n4. ✅ **BF Cache 대응**으로 모든 브라우저 호환성 확보\n5. ✅ **스크롤 복원 위치 보정**으로 사용자 경험 향상\n\n이번 작업을 통해 대규모 모노레포에서의 히스토리 복원 시스템 설계 경험을 쌓았고, React Strict Mode, Next.js 내부 동작, BF Cache 등 다양한 기술적 도전을 해결할 수 있었습니다.\n\n---\n\n## 📚 참고 자료\n\n- [Next.js Documentation - Routing](https://nextjs.org/docs/app/building-your-application/routing)\n- [MDN Web Docs - History API](https://developer.mozilla.org/en-US/docs/Web/API/History_API)\n- [MDN Web Docs - Back/Forward Cache](https://web.dev/bfcache/)\n- [React Documentation - Strict Mode](https://react.dev/reference/react/StrictMode)\n"])</script><script>self.__next_f.push([1,"f:T8dac,"])</script><script>self.__next_f.push([1,"\u003cblockquote\u003e\n\u003cp\u003eNext.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"-프로젝트-개요\"\u003e📊 프로젝트 개요\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-프로젝트-개요\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e주요 목표\u003c/strong\u003e: 완벽한 히스토리 복원 지원\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e기술 스택\u003c/strong\u003e: Next.js 14, React 18, TypeScript\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"핵심-성과\"\u003e핵심 성과\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#핵심-성과\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 명시적 클릭 이벤트 기반 저장 시스템 구축\u003c/li\u003e\n\u003cli\u003e✅ React Strict Mode로 인한 상태 관리 문제 완벽 해결\u003c/li\u003e\n\u003cli\u003e✅ Next.js의 history.state 덮어쓰기 문제 해결\u003c/li\u003e\n\u003cli\u003e✅ BF Cache 대응 및 CSR/SSR 환경 통합 처리\u003c/li\u003e\n\u003cli\u003e✅ Safari/Chrome 등 모든 브라우저 호환\u003c/li\u003e\n\u003cli\u003e✅ API 호출 최적화 (204 응답 캐싱 처리로 레이아웃 시프트 해결)\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"-문제-상황\"\u003e🔴 문제 상황\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-문제-상황\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"1-히스토리-복원-키-불일치\"\u003e1. 히스토리 복원 키 불일치\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#1-히스토리-복원-키-불일치\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e네플스홈과 전시허브의 히스토리 복원 관리 키 값이 다름\u003c/li\u003e\n\u003cli\u003e각 모듈마다 다른 키 체계를 사용하여 일관성 부족\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e영향\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e모듈 간 히스토리 복원이 제대로 동작하지 않음\u003c/li\u003e\n\u003cli\u003e스크롤 위치 복원이 정확하지 않음\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-스크롤-복원-위치-오차\"\u003e2. 스크롤 복원 위치 오차\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#2-스크롤-복원-위치-오차\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e스크롤이 긴 경우 스크롤 복원 위치가 조금 틀어짐\u003c/li\u003e\n\u003cli\u003e동적 콘텐츠 로딩으로 인한 높이 변화 미반영\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e영향\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e사용자가 이전에 보던 위치로 정확히 돌아가지 못함\u003c/li\u003e\n\u003cli\u003e사용자 경험 저하\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"3-react-strict-mode로-인한-상태-관리-문제\"\u003e3. React Strict Mode로 인한 상태 관리 문제\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#3-react-strict-mode로-인한-상태-관리-문제\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eReact Strict Mode에서 컴포넌트가 두 번 렌더링됨\u003c/li\u003e\n\u003cli\u003e히스토리 저장/복원 타이밍이 꼬임\u003c/li\u003e\n\u003cli\u003e\u003ccode class=\"inline-code\"\u003epagehide\u003c/code\u003e 이벤트 기반 저장이 불안정함\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e영향\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e히스토리 저장이 중복되거나 누락됨\u003c/li\u003e\n\u003cli\u003e뒤로가기 시 상태가 제대로 복원되지 않음\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"4-nextjs의-historystate-덮어쓰기-문제\"\u003e4. Next.js의 history.state 덮어쓰기 문제\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#4-nextjs의-historystate-덮어쓰기-문제\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNext.js가 자신들의 데이터로 \u003ccode class=\"inline-code\"\u003ehistory.state\u003c/code\u003e를 덮어씀\u003c/li\u003e\n\u003cli\u003e사용자가 저장한 커스텀 state가 삭제됨\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e영향\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e히스토리 복원 정보가 손실됨\u003c/li\u003e\n\u003cli\u003eCSR 환경에서 특히 문제 발생\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"5-이미지-과다-요청-문제\"\u003e5. 이미지 과다 요청 문제\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#5-이미지-과다-요청-문제\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\"컬리홈 -\u003e 새로고침 -\u003e 베스트 이동 -\u003e 새로고침 -\u003e 뒤로가기\" 시나리오에서 이미지를 엄청 많이 요청\u003c/li\u003e\n\u003cli\u003e기존의 5~10배 이미지 요청 발생\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e원인\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode class=\"inline-code\"\u003eStateRestorationUtil.clearOptionsState()\u003c/code\u003e가 무수히 호출됨\u003c/li\u003e\n\u003cli\u003e히스토리 삭제 로직이 잘못된 타이밍에 실행됨\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"-해결-방법\"\u003e✅ 해결 방법\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-해결-방법\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"1-명시적-클릭-이벤트-기반-저장-시스템\"\u003e1. 명시적 클릭 이벤트 기반 저장 시스템\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#1-명시적-클릭-이벤트-기반-저장-시스템\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e변경 전\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// pagehide 이벤트 기반 저장\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003ewindow\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'pagehide'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  StateRestorationUtil\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esaveOptionsState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e문제점\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode class=\"inline-code\"\u003epagehide\u003c/code\u003e 이벤트는 예측하기 어려운 타이밍에 발생\u003c/li\u003e\n\u003cli\u003eReact Strict Mode에서 중복 실행 가능\u003c/li\u003e\n\u003cli\u003e새로고침 후 뒤로가기 시 문제 발생\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e변경 후\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// 명시적 클릭 이벤트 기반 저장\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003ehandleLinkClick\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehref\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token comment\"\u003e// 스크롤 위치 저장\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e scrollY \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003escrollY\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  StateRestorationUtil\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esaveOptionsState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    scrollY\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    pathname\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elocation\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epathname\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token comment\"\u003e// Next.js Link로 이동\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  router\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehref\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 저장 타이밍이 명확해짐\u003c/li\u003e\n\u003cli\u003e✅ React Strict Mode 문제 해결\u003c/li\u003e\n\u003cli\u003e✅ 이미지 과다 요청 문제 해결\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"2-pathname-기반-키-체계-구축\"\u003e2. pathname 기반 키 체계 구축\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#2-pathname-기반-키-체계-구축\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e변경 전\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// 모듈별로 다른 키 사용\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e key \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003e__USER_STATE__\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 네플스홈\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e key \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003econtainer-\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003eid\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 전시허브\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e변경 후\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// pathname 기반 통일된 키 체계\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003egetHistoryKey\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epathname\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003ehistory-\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003epathname\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// SCROLL_POS 복원을 위한 추가 키\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003egetScrollPosKey\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003escroll-pos\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// pathname 없는 키도 필요\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 모듈 간 일관성 확보\u003c/li\u003e\n\u003cli\u003e✅ Safari에서 히스토리 꼬임 이슈 해결\u003c/li\u003e\n\u003cli\u003e✅ 키 충돌 방지\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"3-nextjs-historystate-덮어쓰기-문제-해결\"\u003e3. Next.js history.state 덮어쓰기 문제 해결\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#3-nextjs-historystate-덮어쓰기-문제-해결\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// Next.js가 history.state를 덮어씀\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003erouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/page'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// 사용자가 저장한 커스텀 state가 사라짐\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e해결 방법\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// patchHistoryReplaceState 함수로 해결\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003epatchHistoryReplaceState\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e originalReplaceState \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehistory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereplaceState\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehistory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function-variable function\"\u003ereplaceState\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e title\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e url\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token comment\"\u003e// 사용자 정의 state 보존\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e userState \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehistory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estate\u003cspan class=\"token operator\"\u003e?.\u003c/span\u003e__USER_STATE__\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e mergedState \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token operator\"\u003e...\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      __USER_STATE__\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e userState\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eoriginalReplaceState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e mergedState\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e title\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e url\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// VerticalLayoutWrapper에서 초기화\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token function\"\u003euseEffect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token function\"\u003epatchHistoryReplaceState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ Next.js가 state를 덮어써도 사용자 정의 state 보존\u003c/li\u003e\n\u003cli\u003e✅ CSR 환경에서 안정적인 히스토리 복원\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"4-bf-cache-대응\"\u003e4. BF Cache 대응\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#4-bf-cache-대응\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSafari의 Back-Forward Cache (bfcache)로 인한 복원 문제\u003c/li\u003e\n\u003cli\u003eDev 모드와 Production 모드의 동작 차이\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e해결 방법\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// Safari bfcache 대응\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etypeof\u003c/span\u003e window \u003cspan class=\"token operator\"\u003e!==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'undefined'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token string\"\u003e'safari'\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e safariVersion \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eparseFloat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    navigator\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003euserAgent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ematch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token regex\"\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003cspan class=\"token regex-source language-regex\"\u003eVersion\u003cspan class=\"token escape\"\u003e\\/\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e\\d\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e+\u003c/span\u003e\u003cspan class=\"token special-escape escape\"\u003e\\.\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e\\d\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e+\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token string\"\u003e'0'\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esafariVersion \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e13.4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehistory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003escrollRestoration \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'auto'\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// bfcache 복원 시 처리\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003ewindow\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'pageshow'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eevent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eevent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epersisted\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token comment\"\u003e// bfcache에서 복원된 경우\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token function\"\u003erestoreHistoryState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ Safari에서도 정상적인 히스토리 복원\u003c/li\u003e\n\u003cli\u003e✅ 모든 브라우저 호환성 확보\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"5-스크롤-복원-위치-보정\"\u003e5. 스크롤 복원 위치 보정\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#5-스크롤-복원-위치-보정\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e동적 콘텐츠 로딩으로 인한 높이 변화\u003c/li\u003e\n\u003cli\u003e스크롤 복원 위치가 정확하지 않음\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e해결 방법\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003erestoreScrollPosition\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esavedScrollY\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003enumber\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token comment\"\u003e// 즉시 스크롤 복원\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003escrollTo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e savedScrollY\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token comment\"\u003e// 높이 변화 감지 및 재조정\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e checkCount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e maxChecks \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e20\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 최대 1초 (20 * 50ms)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003echeckAndAdjust\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e currentHeight \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edocumentElement\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003escrollHeight\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e expectedHeight \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e savedScrollY \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerHeight\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecurrentHeight \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e expectedHeight \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e checkCount \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e maxChecks\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token comment\"\u003e// 높이가 아직 충분하지 않음\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      checkCount\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003echeckAndAdjust\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e50\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      \u003cspan class=\"token comment\"\u003e// 최종 스크롤 위치 조정\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e      window\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003escrollTo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e savedScrollY\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token function\"\u003echeckAndAdjust\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 동적 콘텐츠 로딩 후에도 정확한 스크롤 위치 복원\u003c/li\u003e\n\u003cli\u003e✅ 최대 1초 내 높이 변화 감지 및 보정\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"6-히스토리-삭제-로직-개선\"\u003e6. 히스토리 삭제 로직 개선\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#6-히스토리-삭제-로직-개선\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e문제\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e새로고침 후 뒤로가기 시 히스토리 삭제 로직이 잘못 실행됨\u003c/li\u003e\n\u003cli\u003e\u003ccode class=\"inline-code\"\u003eGlobalPersistManager.getPersistSavingStatus\u003c/code\u003e 값이 초기화되지 않음\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e변경 전\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// pagehide에서 히스토리 삭제 시도\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003ewindow\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'pagehide'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eshouldClearHistory\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e    StateRestorationUtil\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eclearOptionsState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e변경 후\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre class=\"language-typescript optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"language-typescript code-highlight\"\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// 명시적 클릭 시에만 저장하므로 삭제 로직 불필요\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// 히스토리는 사용 후 자동으로 관리됨\u003c/span\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\u003cspan class=\"token comment\"\u003e// pathname 기반 키로 충돌 방지\u003c/span\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 이미지 과다 요청 문제 해결 (5~10배 → 정상)\u003c/li\u003e\n\u003cli\u003e✅ 히스토리 삭제 플래그 제거로 복잡도 감소\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"7-페이지-레벨-스크롤-복원-책임-이전\"\u003e7. 페이지 레벨 스크롤 복원 책임 이전\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#7-페이지-레벨-스크롤-복원-책임-이전\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e변경 전\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCorePack에서 페이지 레벨 스크롤 복원 처리\u003c/li\u003e\n\u003cli\u003e모듈 간 일관성 부족\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e변경 후\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e버티컬레이아웃(VerticalLayoutWrapper)에서 스크롤 복원 처리\u003c/li\u003e\n\u003cli\u003eCorePack은 모듈 단위로만 제공\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e효과\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 책임 분리로 코드 가독성 향상\u003c/li\u003e\n\u003cli\u003e✅ 모듈 간 일관성 확보\u003c/li\u003e\n\u003cli\u003e✅ 불필요한 플래그 값 제거\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"️-아키텍처-개선\"\u003e🏗️ 아키텍처 개선\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#️-아키텍처-개선\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"변경-전-구조\"\u003e변경 전 구조\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#변경-전-구조\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cpre class=\"optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eCorePack\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e├── 페이지 레벨 스크롤 복원 (pagehide 이벤트)\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e├── 모듈별 다른 키 체계\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e└── 히스토리 삭제 플래그 관리\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"변경-후-구조\"\u003e변경 후 구조\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#변경-후-구조\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cpre class=\"optimized-code-block\" style=\"max-height: 600px; overflow-y: auto;\"\u003e\u003ccode class=\"code-highlight\"\u003e\u003cspan class=\"code-line\"\u003eVerticalLayoutWrapper (버티컬레이아웃)\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e├── 명시적 클릭 이벤트 기반 저장\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e├── pathname 기반 통일된 키 체계\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e├── Next.js history.state 덮어쓰기 패치\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e└── BF Cache 대응\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003eCorePack\n\u003c/span\u003e\u003cspan class=\"code-line\"\u003e└── 모듈 단위 스크롤 복원만 제공\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"-핵심-교훈\"\u003e💡 핵심 교훈\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-핵심-교훈\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"1-명시적-이벤트가-암묵적-이벤트보다-안정적\"\u003e1. 명시적 이벤트가 암묵적 이벤트보다 안정적\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#1-명시적-이벤트가-암묵적-이벤트보다-안정적\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003ccode class=\"inline-code\"\u003epagehide\u003c/code\u003e 이벤트는 예측하기 어려운 타이밍에 발생하지만, 명시적 클릭 이벤트는 개발자가 완전히 제어할 수 있습니다. React Strict Mode와 같은 환경에서도 안정적으로 동작합니다.\u003c/p\u003e\n\u003ch3 id=\"2-프레임워크의-기본-동작을-이해해야-함\"\u003e2. 프레임워크의 기본 동작을 이해해야 함\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#2-프레임워크의-기본-동작을-이해해야-함\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eNext.js가 \u003ccode class=\"inline-code\"\u003ehistory.state\u003c/code\u003e를 덮어쓰는 동작을 이해하지 못하면, 사용자 정의 state가 손실될 수 있습니다. 프레임워크의 내부 동작을 이해하고 적절히 패치하는 것이 중요합니다.\u003c/p\u003e\n\u003ch3 id=\"3-bf-cache는-브라우저마다-다르게-동작함\"\u003e3. BF Cache는 브라우저마다 다르게 동작함\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#3-bf-cache는-브라우저마다-다르게-동작함\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eSafari와 Chrome의 BF Cache 동작이 다르며, Dev 모드와 Production 모드에서도 차이가 있습니다. 모든 환경에서 테스트하는 것이 중요합니다.\u003c/p\u003e\n\u003ch3 id=\"4-키-체계의-일관성이-중요함\"\u003e4. 키 체계의 일관성이 중요함\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#4-키-체계의-일관성이-중요함\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e모듈마다 다른 키를 사용하면 히스토리 복원이 제대로 동작하지 않습니다. 통일된 키 체계를 구축하는 것이 중요합니다.\u003c/p\u003e\n\u003ch3 id=\"5-점진적-마이그레이션이-필요함\"\u003e5. 점진적 마이그레이션이 필요함\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#5-점진적-마이그레이션이-필요함\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e7개 모듈에 걸친 대규모 변경은 한 번에 적용하기 어렵습니다. 단계적으로 마이그레이션하고 각 단계마다 검증하는 것이 중요합니다.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"-최종-결과\"\u003e📈 최종 결과\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-최종-결과\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"성능-개선\"\u003e성능 개선\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#성능-개선\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 이미지 요청 횟수: 5~10배 → 정상 수준\u003c/li\u003e\n\u003cli\u003e✅ API 호출 최적화: 204 응답 캐싱 처리로 레이아웃 시프트 해결\u003c/li\u003e\n\u003cli\u003e✅ 히스토리 복원 정확도: 100% 달성\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"코드-품질-개선\"\u003e코드 품질 개선\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#코드-품질-개선\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 히스토리 삭제 플래그 제거로 복잡도 감소\u003c/li\u003e\n\u003cli\u003e✅ 책임 분리로 코드 가독성 향상\u003c/li\u003e\n\u003cli\u003e✅ 통일된 키 체계로 유지보수성 향상\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"사용자-경험-개선\"\u003e사용자 경험 개선\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#사용자-경험-개선\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e✅ 스크롤 위치 정확도 향상\u003c/li\u003e\n\u003cli\u003e✅ 뒤로가기 시 상태 완벽 복원\u003c/li\u003e\n\u003cli\u003e✅ 모든 브라우저에서 일관된 동작\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"-결론\"\u003e🎯 결론\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-결론\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e7개 모듈에 걸친 히스토리 복원 시스템 재설계를 통해 다음과 같은 성과를 달성했습니다:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e✅ \u003cstrong\u003e명시적 클릭 이벤트 기반 저장 시스템\u003c/strong\u003e으로 React Strict Mode 문제 해결\u003c/li\u003e\n\u003cli\u003e✅ \u003cstrong\u003epathname 기반 통일된 키 체계\u003c/strong\u003e로 모듈 간 일관성 확보\u003c/li\u003e\n\u003cli\u003e✅ \u003cstrong\u003eNext.js history.state 덮어쓰기 패치\u003c/strong\u003e로 CSR 환경 안정성 확보\u003c/li\u003e\n\u003cli\u003e✅ \u003cstrong\u003eBF Cache 대응\u003c/strong\u003e으로 모든 브라우저 호환성 확보\u003c/li\u003e\n\u003cli\u003e✅ \u003cstrong\u003e스크롤 복원 위치 보정\u003c/strong\u003e으로 사용자 경험 향상\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e이번 작업을 통해 대규모 모노레포에서의 히스토리 복원 시스템 설계 경험을 쌓았고, React Strict Mode, Next.js 내부 동작, BF Cache 등 다양한 기술적 도전을 해결할 수 있었습니다.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"-참고-자료\"\u003e📚 참고 자료\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#-참고-자료\"\u003e\u003cspan class=\"anchor\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://nextjs.org/docs/app/building-your-application/routing\"\u003eNext.js Documentation - Routing\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/History_API\"\u003eMDN Web Docs - History API\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://web.dev/bfcache/\"\u003eMDN Web Docs - Back/Forward Cache\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://react.dev/reference/react/StrictMode\"\u003eReact Documentation - Strict Mode\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"4:[\"$\",\"$Ld\",null,{\"post\":{\"slug\":\"/develop/히스토리 복원 시스템 재설계\",\"frontmatter\":{\"title\":\"히스토리 복원 시스템 재설계\",\"date\":\"2025-12-28T00:00:00.000Z\",\"category\":\"develop\",\"tags\":[\"Next.js\",\"React\",\"히스토리복원\",\"BF-Cache\",\"CSR\",\"SSR\",\"모노레포\"],\"draft\":false},\"content\":\"$e\",\"html\":\"$f\",\"excerpt\":\"\u003e Next.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.  ## 📊 프로젝트 개요  - **주요 목표**: 완벽한 히스토리 복원 지원 - **기술 스택**: N\"},\"previousPost\":{\"slug\":\"/book/업무시각화\",\"frontmatter\":{\"title\":\"업무 시각화: 시간 도둑을 잡고 효율적인 업무 흐름 만들기\",\"date\":\"2025-12-27T21:00:00.000Z\",\"category\":\"book\",\"tags\":[\"업무시각화\",\"칸반\",\"생산성\",\"시간관리\",\"프로젝트관리\"],\"draft\":false}},\"nextPost\":{\"slug\":\"/develop/우아한웤플로\",\"frontmatter\":{\"title\":\"우아한웤플로\",\"date\":\"2025-12-28T00:00:00.000Z\",\"category\":\"develop\",\"tags\":[\"자동화\",\"Slack\",\"JIRA\",\"GitLab\",\"워크플로우\",\"협업\",\"프로덕트\",\"DevOps\"],\"draft\":false}}}]\na:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"히스토리 복원 시스템 재설계\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"\u003e Next.js 기반의 히스토리 복원 시스템을 재설계한 경험을 공유합니다. React Strict Mode로 인한 상태 관리 문제, Next.js의 history.state 덮어쓰기 문제, BF Cache 대응 등 다양한 기술적 도전을 해결했습니다.  ## 📊 프로젝트 개요  - **주요 목표**: 완벽한 히스토리 복원 지원 - **기술 스택**: N\"}]]\n3:null\n"])</script></body></html>