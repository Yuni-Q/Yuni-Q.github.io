"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[573],{573:function(e,t,s){s.r(t),s.d(t,{default:function(){return Y}});var a=s(2769),i=s(8439),r=s(3382),n=s(8782);class o{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[],this.createDice()}destroy(){this.eventListeners=[],this.rollAnimationTimers.forEach(e=>{e&&e.remove()}),this.rollAnimationTimers=[],this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop(),this.diceRollSound=null,this.dice.forEach(e=>{e&&e.scene&&e.destroy()}),this.dice=[],this.diceBorders.forEach(e=>{e&&e.scene&&e.destroy()}),this.diceBorders=[],this.diceShadows.forEach(e=>{e&&e.scene&&e.destroy()}),this.diceShadows=[],this.rollPromptTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.rollPromptTexts=[]}addEventListener(e){if(!e)throw TypeError("Listener cannot be null");return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}notifyListeners(e){this.eventListeners.forEach(t=>{try{t(e)}catch(e){console.error("Error in event listener:",e)}})}holdDice(e){if(e<0||e>=5)throw RangeError("Dice index must be between 0 and 4, got ".concat(e));this.sharedState.heldDice[e]=!this.sharedState.heldDice[e],this.notifyListeners({type:"DICE_HELD",diceIndex:e,held:this.sharedState.heldDice[e]}),this.updateDiceAppearance()}updateDiceAppearance(){if(!this.dice||0===this.dice.length)return;if(this.isRolling){this.rollPromptTexts.forEach(e=>{e&&e.scene&&e.setVisible(!1)});for(let e=0;e<5;e++)this.dice[e]&&this.dice[e].scene&&this.dice[e].setVisible(!0);return}let e=this.sharedState.diceValues.some(e=>e>0&&e<=6);if(3===this.sharedState.rollsLeft&&!this.isRolling&&!e&&!this.sharedState.isOnlineMode){for(let e=0;e<5;e++)this.dice[e]&&this.dice[e].scene&&this.dice[e].setVisible(!1),this.diceBorders[e]&&this.diceBorders[e].scene&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].scene&&this.diceShadows[e].setVisible(!1);return}if(!e&&3===this.sharedState.rollsLeft){for(let e=0;e<5;e++)this.dice[e]&&this.dice[e].scene&&this.dice[e].setVisible(!1),this.diceBorders[e]&&this.diceBorders[e].scene&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].scene&&this.diceShadows[e].setVisible(!1);return}this.rollPromptTexts.forEach(e=>{e&&e.scene&&e.setVisible(!1)});for(let e=0;e<5;e++)if(this.dice[e]&&this.dice[e].scene){if(this.sharedState.diceValues[e]<=0||this.sharedState.diceValues[e]>6){this.dice[e].setVisible(!0),this.dice[e].setAlpha(.1),this.diceBorders[e]&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].setVisible(!1);let t="dice1";if(this.scene.textures.exists(t))try{this.dice[e].setTexture(t)}catch(t){console.warn("Failed to set default texture for dice ".concat(e,":"),t)}this.dice[e].input&&this.dice[e].disableInteractive();continue}if(this.dice[e].setVisible(!0),this.dice[e].setAlpha(1),!this.isRolling){let t="dice".concat(this.sharedState.diceValues[e]);if(this.scene.textures.exists(t))try{this.dice[e].setTexture(t)}catch(s){console.warn("Failed to set texture ".concat(t," for dice ").concat(e,":"),s)}}if(this.sharedState.rollsLeft<3&&this.sharedState.rollsLeft>0&&!this.isRolling?(this.dice[e].input?(this.dice[e].setInteractive({useHandCursor:!0}),this.dice[e].removeAllListeners()):this.dice[e].setInteractive({useHandCursor:!0}),n.Wc.setup(this.dice[e],()=>{this.sharedState.rollsLeft<3&&this.sharedState.rollsLeft>0&&!this.isRolling&&this.holdDice(e)})):this.dice[e].input&&this.dice[e].disableInteractive(),this.sharedState.heldDice[e]){let t=this.PLAYER_COLORS_LIGHT[this.sharedState.currentPlayer]||5227511;this.dice[e].clearTint(),this.dice[e].setAlpha(1);let s=this.dice[e].displayWidth||this.dice[e].width,a=Math.max(.08*s,3);if(this.diceBorders[e]&&this.diceBorders[e].scene)this.diceBorders[e].setPosition(this.dice[e].x,this.dice[e].y),this.diceBorders[e].setSize(s+2*a,s+2*a),this.diceBorders[e].setFillStyle(t,.9),this.diceBorders[e].setStrokeStyle(a,t,1),this.diceBorders[e].setVisible(!0),this.diceShadows[e].setPosition(this.dice[e].x+.5*a,this.dice[e].y+.5*a),this.diceShadows[e].setSize(s+2*a,s+2*a),this.diceShadows[e].setVisible(!0);else{let i=this.scene.add.rectangle(this.dice[e].x,this.dice[e].y,s+2*a,s+2*a,t,.9);i.setStrokeStyle(a,t,1),i.setDepth(this.dice[e].depth-1),this.diceBorders[e]=i;let r=this.scene.add.rectangle(this.dice[e].x+.5*a,this.dice[e].y+.5*a,s+2*a,s+2*a,0,.3);r.setDepth(this.dice[e].depth-2),this.diceShadows[e]=r}this.dice[e].setDepth(this.dice[e].depth+1)}else this.dice[e].clearTint(),this.dice[e].setAlpha(1),this.diceBorders[e]&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].setVisible(!1)}}async rollDiceAnimation(){if(this.isRolling)return;this.isRolling=!0;for(let e=0;e<5;e++){if(this.dice[e]&&this.dice[e].scene){if(this.dice[e].setVisible(!0),this.dice[e].setAlpha(1),this.sharedState.diceValues[e]<=0||this.sharedState.diceValues[e]>6){let t="dice1";if(this.scene.textures.exists(t))try{this.dice[e].setTexture(t)}catch(t){console.warn("Failed to set default texture for dice ".concat(e," before animation:"),t)}}else{let t="dice".concat(this.sharedState.diceValues[e]);if(this.scene.textures.exists(t))try{this.dice[e].setTexture(t)}catch(s){console.warn("Failed to set texture ".concat(t," for dice ").concat(e," before animation:"),s)}}}this.diceBorders[e]&&this.diceBorders[e].scene&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].scene&&this.diceShadows[e].setVisible(!1)}this.rollPromptTexts.forEach(e=>{e&&e.scene&&e.setVisible(!1)});let e=[];for(let t=0;t<5;t++)this.sharedState.heldDice[t]&&(e[t]=this.sharedState.diceValues[t]>0?this.sharedState.diceValues[t]:1);return this.diceRollSound||(this.diceRollSound=this.scene.sound.add("diceRoll",{loop:!0,volume:.5})),this.diceRollSound&&!this.diceRollSound.isPlaying&&this.diceRollSound.play(),new Promise(t=>{let s=0,i=this.scene.time.addEvent({delay:50,repeat:9,callback:()=>{for(let t=0;t<5;t++)if(this.dice[t]&&this.dice[t].scene){if(this.sharedState.heldDice[t]&&void 0!==e[t]){let s="dice".concat(e[t]);if(this.scene.textures.exists(s))try{this.dice[t].setTexture(s)}catch(e){console.warn("Failed to set texture ".concat(s," for dice ").concat(t,":"),e)}}else{let e=a.Math.Between(1,6),s="dice".concat(e);if(this.scene.textures.exists(s))try{this.dice[t].setTexture(s)}catch(e){console.warn("Failed to set texture ".concat(s," for dice ").concat(t,":"),e)}}}if(++s>=10){this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop();for(let e=0;e<5;e++)if(this.dice[e]&&this.dice[e].scene){if(this.sharedState.diceValues[e]<=0||this.sharedState.diceValues[e]>6){this.dice[e].setVisible(!1),this.diceBorders[e]&&this.diceBorders[e].setVisible(!1),this.diceShadows[e]&&this.diceShadows[e].setVisible(!1);continue}let t="dice".concat(this.sharedState.diceValues[e]);if(this.scene.textures.exists(t))try{this.dice[e].setTexture(t),this.dice[e].setVisible(!0)}catch(s){console.warn("Failed to set final texture ".concat(t," for dice ").concat(e,":"),s)}}this.updateDiceAppearance(),t()}}});this.rollAnimationTimers.push(i)})}getDice(){return this.dice}getDiceBorders(){return this.diceBorders}getDiceShadows(){return this.diceShadows}getRollPromptTexts(){return this.rollPromptTexts}getIsRolling(){return this.isRolling}getRollAnimationTimers(){return[...this.rollAnimationTimers]}getDiceRollSound(){return this.diceRollSound}createDice(){let e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=.08*t,a=.1*t;this.diceBorders.forEach(e=>{e&&e.scene&&e.destroy()}),this.diceShadows.forEach(e=>{e&&e.scene&&e.destroy()}),this.diceBorders=[],this.diceShadows=[];let i=.05*e+s/2,r=.08*t+.035*t+.02*t+.07*t;for(let e=0;e<5;e++){let t=r+e*a,o="dice".concat(this.sharedState.diceValues[e]),l=this.scene.textures.exists(o)?o:"dice1",c=this.scene.add.image(i,t,l).setDisplaySize(s,s).setOrigin(.5).setInteractive({useHandCursor:!0});this.sharedState.diceValues[e]<=0||this.sharedState.diceValues[e]>6?c.setAlpha(.3):c.setAlpha(1),this.scene.textures.exists(o)||this.scene.time.delayedCall(50,()=>{if(c&&c.scene&&this.scene.textures.exists(o))try{c.setTexture(o)}catch(t){console.warn("Failed to update texture for dice ".concat(e,":"),t)}}),n.Wc.setup(c,()=>{this.sharedState.rollsLeft<3&&this.sharedState.rollsLeft>0&&!this.isRolling&&this.holdDice(e)}),this.dice.push(c),this.diceBorders.push(null),this.diceShadows.push(null)}this.updateDiceAppearance()}constructor(){this.dice=[],this.diceBorders=[],this.diceShadows=[],this.rollPromptTexts=[],this.rollAnimationTimers=[],this.diceRollSound=null,this.isRolling=!1,this.eventListeners=[],this.PLAYER_COLORS_LIGHT=[5227511,15684432,16771899,12216520]}}let l=["Aces","Twos","Threes","Fours","Fives","Sixes","ThreeOfAKind","FourOfAKind","FullHouse","SmallStraight","LargeStraight","Yacht","Chance"],c={Aces:"Aces",Twos:"Twos",Threes:"Threes",Fours:"Fours",Fives:"Fives",Sixes:"Sixes",ThreeOfAKind:"3 of a Kind",FourOfAKind:"4 of a Kind",FullHouse:"Full House",SmallStraight:"Small Str",LargeStraight:"Large Str",Yacht:"Yacht",Chance:"Chance"},h=[2201331,16007990,16761095,10233776],d=[6600182,15037299,16766287,12216520];class u{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[],this.scorecardScrollY=0}destroy(){this.eventListeners=[],this.scorecardTexts.forEach(e=>{e.forEach(e=>{e&&e.scene&&e.destroy()})}),this.scorecardTexts.clear(),this.upperTotalTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.upperTotalTexts=[],this.bonusTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.bonusTexts=[],this.lowerTotalTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.lowerTotalTexts=[],this.totalTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.totalTexts=[],this.playerHeaders.forEach(e=>{e&&e.scene&&e.destroy()}),this.playerHeaders=[],this.playerHeaderBgs.forEach(e=>{e&&e.scene&&e.destroy()}),this.playerHeaderBgs=[],this.scorecardContainer&&this.scorecardContainer.scene&&this.scorecardContainer.destroy(!0),this.scorecardMask&&this.scorecardMask.scene&&this.scorecardMask.destroy()}addEventListener(e){if(!e)throw TypeError("Listener cannot be null");return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}notifyListeners(e){this.eventListeners.forEach(t=>{try{t(e)}catch(e){console.error("Error in event listener:",e)}})}updateScorecardText(){if(!this.scorecardTexts||0===this.scorecardTexts.size)return;let e=this.scene.cameras.main.width,t=this.categoryColWidth||140,s=this.playerColWidth||90,i=t+s*this.sharedState.numberOfPlayers,r=this.scorecardStartX||e-40-i;for(let e of l){let i=this.scorecardTexts.get(e);if(i){for(;i.length>this.sharedState.numberOfPlayers;){let e=i.pop();e&&e.active&&e.destroy()}for(let n=0;n<this.sharedState.numberOfPlayers;n++){this.sharedState.scores.length<=n&&this.sharedState.scores.push(new Map);let o=this.sharedState.scores[n],l=i[n];if(!o||!l||!l.active||!l.scene)continue;let c=o.get(e),u=r+t+s/2+n*s,g=this.scene.children.list.find(e=>1>Math.abs(e.x-u)&&1>Math.abs(e.y-l.y)&&"Rectangle"===e.type);if(void 0!==c){try{l.setText(c.toString()).setColor("#aaa")}catch(t){console.warn("Failed to set score text for player ".concat(n,", category ").concat(e,":"),t);continue}if(g){let e=h[n]||1710618,t=a.Display.Color.GetColor32(Math.floor(.15*a.Display.Color.ValueToColor(e).r),Math.floor(.15*a.Display.Color.ValueToColor(e).g),Math.floor(.15*a.Display.Color.ValueToColor(e).b),255);g.setFillStyle(t,.3)}n===this.sharedState.currentPlayer&&(l.removeInteractive(),g&&g.removeInteractive())}else if(n===this.sharedState.currentPlayer&&this.sharedState.rollsLeft<3&&this.potentialScores.size>0){let t=this.potentialScores.get(e)||0,s=h[n]||5025616,a=d[n]||6732650,i="#".concat(s.toString(16).padStart(6,"0"));try{l.setText(t>0?"(".concat(t,")"):"-").setColor(t>0?i:"#888")}catch(t){console.warn("Failed to set potential score text for player ".concat(n,", category ").concat(e,":"),t);continue}g&&(g.setFillStyle(s,.6),g.setStrokeStyle(1,a)),l.setInteractive({useHandCursor:!0}),g&&g.setInteractive({useHandCursor:!0})}else{try{l.setText("-").setColor("#666")}catch(t){console.warn("Failed to set text for player ".concat(n,", category ").concat(e,":"),t);continue}if(g){let e=h[n]||1710618,t=a.Display.Color.GetColor32(Math.floor(.15*a.Display.Color.ValueToColor(e).r),Math.floor(.15*a.Display.Color.ValueToColor(e).g),Math.floor(.15*a.Display.Color.ValueToColor(e).b),255);g.setFillStyle(t,.3)}n===this.sharedState.currentPlayer&&(l.removeInteractive(),g&&g.removeInteractive())}}}}this.notifyListeners({type:"SCORECARD_UPDATED"})}handleScroll(e){let t=this.scene.cameras.main.height;this.scorecardScrollY=a.Math.Clamp(this.scorecardScrollY-.5*e,-Math.max(0,.8*t-(.5*t-.03*t)),0),this.scorecardContainer&&(this.scorecardContainer.setX(this.scorecardStartX),this.scorecardContainer.setY(this.containerStartY+this.scorecardScrollY))}getScorecardTexts(){return this.scorecardTexts}getScorecardContainer(){return this.scorecardContainer}getScorecardMask(){return this.scorecardMask}getScorecardScrollY(){return this.scorecardScrollY}setScorecardScrollY(e){this.scorecardScrollY=e,this.scorecardContainer&&this.scorecardContainer.setY(this.containerStartY+this.scorecardScrollY)}setPotentialScores(e){this.potentialScores=e}createScorecard(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2?arguments[2]:void 0,i=this.scene.cameras.main.width,r=this.scene.cameras.main.height,n=.05*i,o=.02*i,d=Math.max(n+.08*r+.03*i+.03*i,n+.25*i+.02*i),u=i-d-o,g=Math.min(Math.max(120,.3*u),Math.min(.4*u,200)),p=Math.max((u-g)/this.sharedState.numberOfPlayers,40);this.categoryColWidth=g,this.playerColWidth=p;let S=Math.max(.03*r,20),m=Math.max(.016*r,12),y=Math.max(.02*r,14),f=g+p*this.sharedState.numberOfPlayers,b=Math.min(d,i-o-f),C=b+f/2,v=.03*r,M=.08*r+.035*r+.02*r+.07*r,I=M+v,T=Math.max(r-I-.02*r,.3*r),k=v+T;this.scene.add.rectangle(C,M+k/2,f+.01*i*2,k,2434341,.7),this.containerStartY=I-.025*r,this.scorecardStartX=b,this.scorecardContainer=this.scene.add.container(0,0),this.scorecardScrollY=0,this.scorecardContainer.setX(b),this.scorecardContainer.setY(this.containerStartY);let w=.025*r;this.scorecardMask=this.scene.add.graphics(),this.scorecardMask.x=b,this.scorecardMask.y=I-w,this.scorecardMask.clear(),this.scorecardMask.fillStyle(16777215),this.scorecardMask.fillRect(0,0,f,T+w),this.scorecardMask.setVisible(!1);let P=new a.Display.Masks.GeometryMask(this.scene,this.scorecardMask);this.scorecardContainer.setMask(P);let x=b+g/2;this.scene.add.rectangle(x,M,g-2,t?22:25,1710638,.8),this.scene.add.text(x,M,"Category",{fontSize:"".concat(y,"px"),color:"#888",fontStyle:"bold"}).setOrigin(.5),this.playerHeaders&&this.playerHeaders.length>0&&this.playerHeaders.forEach(e=>{e&&e.scene&&e.destroy()}),this.playerHeaderBgs&&this.playerHeaderBgs.length>0&&this.playerHeaderBgs.forEach(e=>{e&&e.scene&&e.destroy()}),this.playerHeaders=[],this.playerHeaderBgs=[];for(let e=0;e<this.sharedState.numberOfPlayers;e++){let s=b+g+p/2+e*p,a=h[e]||3355443,i=this.scene.add.rectangle(s,M,p-4,t?22:25,e===this.sharedState.currentPlayer?a:3355443,e===this.sharedState.currentPlayer?.9:.5),r=this.scene.add.text(s,M,"P".concat(e+1),{fontSize:"".concat(y,"px"),color:e===this.sharedState.currentPlayer?"#fff":"#aaa",fontStyle:"bold"}).setOrigin(.5);this.playerHeaders.push(r),this.playerHeaderBgs.push(i)}let E=Math.max(.02*r,15),D=E+Math.max(.015*r,10),R=this.scene.add.rectangle(f/2,E/2,f,E,0,0).setOrigin(.5,.5);this.scorecardContainer.add(R);let G=this.scene.add.rectangle(g/2,D,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(G);let O=this.scene.add.text(g/2,D,"UPPER",{fontSize:"".concat(m,"px"),color:"#4CAF50",fontStyle:"bold"}).setOrigin(.5);this.scorecardContainer.add(O);let L=Math.max(.025*r,15);l.slice(0,6).forEach((e,t)=>{let a=D+L+t*S,i=this.scene.add.rectangle(g/2,a,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(i);let r=this.scene.add.text(g/2,a,c[e],{fontSize:"".concat(m,"px"),color:"#ddd"}).setOrigin(.5,.5);this.scorecardContainer.add(r),this.createScorecardRow(e,a,g,p,m,!0,0,s)});let B=Math.max(.015*r,10),A=D+L+6*S+B,H=this.scene.add.rectangle(g/2,A,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(H);let F=this.scene.add.text(g/2,A,"Total",{fontSize:"".concat(m,"px"),color:"#aaa",fontStyle:"bold"}).setOrigin(.5,.5);this.scorecardContainer.add(F);let z=Math.max(.02*r,12),N=this.scene.add.rectangle(g/2,A+z,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(N);let _=this.scene.add.text(g/2,A+z,"Bonus",{fontSize:"".concat(m,"px"),color:"#aaa",fontStyle:"bold"}).setOrigin(.5,.5);this.scorecardContainer.add(_);for(let e=0;e<this.sharedState.numberOfPlayers;e++){let t=g+p/2+e*p;this.upperTotalTexts[e]=this.scene.add.text(t,A,"0",{fontSize:"".concat(m,"px"),fontStyle:"bold"}).setOrigin(.5,.5),this.scorecardContainer.add(this.upperTotalTexts[e]),this.bonusTexts[e]=this.scene.add.text(t,A+z,"0",{fontSize:"".concat(m,"px"),color:"#FFC107",fontStyle:"bold"}).setOrigin(.5,.5),this.scorecardContainer.add(this.bonusTexts[e])}let U=A+z+Math.max(.03*r,20),Y=this.scene.add.rectangle(g/2,U,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(Y);let V=this.scene.add.text(g/2,U,"LOWER",{fontSize:"".concat(m,"px"),color:"#2196F3",fontStyle:"bold"}).setOrigin(.5);this.scorecardContainer.add(V),l.slice(6).forEach((e,t)=>{let a=U+L+t*S,i=this.scene.add.rectangle(g/2,a,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(i);let r=this.scene.add.text(g/2,a,c[e],{fontSize:"".concat(m,"px"),color:"#ddd"}).setOrigin(.5,.5);this.scorecardContainer.add(r),this.createScorecardRow(e,a,g,p,m,!0,0,s)});let K=U+L+7*S+B,X=this.scene.add.rectangle(g/2,K,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(X);let W=this.scene.add.text(g/2,K,"Total",{fontSize:"".concat(m,"px"),color:"#aaa",fontStyle:"bold"}).setOrigin(.5,.5);this.scorecardContainer.add(W);let j=K+(t?18:22),q=this.scene.add.rectangle(g/2,j,g-2,S-2,1710638,.8).setOrigin(.5,.5);this.scorecardContainer.add(q);let J=this.scene.add.text(g/2,j,"TOTAL",{fontSize:"".concat(t?Math.max(11,13*e):13,"px"),color:"#4CAF50",fontStyle:"bold"}).setOrigin(.5,.5);this.scorecardContainer.add(J);for(let s=0;s<this.sharedState.numberOfPlayers;s++){let a=g+p/2+s*p;this.lowerTotalTexts[s]=this.scene.add.text(a,K,"0",{fontSize:"".concat(m,"px"),fontStyle:"bold"}).setOrigin(.5,.5),this.scorecardContainer.add(this.lowerTotalTexts[s]);let i=t?Math.max(12,14*e):14;this.totalTexts[s]=this.scene.add.text(a,K+(t?18:22),"0",{fontSize:"".concat(i,"px"),color:"#4CAF50",fontStyle:"bold"}).setOrigin(.5,.5),this.scorecardContainer.add(this.totalTexts[s])}let Q=Math.max(.02*r,15),Z=K+(t?18:22)+Q/2,$=this.scene.add.rectangle(f/2,Z,f,Q,0,0).setOrigin(.5,.5);this.scorecardContainer.add($),this.notifyListeners({type:"TOTAL_TEXTS_CREATED",upperTotalTexts:this.upperTotalTexts,bonusTexts:this.bonusTexts,lowerTotalTexts:this.lowerTotalTexts,totalTexts:this.totalTexts});let ee=this.scene.add.rectangle(C,I+T/2,f+.01*i*2,T,0,0).setInteractive({useHandCursor:!1}).setOrigin(.5).setVisible(!1),et=!1,es=0,ea=0,ei=null,er=()=>{let e=ee.getBounds();ei=new a.Geom.Rectangle(e.x,e.y,e.width,e.height)};er();let en=(e,t)=>{if(!(null==s?void 0:s.rollButtonBg)||!s.rollButtonBg.active)return!1;let a=s.rollButtonBg.getBounds();return a&&a.contains(e,t)},eo=(e,t)=>{if(!(null==s?void 0:s.dice)||0===s.dice.length)return!1;for(let a of s.dice)if(a&&a.active){let s=a.getBounds();if(s&&s.contains(e,t))return!0}return!1},el=(e,t)=>{if(!this.scorecardContainer||!this.scorecardContainer.active)return!1;if(this.scorecardTexts){for(let[s,a]of Array.from(this.scorecardTexts.entries()))for(let s of a)if(s&&s.active){let a=s.getBounds();if(a&&a.contains(e,t))return!0}}return!1};this.scene.input.on("pointerdown",e=>{!(en(e.x,e.y)||eo(e.x,e.y)||el(e.x,e.y))&&ei&&ei.contains(e.x,e.y)&&(et=!0,es=e.y,ea=this.scorecardScrollY)}),this.scene.input.on("pointermove",e=>{if(et&&e.isDown&&ei){if(en(e.x,e.y)||eo(e.x,e.y)||el(e.x,e.y)){et=!1;return}if(ei.contains(e.x,e.y)){let s=e.y-es;if(Math.abs(s)>10){let e=Math.max(0,K+(t?18:22)+Math.max(.02*r,15)-T);this.scorecardScrollY=a.Math.Clamp(ea+s,-e,0),this.scorecardContainer.setX(this.scorecardStartX),this.scorecardContainer.setY(this.containerStartY+this.scorecardScrollY)}}else et=!1}}),this.scene.input.on("pointerup",()=>{et=!1,es=0,ea=0}),this.scene.input.on("pointercancel",()=>{et=!1,es=0,ea=0}),this.scene.input.on("wheel",(e,s,i,n)=>{if(ei&&ei.contains(e.x,e.y)){let e=Math.max(0,K+(t?18:22)+Math.max(.02*r,15)-(T-v));this.scorecardScrollY=a.Math.Clamp(this.scorecardScrollY-.5*n,-e,0),this.scorecardContainer.setX(this.scorecardStartX),this.scorecardContainer.setY(this.containerStartY+this.scorecardScrollY)}}),this.scene.scale.on("resize",()=>{er()})}createScorecardRow(e,t,s,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:11,o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7?arguments[7]:void 0,d=[],u=Math.max(.03*this.scene.cameras.main.height,20);for(let g=0;g<this.sharedState.numberOfPlayers;g++){let p=o?s+i/2+g*i:l+s+i/2+g*i,S=h[g]||1710618,m=g===this.sharedState.currentPlayer?S:a.Display.Color.GetColor32(Math.floor(.15*a.Display.Color.ValueToColor(S).r),Math.floor(.15*a.Display.Color.ValueToColor(S).g),Math.floor(.15*a.Display.Color.ValueToColor(S).b),255),y=this.scene.add.rectangle(p,t,i-4,u,m,g===this.sharedState.currentPlayer?.6:.3).setInteractive({useHandCursor:!0});(null==c?void 0:c.selectCategory)&&n.Wc.setup(y,()=>{let t=g===this.sharedState.currentPlayer;this.sharedState.isOnlineMode&&c.roomInfo&&this.sharedState.playerId&&(t=(Array.isArray(c.roomInfo.players)?c.roomInfo.players:Object.values(c.roomInfo.players||{})).findIndex(e=>e.id===this.sharedState.playerId)===this.sharedState.currentPlayer&&g===this.sharedState.currentPlayer),t&&c.selectCategory(e)}),o&&this.scorecardContainer.add(y);let f=this.scene.add.text(p,t,"-",{fontSize:"".concat(r,"px"),color:"#fff"}).setOrigin(.5,.5).setInteractive({useHandCursor:!0});(null==c?void 0:c.selectCategory)&&n.Wc.setup(f,()=>{let t=g===this.sharedState.currentPlayer;if(this.sharedState.isOnlineMode&&c.roomInfo&&this.sharedState.playerId){let e=(Array.isArray(c.roomInfo.players)?c.roomInfo.players:Object.values(c.roomInfo.players||{})).findIndex(e=>e.id===this.sharedState.playerId);t=e===this.sharedState.currentPlayer&&g===e}t&&c.selectCategory(e)}),o&&this.scorecardContainer.add(f),d.push(f)}this.scorecardTexts.set(e,d)}getUpperTotalTexts(){return this.upperTotalTexts}getBonusTexts(){return this.bonusTexts}getLowerTotalTexts(){return this.lowerTotalTexts}getTotalTexts(){return this.totalTexts}getPlayerHeaders(){return this.playerHeaders}getPlayerHeaderBgs(){return this.playerHeaderBgs}constructor(){this.scorecardTexts=new Map,this.upperTotalTexts=[],this.bonusTexts=[],this.lowerTotalTexts=[],this.totalTexts=[],this.playerHeaders=[],this.playerHeaderBgs=[],this.scorecardScrollY=0,this.scorecardStartX=0,this.containerStartY=0,this.categoryColWidth=0,this.playerColWidth=0,this.potentialScores=new Map,this.eventListeners=[]}}var g=s(294),p=s(7135);class S{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.eventListeners=[],this.screenElements=[],this.selectedPlayerCount=0,this.playerButtonBgs=[],this.playerButtonTexts=[],this.gameSelectionManager=new g.m,this.gameSelectionManager.initialize(e,t),this.gameSelectionManager.setSceneCallbacks({onGameSelected:e=>{var t;(null===(t=this.sceneCallbacks)||void 0===t?void 0:t.onGameSelected)&&this.sceneCallbacks.onGameSelected(e)},onGameSelectionCancelled:()=>{var t;this.showDeviceSelectionScreen(e.cameras.main.width/2,e.cameras.main.height/2,1,!1,{onSingleDeviceSelected:()=>{this.showGameSelectionForSingleDevice()},onMultiDeviceSelected:()=>{this.showGameSelectionForMultiDevice()}}),(null===(t=this.sceneCallbacks)||void 0===t?void 0:t.onGameSelectionCancelled)&&this.sceneCallbacks.onGameSelectionCancelled()}})}setSceneCallbacks(e){this.sceneCallbacks={...this.sceneCallbacks,...e}}destroy(){this.eventListeners=[],this.hideCurrentScreen(),this.gameSelectionManager&&(this.gameSelectionManager.destroy(),this.gameSelectionManager=void 0),this.selectedPlayerCount=0,this.playerButtonBgs=[],this.playerButtonTexts=[],this.startButtonBg=void 0,this.startButtonText=void 0}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}hideCurrentScreen(){this.screenElements.forEach(e=>{e&&e.scene&&(e instanceof a.GameObjects.Container&&e.removeAll(!0),e.destroy())}),this.screenElements=[],this.gameSelectionManager&&"function"==typeof this.gameSelectionManager.clearGameSelectionUI&&this.gameSelectionManager.clearGameSelectionUI(),p.F.clearUI(this.scene)}showDeviceSelectionScreen(e,t,s,a,i){this.hideCurrentScreen();let r=this.scene.cameras.main.width,n=this.scene.cameras.main.height,o=this.scene.add.rectangle(e,t,r-40,n-40,1710618,.95);this.screenElements.push(o);let l=this.scene.add.text(e,t-150*s,"YACHT DICE",{fontSize:"".concat(a?Math.max(24,36*s):36,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.screenElements.push(l);let c=a?70:80,h=a?Math.max(18,22*s):22,d=a?30:40,u=this.scene.add.text(0,0,"\uD83D\uDCF1 하나의 기기에서 플레이",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),g=u.width;u.destroy();let p=this.scene.add.text(0,0,"\uD83C\uDF10 여러 기기에서 플레이",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),S=p.width;p.destroy();let m=Math.max(Math.max(g,S)+2*(a?30:40),a?250:300),y=t-c/2-d/2,f=y+c/2+d+c/2,b=this.scene.add.rectangle(e,y,m,c,5025616,.9).setStrokeStyle(3,6732650).setInteractive({useHandCursor:!0}).setDepth(1e3).on("pointerdown",()=>{(null==i?void 0:i.onSingleDeviceSelected)&&i.onSingleDeviceSelected(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"PLAYER_SELECTION"})}).on("pointerover",()=>{b.setFillStyle(4563017,.9)}).on("pointerout",()=>{b.setFillStyle(5025616,.9)});this.screenElements.push(b);let C=this.scene.add.text(e,y,"\uD83D\uDCF1 하나의 기기에서 플레이",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(1001).on("pointerdown",()=>{this.showGameSelectionForSingleDevice(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"GAME_SELECTION"})}).on("pointerover",()=>{b.setFillStyle(4563017,.9)}).on("pointerout",()=>{b.setFillStyle(5025616,.9)});this.screenElements.push(C);let v=this.scene.add.rectangle(e,f,m,c,2201331,.9).setStrokeStyle(3,6600182).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==i?void 0:i.onMultiDeviceSelected)&&i.onMultiDeviceSelected(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"ONLINE_MODE_SELECTION"})}).on("pointerover",()=>{v.setFillStyle(1668818,.9)}).on("pointerout",()=>{v.setFillStyle(2201331,.9)});this.screenElements.push(v);let M=this.scene.add.text(e,f,"\uD83C\uDF10 여러 기기에서 플레이",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(1001).on("pointerdown",()=>{this.showGameSelectionForMultiDevice(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"GAME_SELECTION"})}).on("pointerover",()=>{v.setFillStyle(1668818,.9)}).on("pointerout",()=>{v.setFillStyle(2201331,.9)});this.screenElements.push(M),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"DEVICE_SELECTION"})}showPlayerSelectionScreen(e,t,s,a,i){this.hideCurrentScreen();let r=this.scene.cameras.main.width,n=this.scene.cameras.main.height,o=this.scene.add.rectangle(e,t,r-40,n-40,1710618,.95);this.screenElements.push(o);let l=this.scene.add.text(e,t-150*s,"YACHT DICE",{fontSize:"".concat(a?Math.max(24,36*s):36,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.screenElements.push(l);let c=t-100*s,h=this.scene.add.text(e,c,"플레이어 수 선택",{fontSize:"".concat(a?Math.max(14,18*s):18,"px"),color:"#aaa"}).setOrigin(.5);this.screenElements.push(h);let d=h.height,u=a?40:50,g=c+d/2+8+u/2,p=this.scene.add.rectangle(e,g,a?120:150,u,6710886,.8).setStrokeStyle(2,8947848).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==i?void 0:i.onBack)&&i.onBack(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"DEVICE_SELECTION"})}).on("pointerover",()=>{p.setFillStyle(5592405,.8)}).on("pointerout",()=>{p.setFillStyle(6710886,.8)});this.screenElements.push(p);let S=this.scene.add.text(e,g,"← 뒤로",{fontSize:"".concat(a?Math.max(14,16*s):16,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==i?void 0:i.onBack)&&i.onBack(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"DEVICE_SELECTION"})}).on("pointerover",()=>{p.setFillStyle(5592405,.8)}).on("pointerout",()=>{p.setFillStyle(6710886,.8)});this.screenElements.push(S);let m=a?75:110,y=a?70:90,f=a?50:60,b=a?Math.max(20,24*s):24,C=e-(3*m+y)/2+y/2,v=g+u/2+8+f/2;for(let e=1;e<=4;e++){let t=C+(e-1)*m,s=this.scene.add.rectangle(t,v,y,f,3355443,.8).setStrokeStyle(2,5592405).setInteractive({useHandCursor:!0}).setDepth(1);this.screenElements.push(s),this.playerButtonBgs.push(s);let a=this.scene.add.text(t,v,String(e),{fontSize:"".concat(b,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(2);this.screenElements.push(a),this.playerButtonTexts.push(a);let r=e=>{this.selectedPlayerCount=e,this.playerButtonBgs.forEach(e=>{e.setFillStyle(3355443,.8),e.setStrokeStyle(2,5592405)});let t=e-1;this.playerButtonBgs[t]&&(this.playerButtonBgs[t].setFillStyle(5025616,.9),this.playerButtonBgs[t].setStrokeStyle(3,6732650)),this.startButtonBg&&this.startButtonText&&(this.startButtonBg.setFillStyle(5025616,.9),this.startButtonBg.setStrokeStyle(3,6732650),this.startButtonBg.setInteractive({useHandCursor:!0}),this.startButtonText.setColor("#fff")),(null==i?void 0:i.onPlayerCountSelected)&&i.onPlayerCountSelected(e),this.notifyListeners({type:"PLAYER_COUNT_SELECTED",count:e})};s.on("pointerdown",()=>r(e)),a.on("pointerdown",()=>r(e))}let M=a?50:60,I=v+f/2+Math.max(8,a?40:50)+M/2,T=this.scene.add.rectangle(e,I,a?180:220,M,3355443,.5).setStrokeStyle(2,5592405).setDepth(1);this.screenElements.push(T),this.startButtonBg=T;let k=this.scene.add.text(e,I,"시작",{fontSize:"".concat(a?Math.max(18,22*s):22,"px"),color:"#666",fontStyle:"bold"}).setOrigin(.5).setDepth(2);this.screenElements.push(k),this.startButtonText=k;let w=()=>{0!==this.selectedPlayerCount&&((null==i?void 0:i.onStart)&&i.onStart(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"GAME"}))};T.on("pointerdown",w),k.on("pointerdown",w),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"PLAYER_SELECTION"})}showOnlineModeSelectionScreen(e){this.hideCurrentScreen();let t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,a=t/2,i=s/2,r=Math.min(.8*t,t-12),n=.4*s,o=this.scene.add.rectangle(a,i,r,n,1710618,.95).setStrokeStyle(3,2201331);this.screenElements.push(o);let l=this.scene.add.text(a,i-.3*n,"온라인 멀티플레이어",{fontSize:"".concat(.04*s,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.screenElements.push(l);let c=.06*s,h=.02*s,d=.04*r,u=.02*s,g=i-.1*n,p=g+c+u,S=this.scene.add.text(0,0,"새 룸 만들기",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),m=S.width;S.destroy();let y=this.scene.add.text(0,0,"룸 참가하기",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),f=y.width;y.destroy();let b=this.scene.add.text(0,0,"뒤로",{fontSize:"".concat(.8*h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),C=b.width;b.destroy();let v=Math.max(Math.max(m,f)+2*d,.4*r),M=Math.max(C+2*d,.7*v),I=this.scene.add.rectangle(a,g,v,c,5025616,.9).setStrokeStyle(2,6732650).setDepth(1001).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==e?void 0:e.onCreateRoom)&&e.onCreateRoom()}).on("pointerover",()=>{I.setFillStyle(4563017,.9)}).on("pointerout",()=>{I.setFillStyle(5025616,.9)});this.screenElements.push(I);let T=this.scene.add.text(a,g,"새 룸 만들기",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setDepth(1002).on("pointerover",()=>{I.setFillStyle(4563017,.9)}).on("pointerout",()=>{I.setFillStyle(5025616,.9)});this.screenElements.push(T);let k=this.scene.add.rectangle(a,p,v,c,2201331,.9).setStrokeStyle(2,6600182).setDepth(1001).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==e?void 0:e.onJoinRoom)&&e.onJoinRoom()}).on("pointerover",()=>{k.setFillStyle(1668818,.9)}).on("pointerout",()=>{k.setFillStyle(2201331,.9)});this.screenElements.push(k);let w=this.scene.add.text(a,p,"룸 참가하기",{fontSize:"".concat(h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setDepth(1002).setInteractive({useHandCursor:!0}).on("pointerdown",async()=>{(null==e?void 0:e.onJoinRoom)&&e.onJoinRoom()}).on("pointerover",()=>{k.setFillStyle(1668818,.9)}).on("pointerout",()=>{k.setFillStyle(2201331,.9)});this.screenElements.push(w);let P=.7*c,x=this.scene.add.rectangle(a,p+c+u,M,P,6710886,.9).setStrokeStyle(2,8947848).setDepth(1001).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==e?void 0:e.onBack)&&e.onBack(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"DEVICE_SELECTION"})}).on("pointerover",()=>{x.setFillStyle(7829367,.9)}).on("pointerout",()=>{x.setFillStyle(6710886,.9)});this.screenElements.push(x);let E=this.scene.add.text(a,p+c+u,"뒤로",{fontSize:"".concat(.8*h,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setDepth(1002).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{(null==e?void 0:e.onBack)&&e.onBack(),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"DEVICE_SELECTION"})}).on("pointerover",()=>{x.setFillStyle(7829367,.9)}).on("pointerout",()=>{x.setFillStyle(6710886,.9)});this.screenElements.push(E),this.notifyListeners({type:"SCREEN_CHANGED",screenType:"ONLINE_MODE_SELECTION"})}selectSingleDeviceMode(){var e;(null===(e=this.sceneCallbacks)||void 0===e?void 0:e.restartScene)&&this.sceneCallbacks.restartScene({})}selectMultiDeviceMode(){var e;(null===(e=this.sceneCallbacks)||void 0===e?void 0:e.showOnlineModeSelection)&&this.sceneCallbacks.showOnlineModeSelection()}showGameSelectionForSingleDevice(){this.gameSelectionManager&&(this.gameSelectionManager.showGameSelectionScreen(0,!1),this.gameSelectionManager.setSceneCallbacks({onGameSelected:e=>{var t;(null===(t=this.sceneCallbacks)||void 0===t?void 0:t.onGameSelected)&&this.sceneCallbacks.onGameSelected(e)},onGameSelectionCancelled:()=>{let e=this.scene.cameras.main.width/2,t=this.scene.cameras.main.height/2;this.showDeviceSelectionScreen(e,t,1,!1)}}))}showGameSelectionForMultiDevice(){this.gameSelectionManager&&(this.gameSelectionManager.showGameSelectionScreen(1,!0),this.gameSelectionManager.setSceneCallbacks({onGameSelected:e=>{var t;(null===(t=this.sceneCallbacks)||void 0===t?void 0:t.onGameSelected)&&this.sceneCallbacks.onGameSelected(e)},onGameSelectionCancelled:()=>{let e=this.scene.cameras.main.width/2,t=this.scene.cameras.main.height/2;this.showDeviceSelectionScreen(e,t,1,!1)}}))}showGameSelectionForChangeGame(e,t,s){this.gameSelectionManager&&(this.gameSelectionManager.showGameSelectionScreen(e,!1),this.gameSelectionManager.setSceneCallbacks({onGameSelected:async e=>{await t(e)},onGameSelectionCancelled:()=>{s()}}))}notifyListeners(e){this.eventListeners.forEach(t=>t(e))}constructor(){this.eventListeners=[],this.screenElements=[],this.selectedPlayerCount=0,this.playerButtonBgs=[],this.playerButtonTexts=[]}}let m=[2201331,16007990,16761095,10233776],y=[6600182,15037299,16766287,12216520];class f{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[]}destroy(){this.eventListeners=[],this.rollButton&&this.rollButton.scene&&this.rollButton.destroy(),this.rollButtonBg&&this.rollButtonBg.scene&&this.rollButtonBg.destroy()}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}createRollButton(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1];let e=arguments.length>2?arguments[2]:void 0,t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,a=.25*t,i=.06*s,r=this.sharedState.numberOfPlayers*s*.022,o=.08*s+.035*s+r+.07*s+.1*s*4+.08*s/2+.06*s+i/2,l=.05*t+a/2,c=m[this.sharedState.currentPlayer]||5025616,h=y[this.sharedState.currentPlayer]||6732650;this.rollButtonBg=this.scene.add.rectangle(l,o,a,i,c,.9).setStrokeStyle(2,h).setInteractive({useHandCursor:!0}),n.Wc.setup(this.rollButtonBg,()=>{this.rollButton.text.includes("Roll")?((null==e?void 0:e.onRollClick)&&e.onRollClick(),this.notifyListeners({type:"BUTTON_CLICKED",buttonId:"roll"})):this.rollButton.text.includes("Play Again")&&((null==e?void 0:e.onPlayAgainClick)&&e.onPlayAgainClick(),this.notifyListeners({type:"BUTTON_CLICKED",buttonId:"playAgain"}))}),this.rollButton=this.scene.add.text(l,o,"",{fontSize:"".concat(.025*s,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}),n.Wc.setup(this.rollButton,()=>{this.rollButton.text.includes("Roll")?((null==e?void 0:e.onRollClick)&&e.onRollClick(),this.notifyListeners({type:"BUTTON_CLICKED",buttonId:"roll"})):this.rollButton.text.includes("Play Again")&&((null==e?void 0:e.onPlayAgainClick)&&e.onPlayAgainClick(),this.notifyListeners({type:"BUTTON_CLICKED",buttonId:"playAgain"}))}),this.updateRollButtonText({rollsLeft:this.sharedState.rollsLeft,isRolling:!1,isMyTurn:!0,allDiceHeld:this.sharedState.heldDice.every(e=>!0===e),currentPlayer:this.sharedState.currentPlayer})}updateRollButtonText(e){if(!this.rollButton||!this.rollButton.active)return;let{rollsLeft:t,isRolling:s,isMyTurn:a,allDiceHeld:i,currentPlayer:r}=e,n=this.scene.cameras.main.width<900;this.rollButton.setText(n?"Roll(".concat(t,")"):"Roll Dice(".concat(t," left)"));let o=t>0&&!s&&a&&!i;if(o?(this.rollButton.setInteractive({useHandCursor:!0}),this.rollButtonBg&&this.rollButtonBg.active&&this.rollButtonBg.setInteractive({useHandCursor:!0})):(this.rollButton.disableInteractive(),this.rollButtonBg&&this.rollButtonBg.active&&this.rollButtonBg.disableInteractive()),this.rollButton.setColor(o?"#fff":"#666"),this.rollButtonBg&&this.rollButtonBg.active){let e=m[r]||5025616,t=y[r]||6732650;this.rollButtonBg.setFillStyle(o?e:3355443,o?.9:.5),this.rollButtonBg.setStrokeStyle(2,o?t:5592405)}}setPlayAgainMode(){if(this.rollButton&&this.rollButton.active&&(this.rollButton.setText("Play Again?").setInteractive({useHandCursor:!0}).setColor("#fff"),this.rollButtonBg&&this.rollButtonBg.active)){let e=m[this.sharedState.currentPlayer]||5025616,t=y[this.sharedState.currentPlayer]||6732650;this.rollButtonBg.setFillStyle(e,.9),this.rollButtonBg.setStrokeStyle(2,t)}}getRollButton(){return this.rollButton}getRollButtonBg(){return this.rollButtonBg}notifyListeners(e){this.eventListeners.forEach(t=>t(e))}constructor(){this.eventListeners=[]}}class b{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[],this.unsubscribeFunctions=[]}destroy(){if(this.eventListeners=[],this.unsubscribeFunctions.forEach(e=>{try{e()}catch(e){console.error("Error unsubscribing from Supabase:",e)}}),this.unsubscribeFunctions=[],this.roomId)try{this.supabaseManager.leaveRoom(),this.supabaseManager.cleanup()}catch(e){console.error("Error cleaning up Supabase:",e)}this.roomId=null,this.playerId=null}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}setupOnlineMode(e,t,s){this.roomId=e,this.playerId=t;let a=this.supabaseManager.onGameStateUpdate(e=>{this.syncFromSupabase(e,{onGameStateChanged:null==s?void 0:s.onGameStateChanged})});this.unsubscribeFunctions.push(a);let i=this.supabaseManager.onRoomUpdate(e=>{(null==s?void 0:s.onRoomChanged)&&s.onRoomChanged(e),this.notifyListeners({type:"GAME_STATE_SYNCED"})});this.unsubscribeFunctions.push(i);let r=this.supabaseManager.onPlayerLeft((e,t)=>{(null==s?void 0:s.onPlayerLeft)&&s.onPlayerLeft(e,t)});this.unsubscribeFunctions.push(r),this.scene.events.once("shutdown",()=>{this.destroy()})}syncToSupabase(){if(!this.roomId){console.warn("[GameStateSyncManager] Cannot sync to Supabase: roomId is null");return}console.warn("[GameStateSyncManager] syncToSupabase is not implemented. Use supabaseManager.rollDice(), selectCategory() etc. directly.")}syncFromSupabase(e,t){try{(null==t?void 0:t.onGameStateChanged)&&t.onGameStateChanged(e),"diceValues"in e&&(this.sharedState.diceValues=[...e.diceValues],this.sharedState.heldDice=[...e.heldDice],this.sharedState.rollsLeft=e.rollsLeft,this.sharedState.round=e.currentRound,this.sharedState.currentPlayer=e.currentPlayer),this.notifyListeners({type:"GAME_STATE_SYNCED"})}catch(e){console.error("[GameStateSyncManager] Failed to sync from Supabase:",e),this.handleSyncError(e instanceof Error?e:Error("Unknown error"))}}handleSyncError(e){console.error("[GameStateSyncManager] Sync error:",e),this.notifyListeners({type:"SYNC_ERROR",error:e})}notifyListeners(e){this.eventListeners.forEach(t=>t(e))}getRoomId(){return this.roomId}getPlayerId(){return this.playerId}constructor(){this.eventListeners=[],this.supabaseManager=(0,r.nc)(),this.unsubscribeFunctions=[],this.roomId=null,this.playerId=null}}var C=s(6332);class v{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.sharedState=t}setSceneCallbacks(e){this.sceneCallbacks=e}nextTurn(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let e=this.sceneCallbacks.getCurrentPlayer(),t=this.sceneCallbacks.getNumberOfPlayers(),s=e+1;if(s>=t&&(s=0,this.sharedState.round++),this.sceneCallbacks.setCurrentPlayer(s),this.sceneCallbacks.getScores().every(e=>e.size===l.length)){this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals();let e=this.sceneCallbacks.endGame();e&&"object"==typeof e&&"then"in e&&e.catch(e=>{console.error("Error in endGame:",e)});return}this.sharedState.rollsLeft=3,this.sharedState.heldDice.fill(!1),this.sharedState.diceValues.fill(0),this.sceneCallbacks.getRollAnimationTimers().forEach(e=>e.remove());let a=this.sceneCallbacks.getDiceRollSound();a&&a.isPlaying&&a.stop(),this.sceneCallbacks.getPotentialScores().clear(),this.sceneCallbacks.updateUI(),this.notifyListeners({type:"TURN_CHANGED",currentPlayer:s,round:this.sharedState.round})}endGame(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");this.sceneCallbacks.getButtonManager().setPlayAgainMode(),this.sceneCallbacks.getDice().forEach(e=>e.disableInteractive());let e=this.sceneCallbacks.getScores().map((e,t)=>{let{grandTotal:s}=this.sceneCallbacks.calculateTotalScore(e);return{player:t+1,score:s}});e.sort((e,t)=>t.score-e.score),this.sceneCallbacks.showVictoryPopup(e),this.notifyListeners({type:"GAME_ENDED",finalScores:e})}restartGame(){var e;if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0);let t=this.sceneCallbacks.getRollAnimationTimers();t&&t.length>0&&t.forEach(e=>{e&&e.remove()});let s=this.sceneCallbacks.getDiceRollSound();s&&s.isPlaying&&s.stop(),(null===(e=this.sceneCallbacks)||void 0===e?void 0:e.startScene)&&this.sceneCallbacks.startScene("DeviceSelectionScene"),this.notifyListeners({type:"GAME_RESTARTED"})}goToMainMenu(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0);let e=this.sceneCallbacks.getRollAnimationTimers();e&&e.length>0&&e.forEach(e=>{e&&e.remove()});let t=this.sceneCallbacks.getDiceRollSound();t&&t.isPlaying&&t.stop(),this.sceneCallbacks.startScene("DeviceSelectionScene",{}),this.notifyListeners({type:"MAIN_MENU_REQUESTED"})}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}notifyListeners(e){this.eventListeners.forEach(t=>t(e))}destroy(){this.eventListeners=[],this.sceneCallbacks=void 0}constructor(){this.eventListeners=[]}}let M=[2201331,16007990,16761095,10233776],I=[6600182,15037299,16766287,12216520];class T{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[],this.uiUpdateRequestId=null}setSceneCallbacks(e){this.sceneCallbacks=e}setUIElements(e){void 0!==e.playerScoreTexts&&(this.playerScoreTexts=e.playerScoreTexts),void 0!==e.playerHeaders&&(this.playerHeaders=e.playerHeaders),void 0!==e.playerHeaderBgs&&(this.playerHeaderBgs=e.playerHeaderBgs),void 0!==e.upperTotalTexts&&(this.upperTotalTexts=e.upperTotalTexts),void 0!==e.bonusTexts&&(this.bonusTexts=e.bonusTexts),void 0!==e.lowerTotalTexts&&(this.lowerTotalTexts=e.lowerTotalTexts),void 0!==e.totalTexts&&(this.totalTexts=e.totalTexts)}updateUI(){var e;if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let t=this.sceneCallbacks.getHeaderResult();(null==t?void 0:null===(e=t.info)||void 0===e?void 0:e.round)&&t.info.round.active&&null===this.uiUpdateRequestId&&(this.uiUpdateRequestId=requestAnimationFrame(()=>{this.performUIUpdate(),this.uiUpdateRequestId=null}))}performUIUpdate(){var e;if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let t=this.sceneCallbacks.getHeaderResult();if(!(null==t?void 0:null===(e=t.info)||void 0===e?void 0:e.round)||!t.info.round.active)return;this.sceneCallbacks.updateDiceAppearance(),this.sceneCallbacks.updateRollButtonText(),this.sceneCallbacks.updateScorecardText(),this.updateTotals(),this.updatePlayerHeaders(),this.updatePlayerScores();let s=this.sceneCallbacks.getHeaderManager();t&&s&&s.updateInfo({showTurn:!0,showRound:!0,currentPlayer:this.sceneCallbacks.getCurrentPlayer(),currentRound:this.sharedState.round,maxRounds:13,playerColors:[2201331,16007990,16761095,10233776,5025616],playerColorsLight:[6600182,15037299,16766287,12216520,8505220]},t)}updatePlayerHeaders(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let e=this.sceneCallbacks.getNumberOfPlayers(),t=this.sceneCallbacks.getCurrentPlayer();for(;this.playerHeaders.length>e;){let e=this.playerHeaders.pop(),t=this.playerHeaderBgs.pop();e&&e.destroy(),t&&t.destroy()}if(this.playerHeaders.length<e){console.warn("Player headers count mismatch: ".concat(this.playerHeaders.length," < ").concat(e));return}for(let s=0;s<this.playerHeaders.length&&s<e;s++)if(this.playerHeaders[s]){this.playerHeaders[s].setColor(s===t?"#fff":"#aaa");let e=M[s]||3355443,a=I[s]||5592405;this.playerHeaderBgs[s]&&(this.playerHeaderBgs[s].setFillStyle(s===t?e:3355443,s===t?.9:.5),this.playerHeaderBgs[s].setStrokeStyle(1,s===t?a:5592405))}}updateTotals(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let e=this.sceneCallbacks.getNumberOfPlayers(),t=this.sceneCallbacks.getCurrentPlayer(),s=this.sceneCallbacks.getScores();for(;this.upperTotalTexts.length>e;){let e=this.upperTotalTexts.pop();e&&e.active&&e.destroy()}for(;this.bonusTexts.length>e;){let e=this.bonusTexts.pop();e&&e.active&&e.destroy()}for(;this.lowerTotalTexts.length>e;){let e=this.lowerTotalTexts.pop();e&&e.active&&e.destroy()}for(;this.totalTexts.length>e;){let e=this.totalTexts.pop();e&&e.active&&e.destroy()}for(let a=0;a<e;a++){if(!this.upperTotalTexts[a]||!this.bonusTexts[a]||!this.lowerTotalTexts[a]||!this.totalTexts[a]){console.warn("Total texts array incomplete for player ".concat(a,". Expected ").concat(e," players."));continue}let{upperTotal:i,bonus:r,lowerTotal:n,grandTotal:o}=this.sceneCallbacks.calculateTotalScore(s[a]);this.upperTotalTexts[a].setText(i.toString()),this.bonusTexts[a].setText(r>0?r.toString():"-"),this.lowerTotalTexts[a].setText(n.toString()),this.totalTexts[a].setText(o.toString());let l=a===t?"#0f0":"#fff";this.totalTexts[a].setColor(l)}this.updatePlayerScores()}updatePlayerScores(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");if(0===this.playerScoreTexts.length)return;let e=this.sceneCallbacks.getNumberOfPlayers(),t=this.sceneCallbacks.getCurrentPlayer(),s=this.sceneCallbacks.getScores();for(;this.playerScoreTexts.length>e;){let e=this.playerScoreTexts.pop();e&&e.active&&e.destroy()}for(let a=0;a<e;a++)if(this.playerScoreTexts[a]&&this.playerScoreTexts[a].scene){let{grandTotal:e}=this.sceneCallbacks.calculateTotalScore(s[a]),i=M[a]||16777215,r="#".concat(i.toString(16).padStart(6,"0"));this.playerScoreTexts[a].setText("P".concat(a+1,": ").concat(e)),this.playerScoreTexts[a].setColor(a===t?r:"#888"),this.playerScoreTexts[a].setStyle({fontStyle:a===t?"bold":"normal"})}}createPlayerScores(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");let t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,a=.05*t,i=.08*s+.035*s,r=.016*s,n=e?.15*t:.12*t;this.playerScoreTexts.forEach(e=>e.destroy()),this.playerScoreTexts=[];let o=this.sceneCallbacks.getNumberOfPlayers(),l=this.sceneCallbacks.getCurrentPlayer(),c=this.sceneCallbacks.getScores();for(let t=0;t<o;t++){let{grandTotal:s}=this.sceneCallbacks.calculateTotalScore(c[t]),o=M[t]||16777215,h="#".concat(o.toString(16).padStart(6,"0")),d=e?"P".concat(t+1,":").concat(s):"P".concat(t+1,": ").concat(s),u=this.sceneCallbacks.createHighQualityText(a+t*n,i,d,{fontSize:"".concat(r,"px"),color:t===l?h:"#888",fontStyle:t===l?"bold":"normal"}).setOrigin(0,.5);this.playerScoreTexts.push(u)}}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}toggleFullscreen(){"undefined"!=typeof document&&(document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().catch(e=>{console.error("Error attempting to exit fullscreen:",e)}):this.scene.game.canvas.requestFullscreen&&this.scene.game.canvas.requestFullscreen().catch(e=>{console.error("Error attempting to enable fullscreen:",e)}))}updateFullscreenButton(){var e,t,s,a;if(!this.sceneCallbacks)return;let i=this.sceneCallbacks.getHeaderResult(),r=null==i?void 0:null===(t=i.buttons)||void 0===t?void 0:null===(e=t.fullscreen)||void 0===e?void 0:e.text,n=null==i?void 0:null===(a=i.buttons)||void 0===a?void 0:null===(s=a.fullscreen)||void 0===s?void 0:s.bg,o=this.sceneCallbacks.getIsFullscreen();if(r&&n){let e=this.scene.cameras.main.width<900;r.setText(e?o?"Exit":"FS":o?"Exit Fullscreen":"Fullscreen"),n.setFillStyle(o?16729156:5025616,.9),n.setStrokeStyle(2,o?16737894:6732650)}}setupResizeHandler(){if(!this.sceneCallbacks)return;let e=this.sceneCallbacks.getResizeHandler();e&&window.removeEventListener("resize",e);let t=null,s=()=>{t&&clearTimeout(t),t=setTimeout(()=>{var e,t,s,a;let i=window.innerWidth,r=window.innerHeight;if(this.scene.scale)try{this.scene.scale.resize(i,r)}catch(e){console.warn("Failed to resize game scale:",e)}let n=(null===(e=this.sceneCallbacks)||void 0===e?void 0:e.getIsOnlineMode())||!1,o=(null===(t=this.sceneCallbacks)||void 0===t?void 0:t.getRoomId())||null,l=(null===(s=this.sceneCallbacks)||void 0===s?void 0:s.getRoomInfo())||null,c=(null===(a=this.sceneCallbacks)||void 0===a?void 0:a.getNumberOfPlayersForRestart())||0;this.sceneCallbacks&&(n&&o?this.sceneCallbacks.restartScene({numberOfPlayers:c,isOnlineMode:!0,roomId:o,roomInfo:l}):c>0?this.sceneCallbacks.restartScene({numberOfPlayers:c}):this.sceneCallbacks.restartScene())},300)};this.sceneCallbacks.setResizeHandler(s),window.addEventListener("resize",s)}removeResizeHandler(){if(!this.sceneCallbacks)return;let e=this.sceneCallbacks.getResizeHandler();e&&(window.removeEventListener("resize",e),this.sceneCallbacks.setResizeHandler(null))}disableGameInteractions(){var e,t,s,a,i,r,n,o,l,c,h,d,u,g,p,S,m,y;if(!this.sceneCallbacks)return;let f=this.sceneCallbacks.getDice();f&&f.length>0&&f.forEach(e=>{e&&e.active&&e.disableInteractive()});let b=this.sceneCallbacks.getRollButton();b&&b.active&&b.disableInteractive();let C=this.sceneCallbacks.getHeaderResult();(null==C?void 0:null===(s=C.buttons)||void 0===s?void 0:null===(t=s.mainMenu)||void 0===t?void 0:null===(e=t.text)||void 0===e?void 0:e.active)&&C.buttons.mainMenu.text.disableInteractive(),(null==C?void 0:null===(r=C.buttons)||void 0===r?void 0:null===(i=r.mainMenu)||void 0===i?void 0:null===(a=i.bg)||void 0===a?void 0:a.active)&&C.buttons.mainMenu.bg.disableInteractive(),(null==C?void 0:null===(l=C.buttons)||void 0===l?void 0:null===(o=l.newGame)||void 0===o?void 0:null===(n=o.text)||void 0===n?void 0:n.active)&&C.buttons.newGame.text.disableInteractive(),(null==C?void 0:null===(d=C.buttons)||void 0===d?void 0:null===(h=d.newGame)||void 0===h?void 0:null===(c=h.bg)||void 0===c?void 0:c.active)&&C.buttons.newGame.bg.disableInteractive(),(null==C?void 0:null===(p=C.buttons)||void 0===p?void 0:null===(g=p.fullscreen)||void 0===g?void 0:null===(u=g.text)||void 0===u?void 0:u.active)&&C.buttons.fullscreen.text.disableInteractive(),(null==C?void 0:null===(y=C.buttons)||void 0===y?void 0:null===(m=y.fullscreen)||void 0===m?void 0:null===(S=m.bg)||void 0===S?void 0:S.active)&&C.buttons.fullscreen.bg.disableInteractive(),this.sceneCallbacks.getScorecardTexts().forEach(e=>{e.forEach(e=>{e&&e.active&&e.disableInteractive()})})}enableGameInteractions(){var e,t,s,a,i,r,n,o,l,c,h,d,u,g,p,S,m,y;if(!this.sceneCallbacks)return;let f=this.sceneCallbacks.getDice();f&&f.length>0&&f.forEach(e=>{e&&e.active&&e.setInteractive({useHandCursor:!0})});let b=this.sceneCallbacks.getRollButton(),C=this.sceneCallbacks.getSharedGameState(),v=this.sceneCallbacks.getIsRolling();b&&b.active&&(C.rollsLeft>0&&!v?b.setInteractive({useHandCursor:!0}):b.disableInteractive());let M=this.sceneCallbacks.getHeaderResult();(null==M?void 0:null===(s=M.buttons)||void 0===s?void 0:null===(t=s.mainMenu)||void 0===t?void 0:null===(e=t.text)||void 0===e?void 0:e.active)&&M.buttons.mainMenu.text.setInteractive({useHandCursor:!0}),(null==M?void 0:null===(r=M.buttons)||void 0===r?void 0:null===(i=r.mainMenu)||void 0===i?void 0:null===(a=i.bg)||void 0===a?void 0:a.active)&&M.buttons.mainMenu.bg.setInteractive({useHandCursor:!0}),(null==M?void 0:null===(l=M.buttons)||void 0===l?void 0:null===(o=l.newGame)||void 0===o?void 0:null===(n=o.text)||void 0===n?void 0:n.active)&&M.buttons.newGame.text.setInteractive({useHandCursor:!0}),(null==M?void 0:null===(d=M.buttons)||void 0===d?void 0:null===(h=d.newGame)||void 0===h?void 0:null===(c=h.bg)||void 0===c?void 0:c.active)&&M.buttons.newGame.bg.setInteractive({useHandCursor:!0}),(null==M?void 0:null===(p=M.buttons)||void 0===p?void 0:null===(g=p.fullscreen)||void 0===g?void 0:null===(u=g.text)||void 0===u?void 0:u.active)&&M.buttons.fullscreen.text.setInteractive({useHandCursor:!0}),(null==M?void 0:null===(y=M.buttons)||void 0===y?void 0:null===(m=y.fullscreen)||void 0===m?void 0:null===(S=m.bg)||void 0===S?void 0:S.active)&&M.buttons.fullscreen.bg.setInteractive({useHandCursor:!0}),this.sceneCallbacks.getScorecardTexts().forEach(e=>{e.forEach(e=>{e&&e.active&&e.setInteractive({useHandCursor:!0})})})}showError(e){if(!this.sceneCallbacks)return;let t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,a=this.scene.children.list.find(e=>e.getData&&e.getData("isErrorText"));a&&a.destroy();let i=this.scene.add.text(t/2,.1*s,e,{fontSize:"".concat(.03*s,"px"),color:"#ff4444",fontStyle:"bold"}).setOrigin(.5).setDepth(2e3).setData("isErrorText",!0);this.sceneCallbacks.getGameTime().delayedCall(5e3,()=>{i&&i.scene&&i.destroy()})}destroy(){null!==this.uiUpdateRequestId&&(cancelAnimationFrame(this.uiUpdateRequestId),this.uiUpdateRequestId=null),this.removeResizeHandler(),this.eventListeners=[],this.sceneCallbacks=void 0}constructor(){this.eventListeners=[],this.playerScoreTexts=[],this.playerHeaders=[],this.playerHeaderBgs=[],this.upperTotalTexts=[],this.bonusTexts=[],this.lowerTotalTexts=[],this.totalTexts=[],this.uiUpdateRequestId=null}}class k{calculateScore(e,t){let s=e.getCounts(),a=e.getSum(),i=Array.from(s.values()),r=e.getSortedUniqueValues();switch(t){case"Aces":return{success:!0,value:1*(s.get(1)||0)};case"Twos":return{success:!0,value:2*(s.get(2)||0)};case"Threes":return{success:!0,value:3*(s.get(3)||0)};case"Fours":return{success:!0,value:4*(s.get(4)||0)};case"Fives":return{success:!0,value:5*(s.get(5)||0)};case"Sixes":return{success:!0,value:6*(s.get(6)||0)};case"ThreeOfAKind":return{success:!0,value:i.some(e=>e>=3)?a:0};case"FourOfAKind":return{success:!0,value:i.some(e=>e>=4)?a:0};case"FullHouse":return{success:!0,value:i.includes(3)&&i.includes(2)?25:0};case"Yacht":return{success:!0,value:i.some(e=>5===e)?50:0};case"Chance":return{success:!0,value:a};case"SmallStraight":return{success:!0,value:/1234|2345|3456/.test(r)?30:0};case"LargeStraight":return{success:!0,value:/12345|23456/.test(r)?40:0};default:return{success:!1,error:Error("Unknown category: ".concat(t))}}}calculateTotalScore(e){let t=0;for(let s=0;s<6;s++){let a=e.get(l[s])||0;if(a<0)throw Error("Invalid score for ".concat(l[s],": must be >= 0, got ").concat(a));t+=a}if(t<0)throw Error("Invalid upper total: must be >= 0, got ".concat(t));let s=t>=63?35:0,a=0;for(let t=6;t<l.length;t++){let s=e.get(l[t])||0;if(s<0)throw Error("Invalid score for ".concat(l[t],": must be >= 0, got ").concat(s));a+=s}let i=t+s+a;if(i>375)throw Error("Invalid grand total: exceeds maximum possible score ".concat(375,", got ").concat(i));return{upperTotal:t,bonus:s,lowerTotal:a,grandTotal:i}}}class w{static create(e){return new w(Object.freeze([...e]))}getValues(){return this.values}getSum(){return this.values.reduce((e,t)=>e+t,0)}getCounts(){let e=new Map;return this.values.forEach(t=>{e.set(t,(e.get(t)||0)+1)}),e}getSortedUniqueValues(){return Array.from(new Set(this.values)).sort().join("")}constructor(e){if(this.values=e,5!==e.length)throw Error("DiceRoll must contain exactly 5 dice values");if(e.some(e=>e<1||e>6))throw Error("Dice values must be between 1 and 6")}}class P{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.sharedState=t}calculateTotalScore(e){let t=0;for(let s=0;s<6;s++)t+=e.get(l[s])||0;let s=t>=63?35:0,a=0;for(let t=6;t<l.length;t++)a+=e.get(l[t])||0;let i=t+s+a;return{upperTotal:t,bonus:s,lowerTotal:a,grandTotal:i}}calculatePotentialScores(e){if(!this.sharedState.diceValues.every(e=>e>=1&&e<=6)){for(let t of l)e.set(t,0);return}let t=w.create(this.sharedState.diceValues);for(let s of l){let a=this.scoreCalculator.calculateScore(t,s);a.success?e.set(s,a.value):e.set(s,0)}}getDiceCounts(){return this.sharedState.diceValues.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{})}destroy(){}constructor(){this.scoreCalculator=new k}}class x{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[]}setSceneCallbacks(e){this.sceneCallbacks=e}setupKeyboardNavigation(){this.scene.input.keyboard&&this.sceneCallbacks&&(this.scene.input.keyboard.on("keydown-SPACE",()=>{var e;this.sharedState.rollsLeft>0&&!this.sceneCallbacks.getIsRolling()&&(null===(e=this.sceneCallbacks.getRollButton())||void 0===e?void 0:e.active)&&this.sceneCallbacks.rollDice()}),this.scene.input.keyboard.on("keydown-ENTER",()=>{var e;this.sharedState.rollsLeft>0&&!this.sceneCallbacks.getIsRolling()&&(null===(e=this.sceneCallbacks.getRollButton())||void 0===e?void 0:e.active)&&this.sceneCallbacks.rollDice()}),[a.Input.Keyboard.KeyCodes.ONE,a.Input.Keyboard.KeyCodes.TWO,a.Input.Keyboard.KeyCodes.THREE,a.Input.Keyboard.KeyCodes.FOUR,a.Input.Keyboard.KeyCodes.FIVE].forEach((e,t)=>{var s;let a=null===(s=this.scene.input.keyboard)||void 0===s?void 0:s.addKey(e);a&&a.on("down",()=>{var e;let s=this.sceneCallbacks.getDice();this.sharedState.rollsLeft<3&&this.sharedState.rollsLeft>0&&!this.sceneCallbacks.getIsRolling()&&(null===(e=s[t])||void 0===e?void 0:e.active)&&this.sceneCallbacks.toggleDiceHold(t)})}),[a.Input.Keyboard.KeyCodes.SIX,a.Input.Keyboard.KeyCodes.SEVEN,a.Input.Keyboard.KeyCodes.EIGHT,a.Input.Keyboard.KeyCodes.NINE,a.Input.Keyboard.KeyCodes.ZERO].forEach((e,t)=>{var s;let a=null===(s=this.scene.input.keyboard)||void 0===s?void 0:s.addKey(e);a&&a.on("down",()=>{let e=Array.from(l),s=this.sceneCallbacks.getPotentialScores();e[t]&&s.has(e[t])&&this.sceneCallbacks.selectCategory(e[t])})}),this.scene.input.keyboard.on("keydown-ESC",()=>{var e,t,s;let a=this.sceneCallbacks.getHeaderResult();(null==a?void 0:null===(s=a.buttons)||void 0===s?void 0:null===(t=s.mainMenu)||void 0===t?void 0:null===(e=t.text)||void 0===e?void 0:e.active)&&this.sceneCallbacks.showMainMenuConfirmPopup()}))}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}destroy(){this.eventListeners=[],this.sceneCallbacks=void 0}constructor(){this.eventListeners=[]}}class E{execute(e,t){if(!e||0===e.length)throw Error("heldDice array cannot be empty");if(!t||0===t.length)throw Error("currentDice array cannot be empty");let s=[...t],a=[...e],i=5-a.filter(e=>e).length;if(0===i)return{newDice:s,heldDice:a};let r=this.diceRoller.rollDice(i),n=0;for(let e=0;e<s.length;e++)!a[e]&&(s[e]=r[n],n++);return{newDice:s,heldDice:a}}constructor(e){this.diceRoller=e}}class D{execute(e,t,s){if(!e||0===e.length)return{success:!1,error:Error("Dice values cannot be empty")};if(!s)return{success:!1,error:Error("Player scores cannot be null")};if(s.has(t))return{success:!1,error:Error("Category ".concat(t," already selected"))};let a=w.create(e);return this.calculator.calculateScore(a,t)}constructor(e){this.calculator=e||new k}}class R{addEventListener(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(e){this.listeners.forEach(t=>t(e))}async rollDice(){if(void 0!==this.gameState.rollsLeft&&this.gameState.rollsLeft<=0)return;let e=this.rollDiceUseCase.execute(this.gameState.heldDice,this.gameState.dice);this.gameState.dice=e.newDice,this.gameState.heldDice=e.heldDice,void 0!==this.gameState.rollsLeft&&this.gameState.rollsLeft--,this.notifyListeners({type:"DICE_ROLLED",dice:this.gameState.dice}),this.notifyListeners({type:"GAME_STATE_CHANGED",state:{...this.gameState}}),await this.updateUI()}async selectCategory(e){let t=this.gameState.scores.get(this.gameState.currentPlayer)||new Map,s=this.selectCategoryUseCase.execute(this.gameState.dice,e,t);s.success&&(t.set(e,s.value),this.gameState.scores.set(this.gameState.currentPlayer,t),this.gameState.selectedCategory=e,this.gameState.currentPlayer=(this.gameState.currentPlayer+1)%this.gameState.numberOfPlayers,0===this.gameState.currentPlayer&&this.gameState.round++,this.gameState.rollsLeft=3,this.gameState.heldDice=[!1,!1,!1,!1,!1],this.notifyListeners({type:"SCORE_CHANGED",playerId:0===this.gameState.currentPlayer?this.gameState.numberOfPlayers-1:this.gameState.currentPlayer-1,category:e,score:s.value}),this.notifyListeners({type:"CATEGORY_SELECTED",category:e,playerId:0===this.gameState.currentPlayer?this.gameState.numberOfPlayers-1:this.gameState.currentPlayer-1}),this.notifyListeners({type:"GAME_STATE_CHANGED",state:{...this.gameState}}),await this.updateUI(),await this.saveGameState())}async holdDice(e){let t=[...this.gameState.heldDice];t[e]=!t[e],this.gameState.heldDice=t,this.notifyListeners({type:"DICE_HELD",heldDice:this.gameState.heldDice}),this.notifyListeners({type:"GAME_STATE_CHANGED",state:{...this.gameState}}),await this.updateUI()}onEvent(e){"GAME_STATE_CHANGED"===e.type&&(this.gameState=e.state,this.updateUI())}async updateUI(){this.uiRenderer.updateGameState(this.gameState)}async saveGameState(){await this.gameStateRepository.saveGameState(this.gameState)}getGameState(){return{...this.gameState}}constructor(e,t,s,a=2){this.listeners=[],this.gameStateRepository=e,this.uiRenderer=t,this.gameState=function(e){if(e<1||e>4)throw Error("Invalid number of players: must be between 1 and 4, got ".concat(e));let t=new Map;for(let s=0;s<e;s++)t.set(s,new Map);return{currentPlayer:0,round:1,scores:t,dice:[1,1,1,1,1],heldDice:[!1,!1,!1,!1,!1],selectedCategory:null,numberOfPlayers:e,rollsLeft:3}}(a),this.rollDiceUseCase=new E(s),this.selectCategoryUseCase=new D}}class G{setUpdateDiceCallback(e){this.updateDiceCallback=e}setUpdateScoreBoardCallback(e){this.updateScoreBoardCallback=e}setUpdateCategorySelectionCallback(e){this.updateCategorySelectionCallback=e}setUpdateGameStateCallback(e){this.updateGameStateCallback=e}renderDice(e,t){this.updateDiceCallback&&this.updateDiceCallback(e,t)}renderScoreBoard(e,t){this.updateScoreBoardCallback&&this.updateScoreBoardCallback(e,t)}renderCategorySelection(e,t){this.updateCategorySelectionCallback&&this.updateCategorySelectionCallback(e,t)}updateGameState(e){this.updateGameStateCallback?this.updateGameStateCallback(e):(this.renderDice(e.dice,e.heldDice),this.renderScoreBoard(e.scores,e.currentPlayer))}constructor(e){this._scene=e}}class O{rollDice(e){return Array.from({length:e},()=>a.Math.Between(1,6))}constructor(e){this._scene=e}}var L=s(9301);class B{setRoomId(e){this.roomId=e,this.supabaseManager.getRoomId()}setPlayerId(e){this.playerId=e,this.supabaseManager.getPlayerId()}setAuthToken(e){this.authToken=e}async validateAuthToken(){if(!this.authToken)return!1;try{return this.authToken.length>0}catch(e){return console.error("Auth token validation failed:",e),!1}}async validateAuthorization(){if(!this.roomId||!this.playerId)return!1;try{let e=(0,L.N)(),{data:t,error:s}=await e.from("game_players").select("player_id").eq("room_id",this.roomId).eq("player_id",this.playerId).single();if(s||!t)return!1;return!0}catch(e){return console.error("Authorization validation failed:",e),!1}}encryptSensitiveData(e){return e}decryptSensitiveData(e){return e}async saveGameState(e){try{if(!this.roomId)return{success:!1,error:Error("Room ID not set. Call setRoomId() first.")};if(!await this.validateAuthToken())return{success:!1,error:Error("Authentication token validation failed")};if(!await this.validateAuthorization())return{success:!1,error:Error("Authorization failed: Player not in room")};let t=Array.from(e.scores.entries()).map(e=>{let[t,s]=e,a={};return s.forEach((e,t)=>{a[t]=e}),a}),s=this.encryptSensitiveData(t),a={currentRound:e.round,currentPlayer:e.currentPlayer,gameStarted:!0,diceValues:e.dice,heldDice:e.heldDice,rollsLeft:3,scores:s,timestamp:Date.now()},i=(0,L.N)(),{error:r}=await i.from("game_rooms").update({game_state:a}).eq("room_id",this.roomId);if(r)throw r;return{success:!0,value:void 0}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Failed to save game state")}}}async loadGameState(){try{var e;if(!this.roomId)return{success:!1,error:Error("Room ID not set. Call setRoomId() first.")};if(!await this.validateAuthToken())return{success:!1,error:Error("Authentication token validation failed")};if(!await this.validateAuthorization())return{success:!1,error:Error("Authorization failed: Player not in room")};let t=await this.supabaseManager.getCurrentGameState();if(!t)return{success:!1,error:Error("No game state found")};let s={currentPlayer:t.currentPlayer||0,round:t.currentRound||1,scores:new Map,dice:t.diceValues||[1,1,1,1,1],heldDice:t.heldDice||[!1,!1,!1,!1,!1],selectedCategory:null,numberOfPlayers:(null===(e=t.scores)||void 0===e?void 0:e.length)||2,rollsLeft:t.rollsLeft||3};return t.scores&&this.decryptSensitiveData(t.scores).forEach((e,t)=>{let a=new Map;Object.entries(e).forEach(e=>{let[t,s]=e;a.set(t,s)}),s.scores.set(t,a)}),{success:!0,value:s}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Failed to load game state")}}}subscribeToGameState(e){return this.roomId?this.supabaseManager.onGameStateUpdate(t=>{if(t){var s;let a={currentPlayer:t.currentPlayer||0,round:t.currentRound||1,scores:new Map,dice:t.diceValues||[1,1,1,1,1],heldDice:t.heldDice||[!1,!1,!1,!1,!1],selectedCategory:null,numberOfPlayers:(null===(s=t.scores)||void 0===s?void 0:s.length)||2};t.scores&&t.scores.forEach((e,t)=>{let s=new Map;Object.entries(e).forEach(e=>{let[t,a]=e;s.set(t,a)}),a.scores.set(t,s)}),e(a)}}):()=>{}}constructor(){this.supabaseManager=(0,r.nc)(),this.roomId=null,this.playerId=null,this.authToken=null}}class A{async saveGameState(e){return this.state={...e},this.listeners.forEach(e=>e(this.state)),{success:!0,value:void 0}}async loadGameState(){return this.state?{success:!0,value:{...this.state}}:{success:!1,error:Error("No game state found")}}subscribeToGameState(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}constructor(){this.state=null,this.listeners=[]}}class H{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[]}setSceneCallbacks(e){this.sceneCallbacks=e}initializePresentationLayer(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");if(this.uiAdapter=new G(this.scene),this.uiAdapter.setUpdateDiceCallback((e,t)=>{this.sharedState.diceValues=[...e],this.sharedState.heldDice=[...t],this.sceneCallbacks.updateDiceAppearance()}),this.uiAdapter.setUpdateScoreBoardCallback((e,t)=>{let s=this.sceneCallbacks.getNumberOfPlayers(),a=[];for(let t=0;t<s;t++){let s=e.get(t)||new Map;a.push(new Map(s))}this.sceneCallbacks.setScores(a),this.sceneCallbacks.setCurrentPlayer(t),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals()}),this.uiAdapter.setUpdateGameStateCallback(e=>{this.sharedState.diceValues=[...e.dice],this.sharedState.heldDice=[...e.heldDice],this.sharedState.currentPlayer=e.currentPlayer,this.sharedState.round=e.round;let t=this.sceneCallbacks.getNumberOfPlayers();this.sharedState.scores=[];for(let s=0;s<t;s++){let t=e.scores.get(s)||new Map;this.sharedState.scores.push(new Map(t))}let s=[];for(let a=0;a<t;a++){let t=e.scores.get(a)||new Map;s.push(new Map(t))}this.sceneCallbacks.setScores(s),this.sceneCallbacks.updateUI()}),this.diceRoller=new O(this.scene),this.sceneCallbacks.getIsOnlineMode()&&this.sceneCallbacks.getRoomId()){let e=new B;e.setRoomId(this.sceneCallbacks.getRoomId()),this.gameStateRepository=e}else this.gameStateRepository=new A;this.presenter=new R(this.gameStateRepository,this.uiAdapter,this.diceRoller,this.sceneCallbacks.getNumberOfPlayers()),this.presenter.addEventListener(e=>{this.handleGameEvent(e)})}handleGameEvent(e){if(this.sceneCallbacks)switch(e.type){case"DICE_ROLLED":this.handleDiceRolledAnimation(e.dice);break;case"CATEGORY_SELECTED":this.sceneCallbacks.calculatePotentialScores(),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals();break;case"DICE_HELD":this.sceneCallbacks.updateDiceAppearance();break;case"GAME_STATE_CHANGED":this.sceneCallbacks.syncGameState(e.state)}}handleDiceRolledAnimation(e){}getPresenter(){return this.presenter}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}destroy(){this.presenter&&(this.presenter=null),this.uiAdapter=null,this.diceRoller=null,this.gameStateRepository=null,this.eventListeners=[],this.sceneCallbacks=void 0}constructor(){this.eventListeners=[],this.presenter=null,this.uiAdapter=null,this.diceRoller=null,this.gameStateRepository=null}}var F=s(9309);class z{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.popupSystem=new F.T(e)}setSceneCallbacks(e){this.sceneCallbacks=e}destroy(){this.popupSystem&&this.popupSystem.isOpen()&&this.popupSystem.close(),this.sceneCallbacks=void 0}showConfirmPopup(e,t){if(!this.sceneCallbacks||null!==this.sceneCallbacks.getPendingCategory()&&this.sceneCallbacks.getPendingCategory()!==e)return;let s=this.sceneCallbacks.getGameHeight();this.popupSystem.close(),this.sceneCallbacks.setPendingCategory(e),this.sceneCallbacks.setPendingScore(t),this.popupSystem.show({message:["Category: ".concat(e),"Score: ".concat(t)],width:.8,height:.22,strokeColor:5025616,strokeWidth:5,messageColor:"#fff",messageFontSize:.025*s,buttons:[{text:"Cancel",color:6710886,strokeColor:8947848,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.cancelCategorySelection()}},{text:"Confirm",color:5025616,strokeColor:6732650,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.confirmCategorySelection()}}],disableInteractions:()=>{this.sceneCallbacks.disableGameInteractions()},enableInteractions:()=>{this.sceneCallbacks.enableGameInteractions()}})}showVictoryPopup(e){var t,s,a,i,r,n;if(!this.sceneCallbacks)return;let o=this.sceneCallbacks.getGameHeight(),l=this.sceneCallbacks.getNumberOfPlayers();this.popupSystem.close();let c=["Final Scores"];e.forEach(e=>{c.push("Player ".concat(e.player,": ").concat(e.score))}),l>1&&c.push("Player ".concat(e[0].player," Wins!"));let h=[{text:"Play Again",color:5025616,strokeColor:6732650,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.restartGame()}}],d=(null===(t=(s=this.sceneCallbacks).getIsOnlineMode)||void 0===t?void 0:t.call(s))||!1,u=(null===(a=(i=this.sceneCallbacks).getRoomId)||void 0===a?void 0:a.call(i))||null;!d&&this.sceneCallbacks.changeGame&&h.push({text:"게임 변경",color:2201331,strokeColor:6600182,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.changeGame()}}),d&&u&&this.sceneCallbacks.shareRoomCode&&h.push({text:"\uD83D\uDCCB 초대 코드 공유",color:2201331,strokeColor:6600182,onClick:async()=>{var e;(null===(e=this.sceneCallbacks)||void 0===e?void 0:e.shareRoomCode)&&await this.sceneCallbacks.shareRoomCode(u)}});let g=(null===(r=(n=this.sceneCallbacks).getIsHost)||void 0===r?void 0:r.call(n))||!1;d&&g&&this.sceneCallbacks.changeGame&&h.push({text:"게임 변경",color:16761095,strokeColor:16766287,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.changeGame()}}),this.popupSystem.show({message:c,width:.8,height:.4,strokeColor:5025616,strokeWidth:5,messageColor:"#fff",messageFontSize:.025*o,buttons:h,disableInteractions:()=>{this.sceneCallbacks.disableGameInteractions()},enableInteractions:()=>{this.sceneCallbacks.enableGameInteractions()}})}showMainMenuConfirmPopup(){this.sceneCallbacks&&this.popupSystem.show({message:"메인 메뉴로 돌아가시겠습니까?",width:.8,height:.22,strokeColor:10233776,strokeWidth:5,buttons:[{text:"취소",color:6710886,strokeColor:8947848,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.enableGameInteractions()}},{text:"확인",color:10233776,strokeColor:12216520,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.goToMainMenu()}}],disableInteractions:()=>{this.sceneCallbacks.disableGameInteractions()},enableInteractions:()=>{this.sceneCallbacks.enableGameInteractions()}})}showRestartConfirmPopup(){this.sceneCallbacks&&this.popupSystem.show({message:"게임을 재시작하시겠습니까?",width:.8,height:.22,strokeColor:2201331,strokeWidth:5,buttons:[{text:"취소",color:6710886,strokeColor:8947848,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.enableGameInteractions()}},{text:"확인",color:2201331,strokeColor:6600182,onClick:()=>{this.popupSystem.close(),this.sceneCallbacks.restartGame()}}],disableInteractions:()=>{this.sceneCallbacks.disableGameInteractions()},enableInteractions:()=>{this.sceneCallbacks.enableGameInteractions()}})}closePopup(){this.popupSystem.isOpen()&&this.popupSystem.close()}isPopupOpen(){return this.popupSystem.isOpen()}}class N{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.sharedState=t}setSceneCallbacks(e){this.sceneCallbacks=e}destroy(){this.sceneCallbacks=void 0}async rollDice(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");if(this.sharedState.rollsLeft<=0||this.sceneCallbacks.getIsRolling())return;if(this.sceneCallbacks.getIsOnlineMode()&&!this.sceneCallbacks.checkPlayerTurn()){this.sceneCallbacks.showError("지금은 다른 플레이어의 턴입니다.");return}this.sharedState.currentPlayer=this.sceneCallbacks.getCurrentPlayer();let e=this.sceneCallbacks.getPresenter();if(e&&!this.sceneCallbacks.getIsOnlineMode()){var t;let s=e.getGameState();for(let t=0;t<5;t++)this.sharedState.heldDice[t]!==s.heldDice[t]&&(this.sharedState.heldDice[t]?s.heldDice[t]||await e.holdDice(t):s.heldDice[t]&&await e.holdDice(t));await e.rollDice();let a=e.getGameState();this.sharedState.diceValues=[...a.dice],this.sharedState.heldDice=[...a.heldDice],this.sharedState.rollsLeft=null!==(t=a.rollsLeft)&&void 0!==t?t:3,this.sharedState.currentPlayer=a.currentPlayer,this.sharedState.round=a.round,this.sceneCallbacks.setCurrentPlayer(this.sharedState.currentPlayer),await this.sceneCallbacks.getDiceManager().rollDiceAnimation(),this.sceneCallbacks.calculatePotentialScores(),this.sceneCallbacks.updateUI();return}if(this.sceneCallbacks.getIsOnlineMode()&&this.sceneCallbacks.getRoomId()){try{let e=await this.sceneCallbacks.getSupabaseManager().rollDice(this.sharedState.heldDice);this.sharedState.diceValues=e,this.sharedState.rollsLeft--,this.sceneCallbacks.setRollsLeft(this.sharedState.rollsLeft),await this.sceneCallbacks.getDiceManager().rollDiceAnimation(),this.sceneCallbacks.updateDiceAppearance(),this.sceneCallbacks.calculatePotentialScores(),this.sceneCallbacks.updateUI()}catch(t){console.error("Failed to roll dice:",t);let e=t instanceof Error?t.message:"알 수 없는 오류";this.sceneCallbacks.showError("주사위 굴리기에 실패했습니다: ".concat(e))}return}this.sharedState.rollsLeft--,this.sceneCallbacks.setRollsLeft(this.sharedState.rollsLeft);for(let e=0;e<5;e++)this.sharedState.heldDice[e]||(this.sharedState.diceValues[e]=a.Math.Between(1,6));await this.sceneCallbacks.getDiceManager().rollDiceAnimation(),this.sceneCallbacks.calculatePotentialScores(),this.sceneCallbacks.updateUI()}async selectCategory(e){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");if(null===this.sceneCallbacks.getPendingCategory()){if(!this.sceneCallbacks.checkPlayerTurn()){this.sceneCallbacks.showError("지금은 다른 플레이어의 턴입니다.");return}if(this.sceneCallbacks.getPresenter()&&!this.sceneCallbacks.getIsOnlineMode()){if(this.sharedState.rollsLeft<3&&!this.sceneCallbacks.getScores()[this.sceneCallbacks.getCurrentPlayer()].has(e)){let t=this.sceneCallbacks.getPotentialScores().get(e)||0;this.sceneCallbacks.setPendingCategory(e),this.sceneCallbacks.setPendingScore(t),this.sceneCallbacks.showConfirmPopup(e,t)}return}if(this.sharedState.rollsLeft<3&&!this.sceneCallbacks.getScores()[this.sceneCallbacks.getCurrentPlayer()].has(e)){let t=this.sceneCallbacks.getPotentialScores().get(e)||0;this.sceneCallbacks.setPendingCategory(e),this.sceneCallbacks.setPendingScore(t),this.sceneCallbacks.showConfirmPopup(e,t)}}}async confirmCategorySelection(){if(!this.sceneCallbacks)throw Error("Manager not initialized with scene callbacks");if(this.sceneCallbacks.closePopup(),!this.sceneCallbacks.getPendingCategory())return;if(this.sceneCallbacks.getIsOnlineMode()&&this.sceneCallbacks.getRoomId()&&this.sceneCallbacks.getPendingCategory()){if(!this.sceneCallbacks.checkPlayerTurn()){this.sceneCallbacks.showError("지금은 다른 플레이어의 턴입니다."),this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0);return}let e=this.sceneCallbacks.getPendingCategory(),t=this.sceneCallbacks.getPendingScore();this.sceneCallbacks.getSupabaseManager().selectCategory(e,t).then(()=>{if(this.sceneCallbacks){this.sceneCallbacks.getScores()[this.sceneCallbacks.getCurrentPlayer()].set(e,t),this.sharedState.scores[this.sceneCallbacks.getCurrentPlayer()].set(e,t);let s=this.sceneCallbacks.getNumberOfPlayers(),a=this.sceneCallbacks.getCurrentPlayer()+1,i=this.sharedState.round;a>=s&&(a=0,i++),this.sceneCallbacks.setCurrentPlayer(a),this.sharedState.currentPlayer=a,this.sharedState.round=i,this.sharedState.rollsLeft=3,this.sharedState.heldDice.fill(!1),this.sharedState.diceValues.fill(0),this.sceneCallbacks.getPotentialScores().clear(),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals(),this.sceneCallbacks.updatePlayerScores(),this.sceneCallbacks.updateUI(),this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0),this.sceneCallbacks.enableGameInteractions()}}).catch(e=>{if(console.error("Failed to select category:",e),this.sceneCallbacks){let t=e instanceof Error?e.message:"알 수 없는 오류";this.sceneCallbacks.showError("점수 기록에 실패했습니다: ".concat(t)),this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0),this.sceneCallbacks.enableGameInteractions()}});return}let e=this.sceneCallbacks.getPresenter();if(e&&this.sceneCallbacks.getPendingCategory()){var t;await e.selectCategory(this.sceneCallbacks.getPendingCategory());let s=e.getGameState();this.sharedState.diceValues=[...s.dice],this.sharedState.heldDice=[...s.heldDice],this.sharedState.rollsLeft=null!==(t=s.rollsLeft)&&void 0!==t?t:3,this.sceneCallbacks.setCurrentPlayer(s.currentPlayer),this.sharedState.round=s.round;let a=[];for(let e=0;e<this.sceneCallbacks.getNumberOfPlayers();e++){let t=s.scores.get(e)||new Map;a.push(new Map(t))}this.sceneCallbacks.updateScores(a),this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0),this.sceneCallbacks.enableGameInteractions(),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals(),this.sceneCallbacks.updateUI();return}this.sceneCallbacks.saveScoreAndNextTurn(this.sceneCallbacks.getPendingCategory(),this.sceneCallbacks.getPendingScore()),this.sceneCallbacks.setPendingCategory(null),this.sceneCallbacks.setPendingScore(0)}}var _=s(2966),U=s(6201);class Y extends a.Scene{createHighQualityText(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=Math.min(window.devicePixelRatio||1,2);return this.add.text(e,t,s,{...a,resolution:i})}getDice(){var e;return(null===(e=this.diceManager)||void 0===e?void 0:e.getDice())||[]}getIsRolling(){var e;return(null===(e=this.diceManager)||void 0===e?void 0:e.getIsRolling())||!1}getRollAnimationTimers(){var e;return(null===(e=this.diceManager)||void 0===e?void 0:e.getRollAnimationTimers())||[]}getDiceRollSound(){var e;return(null===(e=this.diceManager)||void 0===e?void 0:e.getDiceRollSound())||null}preload(){for(let e=1;e<=6;e++)this.load.image("dice".concat(e),"/images/dice/Side".concat(e,".png"));this.load.audio("diceRoll","/sounds/dice-18.wav")}init(e){if(this.potentialScores.clear(),this.playerScoreTexts&&this.playerScoreTexts.length>0&&(this.playerScoreTexts.forEach(e=>{e&&e.scene&&e.destroy()}),this.playerScoreTexts=[]),this.popupManager&&this.popupManager.closePopup(),this.pendingCategory=null,this.pendingScore=0,this.isOnlineMode=(null==e?void 0:e.isOnlineMode)||!1,this.roomId=(null==e?void 0:e.roomId)||null,e&&e.roomInfo&&(this.roomInfo=e.roomInfo),this.isOnlineMode&&this.roomId){if(this.roomInfo){var t;let e=this.roomInfo.sceneKey;if("YachtDiceScene"!==e){console.log("[YachtDiceScene] SceneKey is not YachtDiceScene, redirecting to RoomWaitingScene",{roomSceneKey:e,roomId:this.roomId}),n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:this.roomInfo});return}if((null===(t=this.roomInfo.gameState)||void 0===t?void 0:t.gameStarted)===!1){n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:this.roomInfo});return}let s=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.values(this.roomInfo.players||{});this.numberOfPlayers=s.length,this.scores=[];for(let e=0;e<this.numberOfPlayers;e++)this.scores.push(new Map)}else this.numberOfPlayers=0,this.scores=[]}else if(e&&e.numberOfPlayers&&e.numberOfPlayers>0){this.numberOfPlayers=e.numberOfPlayers,this.scores=[];for(let e=0;e<this.numberOfPlayers;e++)this.scores.push(new Map)}else this.numberOfPlayers=0,this.scores=[]}async create(){var e,t;if(this.isCreateComplete=!1,this.pendingStartOnlineGame=null,this.isOnlineMode&&this.roomId&&this.roomInfo){let e=this.roomInfo.sceneKey;if(e&&"YachtDiceScene"!==e){console.log("[YachtDiceScene] SceneKey is not YachtDiceScene in create(), redirecting to RoomWaitingScene",{roomSceneKey:e,roomId:this.roomId}),n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:this.roomInfo});return}}let s=this.children.list.filter(e=>e.active);s.length>0&&s.forEach(e=>{e&&e.scene&&(e instanceof a.GameObjects.Container&&e.removeAll(!0),e.destroy())});{let e=!1,t=async()=>{if(!e&&this.isOnlineMode&&this.roomId){e=!0;try{this.supabaseManager.leaveRoom().catch(e=>{console.error("[YachtDiceScene] Error leaving room on beforeunload:",e)})}catch(e){console.error("[YachtDiceScene] Error leaving room on beforeunload:",e)}}},s=async t=>{if(!e&&this.isOnlineMode&&this.roomId){var s,a;if((null===(a=this.roomInfo)||void 0===a?void 0:null===(s=a.gameState)||void 0===s?void 0:s.gameStarted)!==!0||!t.persisted){e=!0;try{await this.supabaseManager.leaveRoom()}catch(e){console.error("[YachtDiceScene] Error leaving room on pagehide:",e)}}}},a=async()=>{var e,t,s,a,i;if(this.isOnlineMode&&this.roomId){if("hidden"===document.visibilityState){if((null===(t=this.roomInfo)||void 0===t?void 0:null===(e=t.gameState)||void 0===e?void 0:e.gameStarted)===!0||this.roomInfo&&(null===(s=this.roomInfo.gameState)||void 0===s?void 0:s.gameStarted)===!1)return;try{await this.supabaseManager.leaveRoom()}catch(e){console.error("[YachtDiceScene] Error leaving room on visibilitychange:",e)}}else if("visible"===document.visibilityState&&(null===(i=this.roomInfo)||void 0===i?void 0:null===(a=i.gameState)||void 0===a?void 0:a.gameStarted)===!0)try{let e=await this.supabaseManager.getRoomInfo();(null==e?void 0:e.gameState)&&(this.syncGameState(e.gameState),this.uiManager&&this.diceManager&&this.scorecardManager&&(this.updateDiceAppearance(),this.calculatePotentialScores(),this.updateUI()))}catch(e){console.error("[YachtDiceScene] Error syncing game state on visibilitychange:",e)}}};window.addEventListener("beforeunload",t),window.addEventListener("pagehide",s),document.addEventListener("visibilitychange",a),this.events.once("shutdown",()=>{window.removeEventListener("beforeunload",t),window.removeEventListener("pagehide",s),document.removeEventListener("visibilitychange",a)})}this.headerManager=new i.F(this),this.sharedGameState=(0,_.S)(this.numberOfPlayers||1),this.sharedGameState.currentPlayer=this.currentPlayer,this.sharedGameState.isOnlineMode=this.isOnlineMode,this.sharedGameState.roomId=this.roomId,this.sharedGameState.playerId=this.playerId,this.sharedGameState.scores=this.scores.map(e=>new Map(e)),this.screenManager=new S,this.screenManager.initialize(this,this.sharedGameState),this.screenManager.setSceneCallbacks({restartScene:e=>{this.scene.restart(e)},showOnlineModeSelection:()=>{this.showOnlineModeSelection()},onGameSelected:async e=>{await this.handleGameSelected(e)},onGameSelectionCancelled:()=>{}});let r=this.cameras.main.width/2,l=this.cameras.main.height/2,c=this.cameras.main.width<900,h=c?Math.min(this.cameras.main.width/800,this.cameras.main.height/700):1;if(this.isOnlineMode){if(this.roomId);else{if(this.isOnlineMode){n.rX.startScene(this,"GameSelectionScene",{isOnlineMode:!0});return}this.showOnlineModeSelection();return}}else if(!this.numberOfPlayers||0===this.numberOfPlayers){console.warn("[YachtDiceScene] numberOfPlayers is required for single device mode"),n.rX.startScene(this,"DeviceSelectionScene");return}if(!this.isOnlineMode&&0===this.numberOfPlayers){console.warn("[YachtDiceScene] numberOfPlayers is required"),n.rX.startScene(this,"DeviceSelectionScene");return}if(this.isOnlineMode&&0===this.numberOfPlayers){if(!this.roomInfo)return;{let e=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.values(this.roomInfo.players||{});this.numberOfPlayers=e.length,this.sharedGameState.numberOfPlayers=this.numberOfPlayers,this.scores=[];for(let e=0;e<this.numberOfPlayers;e++)this.scores.push(new Map)}}else if(this.isOnlineMode&&!this.roomId){n.rX.startScene(this,"RoomListScene");return}this.add.rectangle(r,l,this.cameras.main.width-40,this.cameras.main.height-40,2763306,.3),this.headerResult&&this.headerManager.destroy(this.headerResult);let d=!this.isOnlineMode||(null===(e=this.roomInfo)||void 0===e?void 0:e.hostId)===(null===(t=this.supabaseManager)||void 0===t?void 0:t.getPlayerId()),g=!this.isOnlineMode||this.isOnlineMode&&d;this.headerResult=this.headerManager.createHeader({showMainMenu:!0,showNewGame:!0,showChangeGame:g,showFullscreen:!0,isMobile:c,scale:h},{showTurn:!0,showRound:!0,currentPlayer:this.currentPlayer,currentRound:this.sharedGameState.round,maxRounds:13,playerColors:[2201331,16007990,16761095,10233776,5025616],playerColorsLight:[6600182,15037299,16766287,12216520,8505220]}),this.headerResult.buttons.mainMenu&&(this.headerResult.buttons.mainMenu.bg.on("pointerdown",()=>{this.showMainMenuConfirmPopup()}),this.headerResult.buttons.mainMenu.text.on("pointerdown",()=>{this.showMainMenuConfirmPopup()})),this.headerResult.buttons.newGame&&(this.headerResult.buttons.newGame.bg.on("pointerdown",()=>{this.showRestartConfirmPopup()}),this.headerResult.buttons.newGame.text.on("pointerdown",()=>{this.showRestartConfirmPopup()})),this.headerResult.buttons.changeGame&&(this.headerResult.buttons.changeGame.bg.on("pointerdown",()=>{this.changeGame()}),this.headerResult.buttons.changeGame.text.on("pointerdown",()=>{this.changeGame()})),this.sharedGameState.numberOfPlayers=this.numberOfPlayers,this.sharedGameState.currentPlayer=this.currentPlayer,this.sharedGameState.isOnlineMode=this.isOnlineMode,this.sharedGameState.roomId=this.roomId,this.sharedGameState.playerId=this.playerId,this.sharedGameState.scores=this.scores.map(e=>new Map(e)),this.diceManager=new o,this.diceManager.initialize(this,this.sharedGameState),this.diceManager.addEventListener(e=>{if("DICE_HELD"===e.type){this.sharedGameState.heldDice[e.diceIndex]=e.held;let t=this.getPresenter();t&&!this.isOnlineMode&&t.holdDice(e.diceIndex).catch(e=>{console.error("Failed to hold dice via presenter:",e)}),this.isOnlineMode&&this.roomId&&this.supabaseManager.toggleDiceHold(e.diceIndex).catch(e=>{console.error("Failed to toggle dice hold:",e)})}}),this.scorecardManager=new u,this.scorecardManager.initialize(this,this.sharedGameState),this.screenManager.addEventListener(e=>{"PLAYER_COUNT_SELECTED"===e.type&&(this.numberOfPlayers=e.count,this.sharedGameState.numberOfPlayers=e.count)}),this.buttonManager=new f,this.buttonManager.initialize(this,this.sharedGameState),this.gameStateSyncManager=new b,this.gameStateSyncManager.initialize(this,this.sharedGameState),this.gameStateSyncManager.addEventListener(e=>{"SYNC_ERROR"===e.type&&(console.error("[YachtDiceScene] Sync error:",e.error),this.showError("동기화 오류: ".concat(e.error.message)))}),this.onlineMultiplayerManager=new C.L,this.onlineMultiplayerManager.initialize(this,this.sharedGameState),this.onlineMultiplayerManager.setSceneCallbacks({getNumberOfPlayers:()=>this.numberOfPlayers,setNumberOfPlayers:e=>{this.numberOfPlayers=e,this.sharedGameState.numberOfPlayers=e},getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:e=>{this.currentPlayer=e,this.sharedGameState.currentPlayer=e},getScores:()=>this.scores,setScores:e=>{this.scores=e,this.sharedGameState.scores=e.map(e=>new Map(e))},getRoomInfo:()=>this.roomInfo,setRoomInfo:e=>{this.roomInfo=e},getRoomId:()=>this.roomId,setRoomId:e=>{this.roomId=e},getPlayerId:()=>this.playerId,setPlayerId:e=>{this.playerId=e},getIsOnlineMode:()=>this.isOnlineMode,setIsOnlineMode:e=>{this.isOnlineMode=e,this.sharedGameState.isOnlineMode=e},getIsPlayerSelectMode:()=>!1,showError:e=>this.showError(e),updateUI:()=>this.updateUI(),updateScorecardText:()=>this.updateScorecardText(),updateTotals:()=>this.updateTotals(),updatePlayerScores:()=>this.updatePlayerScores(),updateDiceAppearance:()=>this.updateDiceAppearance(),updateRollButtonText:()=>this.updateRollButtonText(),endGame:()=>this.endGame(),calculatePotentialScores:()=>this.calculatePotentialScores(),getIsRolling:()=>this.getIsRolling(),getDiceRollSound:()=>this.getDiceRollSound(),restartScene:e=>this.scene.restart(e),startScene:(e,t)=>n.rX.startScene(this,e,t),getOnlineModeButtons:()=>this.onlineModeButtons,setOnlineModeButtons:e=>{this.onlineModeButtons=e}}),this.onlineMultiplayerManager.addEventListener(e=>{if("SHOW_ONLINE_MODE_SELECTION"===e.type)this.onlineMultiplayerManager&&this.onlineMultiplayerManager.clearRoomListUI(),this.showOnlineModeSelection();else if("GAME_STATE_CHANGED"===e.type)this.syncGameState(e.gameState);else if("START_ONLINE_GAME"===e.type){let t=e.roomInfo;if("YachtDiceScene"!==t.sceneKey){console.warn("[YachtDiceScene] START_ONLINE_GAME event received for non-yacht-dice game, ignoring",{roomId:t.roomId,sceneKey:t.sceneKey});return}if(!this.isCreateComplete){if(this.uiManager&&this.diceManager&&this.scorecardManager){this.handleStartOnlineGameEvent(t);return}this.pendingStartOnlineGame={room:t};return}this.handleStartOnlineGameEvent(t)}else"SETUP_ONLINE_MODE"===e.type&&e.roomId&&e.playerId&&(this.roomId=e.roomId,this.playerId=e.playerId,this.isOnlineMode=!0,this.sharedGameState.isOnlineMode=!0,this.sharedGameState.roomId=e.roomId,this.sharedGameState.playerId=e.playerId)}),this.gameFlowManager=new v,this.gameFlowManager.initialize(this,this.sharedGameState),this.gameFlowManager.setSceneCallbacks({getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:e=>{this.currentPlayer=e,this.sharedGameState.currentPlayer=e},getNumberOfPlayers:()=>this.numberOfPlayers,getRollAnimationTimers:()=>this.getRollAnimationTimers(),getDiceRollSound:()=>this.getDiceRollSound(),updateUI:()=>this.updateUI(),updateScorecardText:()=>this.updateScorecardText(),updateTotals:()=>this.updateTotals(),endGame:()=>this.endGame(),getDice:()=>this.getDice(),getScores:()=>this.scores,calculateTotalScore:e=>this.calculateTotalScore(e),showVictoryPopup:e=>this.showVictoryPopup(e),getButtonManager:()=>this.buttonManager,getPendingCategory:()=>this.pendingCategory,setPendingCategory:e=>{this.pendingCategory=e},getPendingScore:()=>this.pendingScore,setPendingScore:e=>{this.pendingScore=e},restartScene:e=>{this.scene.restart(e)},startScene:(e,t)=>{console.log("[YachtDiceScene] startScene called: ".concat(e),t?{roomId:t.roomId}:{}),n.rX.startScene(this,e,t),console.log("[YachtDiceScene] Scene.start() called successfully for ".concat(e))},getPotentialScores:()=>this.potentialScores}),this.gameFlowManager.addEventListener(async e=>{if("GAME_ENDED"===e.type&&this.isOnlineMode&&this.roomId&&this.supabaseManager)try{let e=await this.supabaseManager.getRoomInfo();if((null==e?void 0:e.hostId)===this.supabaseManager.getPlayerId()){let e=await this.supabaseManager.deleteRoom(this.roomId);e.success||console.error("[YachtDiceScene] Failed to delete room:",e.error)}else await this.supabaseManager.leaveRoom()}catch(e){console.error("[YachtDiceScene] Error cleaning up room after game end:",e)}}),this.scoreManager=new P,this.scoreManager.initialize(this,this.sharedGameState),this.uiManager=new T,this.uiManager.initialize(this,this.sharedGameState),this.uiManager.setSceneCallbacks({getCurrentPlayer:()=>this.currentPlayer,getNumberOfPlayers:()=>this.numberOfPlayers,getScores:()=>this.scores,getPotentialScores:()=>this.potentialScores,getHeaderResult:()=>this.headerResult,getHeaderManager:()=>this.headerManager,getDiceManager:()=>this.diceManager,getButtonManager:()=>this.buttonManager,getScorecardManager:()=>this.scorecardManager,calculateTotalScore:e=>this.scoreManager.calculateTotalScore(e),updateDiceAppearance:()=>this.updateDiceAppearance(),updateRollButtonText:()=>this.updateRollButtonText(),updateScorecardText:()=>this.updateScorecardText(),calculatePotentialScores:()=>this.calculatePotentialScores(),createHighQualityText:(e,t,s,a)=>this.createHighQualityText(e,t,s,a),getIsFullscreen:()=>this.isFullscreen,setIsFullscreen:e=>{this.isFullscreen=e},getResizeHandler:()=>this.resizeHandler,setResizeHandler:e=>{this.resizeHandler=e},getIsOnlineMode:()=>this.isOnlineMode,getRoomId:()=>this.roomId,getRoomInfo:()=>this.roomInfo,getNumberOfPlayersForRestart:()=>this.numberOfPlayers,restartScene:e=>{this.scene.restart(e)},getDice:()=>this.getDice(),getIsRolling:()=>this.getIsRolling(),getRollButton:()=>this.rollButton,getScorecardTexts:()=>this.scorecardTexts,getSharedGameState:()=>this.sharedGameState,getGameTime:()=>this.time}),this.uiManager.setupResizeHandler(),this.uiManager.createPlayerScores(c),this.inputManager=new x,this.inputManager.initialize(this,this.sharedGameState),this.inputManager.setSceneCallbacks({getIsRolling:()=>this.getIsRolling(),getDice:()=>this.getDice(),getRollButton:()=>this.rollButton,getHeaderResult:()=>this.headerResult,getPotentialScores:()=>this.potentialScores,rollDice:()=>this.rollDice(),toggleDiceHold:e=>this.toggleDiceHold(e),selectCategory:e=>this.selectCategory(e),showMainMenuConfirmPopup:()=>this.showMainMenuConfirmPopup()}),this.presentationManager=new H,this.presentationManager.initialize(this,this.sharedGameState),this.popupManager=new z,this.popupManager.initialize(this,this.sharedGameState),this.popupManager.setSceneCallbacks({getGameHeight:()=>this.cameras.main.height,getNumberOfPlayers:()=>this.numberOfPlayers,disableGameInteractions:()=>this.disableGameInteractions(),enableGameInteractions:()=>this.enableGameInteractions(),restartGame:()=>this.restartGame(),goToMainMenu:()=>this.goToMainMenu(),confirmCategorySelection:()=>this.confirmCategorySelection(),cancelCategorySelection:()=>this.cancelCategorySelection(),getPendingCategory:()=>this.pendingCategory,getPendingScore:()=>this.pendingScore,setPendingCategory:e=>{this.pendingCategory=e},setPendingScore:e=>{this.pendingScore=e},getIsOnlineMode:()=>this.isOnlineMode,getRoomId:()=>this.roomId,getIsHost:()=>!!this.isOnlineMode&&!!this.roomInfo&&!!this.supabaseManager&&this.roomInfo.hostId===this.supabaseManager.getPlayerId(),shareRoomCode:async e=>{this.onlineMultiplayerManager&&await this.onlineMultiplayerManager.shareRoomCode(e)},changeGame:()=>this.changeGame()}),this.gameActionManager=new N,this.gameActionManager.initialize(this,this.sharedGameState),this.gameActionManager.setSceneCallbacks({getIsRolling:()=>this.getIsRolling(),getPresenter:()=>this.getPresenter(),getIsOnlineMode:()=>this.isOnlineMode,getRoomId:()=>this.roomId,getSupabaseManager:()=>this.supabaseManager,getDiceManager:()=>this.diceManager,getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:e=>{this.currentPlayer=e,this.sharedGameState.currentPlayer=e},getScores:()=>this.scores,updateDiceAppearance:()=>this.updateDiceAppearance(),getPotentialScores:()=>this.potentialScores,getRollsLeft:()=>this.sharedGameState.rollsLeft,setRollsLeft:e=>{this.sharedGameState.rollsLeft=e},calculatePotentialScores:()=>this.calculatePotentialScores(),updateUI:()=>this.updateUI(),updateScorecardText:()=>this.updateScorecardText(),updateTotals:()=>this.updateTotals(),updatePlayerScores:()=>this.updatePlayerScores(),showError:e=>this.showError(e),showConfirmPopup:(e,t)=>this.showConfirmPopup(e,t),checkPlayerTurn:()=>this.checkPlayerTurn(),getPendingCategory:()=>this.pendingCategory,getPendingScore:()=>this.pendingScore,setPendingCategory:e=>{this.pendingCategory=e},setPendingScore:e=>{this.pendingScore=e},getNumberOfPlayers:()=>this.numberOfPlayers,enableGameInteractions:()=>this.enableGameInteractions(),nextTurn:()=>this.nextTurn(),updateScores:e=>{this.scores=e,this.sharedGameState.scores=e.map(e=>new Map(e))},saveScoreAndNextTurn:(e,t)=>{this.scores[this.currentPlayer].set(e,t),this.sharedGameState.scores[this.currentPlayer].set(e,t),this.updateScorecardText(),this.updateTotals(),this.nextTurn()},closePopup:()=>this.popupManager.closePopup()}),this.presentationManager.setSceneCallbacks({getNumberOfPlayers:()=>this.numberOfPlayers,getIsOnlineMode:()=>this.isOnlineMode,getRoomId:()=>this.roomId,getScores:()=>this.scores,setScores:e=>{this.scores=e,this.sharedGameState.scores=e.map(e=>new Map(e))},getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:e=>{this.currentPlayer=e,this.sharedGameState.currentPlayer=e},updateDiceAppearance:()=>this.updateDiceAppearance(),updateScorecardText:()=>this.updateScorecardText(),updateTotals:()=>this.updateTotals(),updateUI:()=>this.updateUI(),syncGameState:e=>this.syncGameState(e),calculatePotentialScores:()=>this.calculatePotentialScores()}),this.buttonManager.createRollButton(h,c,{onRollClick:()=>{this.rollDice()},onPlayAgainClick:()=>{this.restartGame()}}),this.rollButton=this.buttonManager.getRollButton(),this.rollButtonBg=this.buttonManager.getRollButtonBg();let p=this.diceManager.getDice();this.scorecardManager.createScorecard(h,c,{rollButtonBg:this.rollButtonBg,dice:p,selectCategory:e=>{this.selectCategory(e)},roomInfo:this.roomInfo}),this.uiManager.setUIElements({playerHeaders:this.scorecardManager.getPlayerHeaders(),playerHeaderBgs:this.scorecardManager.getPlayerHeaderBgs(),upperTotalTexts:this.scorecardManager.getUpperTotalTexts(),bonusTexts:this.scorecardManager.getBonusTexts(),lowerTotalTexts:this.scorecardManager.getLowerTotalTexts(),totalTexts:this.scorecardManager.getTotalTexts()}),this.presentationManager.initializePresentationLayer(),this.inputManager.setupKeyboardNavigation(),this.isOnlineMode&&this.roomId&&(!this.playerId&&this.supabaseManager&&(this.playerId=this.supabaseManager.getPlayerId()),this.roomId&&this.supabaseManager&&(this.supabaseManager.roomId=this.roomId),this.ensureOnlineMultiplayerManagerInitialized(),this.roomId&&this.playerId&&this.setupOnlineMode(),this.roomInfo&&this.roomInfo.gameState?(this.syncGameState(this.roomInfo.gameState),this.updateUI(),this.updateRollButtonText()):this.diceManager&&this.diceManager.getDice().length>0&&(this.updateUI(),this.updateRollButtonText())),this.diceManager&&this.diceManager.getDice().length>0&&(this.updateUI(),this.updateRollButtonText()),this.time.delayedCall(100,()=>{var e;if(this.isCreateComplete=!0,this.uiManager&&this.diceManager&&this.scorecardManager&&(this.updateUI(),this.updateRollButtonText()),this.isOnlineMode&&this.roomId&&this.roomInfo&&(null===(e=this.roomInfo.gameState)||void 0===e?void 0:e.gameStarted)===!0&&this.uiManager&&this.diceManager&&this.scorecardManager&&this.roomInfo.gameState&&(this.syncGameState(this.roomInfo.gameState),this.updateUI(),this.updateRollButtonText()),this.pendingStartOnlineGame){let e=this.pendingStartOnlineGame;this.pendingStartOnlineGame=null,this.handleStartOnlineGameEvent(e.room)}})}handleStartOnlineGameEvent(e){this.isOnlineMode=!0,this.roomId=e.roomId,this.playerId=this.supabaseManager.getPlayerId();let t=Array.isArray(e.players)?e.players:Object.values(e.players||{});if(this.numberOfPlayers=t.length,this.sharedGameState.numberOfPlayers=this.numberOfPlayers,this.roomInfo=e,!this.uiManager||!this.diceManager||!this.scorecardManager){n.rX.startScene(this,"YachtDiceScene",{numberOfPlayers:this.numberOfPlayers,isOnlineMode:!0,roomId:this.roomId,roomInfo:e});return}this.roomId&&this.playerId?this.setupOnlineMode():console.warn("[YachtDiceScene] Cannot call setupOnlineMode: roomId or playerId not set",{roomId:this.roomId,playerId:this.playerId}),e.gameState?(this.syncGameState(e.gameState),this.uiManager&&this.diceManager&&this.scorecardManager&&(this.updateUI(),this.updateRollButtonText(),this.updateDiceAppearance())):this.restartGame()}getPresenter(){return this.presentationManager.getPresenter()}checkPlayerTurn(){let e;if(!this.isOnlineMode||!this.roomInfo||!this.playerId)return!0;let t=(e=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId);return!(e.length>1)||-1===t||t===this.currentPlayer}async handleGameSelected(e){if(!U.P.getInstance().getGame(e)){console.error("[YachtDiceScene] Unknown scene key: ".concat(e));return}if(this.isOnlineMode)n.rX.startScene(this,"RoomWaitingScene",{sceneKey:e});else{if(!this.numberOfPlayers||0===this.numberOfPlayers){console.warn("[YachtDiceScene] numberOfPlayers is required for single device mode"),n.rX.startScene(this,"DeviceSelectionScene");return}"YachtDiceScene"===e?this.scene.restart({numberOfPlayers:this.numberOfPlayers}):n.rX.startScene(this,e,{numberOfPlayers:this.numberOfPlayers})}}toggleFullscreen(){this.uiManager.toggleFullscreen()}updateFullscreenButton(){this.uiManager.updateFullscreenButton()}async rollDice(){await this.gameActionManager.rollDice()}async selectCategory(e){await this.gameActionManager.selectCategory(e)}showConfirmPopup(e,t){this.popupManager.showConfirmPopup(e,t)}async confirmCategorySelection(){await this.gameActionManager.confirmCategorySelection()}disableGameInteractions(){this.uiManager.disableGameInteractions()}enableGameInteractions(){this.uiManager.enableGameInteractions()}cancelCategorySelection(){this.popupManager.closePopup(),this.pendingCategory=null,this.pendingScore=0,this.enableGameInteractions()}nextTurn(){this.gameFlowManager.nextTurn()}async endGame(){if(this.isOnlineMode&&this.roomId&&this.supabaseManager)try{let e=await this.supabaseManager.getRoomInfo();if((null==e?void 0:e.gameState)&&(this.syncGameState(e.gameState),this.updateScorecardText(),this.updateTotals(),this.updatePlayerScores(),this.updateUI(),await new Promise(e=>setTimeout(e,100))),(null==e?void 0:e.hostId)===this.playerId){let e=this.scores.map(e=>{let t={};return e.forEach((e,s)=>{t[s]=e}),t}),t={gameStarted:!0,currentRound:Math.max(this.sharedGameState.round,14),currentPlayer:this.sharedGameState.currentPlayer,diceValues:this.sharedGameState.diceValues,heldDice:this.sharedGameState.heldDice,rollsLeft:this.sharedGameState.rollsLeft,scores:e};await this.supabaseManager.endGameYachtDice(t)}}catch(t){let e=t instanceof Error?t.message:"알 수 없는 오류";console.error("[YachtDiceScene] endGame: Failed to fetch latest game state or update room state:",e),e.includes("Room not found")||e.includes("406")}this.gameFlowManager.endGame()}showVictoryPopup(e){this.popupManager.showVictoryPopup(e)}showMainMenuConfirmPopup(){this.popupManager.showMainMenuConfirmPopup()}showRestartConfirmPopup(){this.popupManager.showRestartConfirmPopup()}restartGame(){this.isOnlineMode?this.onlineMultiplayerManager?this.onlineMultiplayerManager.restartGame().catch(e=>{console.error("[YachtDiceScene] Failed to restart game:",e),this.showError("게임 재시작에 실패했습니다.")}):this.gameFlowManager.restartGame():this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!1})}changeGame(){this.isOnlineMode?this.onlineMultiplayerManager?(this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null),this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null),this.onlineMultiplayerManager.changeGame().catch(e=>{console.error("[YachtDiceScene] Failed to change game:",e),this.showError("게임 변경에 실패했습니다: ".concat(e.message))})):console.warn("[YachtDiceScene] onlineMultiplayerManager not initialized"):n.rX.startScene(this,"GameSelectionScene",{isOnlineMode:!1,numberOfPlayers:this.numberOfPlayers})}goToMainMenu(){this.gameFlowManager.goToMainMenu()}updateUI(){this.uiManager?this.uiManager.updateUI():console.warn("[YachtDiceScene] updateUI called but uiManager is not initialized")}updateDiceAppearance(){this.diceManager?(this.diceManager.updateDiceAppearance(),this.updateRollButtonText()):console.warn("[YachtDiceScene] updateDiceAppearance called but diceManager is not initialized")}toggleDiceHold(e){this.sharedGameState.currentPlayer=this.currentPlayer,this.diceManager.holdDice(e)}updateRollButtonText(){let e=!0;if(this.isOnlineMode&&this.roomInfo&&this.playerId){let t;let s=(t=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId);e=t.length<=1||-1!==s&&s===this.currentPlayer}let t=this.sharedGameState.heldDice.every(e=>!0===e);this.buttonManager.updateRollButtonText({rollsLeft:this.sharedGameState.rollsLeft,isRolling:this.getIsRolling(),isMyTurn:e,allDiceHeld:t,currentPlayer:this.currentPlayer})}updateScorecardText(){this.scorecardManager?(this.scorecardManager.setPotentialScores(this.potentialScores),this.scorecardManager.updateScorecardText(),this.updateTotals()):console.warn("[YachtDiceScene] updateScorecardText called but scorecardManager is not initialized")}updateTotals(){this.uiManager.updateTotals()}updatePlayerScores(){this.uiManager.updatePlayerScores()}calculateTotalScore(e){return this.scoreManager.calculateTotalScore(e)}calculatePotentialScores(){this.scoreManager.calculatePotentialScores(this.potentialScores)}getDiceCounts(){return this.scoreManager.getDiceCounts()}async shutdown(){let e=[];if(this.children.list.forEach(t=>{t.active&&e.push(t)}),e.forEach(e=>{e&&e.scene&&(e instanceof a.GameObjects.Container&&e.removeAll(!0),e.destroy())}),this.diceManager&&this.diceManager.destroy(),this.scorecardManager&&this.scorecardManager.destroy(),this.screenManager&&this.screenManager.destroy(),this.buttonManager&&this.buttonManager.destroy(),this.gameStateSyncManager&&this.gameStateSyncManager.destroy(),this.onlineMultiplayerManager&&this.onlineMultiplayerManager.destroy(),this.gameFlowManager&&this.gameFlowManager.destroy(),this.uiManager&&this.uiManager.destroy(),this.scoreManager&&this.scoreManager.destroy(),this.inputManager&&this.inputManager.destroy(),this.presentationManager&&this.presentationManager.destroy(),this.popupManager&&this.popupManager.destroy(),this.gameActionManager&&this.gameActionManager.destroy(),this.uiManager&&this.uiManager.removeResizeHandler(),this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null),this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null),this.isOnlineMode&&this.roomId){try{await this.supabaseManager.leaveRoom()}catch(e){console.error("Error leaving room on shutdown:",e)}this.supabaseManager.cleanup()}}showOnlineModeSelection(){this.screenManager.showOnlineModeSelectionScreen({onCreateRoom:()=>{n.rX.startScene(this,"GameSelectionScene",{isOnlineMode:!0})},onJoinRoom:async()=>{n.rX.startScene(this,"RoomListScene")},onBack:()=>{this.screenManager.hideCurrentScreen(),n.rX.startScene(this,"DeviceSelectionScene")}})}ensureOnlineMultiplayerManagerInitialized(){!this.onlineMultiplayerManager&&(!this.sharedGameState&&(this.sharedGameState=(0,_.S)(this.numberOfPlayers||1),this.sharedGameState.currentPlayer=this.currentPlayer,this.sharedGameState.isOnlineMode=this.isOnlineMode,this.sharedGameState.roomId=this.roomId,this.sharedGameState.playerId=this.playerId,this.scores.length>0&&(this.sharedGameState.scores=this.scores.map(e=>new Map(e)))),this.onlineMultiplayerManager||(this.onlineMultiplayerManager=new C.L,this.onlineMultiplayerManager.initialize(this,this.sharedGameState),this.onlineMultiplayerManager.setSceneCallbacks({getNumberOfPlayers:()=>this.numberOfPlayers,setNumberOfPlayers:e=>{this.numberOfPlayers=e,this.sharedGameState.numberOfPlayers=e},getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:e=>{this.currentPlayer=e,this.sharedGameState.currentPlayer=e},getScores:()=>this.scores,setScores:e=>{this.scores=e,this.sharedGameState.scores=e.map(e=>new Map(e))},getRoomInfo:()=>this.roomInfo,setRoomInfo:e=>{this.roomInfo=e},getRoomId:()=>this.roomId,setRoomId:e=>{this.roomId=e},getPlayerId:()=>this.playerId,setPlayerId:e=>{this.playerId=e},getIsOnlineMode:()=>this.isOnlineMode,setIsOnlineMode:e=>{this.isOnlineMode=e,this.sharedGameState.isOnlineMode=e},getIsPlayerSelectMode:()=>!1,showError:e=>this.showError(e),updateUI:()=>this.updateUI(),updateScorecardText:()=>this.updateScorecardText(),updateTotals:()=>this.updateTotals(),updatePlayerScores:()=>this.updatePlayerScores(),updateDiceAppearance:()=>this.updateDiceAppearance(),updateRollButtonText:()=>this.updateRollButtonText(),endGame:()=>this.endGame(),calculatePotentialScores:()=>this.calculatePotentialScores(),getIsRolling:()=>this.getIsRolling(),getDiceRollSound:()=>this.getDiceRollSound(),restartScene:e=>this.scene.restart(e),startScene:(e,t)=>{console.log("[YachtDiceScene] startScene called (setupOnlineMode): ".concat(e),t?{roomId:t.roomId}:{}),n.rX.startScene(this,e,t),console.log("[YachtDiceScene] Scene.start() called (setupOnlineMode) for ".concat(e))},getOnlineModeButtons:()=>this.onlineModeButtons,setOnlineModeButtons:e=>{this.onlineModeButtons=e},cleanupRealtimeListeners:()=>{this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null),this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null)}})))}syncGameState(e){if(!this.uiManager||!this.diceManager||!this.scorecardManager){this.roomInfo&&(this.roomInfo.gameState=e);return}this.onlineMultiplayerManager.syncGameState(e)}setupOnlineMode(){if(!this.isSettingUpOnlineMode){if(!this.roomId||!this.playerId){console.warn("[YachtDiceScene] setupOnlineMode called but roomId or playerId not set",{roomId:this.roomId,playerId:this.playerId});return}this.isSettingUpOnlineMode=!0;try{this.onlineMultiplayerManager.setupOnlineMode(this.roomId,this.playerId),this.roomId&&(this.unsubscribeRoom=this.supabaseManager.onRoomUpdate(e=>{try{if(!this.scene.isActive())return;this.roomInfo&&(this.roomInfo=e);let t=e.sceneKey;if(t&&"YachtDiceScene"!==t&&this.roomId){console.log("[YachtDiceScene] Room sceneKey changed (host changed game), redirecting to RoomWaitingScene",{sceneKey:t,roomId:this.roomId,previousSceneKey:"YachtDiceScene"}),n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:e});return}let s=e.state;if("game_ended"===s&&e.gameState){let t=e.gameState,s=t.currentRound||this.sharedGameState.round,a=t.scores||this.scores,i=!!Array.isArray(a)&&a.every(e=>(e instanceof Map?e.size:Object.keys(e||{}).length)===13);if((s>13||i)&&this.uiManager&&this.diceManager&&this.scorecardManager){if(this.syncGameState(e.gameState),t.scores&&Array.isArray(t.scores)){let e=t.scores,s=[];for(let t=0;t<e.length;t++){let a=e[t];if(a&&"object"==typeof a){let e=new Map;Object.entries(a).forEach(t=>{let[s,a]=t;"number"==typeof a&&e.set(s,a)}),s.push(e)}else s.push(new Map)}this.scores=s,this.sharedGameState.scores=s.map(e=>new Map(e)),this.updateScorecardText(),this.updateTotals(),this.updatePlayerScores()}this.gameFlowManager.endGame()}}}catch(e){console.error("[YachtDiceScene] Error in onRoomUpdate callback:",e),this.sharedGameState.round>13&&this.uiManager&&this.diceManager&&this.scorecardManager&&this.gameFlowManager.endGame()}}),this.events.once("shutdown",()=>{this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null)})),this.roomId&&(this.unsubscribeGameState=this.supabaseManager.onGameStateUpdate(async e=>{if(!this.unsubscribeGameState){console.log("[YachtDiceScene] Realtime listener already cleaned up, ignoring gameState update");return}let t=this.roomInfo,s=t?t.state:null;if(!s||"game_ended"!==s)try{let e=await this.supabaseManager.getRoomInfo();if(e){var a;let i=null===(a=this.roomInfo)||void 0===a?void 0:a.sceneKey,r=e.sceneKey;if(i&&r&&i!==r&&"YachtDiceScene"===i){console.log("[YachtDiceScene] Game type changed, skipping roomInfo update and gameState sync",{currentSceneKey:i,newSceneKey:r});return}t=e,s=e.state,this.roomInfo=e}}catch(e){console.warn("[YachtDiceScene] Failed to get latest room info in onGameStateUpdate:",e)}if(!this.unsubscribeGameState){console.log("[YachtDiceScene] Realtime listener cleaned up during roomInfo check, skipping gameState sync");return}if(this.syncGameState(e),("game_ended"===s||e.currentRound>13)&&this.uiManager&&this.diceManager&&this.scorecardManager){if(e.scores&&Array.isArray(e.scores)){let t=e.scores,s=[];for(let e=0;e<t.length;e++){let a=t[e];if(a&&"object"==typeof a){let e=new Map;Object.entries(a).forEach(t=>{let[s,a]=t;"number"==typeof a&&e.set(s,a)}),s.push(e)}else s.push(new Map)}this.scores=s,this.sharedGameState.scores=s.map(e=>new Map(e)),this.updateScorecardText(),this.updateTotals(),this.updatePlayerScores()}this.gameFlowManager.endGame()}else this.uiManager&&this.diceManager&&this.scorecardManager&&(this.updateDiceAppearance(),this.calculatePotentialScores(),this.updateUI(),this.updatePlayerScores(),this.updateRollButtonText())}),this.events.once("shutdown",()=>{this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null)}))}finally{setTimeout(()=>{this.isSettingUpOnlineMode=!1},100)}}}showError(e){this.uiManager?this.uiManager.showError(e):console.error("[YachtDiceScene] showError called but uiManager is not initialized:",e)}constructor(){super("YachtDiceScene"),this.isCreateComplete=!1,this.playerScoreTexts=[],this.isFullscreen=!1,this.scores=[],this.potentialScores=new Map,this.scorecardTexts=new Map,this.pendingCategory=null,this.pendingScore=0,this.currentPlayer=0,this.resizeHandler=null,this.isOnlineMode=!1,this.roomId=null,this.playerId=null,this.roomInfo=null,this.isSettingUpOnlineMode=!1,this.supabaseManager=(0,r.nc)(),this.unsubscribeRoom=null,this.unsubscribeGameState=null,this.onlineModeButtons=null,this.pendingStartOnlineGame=null,this.numberOfPlayers=0}}}}]);