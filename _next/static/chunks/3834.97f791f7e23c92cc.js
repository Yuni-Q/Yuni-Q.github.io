"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3834],{9309:function(e,t,s){s.d(t,{T:function(){return o}});class o{show(e){var t,s,o,a,n,i,r,l,c;this.close();let h=this.scene.cameras.main.width,d=this.scene.cameras.main.height,u=h/2,p=d/2,m=null!==(t=e.strokeWidth)&&void 0!==t?t:5,y=null!==(s=e.width)&&void 0!==s?s:.8,f=null!==(o=e.height)&&void 0!==o?o:.22,g=Math.min(h*y,h-4*m),b=Math.min(d*f,d-4*m),S=null!==(a=e.backgroundColor)&&void 0!==a?a:1710618,C=null!==(n=e.backgroundAlpha)&&void 0!==n?n:.95,w=null!==(i=e.strokeColor)&&void 0!==i?i:2201331,k=null!==(r=e.messageColor)&&void 0!==r?r:"#fff",v=null!==(l=e.messageFontSize)&&void 0!==l?l:.022*d,E=null!==(c=e.depth)&&void 0!==c?c:2e3;this.currentPopup=this.scene.add.container(0,0);let M=this.scene.add.rectangle(u,p,h,d,0,.7).setInteractive({useHandCursor:!1});this.currentPopup.add(M);let x=this.scene.add.rectangle(u,p,g,b,S,C).setStrokeStyle(m,w);this.currentPopup.add(x);let O=Array.isArray(e.message)?e.message:[e.message],I=.1*g,R=g-2*I,G=.015*d,L=O.length*v+(O.length-1)*G,A=e.buttons&&e.buttons.length>0?.055*d:0,P=e.buttons&&e.buttons.length>0?.03*d:0,W=L+P+A,z=Math.max(p-b/2+8+W/2,p);if(O.forEach((e,t)=>{let s=this.scene.add.text(u,z-W/2+t*(v+G)+v/2,e,{fontSize:"".concat(v,"px"),color:k,fontStyle:"bold",wordWrap:{width:R},align:"center"}).setOrigin(.5);this.currentPopup&&this.currentPopup.add(s)}),e.buttons&&e.buttons.length>0){let t=.28*g,s=.022*d,o=z-W/2+L+P+A/2,a=.15*g,n=u-(t*e.buttons.length+a*(e.buttons.length-1))/2+t/2;e.buttons.forEach((e,i)=>{var r,l,c;let h=n+i*(t+a),d=null!==(r=e.color)&&void 0!==r?r:2201331,u=null!==(l=e.textColor)&&void 0!==l?l:"#fff",p=null!==(c=e.strokeColor)&&void 0!==c?c:6600182,m=this.scene.add.rectangle(h,o,t,A,d,.9).setStrokeStyle(2,p).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{e.onClick()});this.currentPopup&&this.currentPopup.add(m);let y=this.scene.add.text(h,o,e.text,{fontSize:"".concat(s,"px"),color:u,fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{e.onClick()});this.currentPopup&&this.currentPopup.add(y)})}return this.currentPopup&&this.currentPopup.setDepth(E),e.disableInteractions&&e.disableInteractions(),this.currentEnableInteractions=e.enableInteractions,this.currentPopup}close(){this.currentPopup&&(this.currentPopup.destroy(),this.currentPopup=null),this.currentEnableInteractions&&(this.currentEnableInteractions(),this.currentEnableInteractions=void 0)}isOpen(){return null!==this.currentPopup}getPopup(){return this.currentPopup}constructor(e){this.currentPopup=null,this.scene=e}}},6332:function(e,t,s){s.d(t,{L:function(){return l}});var o=s(6201),a=s(3382),n=s(2769),i=s(294),r=s(8782);class l{initialize(e,t){if(!e)throw TypeError("Scene cannot be null");if(!t)throw TypeError("SharedGameState cannot be null");this.scene=e,this.sharedState=t,this.eventListeners=[],this.roomWaitingGroup=null,this.roomWaitingUnsubscribers=[],this.gameSelectionManager=new i.m,this.gameSelectionManager.initialize(e,t)}setSceneCallbacks(e){if(!e)throw TypeError("Callbacks cannot be null");this.sceneCallbacks=e}destroy(){this.eventListeners=[],this.roomWaitingGroup&&(this.roomWaitingGroup.destroy(!0),this.roomWaitingGroup=null),this.roomWaitingUnsubscribers.forEach(e=>e()),this.roomWaitingUnsubscribers=[],this.gameSelectionManager&&(this.gameSelectionManager.destroy(),this.gameSelectionManager=void 0)}addEventListener(e){return this.eventListeners.push(e),()=>{this.eventListeners=this.eventListeners.filter(t=>t!==e)}}setSelectedGame(e,t){this.currentSceneKey=e,this.selectedMaxPlayers=t}async createOnlineRoom(){if(!this.sceneCallbacks)throw Error("Manager not initialized");let e=this.sceneCallbacks.getOnlineModeButtons();e&&(e.destroy(!0),this.sceneCallbacks.setOnlineModeButtons(null)),this.clearRoomListUI();let t=[];this.scene.children.list.forEach(e=>{e.active&&e!==this.roomWaitingGroup&&t.push(e)}),t.forEach(e=>{e&&e.scene&&e.destroy()});let s=this.scene.add.text(this.scene.cameras.main.width/2,this.scene.cameras.main.height/2,"룸 생성 중...",{fontSize:"".concat(.03*this.scene.cameras.main.height,"px"),color:"#fff"}).setOrigin(.5).setDepth(2e3);try{if(!this.supabaseManager.isConnected())return console.error("Supabase not connected"),s.destroy(),this.sceneCallbacks.showError("Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요."),null;let e=this.sceneCallbacks.getRoomInfo(),t=(null==e?void 0:e.sceneKey)||this.currentSceneKey;if(!t)throw Error("Game not selected. Please select a game first.");let o=await this.supabaseManager.createRoom(this.selectedMaxPlayers,t);s.destroy(),this.sceneCallbacks.setRoomId(o),this.sceneCallbacks.setPlayerId(this.supabaseManager.getPlayerId());try{let e=this.supabaseManager.getRoomId();this.supabaseManager.roomId=o;try{let e=await this.supabaseManager.getRoomInfo();this.sceneCallbacks.setRoomInfo(e)}finally{this.supabaseManager.roomId=e}}catch(e){console.error("Failed to load room info:",e)}return o}catch(t){console.error("Failed to create room:",t),s.destroy();let e=t instanceof Error?t.message:String(t);return e.includes("permission")||e.includes("PERMISSION_DENIED")?this.sceneCallbacks.showError("권한 오류가 발생했습니다. 페이지를 새로고침하거나 다른 게임을 선택해주세요."):e.includes("network")||e.includes("timeout")?this.sceneCallbacks.showError("네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요."):e.includes("Room creation failed")?this.sceneCallbacks.showError("룸 생성에 실패했습니다. 다른 게임을 선택하거나 잠시 후 다시 시도해주세요."):this.sceneCallbacks.showError("룸 생성에 실패했습니다: ".concat(e,". 페이지를 새로고침하거나 다른 게임을 선택해주세요.")),null}}async showGameSelectionForRoomCreation(){if(!this.sceneCallbacks)throw Error("Manager not initialized");if(!this.gameSelectionManager)throw Error("GameSelectionManager not initialized");let e=this.sceneCallbacks.getOnlineModeButtons();e&&(e.destroy(!0),this.sceneCallbacks.setOnlineModeButtons(null)),this.clearRoomListUI();let t=[];this.scene.children.list.forEach(e=>{e.active&&e!==this.roomWaitingGroup&&t.push(e)}),t.forEach(e=>{e&&e.scene&&e.destroy()}),this.gameSelectionManager.showGameSelectionScreen(1,!0),this.gameSelectionManager.setSceneCallbacks({onGameSelected:async e=>{if(!this.sceneCallbacks){console.error("[OnlineMultiplayerManager] Scene callbacks not set");return}try{let t=o.P.getInstance().getGame(e);if(t){let s=t.maxPlayers;this.setSelectedGame(e,s)}else throw Error("Game not found: ".concat(e));await this.createOnlineRoom()}catch(t){console.error("[OnlineMultiplayerManager] Failed to create room after game selection:",t);let e=t instanceof Error?t.message:"알 수 없는 오류";this.sceneCallbacks&&(e.includes("network")||e.includes("timeout")?this.sceneCallbacks.showError("네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요."):this.sceneCallbacks.showError("룸 생성에 실패했습니다: ".concat(e,". 페이지를 새로고침하거나 다시 시도해주세요.")));try{await this.showGameSelectionForRoomCreation()}catch(e){console.error("[OnlineMultiplayerManager] Failed to show game selection again after error:",e)}}},onGameSelectionCancelled:()=>{this.notifyListeners({type:"GAME_SELECTION_CANCELLED"})}})}async showRoomList(){if(!this.sceneCallbacks)throw Error("Manager not initialized");let e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=e/2,o=t/2;this.clearRoomListUI();let a=[],n=this.sceneCallbacks.getOnlineModeButtons();this.scene.children.list.forEach(e=>{e.active&&e!==n&&a.push(e)}),a.forEach(e=>{e&&e.scene&&e.destroy()});let i=Math.min(.8*e,e-12),r=.6*t,l=this.scene.add.rectangle(s,o,i,r,1710618,.95).setStrokeStyle(3,2201331);this.roomListElements.push(l);let c=this.scene.add.text(s,o-.4*r,"방 목록",{fontSize:"".concat(.04*t,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomListElements.push(c);let h=this.scene.add.text(s,o,"방 목록을 불러오는 중...",{fontSize:"".concat(.025*t,"px"),color:"#aaa"}).setOrigin(.5);try{let e=await this.supabaseManager.getActiveRooms();if(h.destroy(),0===e.length){let e=this.scene.add.text(s,o,"현재 열려있는 방이 없습니다.",{fontSize:"".concat(.025*t,"px"),color:"#aaa"}).setOrigin(.5);this.roomListElements.push(e);let a=.3*i,n=o+.2*r,l=this.scene.add.rectangle(s,n,a,.05*t,2201331,.9).setStrokeStyle(2,6600182).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this.showRoomList()}).on("pointerover",()=>{l.setFillStyle(1668818,.9)}).on("pointerout",()=>{l.setFillStyle(2201331,.9)});this.roomListElements.push(l);let c=this.scene.add.text(s,n,"새로고침",{fontSize:"".concat(.022*t,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomListElements.push(c)}else this.renderRoomList(e,s,o,i,r,c);this.createBackButton(s,o,i,r)}catch(a){console.error("Failed to load room list:",a),h.destroy();let e=this.scene.add.text(s,o,"방 목록을 불러오는데 실패했습니다.",{fontSize:"".concat(.025*t,"px"),color:"#ff4444"}).setOrigin(.5);this.roomListElements.push(e),this.createBackButton(s,o,i,r)}}renderRoomList(e,t,s,a,i,r){let l=this.scene.cameras.main.height,c=s-.05*i,h=.65*i,d=.08*l,u=.02*l,p=.85*a,m=this.scene.add.container(t,c);m.setSize(p,h),this.roomListElements.push(m);let y=this.scene.make.graphics();y.fillStyle(16777215),y.fillRect(t-.5*p,c-.5*h,p,h);let f=y.createGeometryMask();m.setMask(f),this.roomListElements.push(y);let g=0,b=Math.max(0,e.length*(d+u)-u-h),S=-h/2+d/2,C=[],w=0,k=0,v=!1,E=0;e.forEach((e,t)=>{let s=S+t*(d+u),a=(Array.isArray(e.players)?e.players:Object.values(e.players||{})).length,i=this.scene.add.rectangle(0,s,p,d,3355443,.9).setStrokeStyle(2,5592405).setInteractive({useHandCursor:!0}).setData("roomId",e.roomId).setDepth(1e3).on("pointerover",()=>{v||i.setFillStyle(4473924,.9)}).on("pointerout",()=>{i.setFillStyle(3355443,.9)}),r=e=>{w=e.y,k=g,E=Date.now(),v=!1},c=e=>{if(b>0&&w>0&&Math.abs(e.y-w)>10){v=!0;let t=e.y-w;g=n.Math.Clamp(k-t,0,b),M()}},h=t=>{if(0===b){this.joinOnlineRoom(e.roomId);return}let s=Date.now()-E,o=w>0?Math.abs(t.y-w):0;!v&&s<300&&o<10&&this.joinOnlineRoom(e.roomId),w=0,k=0,v=!1,E=0},y=()=>{w=0,k=0,v=!1,E=0};i.on("pointerdown",r).on("pointermove",c).on("pointerup",h).on("pointerout",y);let f=.022*l,x="게임",O="\uD83C\uDFAE";if(e.sceneKey){let t=o.P.getInstance().getGame(e.sceneKey);t&&(x=t.name,O=t.icon||"\uD83C\uDFAE")}let I=this.scene.add.text(0,0,"".concat(O," ").concat(x),{fontSize:"".concat(f,"px"),color:"#ffd700",fontStyle:"bold"}).setOrigin(.5,.5),R=I.height;I.destroy();let G=this.scene.add.text(0,0,"룸 코드: ".concat(e.roomId),{fontSize:"".concat(f,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5,.5),L=G.height;G.destroy();let A=this.scene.add.text(0,0,"플레이어: ".concat(a,"/").concat(e.maxPlayers),{fontSize:"".concat(f,"px"),color:"#fff"}).setOrigin(.5,.5),P=A.height;A.destroy();let W=s-(R+4+L+4+P)/2+R/2,z=W+R/2+4+L/2,j=this.scene.add.text(0,W,"".concat(O," ").concat(x),{fontSize:"".concat(f,"px"),color:"#ffd700",fontStyle:"bold"}).setOrigin(.5,.5),D=this.scene.add.text(0,z,"룸 코드: ".concat(e.roomId),{fontSize:"".concat(f,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5,.5),T=this.scene.add.text(0,z+L/2+4+P/2,"플레이어: ".concat(a,"/").concat(e.maxPlayers),{fontSize:"".concat(f,"px"),color:"#fff"}).setOrigin(.5,.5);[j,D,T].forEach(e=>{e.setInteractive({useHandCursor:!0}),e.setDepth(1001),e.on("pointerdown",r).on("pointermove",c).on("pointerup",h).on("pointerout",y)}),m.add([i,j,D,T]),C.push(i,j,D,T)});let M=()=>{g=n.Math.Clamp(g,0,b),m.setY(c-g)};if(m.setInteractive(new n.Geom.Rectangle(-(.5*p),-(.5*h),p,h),n.Geom.Rectangle.Contains),m.on("pointerdown",e=>{b>0&&(w=e.y,k=g,E=Date.now(),v=!1)}).on("pointermove",e=>{if(b>0&&w>0&&Math.abs(e.y-w)>10){v=!0;let t=e.y-w;g=n.Math.Clamp(k-t,0,b),M()}}).on("pointerup",()=>{w=0,k=0,v=!1,E=0}).on("pointerout",()=>{w=0,k=0,v=!1,E=0}),r){let e=0;r.setInteractive({useHandCursor:!0}),r.on("pointerdown",()=>{let t=Date.now();t-e<300&&(g=0,M()),e=t})}this.scene.input.on("wheel",(e,t,s,o,a)=>{b>0&&(g-=.5*o,M())}),M()}createBackButton(e,t,s,o){let a=this.scene.cameras.main.height,n=t+.35*o,i=this.scene.add.rectangle(e,n,.3*s,.05*a,6710886,.9).setStrokeStyle(2,8947848).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this.clearRoomListUI(),this.notifyListeners({type:"SHOW_ONLINE_MODE_SELECTION"})}).on("pointerover",()=>{i.setFillStyle(7829367,.9)}).on("pointerout",()=>{i.setFillStyle(6710886,.9)});this.roomListElements.push(i);let r=this.scene.add.text(e,n,"뒤로",{fontSize:"".concat(.022*a,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomListElements.push(r)}clearRoomListUI(){this.roomListElements.forEach(e=>{e&&e.scene&&e.active&&(e instanceof n.GameObjects.Container&&e.removeAll(!0),e.destroy())}),this.roomListElements=[],this.scene.input.off("wheel")}showRoomCodeInputScreen(){if(!this.sceneCallbacks)throw Error("Manager not initialized");let e=this.sceneCallbacks,t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,o=t/2,a=s/2;this.clearRoomListUI();let n=this.sceneCallbacks.getOnlineModeButtons();n&&(n.destroy(!0),this.sceneCallbacks.setOnlineModeButtons(null));let i=Math.min(.8*t,t-12),r=.3*s,l=this.scene.add.rectangle(o,a,i,r,1710618,.95).setStrokeStyle(3,2201331);this.roomListElements.push(l);let c=this.scene.add.text(o,a-.3*r,"룸 코드 입력",{fontSize:"".concat(.04*s,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);if(this.roomListElements.push(c),"undefined"==typeof document)return;let h=document.createElement("div");h.style.position="absolute",h.style.left="".concat(o-.4*i,"px"),h.style.top="".concat(a-.05*r,"px"),h.style.width="".concat(.8*i,"px"),h.style.height="".concat(.06*s,"px"),h.style.backgroundColor="#333",h.style.border="2px solid #2196f3",h.style.borderRadius="4px",h.style.padding="0 10px",h.style.fontSize="".concat(.03*s,"px"),h.style.color="#fff",h.style.textAlign="center",h.style.textTransform="uppercase",h.style.fontWeight="bold",h.style.zIndex="10000";let d=document.createElement("input");d.type="text",d.placeholder="룸 코드 입력 (6-8자)",d.maxLength=8,d.style.width="100%",d.style.height="100%",d.style.backgroundColor="transparent",d.style.border="none",d.style.outline="none",d.style.color="#fff",d.style.fontSize="".concat(.03*s,"px"),d.style.textAlign="center",d.style.textTransform="uppercase",d.style.fontWeight="bold",d.addEventListener("input",e=>{let t=e.target;t.value=t.value.replace(/[^A-Z0-9]/gi,"").toUpperCase()}),h.appendChild(d),document.body.appendChild(h);let u=.05*s,p=.022*s,m=.03*i,y=a+.2*r,f=this.scene.add.text(0,0,"참가",{fontSize:"".concat(p,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),g=f.width;f.destroy();let b=this.scene.add.rectangle(o,y,Math.max(g+2*m,.3*i),u,5025616,.9).setStrokeStyle(2,6732650).setInteractive({useHandCursor:!0}).on("pointerdown",async()=>{let t=d.value.trim().toUpperCase();if(!t){e.showError("룸 코드를 입력해주세요.");return}if(!/^[A-Z0-9]{6,8}$/.test(t)){e.showError("룸 코드는 6-8자의 영숫자여야 합니다.");return}document.body.removeChild(h),await this.joinOnlineRoom(t)}).on("pointerover",()=>{b.setFillStyle(4563017,.9)}).on("pointerout",()=>{b.setFillStyle(5025616,.9)});this.roomListElements.push(b);let S=this.scene.add.text(o,y,"참가",{fontSize:"".concat(p,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",async()=>{let t=d.value.trim().toUpperCase();if(!t){e.showError("룸 코드를 입력해주세요.");return}if(!/^[A-Z0-9]{6,8}$/.test(t)){e.showError("룸 코드는 6-8자의 영숫자여야 합니다.");return}document.body.removeChild(h),await this.joinOnlineRoom(t)});this.roomListElements.push(S),d.addEventListener("keydown",async t=>{if("Enter"===t.key){let t=d.value.trim().toUpperCase();if(!t){e.showError("룸 코드를 입력해주세요.");return}if(!/^[A-Z0-9]{6,8}$/.test(t)){e.showError("룸 코드는 6-8자의 영숫자여야 합니다.");return}document.body.removeChild(h),await this.joinOnlineRoom(t)}});let C=y+u+.02*s,w=this.scene.add.rectangle(o,C,.3*i,.05*s,6710886,.9).setStrokeStyle(2,8947848).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{document.body.contains(h)&&document.body.removeChild(h),this.clearRoomListUI(),this.notifyListeners({type:"SHOW_ONLINE_MODE_SELECTION"})}).on("pointerover",()=>{w.setFillStyle(7829367,.9)}).on("pointerout",()=>{w.setFillStyle(6710886,.9)});this.roomListElements.push(w);let k=this.scene.add.text(o,C,"뒤로",{fontSize:"".concat(.022*s,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomListElements.push(k),setTimeout(()=>{d.focus()},100)}async joinOnlineRoom(e){if(!this.sceneCallbacks)throw Error("Manager not initialized");let t=e.toUpperCase().trim();if(!/^[A-Z0-9]{6,8}$/.test(t)){console.error("[joinOnlineRoom] Invalid room code format:",e),this.sceneCallbacks&&this.sceneCallbacks.showError("룸 코드 형식이 올바르지 않습니다. 6-8자의 영숫자를 입력해주세요.");return}try{let s=await this.supabaseManager.joinRoom(t,"Player"),o=this.sceneCallbacks.getOnlineModeButtons();o&&(o.destroy(!0),this.sceneCallbacks.setOnlineModeButtons(null)),this.clearRoomListUI();let a=[];this.scene.children.list.forEach(e=>{e.active&&e!==this.roomWaitingGroup&&a.push(e)}),a.forEach(e=>{e&&e.scene&&e.destroy()}),this.sceneCallbacks.setRoomId(e),this.sceneCallbacks.setPlayerId(this.supabaseManager.getPlayerId()),this.sceneCallbacks.setRoomInfo(s);let n=Array.isArray(s.players)?s.players:Object.values(s.players||{});this.sceneCallbacks.setNumberOfPlayers(n.length);let i=[];for(let e=0;e<n.length;e++)i.push(new Map);this.sceneCallbacks.setScores(i),await this.showRoomWaitingScreen(t)}catch(o){console.error("[joinOnlineRoom] Failed to join room:",o,{roomCode:t,errorType:o instanceof Error?o.constructor.name:typeof o,errorMessage:o instanceof Error?o.message:String(o)});let e=o instanceof Error?o.message:"알 수 없는 오류",s="룸 참가에 실패했습니다.";s=e.includes("Room not found")?"룸을 찾을 수 없습니다. 룸 코드를 확인하고 다시 시도해주세요.":e.includes("Room is full")?"룸이 가득 찼습니다. 다른 룸에 참가하거나 잠시 후 다시 시도해주세요.":e.includes("Room has expired")?"룸이 만료되었습니다. 새로운 룸을 생성하거나 다른 룸에 참가해주세요.":e.includes("currently in progress")?"게임이 진행 중입니다. 게임이 끝날 때까지 기다리거나 다른 룸에 참가해주세요.":e.includes("changing the game")?"호스트가 게임을 변경 중입니다. 잠시 후 다시 시도해주세요.":e.includes("network")||e.includes("timeout")?"네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요.":"룸 참가에 실패했습니다: ".concat(e,". 룸 코드를 확인하고 다시 시도해주세요."),this.sceneCallbacks&&this.sceneCallbacks.showError(s);try{await this.showRoomList()}catch(e){console.error("[joinOnlineRoom] Failed to show room list after error:",e)}}}async showRoomWaitingScreen(e){var t,s,a,n,i,r,l,c;let h;if(!this.sceneCallbacks)throw Error("Manager not initialized");null===(s=this.sceneCallbacks)||void 0===s||null===(t=s.setIsOnlineMode)||void 0===t||t.call(s,!0),null===(n=this.sceneCallbacks)||void 0===n||null===(a=n.setRoomId)||void 0===a||a.call(n,e);let d=this.scene.cameras.main.width,u=this.scene.cameras.main.height,p=d/2,m=u/2,y=null===(r=this.sceneCallbacks)||void 0===r?void 0:null===(i=r.getOnlineModeButtons)||void 0===i?void 0:i.call(r);y&&(y.destroy(!0),null===(c=this.sceneCallbacks)||void 0===c||null===(l=c.setOnlineModeButtons)||void 0===l||l.call(c,null)),this.roomWaitingGroup&&(this.roomWaitingGroup.destroy(!0),this.roomWaitingGroup=null),this.roomWaitingUnsubscribers.forEach(e=>e()),this.roomWaitingUnsubscribers=[];let f=[];this.scene.children.list.forEach(e=>{e.active&&f.push(e)}),f.forEach(e=>{e&&e.scene&&e.destroy()}),this.roomWaitingGroup=this.scene.add.container(0,0);let g=this.sceneCallbacks.getRoomInfo();if(!g)try{let t=this.supabaseManager.getRoomId();this.supabaseManager.roomId=e;try{g=await this.supabaseManager.getRoomInfo(),this.sceneCallbacks.setRoomInfo(g)}finally{this.supabaseManager.roomId=t}}catch(e){console.error("Failed to load room info:",e)}let b=.8*d,S=.5*u,C=this.scene.add.rectangle(p,m,b,S,1710618,.95).setStrokeStyle(3,5025616);this.roomWaitingGroup.add(C);let w="게임";if(g&&g.sceneKey){let e=o.P.getInstance().getGame(g.sceneKey);e&&(w=e.name)}else if(this.currentSceneKey){let e=o.P.getInstance().getGame(this.currentSceneKey);e&&(w=e.name)}let k=.04*u,v=.022*u,E=.025*u,M=.018*u,x=.02*u,O=this.scene.add.text(0,0,"룸 대기 중...",{fontSize:"".concat(k,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5,.5),I=O.height;O.destroy();let R=this.scene.add.text(0,0,"게임: ".concat(w),{fontSize:"".concat(v,"px"),color:"#fff"}).setOrigin(.5,.5),G=R.height;R.destroy();let L=this.scene.add.text(0,0,"룸 코드: ".concat(e),{fontSize:"".concat(E,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5,.5),A=L.height;L.destroy();let P=this.scene.add.text(0,0,"플레이어: (1/4)",{fontSize:"".concat(x,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5,.5),W=P.height;P.destroy();let z=.012*u,j=m-S/2+.02*u+I/2,D=this.scene.add.text(p,j,"룸 대기 중...",{fontSize:"".concat(k,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5,.5);this.roomWaitingGroup.add(D);let T=j+I/2+z+G/2,F=this.scene.add.text(p,T,"게임: ".concat(w),{fontSize:"".concat(v,"px"),color:"#fff"}).setOrigin(.5,.5);this.roomWaitingGroup.add(F);let N=T+G/2+z+A/2,U=this.scene.add.text(p,N,"룸 코드: ".concat(e),{fontSize:"".concat(E,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5,.5);this.roomWaitingGroup.add(U);let _=.04*u,H=.02*b,B=N+A/2+z+_/2,V=this.scene.add.text(0,0,"\uD83D\uDCCB 복사",{fontSize:"".concat(M,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),K=V.width;V.destroy();let J=this.scene.add.rectangle(p,B,Math.max(K+2*H,.2*b),_,2201331,.9).setStrokeStyle(2,6600182).setInteractive({useHandCursor:!0}).on("pointerdown",t=>{this.copyRoomCodeToClipboardSync(e,t)}).on("pointerover",()=>{J.setFillStyle(1668818,.9)}).on("pointerout",()=>{J.setFillStyle(2201331,.9)}).setDepth(1001);this.roomWaitingGroup.add(J);let Z=this.scene.add.text(p,B,"\uD83D\uDCCB 복사",{fontSize:"".concat(M,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",t=>{t.event.stopPropagation(),this.copyRoomCodeToClipboardSync(e,t)}).setDepth(1002);this.roomWaitingGroup.add(Z);let $=g?Array.isArray(g.players)?g.players.length:Object.keys(g.players||{}).length:1,Y=(null==g?void 0:g.maxPlayers)||4,X=B+_/2+z+W/2,q=this.scene.add.text(p,X,"플레이어: (".concat($,"/").concat(Y,")"),{fontSize:"".concat(x,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5,.5);this.roomWaitingGroup.add(q);let Q=X+W/2+z,ee=m+S/2,et=.02*u,es=.05*u+.02*u,eo=.12*u,ea=Math.max(eo,Math.min(ee-et-es-Q,.2*S)),en=Q+ea/2,ei=ee-et-es;if(en+ea/2>ei){let e=Math.max(eo,ei-Q);ea=e,en=Q+e/2}let er=this.scene.add.rectangle(p,en,.8*b,ea,2201331,.3).setStrokeStyle(2,2201331);this.roomWaitingGroup.add(er);let el=this.scene.add.text(p,en-.35*ea,"플레이어 목록",{fontSize:"".concat(.018*u,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomWaitingGroup.add(el),g&&Array.isArray(g.players)?h=g.players.filter(e=>e&&e.id):g&&g.players&&"object"==typeof g.players?h=Object.keys(g.players).map(e=>{let t=g.players[e];return t&&"object"==typeof t&&"id"in t?t:t&&"object"==typeof t&&"player_id"in t?{id:t.player_id,name:t.player_name||t.name||"Player ".concat(e),isReady:t.is_ready||t.isReady||!1,joinedAt:t.joined_at||t.joinedAt||0}:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):(console.warn("[showRoomWaitingScreen] Invalid initial players format:",null==g?void 0:g.players),h=[]);let ec=h.length>0?h.map((e,t)=>e.name||"Player ".concat(t+1)).join("\n"):"대기 중...",eh=this.scene.add.text(p,en+.1*ea,ec,{fontSize:"".concat(.016*u,"px"),color:"#fff"}).setOrigin(.5);this.roomWaitingGroup.add(eh);let ed=this.sceneCallbacks.getPlayerId(),eu=(null==g?void 0:g.hostId)===ed,ep=eu&&$>=2,em=.05*u,ey=.022*u,ef=.03*b,eg=.05*b,eb=ee-et,eS=en+ea/2+.02*u+em/2,eC=eS+em/2>eb?eb-em/2:eS,ew=this.scene.add.text(0,0,"게임 시작",{fontSize:"".concat(ey,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),ek=ew.width;ew.destroy();let ev=this.scene.add.text(0,0,"뒤로",{fontSize:"".concat(ey,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),eE=ev.width;ev.destroy();let eM=Math.max(Math.max(ek,eE)+2*ef,.25*b),ex=eM+eg+eM,eO=p-.5*ex+.5*eM,eI=p+.5*ex-.5*eM,eR=this.scene.add.rectangle(eO,eC,eM,em,ep?5025616:5592405,ep?.9:.5).setStrokeStyle(2,ep?6732650:6710886).setVisible(eu);this.roomWaitingGroup.add(eR),ep?eR.setInteractive({useHandCursor:!0}):eR.disableInteractive(),eR.on("pointerdown",async()=>{if(this.isStartingGame||!this.sceneCallbacks)return;let e=this.sceneCallbacks.getPlayerId(),t=this.sceneCallbacks.getRoomInfo(),s=(null==t?void 0:t.hostId)===e,o=(Array.isArray(null==t?void 0:t.players)?t.players:Object.values((null==t?void 0:t.players)||{})).length,a=s&&o>=2;if(!a){console.warn("[showRoomWaitingScreen] Cannot start game:",{isHost:s,playerCount:o});return}this.isStartingGame=!0,eR.disableInteractive();try{if(!this.sceneCallbacks)throw Error("Scene callbacks not set");let e=this.sceneCallbacks.getRoomId(),t=this.sceneCallbacks.getPlayerId();if(!e||!t)throw Error("Room ID or Player ID not set");if(!g||!g.roomId)throw Error("Invalid room info returned from startGame");this.isStartingGame=!1}catch(t){console.error("[showRoomWaitingScreen] Failed to start game:",t),this.isStartingGame=!1,a&&eR.setInteractive({useHandCursor:!0});let e=t instanceof Error?t.message:"알 수 없는 오류";this.sceneCallbacks&&(e.includes("network")||e.includes("timeout")?this.sceneCallbacks.showError("네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요."):this.sceneCallbacks.showError("게임 시작에 실패했습니다: ".concat(e,". 페이지를 새로고침하거나 다시 시도해주세요.")))}});let eG=this.scene.add.text(eO,eC,"게임 시작",{fontSize:"".concat(ey,"px"),color:ep?"#fff":"#888",fontStyle:"bold"}).setOrigin(.5).setVisible(eu);this.roomWaitingGroup.add(eG);let eL=this.scene.add.rectangle(eI,eC,eM,em,6710886,.9).setStrokeStyle(2,8947848).setInteractive({useHandCursor:!0}).on("pointerdown",async()=>{try{await this.supabaseManager.leaveRoom()}catch(e){console.error("[showRoomWaitingScreen] Error leaving room:",e)}this.roomWaitingGroup&&(this.roomWaitingGroup.destroy(!0),this.roomWaitingGroup=null),this.roomWaitingUnsubscribers.forEach(e=>e()),this.roomWaitingUnsubscribers=[],this.supabaseManager.cleanup(),this.notifyListeners({type:"SHOW_ONLINE_MODE_SELECTION"})});this.roomWaitingGroup.add(eL);let eA=this.scene.add.text(eI,eC,"뒤로",{fontSize:"".concat(ey,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5);this.roomWaitingGroup.add(eA);let eP=eu,eW=this.supabaseManager.onRoomUpdate(e=>{var t,s;let o;if(!this.roomWaitingGroup||!this.roomWaitingGroup.scene){(null===(s=e.gameState)||void 0===s?void 0:s.gameStarted)&&!this.isStartingGame&&this.startOnlineGame(e);return}if(!this.sceneCallbacks){console.warn("[showRoomWaitingScreen] sceneCallbacks is null, skipping update");return}this.sceneCallbacks.setRoomInfo(e);let a=this.sceneCallbacks.getPlayerId(),n=e.hostId===a;n!==eP&&(eP=n,n&&this.sceneCallbacks.showError("호스트가 되었습니다. 게임을 시작할 수 있습니다.")),Array.isArray(e.players)?o=e.players.filter(e=>e&&e.id):e.players&&"object"==typeof e.players?o=Object.keys(e.players).map(t=>{let s=e.players[t];return s&&"object"==typeof s&&"id"in s?s:s&&"object"==typeof s&&"player_id"in s?{id:s.player_id,name:s.player_name||s.name||"Player ".concat(t),isReady:s.is_ready||s.isReady||!1,joinedAt:s.joined_at||s.joinedAt||0}:null}).filter(e=>null!==e&&void 0!==e.id).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):(console.warn("[showRoomWaitingScreen] Invalid players format:",{players:e.players,type:typeof e.players,isArray:Array.isArray(e.players)}),o=[]);let i=o.length,r=o.length>0?o.map((e,t)=>e.name||"Player ".concat(t+1)).join("\n"):"대기 중...";q&&q.scene?q.setText("플레이어: (".concat(i,"/").concat(Y,")")):console.warn("[showRoomWaitingScreen] playersCountText is not available for update"),eh&&eh.scene?eh.setText(r):console.warn("[showRoomWaitingScreen] playerListText is not available for update");let l=eP&&i>=2;ep=l,eR.setFillStyle(l?5025616:5592405,l?.9:.5),eR.setStrokeStyle(2,l?6732650:6710886),l?eR.setInteractive({useHandCursor:!0}):eR.disableInteractive(),eG.setColor(l?"#fff":"#888"),eR.setVisible(eP),eG.setVisible(eP),(null===(t=e.gameState)||void 0===t?void 0:t.gameStarted)&&!this.isStartingGame&&this.startOnlineGame(e)}),ez=this.supabaseManager.onGameStateUpdate(async e=>{if(this.notifyListeners({type:"GAME_STATE_CHANGED",gameState:e}),e.gameStarted&&!this.isStartingGame){if(this.isStartingGame=!0,this.sceneCallbacks){let e=this.sceneCallbacks.getRoomId();if(e)try{var t;let s=this.supabaseManager.getRoomId();this.supabaseManager.roomId=e;let o=null;try{o=await this.supabaseManager.getRoomInfo()}finally{this.supabaseManager.roomId=s}o&&(null===(t=o.gameState)||void 0===t?void 0:t.gameStarted)?(this.isStartingGame=!1,this.startOnlineGame(o)):this.isStartingGame=!1}catch(e){console.error("[showRoomWaitingScreen] Error getting room info in onGameStateUpdate:",e),this.isStartingGame=!1}else this.isStartingGame=!1}else this.isStartingGame=!1}});this.roomWaitingUnsubscribers.push(eW,ez)}startOnlineGame(e){if(!this.sceneCallbacks)throw Error("Manager not initialized");this.isStartingGame||(this.isStartingGame=!0,this.roomWaitingGroup&&(this.roomWaitingGroup.destroy(!0),this.roomWaitingGroup=null),this.roomWaitingUnsubscribers.forEach(e=>e()),this.roomWaitingUnsubscribers=[],this.sceneCallbacks.setIsOnlineMode(!0),this.sceneCallbacks.setRoomInfo(e),this.notifyListeners({type:"START_ONLINE_GAME",roomInfo:e}))}async restartGame(){if(!this.sceneCallbacks)throw Error("Manager not initialized");let e=this.sceneCallbacks.getRoomId();if(!e)throw Error("Not in a room");try{await this.supabaseManager.restartGame(),await this.showRoomWaitingScreen(e)}catch(t){console.error("[OnlineMultiplayerManager] Failed to restart game:",t);let e=t instanceof Error?t.message:"알 수 없는 오류";throw e.includes("network")||e.includes("timeout")?this.sceneCallbacks.showError("네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요."):this.sceneCallbacks.showError("게임 재시작에 실패했습니다: ".concat(e,". 페이지를 새로고침하거나 다시 시도해주세요.")),t}}async changeGame(){if(!this.sceneCallbacks)throw Error("Manager not initialized");let e=this.sceneCallbacks.getRoomId(),t=this.sceneCallbacks.getPlayerId(),s=this.sceneCallbacks.getRoomInfo();if(!e||!t||!s)throw Error("Not in a room");if(s.hostId!==t){this.sceneCallbacks.showError("호스트만 게임을 변경할 수 있습니다.");return}let o=(Array.isArray(s.players)?s.players:Object.values(s.players||{})).length;if(!this.gameSelectionManager)throw Error("GameSelectionManager not initialized");this.roomWaitingGroup&&this.roomWaitingGroup.setVisible(!1),this.gameSelectionManager.showGameSelectionScreen(o,!0),this.gameSelectionManager.setSceneCallbacks({onGameSelected:async t=>{if(!this.sceneCallbacks){console.error("[OnlineMultiplayerManager] Scene callbacks not set");return}if(!this.sceneCallbacks.startScene)throw Error("startScene callback not set");try{var o;let a;this.sceneCallbacks.cleanupRealtimeListeners&&this.sceneCallbacks.cleanupRealtimeListeners();let n=await this.supabaseManager.changeGame(e,t,s.maxPlayers);if(!n.success){console.error("[OnlineMultiplayerManager] Failed to change game:",n.error),this.sceneCallbacks&&this.sceneCallbacks.showError("게임 변경 실패: ".concat(n.error.message));return}let i=this.supabaseManager.getRoomId();this.supabaseManager.roomId=e;try{a=await this.supabaseManager.getRoomInfo()}finally{this.supabaseManager.roomId=i}console.log("[OnlineMultiplayerManager] Game changed successfully, transitioning to RoomWaitingScene",{roomId:a.roomId,sceneKey:a.sceneKey,gameStarted:null===(o=a.gameState)||void 0===o?void 0:o.gameStarted});let l={roomId:a.roomId,roomInfo:a};r.rX.startScene(this.scene,"RoomWaitingScene",l),console.log("[OnlineMultiplayerManager] Scene.start() called for RoomWaitingScene")}catch(t){console.error("[OnlineMultiplayerManager] Failed to change game:",t);let e=t instanceof Error?t.message:"알 수 없는 오류";e.includes("Only the host")?this.sceneCallbacks.showError("호스트만 게임을 변경할 수 있습니다."):e.includes("Need at least 2 players")?this.sceneCallbacks.showError("게임을 변경하려면 최소 2명의 플레이어가 필요합니다."):e.includes("network")||e.includes("timeout")?this.sceneCallbacks.showError("네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 잠시 후 다시 시도해주세요."):this.sceneCallbacks.showError("게임 변경에 실패했습니다: ".concat(e,". 페이지를 새로고침하거나 다시 시도해주세요."))}},onGameSelectionCancelled:()=>{this.roomWaitingGroup&&this.roomWaitingGroup.setVisible(!0)}})}syncGameState(e){var t,s,o,n,i,r,l,c,h,d,u;if(!this.sceneCallbacks)throw Error("Manager not initialized");let p=null===(t=this.scene.scene)||void 0===t?void 0:t.key;if("YachtDiceScene"!==p)return;if(!(0,a.Rp)(e)){console.warn("[OnlineMultiplayerManager] syncGameState: Not a Yacht Dice game state",{currentSceneKey:p,gameStateKeys:Object.keys(e),hasDiceValues:"diceValues"in e,hasRollsLeft:"rollsLeft"in e});return}let m=[...this.sharedState.diceValues],y=this.sharedState.round,f=this.sharedState.rollsLeft,g=e.diceValues;if("string"==typeof e.diceValues)try{let t=JSON.parse(e.diceValues);Array.isArray(t)&&(g=t)}catch(e){console.error("[OnlineMultiplayerManager] Failed to parse diceValues:",e)}if(this.sharedState.diceValues=Array.isArray(g)?[...g]:[0,0,0,0,0],this.sharedState.heldDice=Array.isArray(e.heldDice)?[...e.heldDice]:[!1,!1,!1,!1,!1],this.sharedState.rollsLeft=null!==(i=e.rollsLeft)&&void 0!==i?i:3,this.sharedState.round=null!==(r=e.currentRound)&&void 0!==r?r:1,this.sharedState.currentPlayer=null!==(l=e.currentPlayer)&&void 0!==l?l:0,this.sceneCallbacks.setCurrentPlayer(null!==(c=e.currentPlayer)&&void 0!==c?c:0),this.sharedState.round>13&&y<=13){this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals();let e=this.sceneCallbacks.endGame();e&&"object"==typeof e&&"then"in e&&e.catch(e=>{console.error("Error in endGame:",e)});return}let b=null===(s=this.sceneCallbacks)||void 0===s?void 0:s.getRoomInfo(),S=null===(o=this.sceneCallbacks)||void 0===o?void 0:o.getPlayerId(),C=!1;b&&S&&b.players&&(C=(Array.isArray(b.players)?b.players:Object.keys(b.players).map(e=>{let t=b.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===S)===this.sharedState.currentPlayer);let w=JSON.stringify(m)!==JSON.stringify(this.sharedState.diceValues);if(w){let t=void 0!==e.rollsLeft&&this.sharedState.rollsLeft<f;if(!C&&w&&t){let e=null===(d=this.sceneCallbacks)||void 0===d?void 0:d.getDiceRollSound();e&&!e.isPlaying&&(e.play(),this.scene.time.delayedCall(500,()=>{e&&e.isPlaying&&e.stop()}))}let s=()=>{var e,t,s;null===(e=this.sceneCallbacks)||void 0===e||e.updateDiceAppearance(),null===(t=this.sceneCallbacks)||void 0===t||t.calculatePotentialScores(),null===(s=this.sceneCallbacks)||void 0===s||s.updateUI()};(null===(h=this.sceneCallbacks)||void 0===h?void 0:h.getIsRolling())?this.scene.time.delayedCall(500,()=>{s()}):s()}else null===(u=this.sceneCallbacks)||void 0===u||u.updateDiceAppearance(),this.sceneCallbacks.calculatePotentialScores(),this.sceneCallbacks.updateUI(),this.sceneCallbacks.updatePlayerScores();this.sceneCallbacks.updatePlayerScores();let k=[];e.scores&&(Array.isArray(e.scores)?k=e.scores:"object"==typeof e.scores&&(k=Object.values(e.scores)));let v=this.sceneCallbacks.getNumberOfPlayers();if(b&&b.players?v=(Array.isArray(b.players)?b.players:Object.keys(b.players).map(e=>{let t=b.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).length:k.length>0&&(v=k.length),v!==this.sceneCallbacks.getNumberOfPlayers()){this.sceneCallbacks.setNumberOfPlayers(v);let e=[...this.sceneCallbacks.getScores()],t=[];for(let s=0;s<v;s++)s<e.length&&e[s]?t.push(new Map(e[s])):t.push(new Map);this.sceneCallbacks.setScores(t)}else{let e=this.sceneCallbacks.getScores();if(e.length!==v){let t=[...e],s=[];for(let e=0;e<v;e++)e<t.length&&t[e]?s.push(new Map(t[e])):s.push(new Map);this.sceneCallbacks.setScores(s)}}let E=Math.min(k.length,v);if(b&&b.players){let e;if((e=Array.isArray(b.players)?b.players:Object.keys(b.players).map(e=>{let t=b.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).length===k.length&&e.length===v){let e=this.sceneCallbacks.getScores(),t=!1;for(let s=0;s<E;s++){let o=k[s];if(o&&"object"==typeof o){let a=new Map;Object.entries(o).forEach(e=>{let[t,s]=e;"number"==typeof s&&a.set(t,s)});let n=e[s];n&&JSON.stringify(Array.from(n.entries()))===JSON.stringify(Array.from(a.entries()))||(t=!0),e[s]=a}}t&&(this.sceneCallbacks.setScores(e),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals(),this.sceneCallbacks.updatePlayerScores())}else{let e=this.sceneCallbacks.getScores(),t=!1;for(let s=0;s<E;s++){let o=k[s];if(o&&"object"==typeof o){let a=new Map;Object.entries(o).forEach(e=>{let[t,s]=e;"number"==typeof s&&a.set(t,s)});let n=e[s];n&&JSON.stringify(Array.from(n.entries()))===JSON.stringify(Array.from(a.entries()))||(t=!0),e[s]=a}}t&&(this.sceneCallbacks.setScores(e),this.sceneCallbacks.updateScorecardText(),this.sceneCallbacks.updateTotals())}}else{let e=this.sceneCallbacks.getScores();for(let t=0;t<E;t++){let s=k[t];if(s&&"object"==typeof s){let o=new Map;Object.entries(s).forEach(e=>{let[t,s]=e;"number"==typeof s&&o.set(t,s)}),e[t]=o}}this.sceneCallbacks.setScores(e)}null===(n=this.sceneCallbacks)||void 0===n||n.updateRollButtonText()}setupOnlineMode(e,t){if(!this.sceneCallbacks)throw Error("Manager not initialized");this.notifyListeners({type:"SETUP_ONLINE_MODE",roomId:e,playerId:t})}notifyListeners(e){var t;let s=null===(t=this.scene.scene)||void 0===t?void 0:t.key;this.eventListeners.forEach((t,o)=>{try{t(e)}catch(e){throw console.error("[notifyListeners] Listener ".concat(o," threw error:"),e,{currentSceneKey:s}),e}})}async shareRoomCode(e){await this.shareRoomCodeViaMessaging(e)}copyRoomCodeToClipboardSync(e,t){try{let t=new URL(window.location.href);t.searchParams.set("room",e);let s=t.toString();if(navigator.share&&navigator.canShare&&navigator.canShare({text:e,url:s})){navigator.share({title:"게임 룸 초대",text:"게임 룸에 참가하세요! 룸 코드: ".concat(e),url:s}).then(()=>{this.showShareSuccessMessage()}).catch(t=>{"AbortError"!==t.name&&(console.warn("[OnlineMultiplayerManager] Web Share failed:",t),this.showRoomCodeForManualCopy(e,s))});return}this.showRoomCodeForManualCopy(e,s)}catch(s){console.error("[OnlineMultiplayerManager] Failed to share room code:",s);let t=new URL(window.location.href);t.searchParams.set("room",e),this.showRoomCodeForManualCopy(e,t.toString())}}showRoomCodeForManualCopy(e,t){let s=this.scene.cameras.main.width,o=this.scene.cameras.main.height,a=s/2,n=o/2;this.roomWaitingGroup&&this.roomWaitingGroup.list.forEach(e=>{(e.getData("isRoomCodePopup")||e.getData("isRoomCodeText"))&&e.destroy()});let i=.85*s,r=.3*o,l=this.scene.add.rectangle(a,n,i,r,1710618,.95).setStrokeStyle(3,5025616).setDepth(2e3).setData("isRoomCodePopup",!0),c=this.scene.add.text(a,n-.3*r,"룸 코드",{fontSize:"".concat(.03*o,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setDepth(2001).setData("isRoomCodeText",!0),h=this.scene.add.text(a,n,e,{fontSize:"".concat(.05*o,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5).setDepth(2001).setData("isRoomCodeText",!0),d=this.scene.add.text(a,n+.25*r,"룸 코드를 길게 눌러 복사하세요",{fontSize:"".concat(.02*o,"px"),color:"#fff"}).setOrigin(.5).setDepth(2001).setData("isRoomCodeText",!0),u=this.scene.add.rectangle(a,n+.4*r,.3*i,.05*o,6710886,.9).setStrokeStyle(2,10066329).setInteractive({useHandCursor:!0}).setDepth(2001).setData("isRoomCodePopup",!0).on("pointerdown",()=>{l.destroy(),c.destroy(),h.destroy(),d.destroy(),u.destroy(),p.destroy()}),p=this.scene.add.text(a,n+.4*r,"닫기",{fontSize:"".concat(.025*o,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(2002).setData("isRoomCodeText",!0).on("pointerdown",()=>{l.destroy(),c.destroy(),h.destroy(),d.destroy(),u.destroy(),p.destroy()})}showShareSuccessMessage(){let e=this.scene.cameras.main.height,t=this.scene.cameras.main.width/2,s=this.scene.cameras.main.height/2,o=this.scene.add.text(t,s,"공유되었습니다!",{fontSize:"".concat(.025*e,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5).setDepth(2e3);this.scene.time.delayedCall(2e3,()=>{o&&o.scene&&o.destroy()})}async copyRoomCodeToClipboard(e){var t,s;try{if(navigator.clipboard){let t=new URL(window.location.href);t.searchParams.set("room",e);let s=t.toString();await navigator.clipboard.writeText(s);let o=this.scene.cameras.main.height,a=this.scene.cameras.main.width/2,n=this.scene.cameras.main.height/2,i=this.scene.add.text(a,n,"링크가 복사되었습니다!",{fontSize:"".concat(.025*o,"px"),color:"#4caf50",fontStyle:"bold"}).setOrigin(.5).setDepth(2e3);this.scene.time.delayedCall(2e3,()=>{i&&i.scene&&i.destroy()})}else console.warn("[OnlineMultiplayerManager] Clipboard API not available"),null===(t=this.sceneCallbacks)||void 0===t||t.showError("클립보드 복사가 지원되지 않습니다.")}catch(e){console.error("[OnlineMultiplayerManager] Failed to copy room link:",e),null===(s=this.sceneCallbacks)||void 0===s||s.showError("링크 복사에 실패했습니다.")}}async shareRoomCodeViaMessaging(e){try{if(navigator.share&&navigator.canShare){let t={title:"게임 룸 초대",text:"게임 룸에 참가하세요! 룸 코드: ".concat(e),url:window.location.href};navigator.canShare(t)?await navigator.share(t):await this.copyRoomCodeToClipboard(e)}else await this.copyRoomCodeToClipboard(e)}catch(t){"AbortError"!==t.name&&(console.error("[OnlineMultiplayerManager] Failed to share room code:",t),await this.copyRoomCodeToClipboard(e))}}constructor(){this.eventListeners=[],this.supabaseManager=(0,a.nc)(),this.roomWaitingGroup=null,this.roomWaitingUnsubscribers=[],this.roomListElements=[],this.isStartingGame=!1,this.selectedMaxPlayers=4,this.currentSceneKey=null,this.sceneCallbacks=null}}},2966:function(e,t,s){s.d(t,{S:function(){return o}});function o(e){if(e<1||e>4)throw Error("Invalid number of players: must be between 1 and 4, got ".concat(e));let t=[];for(let s=0;s<e;s++)t.push(new Map);return{diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],scores:t,currentPlayer:0,round:1,rollsLeft:3,numberOfPlayers:e,isOnlineMode:!1,roomId:null,playerId:null}}}}]);