"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4752],{4752:function(e,t,i){i.r(t),i.d(t,{default:function(){return p}});var s=i(8439),r=i(7135),n=i(8782),l=i(3382),a=i(2769),o=i(6332),h=i(2966),c=i(9309);let u=[2201331,16007990,16761095,10233776,5025616],d=[6600182,15037299,16766287,12216520,8505220];class y{getNextY(e,t){let i=void 0!==t?t:this.spacing;this.currentY+=i;let s=this.currentY+e/2;return this.currentY+=e,s}getCurrentY(){return this.currentY}setY(e){this.currentY=e}setSpacing(e){this.spacing=e}constructor(e,t,i=0){this.currentY=i,this.spacing=.02*t}}class p extends a.Scene{canPlaceDice(){if(this.isOnlineMode&&this.roomInfo&&this.playerId){let e=(Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId),t=e>=0&&e===this.currentPlayer;if(!t)return!1;let i=(this.playerDice[e]||[]).length>0,s=this.playerDiceCounts[e]||0,r=this.neutralDiceCounts[e]||0;return(s>0||r>0)&&i&&this.hasRolledThisTurn&&t&&!this.isRolling}{let e=(this.playerDice[this.currentPlayer]||[]).length>0,t=this.playerDiceCounts[this.currentPlayer]||0,i=this.neutralDiceCounts[this.currentPlayer]||0;return(t>0||i>0)&&e&&this.hasRolledThisTurn&&!this.isRolling}}darkenColor(e,t){return Math.floor((e>>16&255)*(1-t))<<16|Math.floor((e>>8&255)*(1-t))<<8|Math.floor((255&e)*(1-t))}preload(){for(let e=1;e<=6;e++)this.load.image("dice".concat(e),"/images/dice/Side".concat(e,".png"));this.load.audio("diceRoll","/sounds/dice-18.wav")}init(e){if(console.log("init"),this.isUIInitialized=!1,this.isOnlineMode=(null==e?void 0:e.isOnlineMode)||!1,this.isOnlineMode){var t;if(this.roomId=(null==e?void 0:e.roomId)||null,this.roomInfo=(null==e?void 0:e.roomInfo)||null,!this.roomInfo)throw Error("Room info is required");if((null===(t=this.roomInfo.gameState)||void 0===t?void 0:t.gameStarted)===!1){n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:this.roomInfo});return}let i=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.values(this.roomInfo.players||{});this.numberOfPlayers=i.length}else this.numberOfPlayers=(null==e?void 0:e.numberOfPlayers)||0}create(){var e,t,i;console.log("create"),this.headerManager=new s.F(this),this.popupSystem=new c.T(this);let r=this.cameras.main.width,n=this.cameras.main.height;this.setupResizeHandler(),this.setupTouchScroll(),this.add.rectangle(r/2,n/2,r,n,1710618,1),this.isOnlineMode&&this.roomId&&(!this.playerId&&this.supabaseManager&&(this.playerId=this.supabaseManager.getPlayerId()),this.ensureOnlineMultiplayerManagerInitialized());let l=this.isOnlineMode&&((null===(e=this.roomInfo)||void 0===e?void 0:e.hostId)===this.playerId||this.roomId&&this.playerId&&!this.roomInfo);this.isOnlineMode&&this.roomId&&this.playerId?!l||(null===(i=this.roomInfo)||void 0===i?void 0:null===(t=i.gameState)||void 0===t?void 0:t.gameStarted)?this.setupOnlineMode():(this.setupOnlineMode(),this.startGame()):(this.startGame(),this.createGameUI())}startGame(){this.currentRound=1,this.currentPlayer=0,this.playerMoney=[],this.playerDice=[],this.playerDiceCounts=[],this.neutralDiceCounts=[];let e=this.numberOfPlayers<=4?2:0;for(let t=0;t<this.numberOfPlayers;t++)this.playerMoney.push(0),this.playerCardCounts.push(0),this.playerDice.push([]),this.playerDiceCounts.push(8),this.neutralDiceCounts.push(e);this.createBillDeck(),this.setupRound(),this.isOnlineMode&&this.roomId&&this.onlineMultiplayerManager&&this.roomId&&this.roomInfo&&this.supabaseManager&&(console.log("supabaseManager.startGame"),this.supabaseManager.startGame(this.casinos.map(e=>({number:e.number,playerDice:Object.fromEntries(e.playerDice),neutralDiceCount:e.neutralDiceCount,moneyCards:e.moneyCards}))))}createBillDeck(){this.billDeck=[];for(let e=0;e<6;e++)this.billDeck.push({value:1e4,text:"$10,000"});for(let e=0;e<8;e++)this.billDeck.push({value:2e4,text:"$20,000"});for(let e=0;e<8;e++)this.billDeck.push({value:3e4,text:"$30,000"});for(let e=0;e<6;e++)this.billDeck.push({value:4e4,text:"$40,000"});for(let e=0;e<6;e++)this.billDeck.push({value:5e4,text:"$50,000"});for(let e=6e4;e<=9e4;e+=1e4)for(let t=0;t<5;t++)this.billDeck.push({value:e,text:"$".concat(e.toLocaleString())});for(let e=this.billDeck.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[this.billDeck[e],this.billDeck[t]]=[this.billDeck[t],this.billDeck[e]]}}setupRound(){let e=[];for(let t=1;t<=6;t++){let t=[],i=0;for(;i<5e4&&this.billDeck.length>0;){let e=this.billDeck.shift();t.push(e),i+=e.value}t.sort((e,t)=>t.value-e.value),e.push(t)}this.casinos=[];for(let t=1;t<=6;t++)this.casinos.push({number:t,moneyCards:e[t-1],playerDice:new Map,neutralDiceCount:0});for(let e=0;e<this.numberOfPlayers;e++){this.playerDiceCounts[e]=8;let t=this.numberOfPlayers>=5?0:2;this.neutralDiceCounts[e]=t,this.playerDice[e]=[]}this.currentPlayer=0,this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.isRolling=!1,this.hasRolledThisTurn=!1;for(let e=0;e<this.numberOfPlayers;e++){var t;this.selectedDiceIsNeutral=Array((null===(t=this.playerDice[e])||void 0===t?void 0:t.length)||0).fill(!1)}}createGameUI(){var e,t,i,r,n;let l=this.cameras.main.width,a=this.cameras.main.height;if(!this.playerMoney||0===this.playerMoney.length){this.playerMoney=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerMoney.push(0)}if(!this.playerCardCounts||0===this.playerCardCounts.length){this.playerCardCounts=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerCardCounts.push(0)}this.initialCasinoStartY=null,this.initialCasinoEndY=null,this.initialCasinoHeight=null,this.diceObjects.forEach(e=>e.destroy()),this.diceObjects=[],this.casinoObjects.forEach(e=>e.destroy()),this.casinoObjects=[],this.playerSelectButtons.forEach(e=>e.destroy()),this.playerSelectButtons=[],this.startButton&&this.startButton.destroy(),this.headerResult&&this.headerManager&&(this.headerManager.destroy(this.headerResult),this.headerResult=void 0),!this.headerResult&&(this.mainMenuButtonBg&&this.mainMenuButtonBg.destroy(),this.mainMenuButton&&this.mainMenuButton.destroy());let o=[];this.children.list.forEach(e=>{if(e.active){let t=e.text;if("string"==typeof t&&(t.includes("Las Vegas")||t.includes("플레이어 수를 선택")||t.includes("명")||"메인 메뉴"===t)&&o.push(e),"Rectangle"===e.type){let t=e.fillColor,i=e.y>.3*a&&e.y<.5*a&&e.width>.1*l&&e.width<.2*l;(2201331===t||16007990===t||16761095===t||10233776===t||5025616===t||i)&&o.push(e)}}}),o.forEach(e=>{e&&e.scene&&e.destroy()}),this.headerManager||(this.headerManager=new s.F(this)),this.headerResult&&this.headerManager.destroy(this.headerResult);let h=!this.isOnlineMode||(null===(e=this.roomInfo)||void 0===e?void 0:e.hostId)===this.playerId,c=!this.isOnlineMode||this.isOnlineMode&&h;this.headerResult=this.headerManager.createHeader({showMainMenu:!0,showNewGame:!0,showChangeGame:c,showFullscreen:!0,isMobile:!1},{showTurn:!0,showRound:!0,currentPlayer:this.currentPlayer,currentRound:this.currentRound,maxRounds:this.maxRounds,playerColors:u,playerColorsLight:d}),this.headerResult.buttons.mainMenu&&(this.headerResult.buttons.mainMenu.bg.on("pointerdown",()=>{this.showMainMenuConfirmPopup()}),this.headerResult.buttons.mainMenu.text.on("pointerdown",()=>{this.showMainMenuConfirmPopup()}),this.mainMenuButtonBg=this.headerResult.buttons.mainMenu.bg,this.mainMenuButton=this.headerResult.buttons.mainMenu.text),this.headerResult.buttons.newGame&&(this.headerResult.buttons.newGame.bg.on("pointerdown",()=>{this.showRestartConfirmPopup()}),this.headerResult.buttons.newGame.text.on("pointerdown",()=>{this.showRestartConfirmPopup()})),this.headerResult.buttons.changeGame&&(this.headerResult.buttons.changeGame.bg.on("pointerdown",()=>{this.changeGame()}),this.headerResult.buttons.changeGame.text.on("pointerdown",()=>{this.changeGame()})),(null===(t=this.headerResult.info)||void 0===t?void 0:t.turn)&&(this.playerText=this.headerResult.info.turn.text);let p=this.headerResult.topMargin,m=this.headerResult.height-2*p,g=.05*a,f=new y(l,a,p+Math.max(m,g)+.01*a);this.statusText&&(this.statusText.destroy(),this.statusText=void 0);let D=.1*a,C=f.getNextY(D,.02*a);this.playerMoneyTexts.forEach(e=>e.destroy()),this.playerMoneyTexts=[],this.playerScoreTexts.forEach(e=>e.destroy()),this.playerScoreTexts=[],this.playerDiceCountTexts.forEach(e=>e.destroy()),this.playerDiceCountTexts=[],this.neutralDiceCountTexts.forEach(e=>e.destroy()),this.neutralDiceCountTexts=[],this.playerDiceIcons.forEach(e=>e.destroy()),this.playerDiceIcons=[];let S=l/this.numberOfPlayers;for(let e=0;e<this.numberOfPlayers;e++){let t=(e+.5)*S,s=e===this.currentPlayer,o=this.add.rectangle(t,C,.95*S,D,s?u[e]||6710886:3355443,s?.9:.6);o.setDepth(100),s?o.setStrokeStyle(3,d[e]||10066329):o.setStrokeStyle(2,5592405),this.playerScoreBgs.push(o);let h=d[e]||11184810,c="#".concat(h.toString(16).padStart(6,"0")),y=Math.max(.022*a,12),p=null!==(i=this.playerMoney[e])&&void 0!==i?i:0,m=this.add.text(t,0,"P".concat(e+1,": $").concat(p.toLocaleString()),{fontSize:"".concat(y,"px"),color:s?"#fff":c,fontStyle:"bold",align:"center"});m.setOrigin(.5);let g=C-D/2,f=m.height,b=g+4+f/2;m.setY(b),m.setDepth(101),this.playerScoreTexts.push(m);let I=Math.max(.016*a,10),P=this.add.text(t,0,"카드 ".concat(this.playerCardCounts[e],"장"),{fontSize:"".concat(I,"px"),color:s?"#fff":c,fontStyle:"normal",align:"center"});P.setOrigin(.5);let M=b+f/2,O=P.height,R=M+4+O/2;P.setY(R),P.setDepth(101),this.playerMoneyTexts.push(P);let v=R+O/2+4,x=Math.max(.01*a,6),B=.2*x,A=.85*S,w=8-(null!==(r=this.playerDiceCounts[e])&&void 0!==r?r:8),T=t-A/2+.01*l,E=this.add.text(T,v,"Dice:",{fontSize:"".concat(Math.max(.012*a,9),"px"),color:s?"#fff":c,fontStyle:"normal",align:"left"});E.setOrigin(0,.5),E.setDepth(101),this.playerDiceCountTexts.push(E);let Y=T+(E.width||.03*l)+.015*l,k=u[e]||6710886;for(let e=0;e<8;e++){let t=Y+e*(x+B),i=e<w?k:16777215,s=this.add.circle(t,v,x/2,i,1);s.setDepth(101),this.playerDiceIcons.push(s)}let N=this.add.text(Y+8*(x+B)+B,v,"(".concat(w,"/").concat(8,")"),{fontSize:"".concat(Math.max(.012*a,9),"px"),color:s?"#fff":c,fontStyle:"normal",align:"left"});N.setOrigin(0,.5),N.setDepth(101),this.playerDiceCountTexts.push(N);let j=this.numberOfPlayers<=4?2:0;if(j>0){let t=null!==(n=this.neutralDiceCounts[e])&&void 0!==n?n:j,i=j-t,r=v+E.height/2+4,o=this.add.text(T,r,"Neutral:",{fontSize:"".concat(Math.max(.012*a,9),"px"),color:s?"#fff":c,fontStyle:"normal",align:"left"});o.setOrigin(0,.5),o.setDepth(101),this.neutralDiceCountTexts.push(o);let h=T+(o.width||.04*l)+.015*l;for(let e=0;e<j;e++){let t=h+e*(x+B),s=e<i?10066329:16777215,n=this.add.circle(t,r,x/2,s,1);n.setDepth(101),this.playerDiceIcons.push(n)}let u=this.add.text(h+j*(x+B)+B,r,"(".concat(i,"/").concat(j,")"),{fontSize:"".concat(Math.max(.012*a,9),"px"),color:s?"#fff":c,fontStyle:"normal",align:"left"});u.setOrigin(0,.5),u.setDepth(101),this.neutralDiceCountTexts.push(u)}}this.createCasinos(f),this.createDiceArea(),this.createButtons(f),this.updateScrollBounds()}createCasinos(e){let t,i,s;let r=this.cameras.main.width,l=this.cameras.main.height,o=.015*l,h=.08*l,c=h+.02*l*2,y=.04*l;if(null!==this.initialCasinoStartY&&null!==this.initialCasinoEndY)t=this.initialCasinoStartY,i=this.initialCasinoEndY;else if(e){let s=e.getCurrentY();null!==this.initialCasinoStartY&&null!==this.initialCasinoEndY?(t=this.initialCasinoStartY,i=this.initialCasinoEndY):(t=s+.04*l,i=l-c-y,this.initialCasinoStartY=t,this.initialCasinoEndY=i)}else null!==this.initialCasinoStartY&&null!==this.initialCasinoEndY?(t=this.initialCasinoStartY,i=this.initialCasinoEndY):(t=.02*l+.06*l/2+.06*l/2+.02*l+.04*l+.08*l/2+.03*l,i=this.buttonY>0?this.buttonY-h/2-y:l-c-y,this.initialCasinoStartY=t,this.initialCasinoEndY=i);if(null!==this.initialCasinoHeight)s=this.initialCasinoHeight;else{let e=i-t;s=e,e<.2*l&&console.warn("[LasVegas] createCasinos - Available height is too small:",{availableHeight:e,casinoStartY:t,casinoEndY:i,gameHeight:l,buttonAreaHeight:c,casinoToButtonSpacing:y}),this.initialCasinoHeight=s}e&&null===this.initialCasinoStartY&&null===this.initialCasinoEndY&&e.setY(t+s),this.casinoObjects.forEach(e=>e.destroy()),this.casinoObjects=[],this.prizeCardObjects.clear();let p=(.95*r-2*o)/3,m=.025*r,g=(s-1*o)/2;for(let e=0;e<this.casinos.length;e++){let i=this.casinos[e],s=Math.floor(e/3),h=m+e%3*(p+o)+p/2,c=t+s*(g+o)+g/2,y=h-p/2,f=this.add.rectangle(h,c,p,g,2763306,1);f.setStrokeStyle(2,4473924),f.setDepth(10);let D=y+.02*r,C=c-.35*g,S=this.add.text(D,C,"카지노 ".concat(i.number),{fontSize:"".concat(Math.max(.022*l,14),"px"),color:"#fff",fontStyle:"bold"});S.setOrigin(0,.5),S.setDepth(20);let b=C+.015*l,I=c-b,P=Math.min(.3*I,.15*g),M=[],O=[...i.moneyCards].sort((e,t)=>t.value-e.value);if(0===O.length){let e=this.add.text(h,b+I/2,"(상금 없음)",{fontSize:"".concat(Math.max(.016*l,12),"px"),color:"#999",fontStyle:"italic"});e.setOrigin(.5,.5),e.setDepth(20),M.push(e)}else{let e=Math.max(.014*l,10),t=.01*r,s=0;O.forEach(t=>{let i=this.add.text(0,0,"$".concat(t.value.toLocaleString()),{fontSize:"".concat(e,"px"),color:"#000",fontStyle:"bold",align:"center"}).setOrigin(.5),r=i.width;i.destroy(),s=Math.max(s,r)});let n=Math.max(s+2*t,Math.min(.08*r,.4*g)),a=Math.max(.15*P,.005*l),o=b;O.forEach((t,s)=>{let r=o+a+P/2;0===s&&(r=b+P/2);let l=r-P/2,u=r+P/2;if(l<b&&(r=b+P/2),u>c)return;l<o+a&&(r=o+a+P/2);let d=r-P/2,y=r+P/2;if(d<b||y>c)return;o=y;let p=16766720,m=16772430;t.value>=8e4?(p=16739179,m=16732754):t.value>=6e4?(p=16750592,m=16758605):t.value>=4e4?(p=16766720,m=16772430):t.value>=2e4?(p=5025616,m=8505220):(p=2201331,m=6600182);let g=this.add.rectangle(h,r,n,P,p,1);g.setStrokeStyle(2,m),g.setDepth(20);let f=this.add.rectangle(h,r,.92*n,.88*P,16775388,1);f.setDepth(21);let D=this.add.text(h,r,"$".concat(t.value.toLocaleString()),{fontSize:"".concat(e,"px"),color:"#000",fontStyle:"bold",align:"center"});D.setOrigin(.5),D.setDepth(22),M.push(g,f,D),this.prizeCardObjects.has(i.number)||this.prizeCardObjects.set(i.number,[]),this.prizeCardObjects.get(i.number).push({card:g,innerBg:f,text:D,value:t.value})})}let R=Math.min(.15*g,.05*r),v=.3*R,x=[];Array.from(i.playerDice.entries()).filter(e=>{let[t,i]=e;return i>0}).forEach(e=>{let[t,i]=e;x.push({type:"player",playerIndex:t,count:i})}),i.neutralDiceCount>0&&x.push({type:"neutral",count:i.neutralDiceCount}),x.sort((e,t)=>t.count!==e.count?t.count-e.count:"neutral"===e.type&&"player"===t.type?1:"player"===e.type&&"neutral"===t.type?-1:"player"===e.type&&"player"===t.type?(e.playerIndex||0)-(t.playerIndex||0):0);let B=c+g/2,A=h-p/2,w=h+p/2,T=c+R/2+.01*l,E=h-(x.length*R+(x.length-1)*v)/2+R/2;x.forEach(e=>{let t,i;E-R/2>=A&&E+R/2<=w&&T+R/2<=B&&("player"===e.type&&void 0!==e.playerIndex?((t=this.add.rectangle(E,T,R,R,u[e.playerIndex]||6710886,.9)).setStrokeStyle(2,d[e.playerIndex]||10066329),t.setDepth(20),i=this.add.text(E,T,"".concat(e.count),{fontSize:"".concat(Math.max(.014*l,9),"px"),color:"#fff",fontStyle:"bold"})):((t=this.add.rectangle(E,T,R,R,13421772,.9)).setStrokeStyle(2,10066329),t.setDepth(20),i=this.add.text(E,T,"".concat(e.count),{fontSize:"".concat(Math.max(.014*l,9),"px"),color:"#000",fontStyle:"bold"})),i.setOrigin(.5),i.setDepth(21),M.push(t,i)),E+=R+v}),f.setInteractive(new a.Geom.Rectangle(h-.5*p,c-.5*g,p,g),a.Geom.Rectangle.Contains),this.canPlaceDice()&&this.selectedDiceGroup.length>0&&(n.Wc.setup(f,()=>{this.placeDiceOnCasino(e)}),f.setInteractive({useHandCursor:!0})),[f,S,...M].forEach(e=>{this.casinoObjects.push(e)})}}createDiceArea(){let e=this.cameras.main.width,t=this.cameras.main.height,i=.02*t+.06*t/2+.06*t/2+.02*t+.02*t+.1*t/2+.02*t,s=.03*t,r=i+Math.max(t-(.08*t+.02*t*2)-i-s,.3*t)+s/2,l=Math.min(.08*e,.08*t);this.diceObjects.forEach(e=>e.destroy()),this.diceObjects=[],this.numberButtons.forEach(e=>{if(e&&e.active){try{e.removeAllListeners(),e.input&&e.removeInteractive()}catch(e){console.warn("[LasVegas] Error removing listeners from button:",e)}e.destroy()}}),this.numberButtons=[];let o=[];o=this.playerDice[this.currentPlayer]||[];let h=new Map;o.length>0&&o.forEach((e,t)=>{h.has(e)||h.set(e,{indices:[],isNeutral:[]});let i=h.get(e);i.indices.push(t),i.isNeutral.push(this.selectedDiceIsNeutral[t]||!1)});let c=Array.from(h.entries()).sort((e,t)=>e[0]-t[0]);if(0===c.length)return;if(this.hasRolledThisTurn&&o.length>0&&this.selectedDiceGroup.length>0&&!this.isRolling){let i=o[this.selectedDiceGroup[0]],s=h.get(i);if(s){let i=[],n=[];s.indices.forEach(e=>{this.selectedDiceIsNeutral[e]?n.push(e):i.push(e)});let a=Math.max(i.length,n.length),h=Math.max(.2*e,a*l*.6+(a-1)*l*.15),c=2.2*l,d=.5*e,y=r-2.5*l,p=u[this.currentPlayer]||6710886,m="#".concat(p.toString(16).padStart(6,"0")),g=this.add.rectangle(d,y,h,c,16777215,0);g.setStrokeStyle(3,16711680),g.setDepth(1e4),this.diceObjects.push(g);let f=Math.min(.9*h/a,.6*l),D=.2*f;if(i.length>0){let e=d-(i.length*f+(i.length-1)*D)/2+f/2,t=y-c/2+f/2+2*D;i.forEach((i,s)=>{let r=o[i],n="dice".concat(r);if(!this.textures.exists(n)){console.warn("[LasVegas] createDiceArea - Texture not found: ".concat(n,", skipping dice image creation"));return}let l=this.add.image(e+s*(f+D),t,n);l.setDisplaySize(f,f),l.setTint(p),l.setDepth(10001),this.diceObjects.push(l)})}if(n.length>0){let e=d-(n.length*f+(n.length-1)*D)/2+f/2,t=y-c/2+f/2+2*D+f+2*D;n.forEach((i,s)=>{let r=o[i],n="dice".concat(r);if(!this.textures.exists(n)){console.warn("[LasVegas] createDiceArea - Texture not found: ".concat(n,", skipping neutral dice image creation"));return}let l=this.add.image(e+s*(f+D),t,n);l.setDisplaySize(f,f),l.setTint(8947848),l.setDepth(10001),this.diceObjects.push(l)})}let C=y+c/2-.04*t;if(i.length>0){let e=this.add.text(d,C,"".concat(i.length,"개"),{fontSize:"".concat(.018*t,"px"),color:m,fontStyle:"bold"});e.setOrigin(.5),e.setDepth(10002),this.diceObjects.push(e)}if(n.length>0){let e=i.length>0?C+.018*t:C,s=this.add.text(d,e,"N: ".concat(n.length,"개"),{fontSize:"".concat(.016*t,"px"),color:"#999"});s.setOrigin(.5),s.setDepth(10002),this.diceObjects.push(s)}return}}let d=r-1.2*l,y=.1*e,p=.07*t,m=.02*e,g=[];c.forEach(e=>{let[t,i]=e,s=0,r=0;i.indices.forEach(e=>{this.selectedDiceIsNeutral[e]?r++:s++}),g.push(Math.max(s,r))});let f=Math.min(.04*e,.04*t),D=.2*f,C=.01*e,S=[];g.forEach(e=>{let t=Math.min(e,6),i=t*f+(t-1)*D+2*C;S.push(Math.max(y,1.05*i))});let b=0;S.forEach((e,t)=>{b+=e,t<S.length-1&&(b+=m)});let I=.5*e-b/2;c.forEach((e,i)=>{let s,[r,l]=e,h=S[i],c=I+h/2;I+=h+m;let y=this.selectedDiceGroup.length>0&&o[this.selectedDiceGroup[0]]===r,g=0,C=0;l.indices.forEach(e=>{this.selectedDiceIsNeutral[e]?C++:g++});let b=u[this.currentPlayer]||6710886,P="#".concat(b.toString(16).padStart(6,"0")),M=.022*t,O=0;g>0&&(O+=f+D),C>0&&(O+=f+D),g>0&&(O+=M+.022*t),C>0&&(O+=M);let R=Math.max(p,O+=.02*t*2),v=this.add.rectangle(c,d,h,R,y?5025616:4473924,y?.9:.7);v.setStrokeStyle(2,y?8505220:6710886);let x=[],B=0;if(g>0){let e=d-R/2+f/2+D,t=c-(g*f+(g-1)*D)/2+f/2;for(let i=0;i<g;i++){let s=t+i*(f+D);B=e;let n="dice".concat(r);if(!this.textures.exists(n)){console.warn("[LasVegas] createDiceArea - Texture not found: ".concat(n,", skipping player dice image creation"));continue}let l=this.add.image(s,B,n);l.setDisplaySize(f,f),l.setTint(b),x.push(l)}}let A=[],w=0;if(C>0){let e=g>0?d-R/2+f/2+D+f+D:d-R/2+f/2+D,t=c-(C*f+(C-1)*D)/2+f/2;for(let i=0;i<C;i++){let s=t+i*(f+D);w=e;let n="dice".concat(r);if(!this.textures.exists(n)){console.warn("[LasVegas] createDiceArea - Texture not found: ".concat(n,", skipping neutral dice image creation"));continue}let l=this.add.image(s,w,n);l.setDisplaySize(f,f),l.setTint(8947848),A.push(l)}}let T=.02*t;s=C>0&&w>0?w+f/2+T:g>0&&B>0?B+f/2+T:d+R/2-T;let E=null;g>0&&(E=this.add.text(c,s,"".concat(g,"개"),{fontSize:"".concat(.022*t,"px"),color:P,fontStyle:"bold"})).setOrigin(.5);let Y=null;if(C>0){let e=g>0?s+.022*t:s;(Y=this.add.text(c,e,"N: ".concat(C,"개"),{fontSize:"".concat(.02*t,"px"),color:"#999",fontStyle:"normal"})).setOrigin(.5)}let k=[v,...x,...A];E&&k.push(E),Y&&k.push(Y);let N=this.add.container(0,0);if(N.add(k),N.setDepth(1e4),this.canPlaceDice()){let e=new a.Geom.Rectangle(c-h/2,d-R/2,h,R);N.setInteractive(e,a.Geom.Rectangle.Contains),N.input&&(N.input.cursor="pointer"),N.removeAllListeners(),n.Wc.setup(N,()=>{if(!this.canPlaceDice()){console.warn("[LasVegas] Number button clicked but cannot place dice, ignoring");return}this.selectDiceByNumber(r)}),N.on("pointerover",()=>{y||v.setFillStyle(5592405,.9)}),N.on("pointerout",()=>{y||v.setFillStyle(4473924,.7)})}else N.removeInteractive(),N.removeAllListeners();this.numberButtons.push(N)})}selectDiceByNumber(e){if(!this.canPlaceDice()){console.warn("[LasVegas] Cannot select dice: cannot place dice");return}let t=this.playerDice[this.currentPlayer]||[],i=[];if(t.forEach((t,s)=>{t===e&&i.push(s)}),i.length>0){this.selectedDiceGroup=i;let t=e-1;t>=0&&t<this.casinos.length?this.placeDiceOnCasino(t):(console.warn("[LasVegas] Casino ".concat(e," not found")),this.createDiceArea(),this.updateButtonStates())}else console.warn("[LasVegas] No dice found for number:",e)}createButtons(e){let t,i;let s=this.cameras.main.width,r=this.cameras.main.height,n=.08*r;t=e?r-n/2-.02*r:Math.min(t=.12*r+.06*r/2+.02*r+.04*r+.08*r/2+.03*r+.1*r/2+.03*r,r-n/2-.02*r),this.buttonY>0?i=this.buttonY:(i=t,this.buttonY=i);let l=i-n/2,a=r-n-.02*r;l<a&&(console.warn("[LasVegas] createButtons - Button position adjusted to ensure visibility:",{originalButtonY:i,originalButtonTop:l,minButtonTop:a,adjustedButtonY:a+n/2}),i=a+n/2,this.buttonY=i),null!==this.initialCasinoStartY&&null===this.initialCasinoEndY&&(this.initialCasinoEndY=i-n/2);let o=.035*r,h=this.add.text(0,0,"굴리기",{fontSize:"".concat(o,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5),c=h.width;h.destroy(),this.rollButtonBg&&this.rollButtonBg.destroy(),this.rollButton&&this.rollButton.destroy();let y=this.rollButtonX>0?this.rollButtonX:.3*s;this.rollButtonX=y;let p=u[this.currentPlayer]||5025616,m=d[this.currentPlayer]||8505220,g=this.darkenColor(p,.2);this.rollButtonBg=this.add.rectangle(y,i,Math.max(c+.02*s*2,.15*s),n,p,.9).setStrokeStyle(3,m).setDepth(200).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{let e=this.playerDiceCounts[this.currentPlayer]||0,t=this.neutralDiceCounts[this.currentPlayer]||0;this.isRolling||this.hasRolledThisTurn||!(e+t>0)||this.rollDice()}).on("pointerover",()=>{this.isRolling||this.hasRolledThisTurn||this.rollButtonBg.setFillStyle(g,.9)}).on("pointerout",()=>{this.isRolling||this.hasRolledThisTurn||this.rollButtonBg.setFillStyle(p,.9)}),this.rollButton=this.add.text(y,i,"굴리기",{fontSize:"".concat(o,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setDepth(201).setInteractive({useHandCursor:!0}).on("pointerdown",()=>{let e=this.playerDiceCounts[this.currentPlayer]||0,t=this.neutralDiceCounts[this.currentPlayer]||0;this.isRolling||this.hasRolledThisTurn||!(e+t>0)||this.rollDice()}),this.updateButtonStates()}updatePlayerInfo(){if(this.playerDiceCountTexts&&0!==this.playerDiceCountTexts.length)try{var e,t,i;this.headerResult&&this.headerManager?(this.headerManager.updateInfo({showTurn:!0,showRound:!0,currentPlayer:this.currentPlayer,currentRound:this.currentRound,maxRounds:this.maxRounds,playerColors:u,playerColorsLight:d},this.headerResult),(null===(e=this.headerResult.info)||void 0===e?void 0:e.turn)&&(this.playerText=this.headerResult.info.turn.text)):this.playerText&&this.playerText.active&&this.playerText.scene&&(this.playerText.setText("턴: ".concat(this.currentPlayer+1)),this.playerText.setColor("#fff"));for(let e=0;e<this.numberOfPlayers;e++){let t=this.playerScoreBgs[e];if(t&&t.active&&t.scene){let i=e===this.currentPlayer,s=u[e]||6710886,r=d[e]||10066329;t.setFillStyle(i?s:3355443,i?.9:.6),i?t.setStrokeStyle(3,r):t.setStrokeStyle(2,5592405)}let i=this.playerScoreTexts[e];if(i&&i.active&&i.scene){let t=e===this.currentPlayer,s=d[e]||11184810,r="#".concat(s.toString(16).padStart(6,"0")),n=t?"#fff":r;try{let t="P".concat(e+1,": $").concat((this.playerMoney[e]||0).toLocaleString());i.setText(t),i.setColor(n)}catch(t){console.warn("[LasVegas] Error updating money text for player ".concat(e,":"),t)}}let s=this.playerMoneyTexts[e];if(s&&s.active&&s.scene){let t=e===this.currentPlayer,i=d[e]||11184810,r="#".concat(i.toString(16).padStart(6,"0")),n=t?"#fff":r;try{let t="카드 ".concat(this.playerCardCounts[e]||0,"장");s.setText(t),s.setColor(n)}catch(t){console.warn("[LasVegas] Error updating card count text for player ".concat(e,":"),t)}}}for(let e=0;e<this.numberOfPlayers;e++){let s=e===this.currentPlayer,r=d[e]||11184810,n="#".concat(r.toString(16).padStart(6,"0")),l=s?"#fff":n,a=null!==(t=this.playerDiceCounts[e])&&void 0!==t?t:8,o=8-a,h=2*e,c=this.playerDiceCountTexts[h+1];if(c&&c.active&&c.scene)try{let e="(".concat(o,"/").concat(8,")");c.setText(e),c.setColor(l)}catch(t){console.warn("[LasVegas] Error updating dice count text for player ".concat(e,":"),t)}let y=10*e,p=u[e]||6710886;for(let e=0;e<8;e++){let t=y+e;if(this.playerDiceIcons[t]){let i=e<o?p:16777215;this.playerDiceIcons[t].setFillStyle(i,1)}}let m=this.numberOfPlayers<=4?2:0;if(m>0){let t=m-(null!==(i=this.neutralDiceCounts[e])&&void 0!==i?i:m),s=2*e+1,r=this.neutralDiceCountTexts[s];if(r&&r.active&&r.scene)try{r.setText("(".concat(t,"/").concat(m,")")),r.setColor(l)}catch(t){console.warn("[LasVegas] Error updating neutral dice count text for player ".concat(e,":"),t)}let n=y+8;for(let e=0;e<m;e++){let i=n+e;if(this.playerDiceIcons[i]){let s=e<t?10066329:16777215;this.playerDiceIcons[i].setFillStyle(s,1)}}}}this.statusText&&this.statusText.active&&this.statusText.scene&&(this.playerDiceCounts[this.currentPlayer]+this.neutralDiceCounts[this.currentPlayer]>0&&0===this.playerDice[this.currentPlayer].length||this.canPlaceDice())}catch(e){console.warn("[LasVegas] Error updating player info:",e)}}updateUI(){this.updatePlayerInfo(),this.updateButtonStates()}updateButtonStates(){if(!this.rollButtonBg||!this.rollButtonBg.active||!this.rollButtonBg.scene)return;let e=this.playerDiceCounts[this.currentPlayer]||0,t=this.neutralDiceCounts[this.currentPlayer]||0,i=this.playerDice[this.currentPlayer]||[],s=!this.isRolling&&!this.hasRolledThisTurn&&e+t>0&&0===i.length;try{if(this.rollButtonBg&&this.rollButtonBg.active&&this.rollButtonBg.scene&&(this.rollButtonBg.setAlpha(s?1:.5),this.rollButtonBg.setInteractive(!!s&&{useHandCursor:!0}),s)){let e=u[this.currentPlayer]||5025616,t=d[this.currentPlayer]||8505220;this.rollButtonBg.setFillStyle(e,.9),this.rollButtonBg.setStrokeStyle(3,t)}this.rollButton&&this.rollButton.active&&this.rollButton.scene&&(this.rollButton.setAlpha(s?1:.5),this.rollButton.setInteractive(!!s&&{useHandCursor:!0}))}catch(e){console.warn("[LasVegas] Error updating button states:",e)}}rollDice(){let e=this.playerDiceCounts[this.currentPlayer]||0,t=this.neutralDiceCounts[this.currentPlayer]||0,i=e+t,s=this.playerDice[this.currentPlayer]||[];if(this.isOnlineMode&&this.roomInfo&&this.playerId&&(Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId)!==this.currentPlayer){this.showError("지금은 다른 플레이어의 턴입니다.");return}if(s.length>0)return;if(0===i){this.allPlayersFinished()?this.endRound():this.nextPlayer();return}if(this.isRolling||this.hasRolledThisTurn)return;let r=[],n=[];for(let t=0;t<e;t++)r.push(a.Math.Between(1,6)),n.push(!1);for(let e=0;e<t;e++)r.push(a.Math.Between(1,6)),n.push(!0);if(0===r.length){console.warn("[LasVegas] No dice to roll",{currentPlayer:this.currentPlayer,playerDiceToRoll:e,neutralDiceToRoll:t,playerDiceCount:this.playerDiceCounts[this.currentPlayer],neutralDiceCount:this.neutralDiceCounts[this.currentPlayer],totalDiceRemaining:i}),this.allPlayersFinished()?this.endRound():this.nextPlayer();return}if(this.isOnlineMode&&this.roomId){let e=[...this.playerDice[this.currentPlayer]],t=this.hasRolledThisTurn,i=this.isRolling;this.isRolling=!0,this.hasRolledThisTurn=!0,this.playerDice[this.currentPlayer]=[...r],this.selectedDiceIsNeutral=[...n],this.diceRollSound||(this.diceRollSound=this.sound.add("diceRoll",{loop:!0,volume:.5})),this.diceRollSound&&!this.diceRollSound.isPlaying&&this.diceRollSound.play(),this.supabaseManager.rollDiceLasVegas(r,this.playerDiceCounts,this.neutralDiceCounts).then(()=>{}).catch(s=>{console.error("[LasVegas] Failed to roll dice:",s);let r=s instanceof Error?s.message:"알 수 없는 오류";this.showError("주사위 굴리기에 실패했습니다: ".concat(r)),this.isRolling=i,this.hasRolledThisTurn=t,this.playerDice[this.currentPlayer]=e,this.createDiceArea(),this.updateButtonStates()}),this.createDiceArea(),this.updateButtonStates();let s=0,l=this.time.addEvent({delay:50,repeat:9,callback:()=>{if(this.isOnlineMode&&this.roomInfo&&this.playerId&&(Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId)!==this.currentPlayer){l.remove(),this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop();return}let e=this.playerDice[this.currentPlayer];if(e&&e.length>0){this.createDiceArea(),s++;return}s++}});this.currentRollAnimationTimer=l,this.time.delayedCall(500,()=>{let e=!0;if(this.isOnlineMode&&this.roomInfo&&this.playerId&&(e=(Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId)===this.currentPlayer),l&&l.getRepeatCount()>=0&&l.remove(),this.currentRollAnimationTimer=null,this.selectedDiceIsNeutral=[...n],this.isRolling=!1,!e)return;this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop();let t=this.playerDice[this.currentPlayer];t&&t.length,this.createDiceArea(),this.updateButtonStates()});return}this.isRolling=!0,this.hasRolledThisTurn=!0,this.diceRollSound||(this.diceRollSound=this.sound.add("diceRoll",{loop:!0,volume:.5})),this.diceRollSound&&!this.diceRollSound.isPlaying&&this.diceRollSound.play();let l=0,o=setInterval(()=>{this.playerDice[this.currentPlayer]=r.map(()=>a.Math.Between(1,6)),this.createDiceArea(),this.rollButtonBg&&this.buttonY>0&&this.rollButtonBg.setY(this.buttonY),this.rollButton&&this.buttonY>0&&this.rollButton.setY(this.buttonY),this.placeButtonBg&&this.buttonY>0&&this.placeButtonBg.setY(this.buttonY),this.placeButton&&this.buttonY>0&&this.placeButton.setY(this.buttonY),++l>=10&&(clearInterval(o),this.playerDice[this.currentPlayer]=r,this.selectedDiceIsNeutral=[...n],this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop(),this.createDiceArea(),this.updateButtonStates())},50)}toggleDiceSelection(e){if(!this.canPlaceDice())return;let t=this.playerDice[this.currentPlayer][e];t&&this.selectDiceByNumber(t)}enableCasinoSelection(){if(0===this.selectedDiceGroup.length)return}async placeDiceOnCasino(e){if(!this.canPlaceDice()||0===this.selectedDiceGroup.length||this.isPlacingDice)return;let t=this.casinos[e],i=this.currentPlayer;if(this.isOnlineMode&&this.roomInfo&&this.playerId){let e=(Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).findIndex(e=>e.id===this.playerId);if(i=e>=0?e:this.currentPlayer,e!==this.currentPlayer){this.showError("지금은 다른 플레이어의 턴입니다.");return}try{var s;let t=await this.supabaseManager.getCurrentGameState();if(t&&(0,l.kf)(t,null===(s=this.roomInfo)||void 0===s?void 0:s.sceneKey)&&(this.syncGameState(t),e!==t.currentPlayer)){this.showError("지금은 다른 플레이어의 턴입니다.");return}}catch(e){console.error("[LasVegas] Error checking latest game state before placing dice:",e)}}let r=this.playerDice[i][this.selectedDiceGroup[0]];if(t.number!==r)return;let n=0,a=0;if(this.selectedDiceGroup.forEach(e=>{this.selectedDiceIsNeutral[e]?a++:n++}),this.isOnlineMode&&this.roomId)this.isPlacingDice=!0,this.supabaseManager.placeDiceLasVegas(e,n,a,this.playerDice,this.playerDiceCounts,this.neutralDiceCounts,this.casinos,[...this.selectedDiceGroup],[...this.selectedDiceIsNeutral]).then(()=>{this.isPlacingDice=!1,this.hasRolledThisTurn=!1,this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[]}).catch(e=>{this.isPlacingDice=!1,console.error("Failed to place dice:",e);let t=e instanceof Error?e.message:"알 수 없는 오류";this.showError("주사위 배치에 실패했습니다: ".concat(t))});else{if(n>0){let e=t.playerDice.get(i)||0;t.playerDice.set(i,e+n)}a>0&&(t.neutralDiceCount+=a),[...this.selectedDiceGroup].sort((e,t)=>t-e).forEach(e=>{let t=this.selectedDiceIsNeutral[e];this.playerDice[i].splice(e,1),this.selectedDiceIsNeutral.splice(e,1),t?this.neutralDiceCounts[i]--:this.playerDiceCounts[i]--}),this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.hasRolledThisTurn=!1,this.createCasinos(),this.createDiceArea(),this.updateButtonStates(),this.updatePlayerInfo(),this.nextPlayer()}}allPlayersFinished(){let e=this.playerDiceCounts.every(e=>0===e),t=this.neutralDiceCounts.every(e=>0===e);return e&&t}nextPlayer(){let e=(this.currentPlayer+1)%this.numberOfPlayers,t=e=>{let t=this.playerDiceCounts[e]||0,i=this.neutralDiceCounts[e]||0,s=this.playerDice[e]||[];return t>0||i>0||s.length>0},i=0,s=this.numberOfPlayers;for(;!t(e)&&i<s;)e=(e+1)%this.numberOfPlayers,i++;if(console.log("allPlayersFinished",this.allPlayersFinished()),console.log("hasDiceRemaining",t(e)),!t(e)||this.allPlayersFinished()){this.endRound();return}if(this.isOnlineMode&&this.roomId){let t=this.currentPlayer;this.playerDice[t]=[],this.playerDice[e]=[],this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.isRolling=!1,this.hasRolledThisTurn=!1,this.updatePlayerInfo(),this.createDiceArea(),this.updateButtonStates(),this.supabaseManager.nextPlayerLasVegas(e).then(()=>{this.time.delayedCall(200,async()=>{try{let e=await this.supabaseManager.getCurrentGameState();e&&(e.currentPlayer!==this.currentPlayer||e.currentRound!==this.currentRound)&&this.syncGameState(e)}catch(e){console.error("[LasVegas] Failed to backup sync game state:",e)}})}).catch(e=>{console.error("Failed to move to next player:",e);let t=e instanceof Error?e.message:"알 수 없는 오류";this.showError("차례 변경에 실패했습니다: ".concat(t))})}else{let t=this.currentPlayer;this.playerDice[t]=[],this.currentPlayer=e,this.selectedDiceGroup=[],this.playerDice[this.currentPlayer]=[],this.selectedDiceIsNeutral=[],this.isRolling=!1,this.hasRolledThisTurn=!1,this.updatePlayerInfo(),this.createDiceArea(),this.createButtons(),this.updateButtonStates()}}endRound(){var e;this.isEndingRound||(this.isEndingRound=!0,this.isOnlineMode&&this.roomId&&this.playerId&&(null===(e=this.roomInfo)||void 0===e?void 0:e.hostId)===this.playerId&&this.supabaseManager.resetPrizeAnimationCompleted().then(()=>{}).catch(e=>{console.error("[LasVegas] Failed to reset prize animation state:",e)}),this.distributePrizesWithAnimation())}distributePrizesWithAnimation(){let e=[];this.casinos.forEach(t=>{if(0===t.playerDice.size&&0===t.neutralDiceCount||0===t.moneyCards.length)return;let i=new Map;t.playerDice.forEach((e,t)=>{i.set(t,e)}),t.neutralDiceCount>0&&i.set("neutral",t.neutralDiceCount);let s=new Map;i.forEach((e,t)=>{s.has(e)||s.set(e,[]),s.get(e).push(t)});let r=new Map;s.forEach((e,t)=>{1===e.length&&r.set(e[0],t)});let n=Array.from(r.entries()).sort((e,t)=>t[1]-e[1]),l=[...t.moneyCards].sort((e,t)=>t.value-e.value),a=[];n.forEach((e,i)=>{if(i<l.length){let s=l[i],r=(this.prizeCardObjects.get(t.number)||[]).find(e=>e.value===s.value);r&&("neutral"===e[0]?a.push({prizeCard:r,recipient:"neutral"}):a.push({prizeCard:r,recipient:e[0]}))}}),(this.prizeCardObjects.get(t.number)||[]).forEach(e=>{a.some(t=>t.prizeCard.value===e.value)||a.push({prizeCard:e,recipient:null})}),a.length>0&&e.push({casinoNumber:t.number,prizes:a})}),e.sort((e,t)=>e.casinoNumber-t.casinoNumber),this.isAnimatingPrize=!0,this.animatePrizeDistribution(e,0)}animatePrizeDistribution(e,t){if(t>=e.length){this.isAnimatingPrize=!1,this.isOnlineMode&&this.roomId&&this.playerId?this.supabaseManager.markPrizeAnimationCompleted().then(()=>{}).catch(e=>{console.error("[LasVegas] Failed to mark prize animation completed:",e)}):this.startNextRound();return}let i=e[t],s=this.cameras.main.width,r=this.cameras.main.height,n=s/this.numberOfPlayers,l=.12*r;this.playerScoreBgs&&this.playerScoreBgs.length>0&&this.playerScoreBgs[0]&&this.playerScoreBgs[0].active&&(l=this.playerScoreBgs[0].y);let a=.95*r,o=0,h=()=>{if(o>=i.prizes.length){this.time.delayedCall(300,()=>{this.animatePrizeDistribution(e,t+1)});return}let{prizeCard:r,recipient:c}=i.prizes[o];if(null===c)this.tweens.add({targets:[r.card,r.innerBg,r.text],alpha:0,scaleX:0,scaleY:0,duration:500,ease:"Power2",onComplete:()=>{r.card.destroy(),r.innerBg.destroy(),r.text.destroy(),o++,h()}});else if("neutral"===c)this.tweens.add({targets:[r.card,r.innerBg,r.text],x:s/2,y:a,duration:800,ease:"Power2",onComplete:()=>{r.card.destroy(),r.innerBg.destroy(),r.text.destroy(),o++,h()}});else{let e=l;this.playerMoney[c]+=r.value,this.playerCardCounts[c]++,this.updatePlayerInfo(),this.tweens.add({targets:[r.card,r.innerBg,r.text],x:(c+.5)*n,y:e,scaleX:.5,scaleY:.5,duration:800,ease:"Power2",onComplete:()=>{r.card.destroy(),r.innerBg.destroy(),r.text.destroy(),o++,h()}})}};h()}startNextRound(){if(this.isStartingNextRound){console.warn("[LasVegas] startNextRound - Already starting next round, skipping");return}if(this.isStartingNextRound=!0,this.isEndingRound=!1,!this.isOnlineMode&&this.currentRound++,this.isOnlineMode||(this.createBillDeck(),this.setupRound()),!this.isOnlineMode){let e=this.playerMoney.map((e,t)=>({money:e,cardCount:this.playerCardCounts[t],index:t})).sort((e,t)=>t.money!==e.money?t.money-e.money:t.cardCount-e.cardCount);this.currentPlayer=e[0].index}this.currentRound<=this.maxRounds?this.createGameUI():this.endGame(),this.isStartingNextRound=!1}endGame(){var e;this.isOnlineMode&&this.roomId&&this.supabaseManager.endGameLasVegas(this.playerMoney,this.playerCardCounts).catch(e=>{console.error("Failed to end game:",e);let t=e instanceof Error?e.message:"알 수 없는 오류";this.showError("게임 종료에 실패했습니다: ".concat(t))});let t=Math.max(...this.playerMoney),i=this.playerMoney.map((e,t)=>({money:e,cardCount:this.playerCardCounts[t],index:t})).filter(e=>e.money===t);i.sort((e,t)=>t.cardCount-e.cardCount);let s=(null===(e=i[0])||void 0===e?void 0:e.cardCount)||0,r=i.filter(e=>e.cardCount===s).map(e=>e.index),l=this.cameras.main.width,a=this.cameras.main.height,o=l/2,h=a/2,c=this.add.rectangle(o,h,.6*l,.5*a,0,.9);c.setStrokeStyle(5,16766720),c.setDepth(3e4);let u=1===r.length?"\uD83C\uDFC6 플레이어 ".concat(r[0]+1," 승리! \uD83C\uDFC6"):"무승부! 플레이어 ".concat(r.map(e=>e+1).join(", ")),y=this.add.text(o,h-.2*a,u,{fontSize:"".concat(.06*a,"px"),color:"#ffd700",fontStyle:"bold"});y.setOrigin(.5),y.setDepth(30001);let p=h-.05*a,m=this.playerMoney.map((e,t)=>({money:e,cardCount:this.playerCardCounts[t],index:t})).sort((e,t)=>t.money!==e.money?t.money-e.money:t.cardCount-e.cardCount),g=this.add.text(o,p,"최종 결과",{fontSize:"".concat(.035*a,"px"),color:"#fff",fontStyle:"bold"});if(g.setOrigin(.5),g.setDepth(30001),p+=.06*a,m.forEach((e,t)=>{let i=d[e.index]||16777215,s="#".concat(i.toString(16).padStart(6,"0")),n=r.includes(e.index),l=this.add.text(o,p,"".concat(0===t?"\uD83E\uDD47":1===t?"\uD83E\uDD48":2===t?"\uD83E\uDD49":"".concat(t+1,"위")," 플레이어 ").concat(e.index+1,": 총 $").concat(e.money.toLocaleString()," (카드 ").concat(e.cardCount,"장)"),{fontSize:"".concat(.028*a,"px"),color:n?"#ffd700":s,fontStyle:n?"bold":"normal"});l.setOrigin(.5),l.setDepth(30001),p+=.045*a}),!this.isOnlineMode){let e=this.add.rectangle(o-.12*l,h+.05*a,.2*l,.08*a,5025616,.9).setStrokeStyle(3,6732650).setInteractive({useHandCursor:!0}).setDepth(30001);n.Wc.setup(e,()=>{this.restartGame()});let t=this.add.text(o-.12*l,h+.05*a,"게임 재시작",{fontSize:"".concat(.035*a,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(30002);n.Wc.setup(t,()=>{this.restartGame()});let i=this.add.rectangle(o+.12*l,h+.05*a,.2*l,.08*a,2201331,.9).setStrokeStyle(3,6600182).setInteractive({useHandCursor:!0}).setDepth(30001);n.Wc.setup(i,()=>{this.changeGame()});let s=this.add.text(o+.12*l,h+.05*a,"게임 변경",{fontSize:"".concat(.035*a,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(30002);n.Wc.setup(s,()=>{this.changeGame()})}let f=this.add.rectangle(o,h+.15*a,.2*l,.08*a,5025616,.9).setStrokeStyle(3,8505220).setInteractive({useHandCursor:!0}).setDepth(30001);n.Wc.setup(f,()=>{this.goToMainMenu()});let D=this.add.text(o,h+.15*a,"메인 메뉴",{fontSize:"".concat(.035*a,"px"),color:"#fff",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).setDepth(30002);n.Wc.setup(D,()=>{this.goToMainMenu()})}toggleFullscreen(){if("undefined"!=typeof document){if(document.fullscreenElement){let e=document;e.exitFullscreen?e.exitFullscreen():e.webkitExitFullscreen?e.webkitExitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.msExitFullscreen&&e.msExitFullscreen()}else{let e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()}}}showMainMenuConfirmPopup(){this.popupSystem.show({message:"메인 메뉴로 돌아가시겠습니까?",buttons:[{text:"확인",color:5025616,strokeColor:6732650,onClick:()=>{this.popupSystem.close(),this.goToMainMenu()}},{text:"취소",color:6710886,strokeColor:10066329,onClick:()=>{this.popupSystem.close()}}],width:.8,height:.3,strokeWidth:3,strokeColor:6710886})}showRestartConfirmPopup(){this.popupSystem.show({message:"새 게임을 시작하시겠습니까?",buttons:[{text:"확인",color:2201331,strokeColor:6600182,onClick:()=>{this.popupSystem.close(),n.rX.startScene(this,"DeviceSelectionScene")}},{text:"취소",color:6710886,strokeColor:10066329,onClick:()=>{this.popupSystem.close()}}],width:.8,height:.3,strokeWidth:3,strokeColor:6710886})}restartGame(){this.isOnlineMode?n.rX.startScene(this,"DeviceSelectionScene"):this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!1})}changeGame(){this.isOnlineMode?this.onlineMultiplayerManager?(this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null),this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null),this.onlineMultiplayerManager.changeGame().catch(e=>{console.error("[LasVegasScene] Failed to change game:",e),this.showError("게임 변경에 실패했습니다: ".concat(e.message))})):console.warn("[LasVegasScene] onlineMultiplayerManager not initialized"):n.rX.startScene(this,"GameSelectionScene",{isOnlineMode:!1,numberOfPlayers:this.numberOfPlayers})}goToMainMenu(){{let e=new URL(window.location.href);e.searchParams.delete("room"),window.history.replaceState({},"",e.pathname+e.search)}n.rX.startScene(this,"DeviceSelectionScene",{})}setupTouchScroll(){this.scrollY=0,this.maxScrollY=0,this.input.on("wheel",(e,t,i,s,r)=>{this.maxScrollY>0&&(this.scrollY+=.5*s,this.scrollY=a.Math.Clamp(this.scrollY,-this.maxScrollY,0),this.updateScrollPosition())});let e=!1,t=0,i=0;this.input.on("pointerdown",s=>{let r=this.cameras.main.height,n=this.buttonY>0?this.buttonY:.85*r,l=.08*r,a=s.y>=n-l/2&&s.y<=n+l/2,o=.05*r,h=.06*r,c=s.y>=o-h/2&&s.y<=o+h/2,u=s.y>=.2*r&&s.y<=.5*r;!(this.maxScrollY>0)||a||c||u||(e=!0,t=s.y,i=this.scrollY)}),this.input.on("pointermove",s=>{if(e&&this.maxScrollY>0){let e=s.y-t;this.scrollY=i+e,this.scrollY=a.Math.Clamp(this.scrollY,-this.maxScrollY,0),this.updateScrollPosition()}}),this.input.on("pointerup",()=>{e=!1}),this.input.on("pointercancel",()=>{e=!1})}updateScrollBounds(){let e=this.cameras.main.height,t=.03*e;this.maxScrollY=Math.max(0,.02*e+.06*e+t+.12*e+t+.1*e+t+.15*e+t+.08*e+t-e),this.scrollY=a.Math.Clamp(this.scrollY,-this.maxScrollY,0),this.updateScrollPosition()}updateScrollPosition(){var e,t,i,s;let r=this.scrollY;if(this.playerScoreTexts.forEach(e=>{if(e&&e.active&&e.scene){var t;let i=null!==(t=e.__originalY)&&void 0!==t?t:e.y;e.__originalY=i,e.setY(i+r)}}),this.casinoObjects.forEach(e=>{if(e&&e.active&&e.scene){var t;let i=null!==(t=e.__originalY)&&void 0!==t?t:e.y;e.__originalY=i,e.setY(i+r)}}),this.diceObjects.forEach(e=>{if(e&&e.active&&e.scene){var t;let i=null!==(t=e.__originalY)&&void 0!==t?t:e.y;e.__originalY=i,e.setY(i+r)}}),this.rollButtonBg&&this.rollButtonBg.active&&this.rollButtonBg.scene){let t=null!==(e=this.rollButtonBg.__originalY)&&void 0!==e?e:this.rollButtonBg.y;this.rollButtonBg.__originalY=t,this.rollButtonBg.setY(t+r)}if(this.rollButton&&this.rollButton.active&&this.rollButton.scene){let e=null!==(t=this.rollButton.__originalY)&&void 0!==t?t:this.rollButton.y;this.rollButton.__originalY=e,this.rollButton.setY(e+r)}if(this.placeButtonBg&&this.placeButtonBg.active&&this.placeButtonBg.scene){let e=null!==(i=this.placeButtonBg.__originalY)&&void 0!==i?i:this.placeButtonBg.y;this.placeButtonBg.__originalY=e,this.placeButtonBg.setY(e+r)}if(this.placeButton&&this.placeButton.active&&this.placeButton.scene){let e=null!==(s=this.placeButton.__originalY)&&void 0!==s?s:this.placeButton.y;this.placeButton.__originalY=e,this.placeButton.setY(e+r)}}setupResizeHandler(){this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler);let e=null;this.resizeHandler=()=>{e&&clearTimeout(e),e=setTimeout(()=>{let e=window.innerWidth,t=window.innerHeight;if(this.scale)try{this.scale.resize(e,t)}catch(e){console.warn("Failed to resize game scale:",e)}this.isOnlineMode&&this.roomId?this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!0,roomId:this.roomId,roomInfo:this.roomInfo,playerId:this.playerId}):this.numberOfPlayers>0?this.scene.restart({numberOfPlayers:this.numberOfPlayers}):this.scene.restart()},300)},window.addEventListener("resize",this.resizeHandler),this.events.once("shutdown",()=>{this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),e&&clearTimeout(e)})}shutdown(){if(this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isOnlineMode&&this.roomId){try{this.supabaseManager.leaveRoom()}catch(e){console.error("Error leaving room on shutdown:",e)}this.supabaseManager.cleanup()}}showOnlineModeSelection(){let e=this.cameras.main.width,t=this.cameras.main.height;this.roomWaitingGroup&&(this.roomWaitingGroup.destroy(!0),this.roomWaitingGroup=null),this.roomWaitingUnsubscribers.forEach(e=>e()),this.roomWaitingUnsubscribers=[],this.onlineModeButtons&&(this.onlineModeButtons.destroy(!0),this.onlineModeButtons=null),r.F.clearUI(this);let i=r.F.createPopupBackground(this,{width:.8,height:.4,strokeColor:2201331}),s=r.F.createPopupTitle(this,"온라인 멀티플레이어",i),l=i.height,a=.06*t,o=.02*t,h=.015*t,c=t/2-.1*l,u=c+a+h;r.F.createColumnButtons(this,[{text:"새 룸 만들기",color:5025616,strokeColor:6732650,hoverColor:4563017,y:c,buttonHeight:a,onClick:()=>{n.rX.startScene(this,"GameSelectionScene",{isOnlineMode:!0})}},{text:"룸 참가하기",color:2201331,strokeColor:6600182,hoverColor:1668818,y:u,buttonHeight:a,onClick:()=>{n.rX.startScene(this,"RoomListScene")}}],{x:e/2,buttonPadding:.05*e,fontSize:o}),r.F.createBackButton(this,{onClick:()=>{n.rX.startScene(this,"DeviceSelectionScene")},y:u+a+h,width:.4*i.width*.7,height:.7*a,fontSize:.8*o}),i.setDepth(1e3),s.setDepth(1001)}ensureOnlineMultiplayerManagerInitialized(){if(this.onlineMultiplayerManager)return;let e=(0,h.S)(this.numberOfPlayers||1);e.currentPlayer=this.currentPlayer,e.isOnlineMode=this.isOnlineMode,e.roomId=this.roomId,e.playerId=this.playerId,this.onlineMultiplayerManager||(this.onlineMultiplayerManager=new o.L,this.onlineMultiplayerManager.initialize(this,e),this.onlineMultiplayerManager.setSceneCallbacks({getNumberOfPlayers:()=>this.numberOfPlayers,setNumberOfPlayers:t=>{this.numberOfPlayers=t,e.numberOfPlayers=t},getCurrentPlayer:()=>this.currentPlayer,setCurrentPlayer:t=>{this.currentPlayer=t,e.currentPlayer=t},getScores:()=>[],setScores:e=>{},getRoomInfo:()=>this.roomInfo,setRoomInfo:e=>{this.roomInfo=e},getRoomId:()=>this.roomId,setRoomId:e=>{this.roomId=e},getPlayerId:()=>this.playerId,setPlayerId:e=>{this.playerId=e},getIsOnlineMode:()=>this.isOnlineMode,setIsOnlineMode:t=>{this.isOnlineMode=t,e.isOnlineMode=t},getIsPlayerSelectMode:()=>!1,showError:e=>this.showError(e),updateUI:()=>this.updateUI(),updateScorecardText:()=>{},updateTotals:()=>{},updatePlayerScores:()=>{},updateDiceAppearance:()=>{this.updateUI()},updateRollButtonText:()=>{},endGame:()=>this.endGame(),calculatePotentialScores:()=>{},getIsRolling:()=>this.isRolling,getDiceRollSound:()=>this.diceRollSound,restartScene:e=>this.scene.restart(e),startScene:(e,t)=>n.rX.startScene(this,e,t),getOnlineModeButtons:()=>this.onlineModeButtons,setOnlineModeButtons:e=>{this.onlineModeButtons=e}}),this.onlineMultiplayerManager.addEventListener(t=>{if("SHOW_ONLINE_MODE_SELECTION"===t.type)this.showOnlineModeSelection();else if("GAME_SELECTION_CANCELLED"===t.type)this.showOnlineModeSelection();else if("GAME_STATE_CHANGED"===t.type)this.syncGameState(t.gameState);else if("START_ONLINE_GAME"===t.type){let i=t.roomInfo;if("LasVegasScene"!==i.sceneKey){console.warn("[LasVegasScene] START_ONLINE_GAME event received for non-las-vegas game, ignoring",{roomId:i.roomId,sceneKey:i.sceneKey});return}this.isOnlineMode=!0,this.roomId=i.roomId,this.playerId=this.supabaseManager.getPlayerId();let s=Array.isArray(i.players)?i.players:Object.values(i.players||{});if(this.numberOfPlayers=s.length,e.numberOfPlayers=this.numberOfPlayers,this.roomInfo=i,!this.headerManager||!this.popupSystem){this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!0,roomId:this.roomId,roomInfo:i});return}if(this.roomId&&this.playerId?this.setupOnlineMode():console.warn("[LasVegasScene] Cannot call setupOnlineMode: roomId or playerId not set",{roomId:this.roomId,playerId:this.playerId}),!i.gameState){let e;this.isOnlineMode=!0,e=Array.isArray(i.players)?i.players:Object.keys(i.players||{}).map(e=>{let t=i.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)),this.numberOfPlayers=e.length,this.playerMoney=[],this.playerDice=[],this.playerCardCounts=[],this.playerDiceCounts=[],this.neutralDiceCounts=[];let t=this.numberOfPlayers<=4?2:0;for(let e=0;e<this.numberOfPlayers;e++)this.playerMoney.push(0),this.playerCardCounts.push(0),this.playerDice.push([]),this.playerDiceCounts.push(8),this.neutralDiceCounts.push(t);this.roomInfo=i,this.playerId||(this.playerId=this.supabaseManager.getPlayerId()),this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!0,roomId:this.roomId,roomInfo:this.roomInfo,playerId:this.playerId})}}}))}async joinOnlineRoom(e){this.ensureOnlineMultiplayerManagerInitialized(),await this.onlineMultiplayerManager.joinOnlineRoom(e)}createActiveSceneCallback(e){var t=this;return function(){for(var i=arguments.length,s=Array(i),r=0;r<i;r++)s[r]=arguments[r];t.scene.isActive()&&e(...s)}}setupOnlineMode(){if(this.roomId){this.unsubscribeGameState=this.supabaseManager.onGameStateUpdate(this.createActiveSceneCallback(e=>{this.syncGameState(e)})),this.unsubscribeRoom=this.supabaseManager.onRoomUpdate(this.createActiveSceneCallback(e=>{var t,i,s,r,l,a,o,h,c;let u;if(this.roomInfo=e,e.sceneKey&&"LasVegasScene"!==e.sceneKey&&this.roomId){console.log("[LasVegasScene] Room sceneKey changed (host changed game), redirecting to RoomWaitingScene",{sceneKey:e.sceneKey,roomId:this.roomId,previousSceneKey:"LasVegasScene",isActive:this.scene.isActive()}),n.rX.startScene(this,"RoomWaitingScene",{roomId:this.roomId,roomInfo:e});return}if("LasVegasScene"===e.sceneKey&&console.log("[LasVegasScene] Room update received, sceneKey is still LasVegasScene",{roomId:this.roomId,isActive:this.scene.isActive(),gameStarted:null===(t=e.gameState)||void 0===t?void 0:t.gameStarted}),u=Array.isArray(e.players)?e.players:Object.keys(e.players||{}).map(t=>{let i=e.players[t];return i&&"object"==typeof i&&"id"in i?i:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)),this.numberOfPlayers!==u.length){let e=this.numberOfPlayers;if(this.numberOfPlayers=u.length,this.numberOfPlayers<e&&e>0&&this.isOnlineMode&&(null===(c=this.roomInfo)||void 0===c||null===(h=c.gameState)||void 0===h||h.gameStarted),!(null===(s=this.roomInfo)||void 0===s?void 0:null===(i=s.gameState)||void 0===i?void 0:i.gameStarted)&&this.playerMoney.length!==this.numberOfPlayers){let e=this.numberOfPlayers<=4?2:0;this.playerMoney=[],this.playerCardCounts=[],this.playerDice=[],this.playerDiceCounts=[],this.neutralDiceCounts=[];for(let t=0;t<this.numberOfPlayers;t++)this.playerMoney.push(0),this.playerCardCounts.push(0),this.playerDice.push([]),this.playerDiceCounts.push(8),this.neutralDiceCounts.push(e)}!(this.numberOfPlayers>0)||(null===(l=this.roomInfo)||void 0===l?void 0:null===(r=l.gameState)||void 0===r?void 0:r.gameStarted)?this.numberOfPlayers>0&&(null===(o=this.roomInfo)||void 0===o?void 0:null===(a=o.gameState)||void 0===a?void 0:a.gameStarted)&&this.updatePlayerInfo():this.scene&&this.scene.isActive()&&this.scene.restart({numberOfPlayers:this.numberOfPlayers,isOnlineMode:!0,roomId:this.roomId,roomInfo:this.roomInfo,playerId:this.playerId})}}));let e=this.supabaseManager.onPlayerLeft(this.createActiveSceneCallback(async(e,t)=>{var i,s;let r="플레이어",n=t.find(t=>t.id===e);if(n&&(r=n.name),this.showError("".concat(r,"이(가) 게임에서 나갔습니다.")),null===(s=this.roomInfo)||void 0===s?void 0:null===(i=s.gameState)||void 0===i?void 0:i.gameStarted)try{await this.supabaseManager.removePlayerFromGame(e)}catch(t){console.error("Failed to remove player from game:",t);let e=t instanceof Error?t.message:"알 수 없는 오류";this.showError("플레이어 제거 실패: ".concat(e))}}));this.events.once("shutdown",()=>{this.unsubscribeGameState&&(this.unsubscribeGameState(),this.unsubscribeGameState=null),this.unsubscribeRoom&&(this.unsubscribeRoom(),this.unsubscribeRoom=null),e()})}else throw Error("Room info is required")}syncGameState(e){var t,i,s,r,n,a,o,h,c;let u=(null===(t=this.roomInfo)||void 0===t?void 0:t.hostId)===this.playerId,d=null===(i=this.roomInfo)||void 0===i?void 0:i.sceneKey,y=(0,l.kf)(e,d);if(y&&(!e.casinos||0===e.casinos.length)&&console.warn("[LasVegas] ⚠️ syncGameState: casinos가 없거나 빈 배열입니다. 호스트가 아직 카지노를 생성하지 않았을 수 있습니다.",{casinos:e.casinos,isHost:u,roomId:this.roomId}),!y)return;let p=this.currentPlayer,m=this.currentRound,g=null===(s=e.casinos)||void 0===s?void 0:s.some(e=>e.moneyCards&&e.moneyCards.length>0);if(!this.isUIInitialized&&g){this.createGameUI(),this.isUIInitialized=!0;return}if(this.isOnlineMode&&this.roomInfo&&this.playerId&&(0,l.kf)(e,this.roomInfo.sceneKey)&&e.prizeAnimationCompleted&&e.prizeAnimationCompleted.length>0&&this.allPlayersFinished()){let t;t=Array.isArray(this.roomInfo.players)?this.roomInfo.players:Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0));let i=e.prizeAnimationCompleted||[],s=t.map(e=>e.id),n=s.length>0&&s.every(e=>i.includes(e));if(console.log("[LasVegas] syncGameState - allAnimationsCompleted check:",{allAnimationsCompleted:n,allPlayerIds:s,completedPlayerIds:i,allPlayersCount:s.length,completedPlayersCount:i.length}),!n)return;if(n){if((null===(r=this.roomInfo)||void 0===r?void 0:r.hostId)===this.playerId){console.log("[LasVegas] syncGameState - All animations completed, host starting next round");let e=this.currentRound+1;this.createBillDeck(),this.setupRound();let t=this.casinos.map(e=>({number:e.number,playerDice:Object.fromEntries(e.playerDice),neutralDiceCount:e.neutralDiceCount,moneyCards:e.moneyCards.map(e=>({value:e.value,text:e.text}))})),i=[...this.playerDiceCounts],s=[...this.neutralDiceCounts],r=this.playerMoney.map((e,t)=>({money:e,cardCount:this.playerCardCounts[t],index:t})).sort((e,t)=>t.money!==e.money?t.money-e.money:t.cardCount-e.cardCount)[0].index;this.supabaseManager.endRoundLasVegas(this.playerMoney,this.playerCardCounts,e,t,i,s,r).then(()=>{}).catch(e=>{console.error("[LasVegas] Failed to start next round after animation:",e);let t=e instanceof Error?e.message:"알 수 없는 오류";this.showError("다음 라운드 시작 실패: ".concat(t))})}else console.log("[LasVegas] syncGameState - All animations completed, but not host, waiting for host to start next round")}}let f=p!==e.currentPlayer,D=m!==e.currentRound,C=this.playerDice.map(e=>[...e]),S=this.casinos.map(e=>({number:e.number,moneyCards:[...e.moneyCards],playerDice:Object.fromEntries(e.playerDice),neutralDiceCount:e.neutralDiceCount})),b=-1,I=this.numberOfPlayers;if(this.isOnlineMode&&this.roomInfo&&this.playerId){let e;I=(e=Array.isArray(this.roomInfo.players)?[...this.roomInfo.players].sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0)):Object.keys(this.roomInfo.players||{}).map(e=>{let t=this.roomInfo.players[e];return t&&"object"==typeof t&&"id"in t?t:null}).filter(e=>null!==e).sort((e,t)=>(e.joinedAt||0)-(t.joinedAt||0))).length,b=e.findIndex(e=>e.id===this.playerId)}if(I!==this.numberOfPlayers&&I>0){this.numberOfPlayers=I;let e=[...this.playerMoney],t=[...this.playerCardCounts],i=this.playerDice.map(e=>[...e]),s=[...this.playerDiceCounts],r=[...this.neutralDiceCounts],n=this.numberOfPlayers<=4?2:0;this.playerMoney=[],this.playerCardCounts=[],this.playerDice=[],this.playerDiceCounts=[],this.neutralDiceCounts=[];for(let l=0;l<this.numberOfPlayers;l++)this.playerMoney.push(l<e.length?e[l]:0),this.playerCardCounts.push(l<t.length?t[l]:0),this.playerDice.push(l<i.length?[...i[l]]:[]),this.playerDiceCounts.push(l<s.length?s[l]:8),this.neutralDiceCounts.push(l<r.length?r[l]:n)}let P=e.currentPlayer;this.currentPlayer,null!=P&&P>=0&&P<this.numberOfPlayers?(this.currentPlayer=P,this.currentPlayer):null!=P&&(console.warn("[LasVegas] Invalid currentPlayer index: ".concat(P,", numberOfPlayers: ").concat(this.numberOfPlayers)),this.currentPlayer=0);let M=p!==this.currentPlayer;this.currentRound=e.currentRound;let O=this.playerDice.map(e=>[...e]),R=this.hasRolledThisTurn,v=[...this.playerDiceCounts],x=[...this.neutralDiceCounts],B=!1;if(e.playerDice&&Array.isArray(e.playerDice)){let t=e.playerDice.map(e=>Array.isArray(e)?[...e]:[]);if(t.length===this.numberOfPlayers){let i=t.map((t,i)=>{let s=this.isOnlineMode&&b>=0&&i===b,r=i===e.currentPlayer,n=s&&r;if(r){if(f)return[];if(this.isRolling&&n){let e=this.playerDice[i]||[];if(e.length>0)return e}return e.hasRolledThisTurn?t.length>0?(!n&&this.isRolling&&(this.currentRollAnimationTimer&&(this.currentRollAnimationTimer.remove(),this.currentRollAnimationTimer=null),this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop()),t):this.playerDice[i]||[]:[]}if(s){if(r)return t;let e=this.playerDice[i]||[];return t.length>0?t:!this.isRolling&&e.length>0?[...e]:t}return t.length,t});if(JSON.stringify(this.playerDice)!==JSON.stringify(i)&&(B=!0,JSON.stringify(this.playerDice[this.currentPlayer]||[])!==JSON.stringify(i[this.currentPlayer]||[])&&(this.isOnlineMode&&b>=0&&e.currentPlayer===b?this.time.delayedCall(0,()=>{this.createDiceArea()}):(this.currentRollAnimationTimer&&(this.currentRollAnimationTimer.remove(),this.currentRollAnimationTimer=null),this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop(),this.time.delayedCall(0,()=>{this.createDiceArea(),this.updateButtonStates()})))),this.playerDice=i,B&&this.time.delayedCall(0,()=>{this.createDiceArea(),this.updateButtonStates()}),this.playerDice[this.currentPlayer]){let t=this.playerDice[this.currentPlayer];(0,l.kf)(e)&&e.playerDiceIsNeutral&&Array.isArray(e.playerDiceIsNeutral)&&this.currentPlayer<e.playerDiceIsNeutral.length&&Array.isArray(e.playerDiceIsNeutral[this.currentPlayer])&&e.playerDiceIsNeutral[this.currentPlayer].length===t.length?this.selectedDiceIsNeutral=[...e.playerDiceIsNeutral[this.currentPlayer]]:this.selectedDiceIsNeutral=Array(t.length).fill(!1)}}else{console.warn("[LasVegas] playerDice length mismatch: expected ".concat(this.numberOfPlayers,", got ").concat(t.length));let i=[];for(let e=0;e<this.numberOfPlayers;e++)i.push(e<t.length?[...t[e]]:[]);if(JSON.stringify(this.playerDice)!==JSON.stringify(i)&&(B=!0),this.playerDice=i,this.playerDice[this.currentPlayer]){let t=this.playerDice[this.currentPlayer];(0,l.kf)(e)&&e.playerDiceIsNeutral&&Array.isArray(e.playerDiceIsNeutral)&&this.currentPlayer<e.playerDiceIsNeutral.length&&Array.isArray(e.playerDiceIsNeutral[this.currentPlayer])&&e.playerDiceIsNeutral[this.currentPlayer].length===t.length?this.selectedDiceIsNeutral=[...e.playerDiceIsNeutral[this.currentPlayer]]:this.selectedDiceIsNeutral=Array(t.length).fill(!1)}}}else if(!e.playerDice){if(this.isOnlineMode){this.playerDice=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerDice.push([]);this.selectedDiceIsNeutral=[],B=!0}else if(this.playerDice.length!==this.numberOfPlayers){this.playerDice=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerDice.push([]);B=!0}}if(e.playerDiceCounts){let t=[...e.playerDiceCounts];if(t.length===this.numberOfPlayers)this.playerDiceCounts=t;else{console.warn("[LasVegas] playerDiceCounts length mismatch: expected ".concat(this.numberOfPlayers,", got ").concat(t.length)),this.playerDiceCounts=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerDiceCounts.push(e<t.length?t[e]:8)}}if(e.neutralDiceCounts){let t=[...e.neutralDiceCounts];if(t.length===this.numberOfPlayers)this.neutralDiceCounts=t;else{console.warn("[LasVegas] neutralDiceCounts length mismatch: expected ".concat(this.numberOfPlayers,", got ").concat(t.length));let e=this.numberOfPlayers<=4?2:0;this.neutralDiceCounts=[];for(let i=0;i<this.numberOfPlayers;i++)this.neutralDiceCounts.push(i<t.length?t[i]:e)}}if(e.playerMoney&&!this.isAnimatingPrize){let t=[...e.playerMoney];if(t.length===this.numberOfPlayers){let e=t.map((e,t)=>{if(this.isOnlineMode&&b>=0&&t===b){var i;return null!==(i=this.playerMoney[t])&&void 0!==i?i:e}return e});this.playerMoney=e}else{console.warn("[LasVegas] playerMoney length mismatch: expected ".concat(this.numberOfPlayers,", got ").concat(t.length)),this.playerMoney=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerMoney.push(e<t.length?t[e]:0)}}if(e.playerCardCounts&&!this.isAnimatingPrize){let t=[...e.playerCardCounts];if(t.length===this.numberOfPlayers){let e=t.map((e,t)=>{if(this.isOnlineMode&&b>=0&&t===b){var i;return null!==(i=this.playerCardCounts[t])&&void 0!==i?i:e}return e});this.playerCardCounts=e}else{console.warn("[LasVegas] playerCardCounts length mismatch: expected ".concat(this.numberOfPlayers,", got ").concat(t.length)),this.playerCardCounts=[];for(let e=0;e<this.numberOfPlayers;e++)this.playerCardCounts.push(e<t.length?t[e]:0)}}if(this.isOnlineMode){let t=b>=0&&b===this.currentPlayer;f?this.hasRolledThisTurn=!1:t||(this.hasRolledThisTurn=null!==(n=e.hasRolledThisTurn)&&void 0!==n&&n)}else f?this.hasRolledThisTurn=!1:void 0!==e.hasRolledThisTurn&&(this.hasRolledThisTurn=e.hasRolledThisTurn);if(f){if(this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.isRolling=!1,!this.playerDice[this.currentPlayer])for(;this.playerDice.length<=this.currentPlayer;)this.playerDice.push([]);this.playerDice[this.currentPlayer]=[],this.hasRolledThisTurn=!1,this.isRolling&&(this.currentRollAnimationTimer&&(this.currentRollAnimationTimer.remove(),this.currentRollAnimationTimer=null),this.isRolling=!1,this.diceRollSound&&this.diceRollSound.isPlaying&&this.diceRollSound.stop())}let A=this.canPlaceDice();this.canPlaceDice()&&(this.isRolling=!1);let w=A!==this.canPlaceDice(),T=!1;if(e.casinos&&Array.isArray(e.casinos)&&e.casinos.length>0){let t=e.casinos.some(e=>Array.isArray(e.moneyCards)&&e.moneyCards.length>0);if(this.isOnlineMode){let i=(null===(a=this.roomInfo)||void 0===a?void 0:a.hostId)===this.playerId,s=this.casinos.some(e=>e.moneyCards.length>0);t?this.casinos=e.casinos.map((e,t)=>{let i=Array.isArray(e.moneyCards)?e.moneyCards.map(e=>{var t;return{value:e.value||0,text:e.text||"$".concat((null===(t=e.value)||void 0===t?void 0:t.toLocaleString())||"0")}}):[],s={number:e.number,moneyCards:i,playerDice:new Map,neutralDiceCount:e.neutralDiceCount||0};return e.playerDice&&"object"==typeof e.playerDice&&Object.entries(e.playerDice).forEach(e=>{let[t,i]=e,r=parseInt(t);s.playerDice.set(r,i||0)}),s}):i&&s&&!t?this.casinos=this.casinos.map((t,i)=>{let s=e.casinos[i];if(s){let e={...t,playerDice:new Map,neutralDiceCount:s.neutralDiceCount||0};return e.number,s.playerDice&&"object"==typeof s.playerDice&&Object.entries(s.playerDice).forEach(t=>{let[i,s]=t,r=parseInt(i);e.playerDice.set(r,s||0)}),e}return t}):this.casinos=e.casinos.map(e=>{let t=Array.isArray(e.moneyCards)?e.moneyCards.map(e=>{var t;return{value:e.value||0,text:e.text||"$".concat((null===(t=e.value)||void 0===t?void 0:t.toLocaleString())||"0")}}):[],i={number:e.number,moneyCards:t,playerDice:new Map,neutralDiceCount:e.neutralDiceCount||0};return i.number,e.playerDice&&"object"==typeof e.playerDice&&Object.entries(e.playerDice).forEach(e=>{let[t,s]=e;i.playerDice.set(parseInt(t),s)}),i}),T=!0}else this.casinos=e.casinos.map(e=>{let t={number:e.number,moneyCards:Array.isArray(e.moneyCards)&&e.moneyCards.length>0?e.moneyCards.map(e=>{var t;return{value:e.value||0,text:e.text||"$".concat((null===(t=e.value)||void 0===t?void 0:t.toLocaleString())||"0")}}):[],playerDice:new Map,neutralDiceCount:e.neutralDiceCount||0};return e.playerDice&&"object"==typeof e.playerDice&&Object.entries(e.playerDice).forEach(e=>{let[i,s]=e;t.playerDice.set(parseInt(i),s)}),t});let i=this.casinos.map(e=>({number:e.number,moneyCards:e.moneyCards.map(e=>({...e})),playerDice:Object.fromEntries(e.playerDice),neutralDiceCount:e.neutralDiceCount}));T=0===S.length&&i.length>0||S.length!==i.length||S.some((e,t)=>{let s=i[t];return!s||e.number!==s.number||e.moneyCards.length!==s.moneyCards.length||JSON.stringify(e.moneyCards)!==JSON.stringify(s.moneyCards)||JSON.stringify(e.playerDice)!==JSON.stringify(s.playerDice)||e.neutralDiceCount!==s.neutralDiceCount})}else if(!e.casinos||Array.isArray(e.casinos)&&0===e.casinos.length){if(this.isOnlineMode&&(null===(o=this.roomInfo)||void 0===o?void 0:o.hostId)===this.playerId&&this.casinos.length>0)T=!1;else if(0===this.casinos.length){for(let e=1;e<=6;e++)this.casinos.push({number:e,moneyCards:[],playerDice:new Map,neutralDiceCount:0});T=!0,this.createCasinos()}else T=!1}if(this.headerManager&&this.headerResult){let e=this.currentPlayer+1;this.headerManager.updateTurn(e,this.headerResult),this.headerManager.updateRound(this.currentRound,this.maxRounds,this.headerResult,!0)}b>=0&&this.currentPlayer;let E=B||JSON.stringify(C)!==JSON.stringify(this.playerDice),Y=JSON.stringify(v)!==JSON.stringify(this.playerDiceCounts)||JSON.stringify(x)!==JSON.stringify(this.neutralDiceCounts),k=T;if(M&&this.createButtons(),E||w||M||f||k||Y?(this.createDiceArea(),this.updateButtonStates(),this.updatePlayerInfo(),k&&this.createCasinos()):k?this.createCasinos():Y&&this.updatePlayerInfo(),D&&this.isOnlineMode&&(console.log("[LasVegas] syncGameState - Round changed, resetting isEndingRound",{previousRound:m,newRound:e.currentRound}),this.isEndingRound=!1),!D){let e=this.allPlayersFinished();console.log("[LasVegas] syncGameState - allPlayersFinished check:",{allFinished:e,playerDiceCounts:[...this.playerDiceCounts],neutralDiceCounts:[...this.neutralDiceCounts],playerDice:this.playerDice.map(e=>e.length),currentPlayer:this.currentPlayer,isOnlineMode:this.isOnlineMode,isHost:!!this.isOnlineMode&&(null===(h=this.roomInfo)||void 0===h?void 0:h.hostId)===this.playerId,isEndingRound:this.isEndingRound,roundChanged:D}),e&&(this.isEndingRound?(console.log({allFinished:e}),console.log("[LasVegas] syncGameState - Already ending round, skipping")):(console.log("[LasVegas] syncGameState - All players finished, calling endRound() for animation"),this.endRound()))}if(this.isOnlineMode&&this.roomInfo&&this.playerId&&b>=0){let t=b===this.currentPlayer,i=!1;for(let e=0;e<this.numberOfPlayers;e++)if(e!==b){let t=O[e]||[],s=this.playerDice[e]||[];if(0===t.length&&s.length>0||t.length>0&&s.length>0&&JSON.stringify(t)!==JSON.stringify(s)){i=!0;break}}let s=!R&&e.hasRolledThisTurn,r=!M&&!f&&(i||s)&&!t&&!this.isRolling&&e.hasRolledThisTurn,n=O[this.currentPlayer]||[],l=this.playerDice[this.currentPlayer]||[],a=v[this.currentPlayer]||0,o=this.playerDiceCounts[this.currentPlayer]||0,h=n.length>0&&0===l.length&&a>o;r&&!h&&this.startDiceRollAnimation();let u=(this.playerDiceCounts[this.currentPlayer]||0)+(this.neutralDiceCounts[this.currentPlayer]||0),d=(null===(c=this.roomInfo)||void 0===c?void 0:c.hostId)===this.playerId;if(0===u&&!e.hasRolledThisTurn&&!this.isRolling&&d&&this.isOnlineMode&&this.roomId){let e=(this.currentPlayer+1)%this.numberOfPlayers,t=e=>{let t=this.playerDiceCounts[e]||0,i=this.neutralDiceCounts[e]||0,s=this.playerDice[e]||[];return t>0||i>0||s.length>0};for(;!t(e)&&e!==this.currentPlayer;)e=(e+1)%this.numberOfPlayers;e===this.currentPlayer&&!t(e)||this.allPlayersFinished()?this.endRound():e!==this.currentPlayer&&(this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.isRolling=!1,this.supabaseManager.nextPlayerLasVegas(e).then(()=>{}).catch(e=>{console.error("Failed to move to next player:",e);let t=e instanceof Error?e.message:"알 수 없는 오류";this.showError("차례 변경에 실패했습니다: ".concat(t))}))}}this.isOnlineMode||0!==(this.playerDiceCounts[this.currentPlayer]||0)+(this.neutralDiceCounts[this.currentPlayer]||0)||this.hasRolledThisTurn||this.isRolling||0!==this.playerDice[this.currentPlayer].length||this.nextPlayer(),D&&this.isOnlineMode&&(console.log("[LasVegas] syncGameState - Round changed, starting next round",{previousRound:m,newRound:e.currentRound}),this.startNextRound())}startDiceRollAnimation(){if(this.isRolling)return;this.isRolling=!0,this.rollAnimationTimers.forEach(e=>e.remove()),this.rollAnimationTimers=[];let e=0,t=this.time.addEvent({delay:50,repeat:9,callback:()=>{this.playerDice[this.currentPlayer]&&this.playerDice[this.currentPlayer].length>0&&this.createDiceArea(),e++}});this.rollAnimationTimers.push(t),this.time.delayedCall(500,()=>{this.isRolling=!1,this.createDiceArea(),this.updateButtonStates()})}showError(e){console.error("Showing error:",e);let t=this.cameras.main.width,i=this.cameras.main.height;this.children.list.filter(e=>{var t;return"Text"===e.type&&(null===(t=e.style)||void 0===t?void 0:t.color)==="#ff4444"}).forEach(e=>{e&&e.destroy&&e.destroy()});let s=this.add.text(t/2,i/2,e,{fontSize:"".concat(.03*i,"px"),color:"#ff4444",fontStyle:"bold"}).setOrigin(.5).setDepth(2e3);this.time.delayedCall(5e3,()=>{s&&s.scene&&s.destroy()})}constructor(){super("LasVegasScene"),this.numberOfPlayers=2,this.currentRound=1,this.maxRounds=4,this.currentPlayer=0,this.isRolling=!1,this.hasRolledThisTurn=!1,this.isEndingRound=!1,this.isPlacingDice=!1,this.isUIInitialized=!1,this.isStartingNextRound=!1,this.diceRollSound=null,this.rollAnimationTimers=[],this.currentRollAnimationTimer=null,this.playerDice=[],this.playerDiceCounts=[],this.neutralDiceCounts=[],this.selectedDiceGroup=[],this.selectedDiceIsNeutral=[],this.billDeck=[],this.casinos=[],this.initialCasinoStartY=null,this.initialCasinoEndY=null,this.initialCasinoHeight=null,this.playerSelectButtons=[],this.buttonY=0,this.rollButtonX=0,this.playerScoreBgs=[],this.diceObjects=[],this.casinoObjects=[],this.playerScoreTexts=[],this.playerMoneyTexts=[],this.playerDiceCountTexts=[],this.neutralDiceCountTexts=[],this.playerDiceIcons=[],this.playerMoney=[],this.playerCardCounts=[],this.numberButtons=[],this.prizeCardObjects=new Map,this.isOnlineMode=!1,this.roomId=null,this.playerId=null,this.roomInfo=null,this.supabaseManager=(0,l.nc)(),this.roomWaitingGroup=null,this.roomWaitingUnsubscribers=[],this.onlineModeButtons=null,this.resizeHandler=null,this.scrollY=0,this.maxScrollY=0,this.isAnimatingPrize=!1,this.unsubscribeRoom=null,this.unsubscribeGameState=null}}}}]);