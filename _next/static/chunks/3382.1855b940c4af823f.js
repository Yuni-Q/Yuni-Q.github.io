"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3382],{5709:function(e,r,t){function a(e){return{success:!0,value:e}}function o(e){return{success:!1,error:e}}t.d(r,{T:function(){return o},f:function(){return a}})},3382:function(e,r,t){t.d(r,{Cx:function(){return i},Rp:function(){return n},kf:function(){return s},nc:function(){return p}});var a=t(9301),o=t(5709);function n(e){return"diceValues"in e&&"rollsLeft"in e}function s(e,r){return"LasVegasScene"===r||"YachtDiceScene"!==r&&"UnoScene"!==r&&("casinos"in e&&void 0!==e.casinos||"playerDice"in e&&void 0!==e.playerDice&&(!("diceValues"in e)||null===e.diceValues))}function i(e,r){return"UnoScene"===r||"YachtDiceScene"!==r&&"LasVegasScene"!==r&&"playerHands"in e&&void 0!==e.playerHands&&"discardPile"in e&&void 0!==e.discardPile}function l(e){return({YachtDiceScene:"yacht-dice",LasVegasScene:"las-vegas",UnoScene:"uno"})[e]||null}function c(e){return({"yacht-dice":"YachtDiceScene","las-vegas":"LasVegasScene",uno:"UnoScene"})[e]||null}function m(e){var r;let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"waiting",a=(Array.isArray(e.players)?e.players:Object.values(e.players)).map(r=>({...r,isHost:r.id===e.hostId})),o=e.sceneKey&&l(e.sceneKey)||"yacht-dice";return{roomId:e.roomId,gameType:o,maxPlayers:e.maxPlayers,players:a,hostId:e.hostId||(null===(r=a[0])||void 0===r?void 0:r.id)||"",state:t,createdAt:e.createdAt,expiresAt:e.createdAt+864e5,isVisibleInList:"waiting"===t}}async function d(e){let r,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let o=1;o<=t;o++)try{return await e()}catch(e){if(r=e,e instanceof Error&&(e.message.includes("network")||e.message.includes("timeout")||e.message.includes("ECONNREFUSED")||e.message.includes("ENOTFOUND"))&&o<t){await new Promise(e=>setTimeout(e,a));continue}throw e}throw r}function h(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(e instanceof Error){let a=e.message;if(a.includes("not found")||a.includes("Room not found"))return{type:"ROOM_NOT_FOUND",message:"Room not found: ".concat(a),roomId:r};if(a.includes("full")||a.includes("Room is full")){let e=a.match(/(\d+)\/(\d+)/);return e?{type:"ROOM_FULL",message:a,roomId:r,currentCount:parseInt(e[1],10),maxCount:parseInt(e[2],10)}:{type:"ROOM_FULL",message:a,roomId:r,currentCount:0,maxCount:0}}return a.includes("expired")||a.includes("Room has expired")?{type:"ROOM_EXPIRED",message:a,roomId:r,expiredAt:Date.now()}:a.includes("in progress")||a.includes("currently in progress")?{type:"ROOM_IN_PROGRESS",message:a,roomId:r}:a.includes("Invalid room code")||a.includes("room code format")?{type:"INVALID_ROOM_CODE",message:a,code:r}:a.includes("changing the game")||a.includes("game change")?{type:"GAME_CHANGE_IN_PROGRESS",message:a,roomId:r}:a.includes("creation")||"createRoom"===t?{type:"ROOM_CREATION_FAILED",message:a,reason:a}:{type:"ROOM_UPDATE_FAILED",message:a,roomId:r,reason:a}}return{type:"ROOM_UPDATE_FAILED",message:"Unknown error occurred",roomId:r,reason:String(e)}}class u{generateId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async generateRoomCodeInternal(){for(let e=0;e<10;e++){let e=6+Math.floor(3*Math.random()),r="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t="";for(let a=0;a<e;a++)t+=r.charAt(Math.floor(Math.random()*r.length));try{let{data:e,error:r}=await this.supabase.from("game_rooms").select("room_id").eq("room_id",t).maybeSingle();if(r&&"PGRST116"===r.code)return t;if(r&&!e){let e=JSON.stringify(r),a=r.message||"",o=r.code||"",n=r.status||r.statusCode||"";if("PGRST204"===o||406===n||400===n||e.includes("406")||e.includes("400")||a.includes("406")||a.includes("400")||a.includes("Not Acceptable")||a.includes("Bad Request"))return console.warn("[generateRoomCodeInternal] PostgREST error (assuming code is unique):",{code:t,errorCode:o,errorStatus:n,errorMessage:a}),t;throw r}if(e&&"object"==typeof e&&"room_id"in e)continue;if(!r&&!e)return t}catch(e){return console.warn("[generateRoomCodeInternal] Exception during room code check, assuming code is unique:",t,e),t}}return this.generateId().substring(0,8).toUpperCase()}async generateRoomCode(){try{let e=await this.generateRoomCodeInternal();return(0,o.f)(e)}catch(e){return(0,o.T)(h(e,"","generateRoomCode"))}}async createRoomInternal(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,r=arguments.length>1?arguments[1]:void 0,t=await this.generateRoomCodeInternal();this.playerId=this.generateId(),this.roomId=t;let a={id:this.playerId,name:"Player 1",isReady:!1,joinedAt:Date.now()},o=r?l(r):void 0,n=Date.now();try{let r={id:this.generateId(),room_id:t,max_players:e,game_type:o||"yacht-dice",host_id:this.playerId,created_at:n,game_state:"las-vegas"===o?{playerDice:[],playerDiceCounts:[],neutralDiceCounts:[],casinos:[],playerMoney:[],playerCardCounts:[],currentRound:1,currentPlayer:0,hasRolledThisTurn:!1,gameStarted:!1}:{diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],rollsLeft:3,currentRound:1,currentPlayer:0,scores:[],gameStarted:!1}};try{r.expires_at=n+864e5,r.state="waiting"}catch(e){console.warn("[SupabaseGameManager] createRoomInternal - expires_at or state column may not exist, continuing without them")}let{error:l}=await this.supabase.from("game_rooms").insert(r);if(l){var s,i;if(console.error("[SupabaseGameManager] createRoomInternal - Insert failed:",{error:l,code:l.code,message:l.message,details:l.details,hint:l.hint,roomId:t}),(null===(s=l.message)||void 0===s?void 0:s.includes("column"))&&(null===(i=l.message)||void 0===i?void 0:i.includes("does not exist")))throw Error("데이터베이스 마이그레이션이 필요합니다. Supabase SQL Editor에서 migrations/add_room_expiration_and_state.sql 파일을 실행해주세요. 원본 에러: ".concat(l.message));throw l}let c=null,m=null;for(let e=0;e<5;e++){let r=await this.supabase.from("game_rooms").select("room_id,created_at,state").eq("room_id",t).maybeSingle();if(c=r.data,m=r.error,c)break;e<4?(console.error("[SupabaseGameManager] createRoomInternal - Verification query failed, retrying in ".concat(1e3,"ms... (attempt ").concat(e+1,"/").concat(5,")")),m&&console.error("[SupabaseGameManager] createRoomInternal - Verify error:",m),await new Promise(e=>setTimeout(e,1e3))):console.error("[SupabaseGameManager] createRoomInternal - Verification query failed after all retries:",{hasData:!!c,error:m,errorCode:null==m?void 0:m.code,errorMessage:null==m?void 0:m.message,roomId:t,attempts:5})}if(!c)throw console.error("[SupabaseGameManager] createRoomInternal - CRITICAL: Room insert succeeded but verification failed!",{roomId:t,insertError:null,verifyError:m}),Error("Room creation failed: Room was inserted but could not be verified. Room ID: ".concat(t,". Please try again."));let{error:d}=await this.supabase.from("game_players").insert({id:this.generateId(),room_id:t,player_id:this.playerId,player_name:a.name,is_ready:a.isReady,joined_at:a.joinedAt}).select().single();if(d){console.error("[SupabaseGameManager] createRoomInternal - CRITICAL: Failed to add first player (host) to room!",{roomId:t,playerId:this.playerId,error:d});try{let e=await this.deleteRoom(t);e.success?console.warn("[SupabaseGameManager] createRoomInternal - Cleaned up room after player insert failure"):console.error("[SupabaseGameManager] createRoomInternal - Failed to cleanup room:",e.error)}catch(e){console.error("[SupabaseGameManager] createRoomInternal - Failed to cleanup room after player insert failure:",e)}throw Error("Failed to add host player to room. Room creation aborted. Please try again.")}return t}catch(e){throw console.error("Error creating room:",e),e}}async createRoom(e,r,t){if("number"==typeof e&&(!t||"string"==typeof r))return this.createRoomInternal(e,r);try{let a=Date.now(),n=await this.generateRoomCode();if(!n.success)return n;let s=n.value;this.playerId=t,this.roomId=s;let i={id:t,name:"Player 1",isReady:!1,joinedAt:Date.now()},c=e?l(e):"yacht-dice",u="LasVegasScene"===e?{playerDice:[],playerDiceCounts:[],neutralDiceCounts:[],casinos:[],playerMoney:[],playerCardCounts:[],currentRound:1,currentPlayer:0,hasRolledThisTurn:!1,gameStarted:!1}:{diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],rollsLeft:3,currentRound:1,currentPlayer:0,scores:[],gameStarted:!1},y=Date.now(),p=y+864e5,{error:g}=await d(async()=>{let e=await this.supabase.from("game_rooms").insert({id:this.generateId(),room_id:s,max_players:r,game_type:c,host_id:t,created_at:y,expires_at:p,state:"waiting",game_state:u}).select().single();if(e.error)throw e.error;return e}).catch(e=>(console.error("[SupabaseGameManager] Room insert error:",e),{error:e,data:null}));if(g)return console.error("[SupabaseGameManager] Room creation failed:",{roomError:g,roomId:s}),(0,o.T)(h(g,s,"createRoom"));let{error:f}=await d(async()=>{let e=await this.supabase.from("game_players").insert({id:this.generateId(),room_id:s,player_id:t,player_name:i.name,is_ready:i.isReady,joined_at:i.joinedAt});if(e.error)throw e.error;return e}).catch(e=>({error:e,data:null}));if(f)return(0,o.T)(h(f,s,"createRoom"));let w=Date.now()-a;w>2e3&&console.warn("[createRoom] Room creation took ".concat(w,"ms (target: <2000ms)"));let I=m({roomId:s,players:[i],gameState:u,sceneKey:e,maxPlayers:r,createdAt:y,hostId:t},"waiting");return(0,o.f)(I)}catch(e){return(0,o.T)(h(e,"","createRoom"))}}setupRealtimeListeners(){this.cleanupChannels()}cleanupChannels(){this.roomChannel&&(this.supabase.removeChannel(this.roomChannel),this.roomChannel=null),this.playersChannel&&(this.supabase.removeChannel(this.playersChannel),this.playersChannel=null)}async joinRoom(e,r){let t=e.toUpperCase().trim();if(!/^[A-Z0-9]{6,8}$/.test(t))throw Error("Invalid room code format. Room code must be 6-8 alphanumeric characters.");this.roomId=t,this.playerId=this.generateId();try{let e=Date.now(),a=null,o=null;for(let e=0;e<5;e++){let r=await d(async()=>{let e=await this.supabase.from("game_rooms").select("id,room_id,max_players,game_type,host_id,created_at,game_state,expires_at,state").eq("room_id",t).maybeSingle();if(e.error&&"PGRST116"!==e.error.code)throw e.error;return e}).catch(e=>(console.error("[SupabaseGameManager] Room query error:",e),"PGRST116"===e.code)?{error:null,data:null}:{error:e,data:null});if(a=r.data,o=r.error,a)break;e<4?await new Promise(e=>setTimeout(e,2e3)):console.warn("[SupabaseGameManager] Room query returned null after all retries (no rows found)")}if(o||!a)throw console.error("[SupabaseGameManager] Room not found after all retries:",{roomError:o,hasRoomData:!!a,normalizedRoomId:t,retries:5}),Error("Room not found. Please check the room code and try again.");let n=a;if(!n)throw Error("Room data is invalid");if(n.expires_at&&n.expires_at<e)throw Error("Room has expired. Rooms expire 24 hours after creation. Please create a new room.");if(n.state&&!["waiting","game_ended"].includes(n.state))throw Error("Cannot join room. Room is currently in progress. Please wait for the current game to end or join a different room.");let{data:s,error:i}=await d(async()=>{let e=await this.supabase.from("game_players").select("*").eq("room_id",t);if(e.error)throw e.error;return e}).catch(e=>({error:e,data:null}));if(i)throw i;let l=s||[];if(l.length>=n.max_players)throw Error("Room is full (".concat(l.length,"/").concat(n.max_players," players). Please wait for a spot to open or try a different room."));let c={id:this.playerId,name:r||"Player ".concat(l.length+1),isReady:!1,joinedAt:Date.now()},{error:m}=await d(async()=>{let e=await this.supabase.from("game_players").insert({id:this.generateId(),room_id:t,player_id:this.playerId,player_name:c.name,is_ready:c.isReady,joined_at:c.joinedAt});if(e.error)throw e.error;return e}).catch(e=>({error:e,data:null}));if(m)throw m;return this.setupRealtimeListeners(),await this.getRoomInfo()}catch(e){throw console.error("Error joining room:",e),e}}async getRoomInfo(){let e=this.roomId;if(!e)throw Error("Room ID not set");let{data:r,error:t}=await d(async()=>{let r=await this.supabase.from("game_rooms").select("*").eq("room_id",e).single();if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null}));if(t||!r)throw Error("Room not found");let{data:a,error:o}=await d(async()=>{let r=await this.supabase.from("game_players").select("*").eq("room_id",e).order("joined_at",{ascending:!0});if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null}));if(o)throw o;let n=(null==a?void 0:a.map(e=>({id:e.player_id,name:e.player_name,isReady:e.is_ready,joinedAt:e.joined_at})))||[],s=c(r.game_type)||void 0;return{roomId:r.room_id,players:n,gameState:r.game_state,sceneKey:s,maxPlayers:r.max_players,createdAt:r.created_at,hostId:r.host_id||void 0}}async getRoom(e){try{let t=this.roomId;this.roomId=e;try{var r;let t=await d(async()=>await this.getRoomInfo()),a=await d(async()=>{let r=await this.supabase.from("game_rooms").select("state").eq("room_id",e).single();if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null})),n=null===(r=a.data)||void 0===r?void 0:r.state,s=m(t,n||"waiting");return(0,o.f)(s)}finally{this.roomId=t}}catch(r){return(0,o.T)(h(r,e,"getRoom"))}}async addPlayer(e,r,t){try{let a=await this.getRoom(e);if(!a.success)return a;let n=a.value;if(n.players.length>=n.maxPlayers)return(0,o.T)({type:"ROOM_FULL",message:"Room is full (".concat(n.players.length,"/").concat(n.maxPlayers," players)"),roomId:e,currentCount:n.players.length,maxCount:n.maxPlayers});let{error:s}=await d(async()=>{let a=await this.supabase.from("game_players").insert({id:this.generateId(),room_id:e,player_id:r,player_name:t,is_ready:!1,joined_at:Date.now()});if(a.error)throw a.error;return a}).catch(e=>({error:e,data:null}));if(s)return(0,o.T)(h(s,e,"addPlayer"));return await this.getRoom(e)}catch(r){return(0,o.T)(h(r,e,"addPlayer"))}}async removePlayer(e,r){try{let{error:t}=await d(async()=>{let t=await this.supabase.from("game_players").delete().eq("room_id",e).eq("player_id",r);if(t.error)throw t.error;return t}).catch(e=>({error:e,data:null}));if(t)return(0,o.T)(h(t,e,"removePlayer"));return await this.getRoom(e)}catch(r){return(0,o.T)(h(r,e,"removePlayer"))}}async updateRoomState(e,r){try{let{error:t}=await d(async()=>{let t=await this.supabase.from("game_rooms").update({state:r}).eq("room_id",e);if(t.error)throw t.error;return t}).catch(e=>({error:e,data:null}));if(t)return(0,o.T)(h(t,e,"updateRoomState"));return await this.getRoom(e)}catch(r){return(0,o.T)(h(r,e,"updateRoomState"))}}async transferHost(e,r){try{let{error:t}=await d(async()=>{let t=await this.supabase.from("game_rooms").update({host_id:r}).eq("room_id",e);if(t.error)throw t.error;return t}).catch(e=>({error:e,data:null}));if(t)return(0,o.T)(h(t,e,"transferHost"));return await this.getRoom(e)}catch(r){return(0,o.T)(h(r,e,"transferHost"))}}async deleteRoom(e){try{let{error:r}=await d(async()=>{let r=await this.supabase.from("game_players").delete().eq("room_id",e);if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null}));if(r)return(0,o.T)(h(r,e,"deleteRoom"));let{error:t}=await d(async()=>{let r=await this.supabase.from("game_rooms").delete().eq("room_id",e);if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null}));if(t)return(0,o.T)(h(t,e,"deleteRoom"));return(0,o.f)(void 0)}catch(r){return(0,o.T)(h(r,e,"deleteRoom"))}}async isRoomExpired(e){try{let{data:r,error:t}=await d(async()=>{let r=await this.supabase.from("game_rooms").select("expires_at").eq("room_id",e).single();if(r.error)throw r.error;return r}).catch(e=>({error:e,data:null}));if(t||!r)return(0,o.T)({type:"ROOM_NOT_FOUND",message:"Room not found",roomId:e});let a=r.expires_at<Date.now();return(0,o.f)(a)}catch(r){return(0,o.T)(h(r,e,"isRoomExpired"))}}async changeGame(e,r,t){try{let t=await this.getRoom(e);if(!t.success)return t;let a=t.value;if(!this.playerId||a.hostId!==this.playerId)return(0,o.T)({type:"ROOM_UPDATE_FAILED",message:"Only the host can change the game",roomId:e,reason:"Not the host"});if(a.players.length<2)return(0,o.T)({type:"ROOM_UPDATE_FAILED",message:"Need at least 2 players to change game",roomId:e,reason:"Insufficient players"});let n=this.roomId,s=this.playerId;this.roomId=e,this.playerId=a.hostId;try{let e=await this.changeGameInternal(r),t=m(e,"waiting");return(0,o.f)(t)}finally{this.roomId=n,this.playerId=s}}catch(r){return(0,o.T)(h(r,e,"changeGame"))}}subscribeToRoomUpdates(e,r){let t=this.roomId;this.roomId=e;try{let e=this.onRoomUpdate(e=>{let t=m(e,"waiting");r(t)});return()=>{e(),this.roomId=t}}catch(e){throw this.roomId=t,e}}async leaveRoom(){if(!this.roomId||!this.playerId){this.cleanup();return}let e=this.playerId;try{let r=await this.getRoomInfo().catch(e=>(console.error("[leaveRoom] Failed to get room info for ".concat(this.roomId,":"),e),null));if(!r){this.cleanup();return}let t=r.hostId===e,{error:a}=await this.supabase.from("game_players").delete().eq("room_id",this.roomId).eq("player_id",e).select();if(a){console.error("[leaveRoom] Error removing player ".concat(e," from room ").concat(this.roomId,":"),a),this.cleanup();return}await new Promise(e=>setTimeout(e,200));let{data:o,error:n}=await this.supabase.from("game_players").select("*").eq("room_id",this.roomId).order("joined_at",{ascending:!0});if(n){console.error("[leaveRoom] Error checking remaining players:",n),this.cleanup();return}let s=o||[],i=s.length;if(0===i)try{let e=await this.deleteRoom(this.roomId);e.success||console.error("[leaveRoom] Failed to delete room ".concat(this.roomId,":"),e.error)}catch(e){console.error("[leaveRoom] Failed to delete room ".concat(this.roomId,":"),e)}else if(t){let e=s[0].player_id;try{let{error:r}=await this.supabase.from("game_rooms").update({host_id:e}).eq("room_id",this.roomId);r&&console.error("[leaveRoom] Failed to update host for room ".concat(this.roomId,":"),r)}catch(e){console.error("[leaveRoom] Failed to transfer host for room ".concat(this.roomId,":"),e)}}}catch(e){console.error("[leaveRoom] Error leaving room ".concat(this.roomId,":"),e)}finally{this.cleanup()}}async rollDice(e){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let r=await this.getRoomInfo(),t=r.gameState;if(!t)throw Error("Game state not found");let a=(Array.isArray(r.players)?r.players:Object.values(r.players)).findIndex(e=>e.id===this.playerId);if(-1===a||a!==t.currentPlayer)throw Error("Not your turn");if(!n(t))throw Error("This method is only for Yacht Dice game");if(t.rollsLeft<=0)throw Error("No rolls left");let o=[...t.diceValues];for(let r=0;r<5;r++)e[r]||(o[r]=Math.floor(6*Math.random())+1);let s={...t,diceValues:o,heldDice:e,rollsLeft:t.rollsLeft-1};return await this.updateGameState(s),o}catch(e){throw console.error("Error rolling dice:",e),e}}async updateGameState(e){if(!this.roomId)throw Error("Not in a room");let{error:r}=await this.supabase.from("game_rooms").update({game_state:e}).eq("room_id",this.roomId).select();if(r)throw console.error("[updateGameState] Error updating game state:",r),r}async startGame(e){if(!this.roomId||!this.playerId)throw Error("Not in a room");let r=await this.getRoomInfo();if(r.hostId!==this.playerId)throw Error("Only the host can start the game");let t=r.gameState;if(!t)throw Error("Game state not found");if(t.gameStarted)return console.warn("Game already started"),r;let a=Array.isArray(r.players)?r.players:Object.values(r.players);if(a.length<2)throw Error("Need at least 2 players to start");let o=a.length,n=r.sceneKey;if("LasVegasScene"===n){let r=[],t=[],a=[],n=[],s=[],i=e||(()=>{let e=[];for(let r=1;r<=6;r++)e.push({number:r,playerDice:{},neutralDiceCount:0,moneyCards:[]});return e})();for(let e=0;e<o;e++)r.push([]),t.push(8),a.push(o<=4?2:0),n.push(0),s.push(0);console.log("[supabase-game] startGame - Updating game state",{casinosLength:i.length,hasMoneyCards:i.some(e=>e.moneyCards.length>0),moneyCardsCount:i.reduce((e,r)=>e+r.moneyCards.length,0)}),await this.updateGameState({gameStarted:!0,playerDice:r,playerDiceCounts:t,neutralDiceCounts:a,playerMoney:n,playerCardCounts:s,casinos:i,currentRound:1,currentPlayer:0,hasRolledThisTurn:!1})}else if("UnoScene"===n)await this.updateGameState({gameStarted:!0,currentRound:1,currentPlayer:0,deck:[],discardPile:[],playerHands:[],isClockwise:!0,currentColor:"Red",isColorSelectionMode:!1});else{let e={gameStarted:!0,scores:Array(o).fill({}),diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],rollsLeft:3,currentRound:1,currentPlayer:0};await this.updateGameState(e)}let{error:s}=await this.supabase.from("game_rooms").update({state:"in_progress"}).eq("room_id",this.roomId);return s&&console.error("[startGame] Error updating room state:",s),await this.getRoomInfo()}async removePlayerFromGame(e){if(!this.roomId)throw Error("Not in a room");try{let e=await this.getRoomInfo(),r=e.gameState;if(!r||!r.gameStarted)return;let t=Array.isArray(e.players)?e.players:Object.values(e.players),a=0;n(r)?a=Array.isArray(r.scores)?r.scores.length:Object.keys(r.scores||{}).length:s(r)&&(a=r.playerMoney.length);let o=a-t.length;if(1!==o){console.warn("Unexpected player removal count:",o);return}let i=r.currentPlayer,l=r.currentPlayer;i===l?l=t.length<=1?0:i>=t.length?0:i:i<l&&l--;let c=[],m=[],d=[],h=[],u=[],y=[],p=[];if(n(r)?(c=Array.isArray(r.scores)?[...r.scores]:Object.values(r.scores||{}),i>=0&&i<c.length&&c.splice(i,1)):s(r)&&(m=[...r.playerDice],d=[...r.playerDiceCounts],h=[...r.neutralDiceCounts],u=[...r.playerMoney],y=[...r.playerCardCounts],p=[...r.casinos],i>=0&&i<m.length&&(m=m.filter((e,r)=>r!==i)),i>=0&&i<d.length&&(d=d.filter((e,r)=>r!==i)),i>=0&&i<h.length&&(h=h.filter((e,r)=>r!==i)),i>=0&&i<u.length&&(u=u.filter((e,r)=>r!==i)),i>=0&&i<y.length&&(y=y.filter((e,r)=>r!==i)),p=p.map(e=>{let r={};return Object.entries(e.playerDice).forEach(e=>{let[t,a]=e,o=parseInt(t);o<i?r[o]=a:o>i&&(r[o-1]=a)}),{...e,playerDice:r}})),t.length<1){await this.updateGameState({...r,gameStarted:!1});return}n(r)?await this.updateGameState({...r,scores:c,currentPlayer:l}):s(r)&&await this.updateGameState({...r,currentPlayer:l,playerDice:m,playerDiceCounts:d,neutralDiceCounts:h,playerMoney:u,playerCardCounts:y,casinos:p})}catch(e){throw console.error("Error removing player from game:",e),e}}async selectCategory(e,r){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let t;let a=await this.getRoomInfo(),o=a.gameState;if(!o)return;let s=Array.isArray(a.players)?a.players:Object.values(a.players),i=s.findIndex(e=>e.id===this.playerId);if(-1===i||i!==o.currentPlayer)throw Error("Not your turn");if(!n(o))throw Error("This method is only for Yacht Dice game");for(t=Array.isArray(o.scores)?[...o.scores]:"object"==typeof o.scores&&null!==o.scores?Object.values(o.scores):Array(s.length).fill(null).map(()=>({}));t.length<s.length;)t.push({});if(i>=0&&i<t.length)t[i]&&"object"==typeof t[i]||(t[i]={}),t[i][e]=r;else throw Error("Invalid player index: ".concat(i));let l=o.currentPlayer+1,c=o.currentRound;l>=s.length&&(l=0,c++),await this.updateGameState({...o,scores:t,currentPlayer:l,currentRound:c,rollsLeft:3,heldDice:[!1,!1,!1,!1,!1],diceValues:[0,0,0,0,0]})}catch(e){throw console.error("Error selecting category:",e),e}}async toggleDiceHold(e){if(!this.roomId||!this.playerId)throw Error("Not in a room");let r=await this.getRoomInfo(),t=r.gameState;if(!t)return;if(!n(t))throw Error("This method is only for Yacht Dice game");if((Array.isArray(r.players)?r.players:Object.values(r.players)).findIndex(e=>e.id===this.playerId)!==t.currentPlayer)throw Error("Not your turn");let a=[...t.heldDice];a[e]=!a[e],await this.updateGameState({...t,heldDice:a})}async getActiveRooms(){try{let{data:e,error:r}=await this.supabase.from("game_rooms").select("*").eq("state","waiting");if(r)throw r;if(!e)return[];let t=[];for(let r of e){let{data:e}=await this.supabase.from("game_players").select("*").eq("room_id",r.room_id).order("joined_at",{ascending:!0}),a=(null==e?void 0:e.map(e=>({id:e.player_id,name:e.player_name,isReady:e.is_ready,joinedAt:e.joined_at})))||[],o=r.game_state,n=a.length;if(0===n){if(Date.now()-r.created_at<5e3)continue;try{let e=await this.deleteRoom(r.room_id);e.success||console.error("[getActiveRooms] Failed to delete empty room ".concat(r.room_id,":"),e.error)}catch(e){console.error("[getActiveRooms] Failed to delete empty room ".concat(r.room_id,":"),e)}continue}let s=Date.now(),i=r.expires_at&&r.expires_at<s;if("waiting"===r.state&&!i&&n>0&&n<r.max_players)t.push({roomId:r.room_id,players:a,gameState:o,sceneKey:c(r.game_type)||void 0,maxPlayers:r.max_players,createdAt:r.created_at,hostId:r.host_id||void 0});else if(i)try{let e=await this.deleteRoom(r.room_id);e.success||console.error("[getActiveRooms] Failed to delete expired room ".concat(r.room_id,":"),e.error)}catch(e){console.error("[getActiveRooms] Failed to delete expired room ".concat(r.room_id,":"),e)}}return t}catch(e){throw console.error("Error getting active rooms:",e),e}}async cleanupExpiredRooms(){try{let e=Date.now(),{data:r,error:t}=await d(async()=>await this.supabase.from("game_rooms").select("room_id").lt("expires_at",e));if(t)throw console.error("[cleanupExpiredRooms] Error fetching expired rooms:",t),t;if(!r||0===r.length)return 0;let a=0;for(let e of r)try{let r=e.room_id||e.roomId;if(!r)continue;(await this.deleteRoom(r)).success&&a++}catch(r){console.error("[cleanupExpiredRooms] Failed to delete room ".concat(e.room_id||e.roomId,":"),r)}return a}catch(e){throw console.error("[cleanupExpiredRooms] Error during cleanup:",e),e}}onRoomUpdate(e){if(!this.roomId)throw Error("Not in a room");let r=this.roomId;this.cleanupChannels();let t="room_update:".concat(r,":").concat(Date.now());this.roomChannel=this.supabase.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:"room_id=eq.".concat(r)},async t=>{try{console.log("[supabase-game] onRoomUpdate postgres_changes event received",{roomId:r,event:t.eventType,newRecord:t.new?{game_type:t.new.game_type,state:t.new.state}:null});let o=this.roomId;this.roomId=r;try{var a;let t=await this.getRoomInfo();console.log("[supabase-game] onRoomUpdate roomInfo fetched",{roomId:r,sceneKey:t.sceneKey,gameType:t.sceneKey?l(t.sceneKey):null,gameStarted:null===(a=t.gameState)||void 0===a?void 0:a.gameStarted});try{e(t)}catch(r){let e=r instanceof Error?r.message:"알 수 없는 오류";e.includes("drawImage")||e.includes("Cannot read properties of null")?console.warn("[onRoomUpdate] Callback error (Scene may not be active):",e):console.error("[onRoomUpdate] Error in room update callback:",e)}}finally{this.roomId=o}}catch(r){let e=r instanceof Error?r.message:"알 수 없는 오류";if(console.error("[onRoomUpdate] Error fetching room info:",e),e.includes("Room not found")||e.includes("406")){console.error("[onRoomUpdate] Room not found, but continuing (game may have ended)");return}}}).subscribe(e=>{"SUBSCRIBED"===e||"CHANNEL_ERROR"===e&&console.error("[onRoomUpdate] Error subscribing to room updates for ".concat(r))});let a="players_update:".concat(r,":").concat(Date.now());this.playersChannel=this.supabase.channel(a).on("postgres_changes",{event:"*",schema:"public",table:"game_players",filter:"room_id=eq.".concat(r)},async t=>{try{"DELETE"===t.eventType&&await new Promise(e=>setTimeout(e,500));let a=await this.getRoomInfo(),o=(Array.isArray(a.players)?a.players:Object.values(a.players||{})).length;if(0===o){console.error("[onRoomUpdate] Room ".concat(r," has 0 players, deleting..."));try{let e=await this.deleteRoom(r);e.success||console.error("[onRoomUpdate] Failed to delete room ".concat(r,":"),e.error);return}catch(e){console.error("[onRoomUpdate] Failed to delete room ".concat(r,":"),e)}}e(a)}catch(e){if(console.error("[onRoomUpdate] Error in players update callback:",e),e instanceof Error&&e.message.includes("Room not found")){console.error("[onRoomUpdate] Room ".concat(r," already deleted"));return}}}).subscribe(e=>{"SUBSCRIBED"===e||"CHANNEL_ERROR"===e&&console.error("[onRoomUpdate] Error subscribing to player updates for ".concat(r))});let o=()=>{this.roomChannel&&(this.supabase.removeChannel(this.roomChannel),this.roomChannel=null),this.playersChannel&&(this.supabase.removeChannel(this.playersChannel),this.playersChannel=null)};return this.listeners.push(o),o}onGameStateUpdate(e){if(!this.roomId)throw Error("Not in a room");this.gameStateChannel&&(this.supabase.removeChannel(this.gameStateChannel),this.gameStateChannel=null);let r="game_state_update:".concat(this.roomId,":").concat(Date.now()),t=this.supabase.channel(r).on("postgres_changes",{event:"UPDATE",schema:"public",table:"game_rooms",filter:"room_id=eq.".concat(this.roomId)},async r=>{e(r.new.game_state)}).subscribe(async t=>{if("SUBSCRIBED"===t&&this.roomId&&this.getRoomInfo().then(r=>{if(null==r?void 0:r.gameState){if(r.gameState.diceValues&&"string"==typeof r.gameState.diceValues)try{let e=JSON.parse(r.gameState.diceValues);Array.isArray(e)&&(r.gameState.diceValues=e)}catch(e){console.error("[onGameStateUpdate] Failed to parse diceValues after subscription:",e)}e(r.gameState)}}).catch(e=>{console.error("[onGameStateUpdate] Error fetching latest game state after subscription:",e)}),"TIMED_OUT"===t||"CHANNEL_ERROR"===t){if(this.resubscribeAttempts>=this.MAX_RESUBSCRIBE_ATTEMPTS){console.error("[onGameStateUpdate] Max resubscribe attempts (".concat(this.MAX_RESUBSCRIBE_ATTEMPTS,") reached, stopping resubscription"),{roomId:this.roomId,channelName:r}),this.resubscribeAttempts=0;return}this.resubscribeAttempts++;let a=Math.min(1e3*this.resubscribeAttempts,5e3);console.warn("[onGameStateUpdate] Channel ".concat(t,", attempting to resubscribe after ").concat(a,"ms (attempt ").concat(this.resubscribeAttempts,"/").concat(this.MAX_RESUBSCRIBE_ATTEMPTS,")..."),{roomId:this.roomId,channelName:r}),this.gameStateChannel&&(this.supabase.removeChannel(this.gameStateChannel),this.gameStateChannel=null),setTimeout(()=>{this.roomId&&this.getRoomInfo().then(r=>{if(null==r?void 0:r.gameState){if(r.gameState.diceValues&&"string"==typeof r.gameState.diceValues)try{let e=JSON.parse(r.gameState.diceValues);Array.isArray(e)&&(r.gameState.diceValues=e)}catch(e){console.error("[onGameStateUpdate] Failed to parse diceValues before resubscription:",e)}e(r.gameState)}this.roomId&&e&&this.onGameStateUpdate(e)}).catch(r=>{console.error("[onGameStateUpdate] Error fetching latest game state before resubscription:",r),this.roomId&&e&&this.onGameStateUpdate(e)})},a)}else"SUBSCRIBED"===t&&(this.resubscribeAttempts=0)},300);this.gameStateChannel=t;let a=()=>{this.gameStateChannel&&(this.supabase.removeChannel(this.gameStateChannel),this.gameStateChannel=null);let e=this.listeners.indexOf(a);e>-1&&this.listeners.splice(e,1)};return this.listeners.push(a),a}async getCurrentGameState(){if(!this.roomId)throw Error("Not in a room");try{return(await this.getRoomInfo()).gameState||null}catch(e){return console.error("Error getting current game state:",e),null}}onPlayerJoined(e){if(!this.roomId)throw Error("Not in a room");let r=this.supabase.channel("player_joined:".concat(this.roomId)).on("postgres_changes",{event:"INSERT",schema:"public",table:"game_players",filter:"room_id=eq.".concat(this.roomId)},r=>{try{let t=r.new,a={id:t.player_id,name:t.player_name,isReady:t.is_ready,joinedAt:t.joined_at};a.id!==this.playerId&&e(a)}catch(e){console.error("Error in player joined callback:",e)}}).subscribe(),t=()=>{this.supabase.removeChannel(r)};return this.listeners.push(t),t}onPlayerLeft(e){if(!this.roomId)throw Error("Not in a room");let r=this.supabase.channel("player_left:".concat(this.roomId)).on("postgres_changes",{event:"DELETE",schema:"public",table:"game_players",filter:"room_id=eq.".concat(this.roomId)},async r=>{try{let t=r.old,a=null==t?void 0:t.player_id;if(a){let r=await this.getRoomInfo().catch(()=>null),t=r?Array.isArray(r.players)?r.players:Object.values(r.players):[];e(a,t)}}catch(e){console.error("Error in player left callback:",e)}}).subscribe(),t=()=>{this.supabase.removeChannel(r)};return this.listeners.push(t),t}cleanup(){this.cleanupChannels(),this.listeners.forEach(e=>e()),this.listeners=[],this.roomId=null,this.playerId=null}getRoomId(){return this.roomId}getPlayerId(){return this.playerId}isConnected(){return null!==this.supabase}async deleteAllRooms(){try{let{data:e,error:r}=await this.supabase.from("game_rooms").select("room_id");if(r)throw r;if(!e||0===e.length)return 0;let t=0;for(let r of e)try{await this.supabase.from("game_rooms").delete().eq("room_id",r.room_id),t++}catch(e){console.error("Failed to delete room ".concat(r.room_id,":"),e)}return t}catch(e){throw console.error("Error deleting all rooms:",e),e}}async rollDiceLasVegas(e,r,t){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{var a,o;let n=await this.getRoomInfo(),i=n.gameState;if(!i)return;let l=[...Array.isArray(n.players)?n.players:Object.values(n.players)].sort((e,r)=>(e.joinedAt||0)-(r.joinedAt||0)),c=l.findIndex(e=>e.id===this.playerId);if(-1===c||c!==i.currentPlayer)throw Error("Not your turn");if(!s(i))throw Error("This method is only for Las Vegas game");let m=i.playerDice||[],d=i.playerDiceCounts||[],h=i.neutralDiceCounts||[];if(!Array.isArray(m))throw Error("playerDice is not an array");let u=l.length,y=[];for(let r=0;r<u;r++)r===c?y[r]=[...e]:r<m.length&&Array.isArray(m[r])&&m[r].length>0?y[r]=[...m[r]]:y[r]=[];let p=r.length>0?[...r]:[...d],g=t.length>0?[...t]:[...h];if(r.length>0&&r.length===p.length)for(let e=0;e<r.length;e++)p[e]=r[e];else p[c]=null!==(a=r[c])&&void 0!==a?a:d[c];if(t.length>0&&t.length===g.length)for(let e=0;e<t.length;e++)g[e]=t[e];else g[c]=null!==(o=t[c])&&void 0!==o?o:h[c];let f=i.playerDiceIsNeutral||[],w=[];for(let e=0;e<u;e++)if(e===c){let r=p[c]||0,t=y[c].length,a=Array(t).fill(!1);for(let e=r;e<t;e++)a[e]=!0;w[e]=a}else e<f.length&&Array.isArray(f[e])&&f[e].length===y[e].length?w[e]=[...f[e]]:w[e]=Array(y[e].length).fill(!1);let I={...i,playerDice:y,playerDiceCounts:p,neutralDiceCounts:g,playerDiceIsNeutral:w,hasRolledThisTurn:!0};await this.updateGameState(I)}catch(e){throw console.error("Error rolling dice:",e),e}}async placeDiceLasVegas(e,r,t,a,o,n,i,l,c){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{var m,d,h,u;let a=await this.getRoomInfo(),o=a.gameState;if(!o)return;if(!s(o))throw Error("This method is only for Las Vegas game");let n=[...Array.isArray(a.players)?a.players:Object.values(a.players)].sort((e,r)=>(e.joinedAt||0)-(r.joinedAt||0)),y=n.findIndex(e=>e.id===this.playerId);if(-1===y||y!==o.currentPlayer)throw Error("Not your turn");let p=[...(null===(m=o.playerDice)||void 0===m?void 0:m[y])||[]],g=[...o.playerDiceCounts||[]],f=[...o.neutralDiceCounts||[]],w=o.playerDiceIsNeutral||[],I=[];for(let e=0;e<n.length;e++)e<w.length&&Array.isArray(w[e])?I[e]=[...w[e]]:I[e]=Array((null===(h=o.playerDice)||void 0===h?void 0:null===(d=h[e])||void 0===d?void 0:d.length)||0).fill(!1);if(l&&l.length>0)[...l].sort((e,r)=>r-e).forEach(e=>{if(e>=0&&e<p.length){let r=c&&c[e];p.splice(e,1),y<I.length&&e<I[y].length&&I[y].splice(e,1),r?f[y]=Math.max(0,f[y]-1):g[y]=Math.max(0,g[y]-1)}});else{g[y]=Math.max(0,g[y]-r),f[y]=Math.max(0,f[y]-t);let e=r+t;for(let r=0;r<e&&p.length>0;r++)p.pop(),y<I.length&&I[y].length>0&&I[y].pop()}let _=[...o.casinos||[]].map(e=>({...e}));if(e>=0&&e<_.length&&e<i.length){let a={..._[e]},o=new Map(Object.entries(a.playerDice||{}).map(e=>{let[r,t]=e;return[parseInt(r),t]})),n=o.get(y)||0;o.set(y,n+r),a.neutralDiceCount=(a.neutralDiceCount||0)+t,a.playerDice=Object.fromEntries(o),_[e]=a}let R=n.length,b=[];for(let e=0;e<R;e++)e===y?b[e]=p:b[e]=(null===(u=o.playerDice)||void 0===u?void 0:u[e])||[];let C=(o.currentPlayer+1)%n.length,S=e=>{let r=g[e]||0,t=f[e]||0,a=b[e]||[];return r>0||t>0||a.length>0},E=0,D=n.length;for(;!S(C)&&E<D;)C=(C+1)%n.length,E++;let A=g.every((e,r)=>0===e&&0===f[r]),v=b.every(e=>0===e.length),T=A&&v?o.currentPlayer:C,P=[];for(let e=0;e<n.length;e++)e<b.length&&Array.isArray(b[e])?e===o.currentPlayer||e===T?P[e]=[]:P[e]=[...b[e]]:P[e]=[];let G={...o,currentPlayer:T,playerDice:P,playerDiceCounts:g,neutralDiceCounts:f,playerDiceIsNeutral:I,casinos:_,hasRolledThisTurn:!1};await this.updateGameState(G)}catch(e){throw console.error("Error placing dice:",e),e}}async nextPlayerLasVegas(e){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let r=await this.getRoomInfo(),t=r.gameState;if(!t)return;if(!s(t))throw Error("This method is only for Las Vegas game");let a=t.playerDice?[...t.playerDice]:[],o=[...Array.isArray(r.players)?r.players:Object.values(r.players)].sort((e,r)=>(e.joinedAt||0)-(r.joinedAt||0)).length,n=[];for(let r=0;r<o;r++)r<a.length&&Array.isArray(a[r])?r===t.currentPlayer||r===e?n[r]=[]:n[r]=[...a[r]]:n[r]=[];let i=t.casinos||[],l={...t,currentPlayer:e,playerDice:n,casinos:i,hasRolledThisTurn:!1};await this.updateGameState(l)}catch(e){throw console.error("Error moving to next player:",e),e}}async endGameLasVegas(e,r){if(!this.roomId)throw Error("Not in a room");try{let t=(await this.getRoomInfo()).gameState;if(!t)return;let a={...t,playerMoney:e,playerCardCounts:r};await this.updateGameState(a);let{error:o}=await this.supabase.from("game_rooms").update({state:"game_ended"}).eq("room_id",this.roomId);o&&console.error("[endGameLasVegas] Error updating room state:",o)}catch(e){throw console.error("Error ending game:",e),e}}async endGameYachtDice(e){if(!this.roomId)throw Error("Not in a room");try{e&&await this.updateGameState(e);let{error:r}=await this.supabase.from("game_rooms").update({state:"game_ended"}).eq("room_id",this.roomId);r&&console.error("[endGameYachtDice] Error updating room state:",r)}catch(e){throw console.error("Error ending game:",e),e}}async updateCasinosLasVegas(e,r){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let t=(await this.getRoomInfo()).gameState;if(!t)throw Error("Game state not found");let a={...t,casinos:e,gameSetupComplete:null==r||r};await this.updateGameState(a)}catch(e){throw console.error("Error updating casinos:",e),e}}async endRoundLasVegas(e,r,t,a,o,n,i){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let l=(await this.getRoomInfo()).gameState;if(!l)return;let c=[];s(l)&&(c=l.casinos||[]),a&&a.length>0&&(c=a.map(e=>({number:e.number,playerDice:e.playerDice,neutralDiceCount:e.neutralDiceCount,moneyCards:e.moneyCards||[]})));let m=e.length,d=o||Array(m).fill(8),h=n||Array(m).fill(m>=5?0:2),u=Array(m).fill(null).map(()=>[]),y={...l,playerMoney:e,playerCardCounts:r,currentRound:t,currentPlayer:null!=i?i:0,hasRolledThisTurn:!1,casinos:c,playerDice:u,playerDiceCounts:d,neutralDiceCounts:h,prizeAnimationCompleted:[]};await this.updateGameState(y)}catch(e){throw console.error("Error ending round:",e),e}}async markPrizeAnimationCompleted(){let e;if(!this.roomId||!this.playerId)throw Error("Not in a room");for(let t=1;t<=3;t++)try{var r;let e=(await this.getRoomInfo()).gameState;if(!e||!s(e))return;let a=e.prizeAnimationCompleted||[];if(a.includes(this.playerId))return;let o=[...a,this.playerId];console.log("updatedCompletedPlayers",o);let n={...e,prizeAnimationCompleted:o};await this.updateGameState(n),await new Promise(e=>setTimeout(e,100));let i=(await this.getRoomInfo()).gameState;if(i&&s(i)&&(null===(r=i.prizeAnimationCompleted)||void 0===r?void 0:r.includes(this.playerId))){console.log("성공적으로 업데이트됨",i.prizeAnimationCompleted);return}if(t<3){console.warn("[markPrizeAnimationCompleted] Update not reflected, retrying (attempt ".concat(t+1,"/").concat(3,")")),await new Promise(e=>setTimeout(e,200*t));continue}throw Error("Failed to update prizeAnimationCompleted after retries")}catch(r){if(e=r,t<3){console.warn("[markPrizeAnimationCompleted] Error on attempt ".concat(t,", retrying..."),r),await new Promise(e=>setTimeout(e,200*t));continue}}throw console.error("Error marking prize animation completed after retries:",e),e}async resetPrizeAnimationCompleted(){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let e=(await this.getRoomInfo()).gameState;if(!e||!s(e))return;let r={...e,prizeAnimationCompleted:[]};await this.updateGameState(r)}catch(e){throw console.error("Error resetting prize animation completed:",e),e}}async restartGame(){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let e=await this.getRoomInfo();if(e.hostId!==this.playerId)throw Error("Only the host can restart the game");let r=Array.isArray(e.players)?e.players:Object.values(e.players);if(r.length<2)throw Error("Need at least 2 players to restart");let t=r.length,a=e.sceneKey,{error:o}=await this.supabase.from("game_rooms").update({state:"waiting"}).eq("room_id",this.roomId);if(o)throw console.error("[restartGame] Error updating room state:",o),o;if("LasVegasScene"===a){let e={gameStarted:!1,currentRound:1,currentPlayer:0,playerDice:[],playerDiceCounts:Array(t).fill(8),neutralDiceCounts:Array(t).fill(0),casinos:[{number:1,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:2,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:3,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:4,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:5,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:6,playerDice:{},neutralDiceCount:0,moneyCards:[]}],playerMoney:Array(t).fill(0),playerCardCounts:Array(t).fill(0),hasRolledThisTurn:!1};await this.updateGameState(e)}else{let e={gameStarted:!1,scores:Array(t).fill({}),diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],rollsLeft:3,currentRound:1,currentPlayer:0};await this.updateGameState(e)}return await this.getRoomInfo()}catch(e){throw console.error("[restartGame] Error restarting game:",e),e}}async changeGameInternal(e){if(!this.roomId||!this.playerId)throw Error("Not in a room");try{let r=await this.getRoomInfo();if(r.hostId!==this.playerId)throw Error("Only the host can change the game");let t=Array.isArray(r.players)?r.players:Object.values(r.players);if(t.length<2)throw Error("Need at least 2 players to change game");let a=t.length,o=l(e);if(!o)throw Error("Unknown scene key: ".concat(e));let{error:n}=await this.supabase.from("game_rooms").update({state:"waiting",game_type:o}).eq("room_id",this.roomId);if(n)throw console.error("[changeGame] Error updating room:",n),n;if("LasVegasScene"===e){let e={gameStarted:!1,currentRound:1,currentPlayer:0,playerDice:[],playerDiceCounts:Array(a).fill(8),neutralDiceCounts:Array(a).fill(0),casinos:[{number:1,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:2,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:3,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:4,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:5,playerDice:{},neutralDiceCount:0,moneyCards:[]},{number:6,playerDice:{},neutralDiceCount:0,moneyCards:[]}],playerMoney:Array(a).fill(0),playerCardCounts:Array(a).fill(0),hasRolledThisTurn:!1};await this.updateGameState(e)}else{let e={gameStarted:!1,scores:Array(a).fill({}),diceValues:[0,0,0,0,0],heldDice:[!1,!1,!1,!1,!1],rollsLeft:3,currentRound:1,currentPlayer:0};await this.updateGameState(e)}return await this.getRoomInfo()}catch(e){throw console.error("[changeGameInternal] Error changing game:",e),e}}constructor(){this.supabase=(0,a.N)(),this.roomId=null,this.playerId=null,this.listeners=[],this.roomChannel=null,this.gameStateChannel=null,this.playersChannel=null,this.resubscribeAttempts=0,this.MAX_RESUBSCRIBE_ATTEMPTS=5}}let y=null;function p(){return y||(y=new u),y}},9301:function(e,r,t){t.d(r,{N:function(){return n}});var a=t(6883);let o=null,n=()=>(o||(o=(0,a.eI)("https://halsswnewmblmcqrnwra.supabase.co","sb_publishable_9nXIMFfIH4DJOyyJVncjPg_3KKUMfv4",{realtime:{params:{eventsPerSecond:10}}})),o)}}]);